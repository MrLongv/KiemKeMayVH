<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>login ‚Äì NƒÉng su·∫•t</title>
<style>
  :root{
    --bg1:#0b1b3a;--bg2:#0f2f67;--card:#fff;--muted:#6b7280;--text:#111827;
    --primary:#2563eb;--line:#e5e7eb;--danger:#b91c1c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;
  }
  .wrap{width:min(980px,100%);display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
  .hero{
    color:#fff;padding:22px;border:1px solid rgba(255,255,255,.12);
    border-radius:18px;background:rgba(255,255,255,.08);backdrop-filter: blur(10px);
  }
  .hero h1{margin:0 0 8px;font-size:20px}
  .hero p{margin:0;color:rgba(255,255,255,.86);line-height:1.6}
  .hero .pill{
    display:inline-flex;gap:8px;align-items:center;margin-top:10px;
    padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.10);font-size:12px;flex-wrap:wrap
  }

  .card{
    background:var(--card);border:1px solid rgba(255,255,255,.14);
    border-radius:18px;padding:18px;box-shadow:0 14px 40px rgba(0,0,0,.25);
  }
  .card h2{margin:0 0 12px;color:var(--text);font-size:16px}
  label{font-size:12px;color:var(--muted)}
  input{
    width:100%;padding:10px 12px;border:1px solid var(--line);
    border-radius:12px;outline:none;margin:6px 0 10px;font-size:14px
  }
  input:focus{border-color:rgba(37,99,235,.5);box-shadow:0 0 0 4px rgba(37,99,235,.15)}
  button{
    width:100%;border:none;background:var(--primary);color:#fff;
    padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer
  }
  .row{display:flex;gap:8px;margin-top:10px}
  .ghost{background:#fff;color:#111827;border:1px solid var(--line)}
  .msg{margin-top:10px;font-size:13px;color:var(--danger);min-height:18px}
  .info{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}
  .small{font-size:12px;color:rgba(255,255,255,.8);margin-top:12px}
  @media(max-width:860px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">
  <div class="hero">
    <h1>üìä H·ªá th·ªëng NƒÉng su·∫•t</h1>
    <p>
      ‚Ä¢ <b>TK</b>: nh·∫≠p k·∫ø ho·∫°ch/ng√†y theo t·ªï<br>
      ‚Ä¢ <b>T·ªï tr∆∞·ªüng</b>: nh·∫≠p th·ª±c t·∫ø theo gi·ªù + nguy√™n nh√¢n<br>
      ‚Ä¢ <b>GƒêX</b>: ch·ªâ xem theo x∆∞·ªüng<br>
      ‚Ä¢ <b>GDC</b>: theo d√µi chung t·∫•t c·∫£ (gdc/gdc.html)<br>
      ‚Ä¢ <b>GDH</b>: c√°c m√†n t·ªïng h·ª£p (gdh/gdc1.html, gdh/gdc2.html, gdh/gs1.html ...)
    </p>

    <div class="pill">
      <span>üìÅ C·∫•u tr√∫c:</span>
      <span>tk/tk1..3</span> ¬∑ <span>to/to1..3</span> ¬∑ <span>gdx/gdx1..3</span> ¬∑ <span>gdc/gdc</span> ¬∑ <span>gdh/gdc1..2 + gs1</span>
    </div>

    <div class="small">
      L∆∞u √Ω: s·ª≠a <b>API_URL</b> ƒë√∫ng Worker Cloudflare.
    </div>
  </div>

  <div class="card">
    <h2>ƒêƒÉng nh·∫≠p</h2>

    <label>T√†i kho·∫£n</label>
    <input id="lgUser" autocomplete="username" placeholder="vd: tk1 / gdx1 / gdc / gdc1 / gs1 ..." />

    <label>M·∫≠t kh·∫©u</label>
    <input id="lgPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

    <button id="btnLogin" onclick="login()">ƒêƒÉng nh·∫≠p</button>

    <div class="row">
      <button class="ghost" onclick="clearSession()">X√≥a phi√™n</button>
      <button class="ghost" onclick="goIfLogged()">V√†o h·ªá th·ªëng</button>
    </div>

    <div class="msg" id="msg"></div>
    <div class="info" id="info"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev"; // ‚úÖ s·ª≠a Worker URL

/* ========= SESSION ========= */
const KEY = "NS_SESSION";
function getSession(){ try{ return JSON.parse(localStorage.getItem(KEY) || "null"); }catch{ return null; } }
function setSession(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
function clearSession(){
  localStorage.removeItem(KEY);
  document.getElementById("msg").innerText = "ƒê√£ x√≥a phi√™n ƒëƒÉng nh·∫≠p.";
  renderInfo();
}

/* ========= PATH BASE (GH Pages safe) =========
   V√≠ d·ª•: /KiemKeMayVH
*/
function getBasePath(){
  const parts = location.pathname.split("/").filter(Boolean);
  if(!parts.length) return "";
  return "/" + parts[0];
}
const BASE = getBasePath();

/* ========= ROUTE =========
  ‚úÖ Rule b·∫°n ch·ªët:
  - gdc  -> /gdc/gdc.html
  - gdc1,gdc2.. -> /gdh/gdc1.html, /gdh/gdc2.html
  - gs1 -> /gdh/gs1.html
  - tk/to/gdx -> theo xuong
*/
function routeByRole(sess){
  if(!sess) return;

  const role = String(sess.role || "").toLowerCase();
  const u = String(sess.username || "").toLowerCase().trim();
  const x = Number(sess.xuong || 0);

  // TK/TO/GDX theo x∆∞·ªüng
  if(role === "tk"){
    location.href = `${BASE}/tk/tk${x}.html`; return;
  }
  if(role === "to"){
    location.href = `${BASE}/to/to${x}.html`; return;
  }
  if(role === "gdx"){
    location.href = `${BASE}/gdx/gdx${x}.html`; return;
  }

  // ‚úÖ GDH group theo username (gdc1, gdc2, gs1...)
  if(u === "gdc"){
    location.href = `${BASE}/gdc/gdc.html`; return;
  }
  if(/^gdc\d+$/i.test(u)){
    location.href = `${BASE}/gdh/${u}.html`; return;
  }
  if(/^gs\d+$/i.test(u)){
    location.href = `${BASE}/gdh/${u}.html`; return;
  }

  // fallback an to√†n
  if(role === "gdc"){
    // n·∫øu backend tr·∫£ role=gdc nh∆∞ng username kh√°c, ∆∞u ti√™n gdc/gdc.html
    location.href = `${BASE}/gdc/gdc.html`; return;
  }

  document.getElementById("msg").innerText =
    `Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ªùng d·∫´n cho t√†i kho·∫£n: ${sess.username} (role=${sess.role})`;
}

/* ========= API ========= */
async function apiPost(payload){
  const r = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const t = await r.text();
  try{ return JSON.parse(t); }
  catch{ return { success:false, msg:"API kh√¥ng tr·∫£ JSON", raw:t.slice(0,240) }; }
}

/* ========= UI ========= */
function renderInfo(){
  const s = getSession();
  const info = document.getElementById("info");
  if(!s){
    info.innerText = "Ch∆∞a c√≥ phi√™n ƒëƒÉng nh·∫≠p.";
    return;
  }
  info.innerText =
    `ƒêang l∆∞u phi√™n: ${s.username} ‚Ä¢ role=${s.role} ‚Ä¢ xuong=${s.xuong ?? ""} ‚Ä¢ to=${s.to_nhom ?? ""}`;
}

async function login(){
  const msg = document.getElementById("msg");
  msg.innerText = "";

  const user = document.getElementById("lgUser").value.trim();
  const pass = document.getElementById("lgPass").value.trim();
  if(!user || !pass){
    msg.innerText = "Vui l√≤ng nh·∫≠p t√†i kho·∫£n v√† m·∫≠t kh·∫©u.";
    return;
  }

  const btn = document.getElementById("btnLogin");
  btn.disabled = true;
  btn.innerText = "ƒêang ƒëƒÉng nh·∫≠p...";

  try{
    const res = await apiPost({ action:"login", user, pass });
    if(!res.success){
      msg.innerText = res.msg || "Sai t√†i kho·∫£n";
      return;
    }
    setSession(res);
    renderInfo();
    routeByRole(res);
  }catch(e){
    msg.innerText = "L·ªói k·∫øt n·ªëi: " + (e?.message || e);
  }finally{
    btn.disabled = false;
    btn.innerText = "ƒêƒÉng nh·∫≠p";
  }
}

function goIfLogged(){
  const s = getSession();
  if(!s){
    document.getElementById("msg").innerText = "Ch∆∞a ƒëƒÉng nh·∫≠p.";
    return;
  }
  routeByRole(s);
}

/* Enter ƒë·ªÉ login */
document.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") login();
});

/* Auto show info */
renderInfo();
</script>

</body>
</html>
