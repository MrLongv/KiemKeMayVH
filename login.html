<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>login â€“ NÄƒng suáº¥t</title>
<style>
  :root{
    --bg1:#0b1b3a;--bg2:#0f2f67;--card:#fff;--muted:#6b7280;--text:#111827;
    --primary:#2563eb;--line:#e5e7eb;--danger:#b91c1c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;
  }
  .wrap{width:min(980px,100%);display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
  .hero{
    color:#fff;padding:22px;border:1px solid rgba(255,255,255,.12);
    border-radius:18px;background:rgba(255,255,255,.08);backdrop-filter: blur(10px);
  }
  .hero h1{margin:0 0 8px;font-size:20px}
  .hero p{margin:0;color:rgba(255,255,255,.86);line-height:1.6}
  .hero .pill{
    display:inline-flex;gap:8px;align-items:center;margin-top:10px;
    padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.10);font-size:12px
  }

  .card{
    background:var(--card);border:1px solid rgba(255,255,255,.14);
    border-radius:18px;padding:18px;box-shadow:0 14px 40px rgba(0,0,0,.25);
  }
  .card h2{margin:0 0 12px;color:var(--text);font-size:16px}
  label{font-size:12px;color:var(--muted)}
  input{
    width:100%;padding:10px 12px;border:1px solid var(--line);
    border-radius:12px;outline:none;margin:6px 0 10px;font-size:14px
  }
  input:focus{border-color:rgba(37,99,235,.5);box-shadow:0 0 0 4px rgba(37,99,235,.15)}
  button{
    width:100%;border:none;background:var(--primary);color:#fff;
    padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer
  }
  .row{display:flex;gap:8px;margin-top:10px}
  .ghost{background:#fff;color:#111827;border:1px solid var(--line)}
  .msg{margin-top:10px;font-size:13px;color:var(--danger);min-height:18px}
  .info{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}
  .small{font-size:12px;color:rgba(255,255,255,.8);margin-top:12px}
  @media(max-width:860px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">
  <div class="hero">
    <h1>ğŸ“Š Há»‡ thá»‘ng NÄƒng suáº¥t</h1>
    <p>
      â€¢ <b>TK</b>: nháº­p káº¿ hoáº¡ch/ngÃ y theo tá»•<br>
      â€¢ <b>Tá»• trÆ°á»Ÿng</b>: nháº­p thá»±c táº¿ theo giá» + nguyÃªn nhÃ¢n<br>
      â€¢ <b>GÄX</b>: chá»‰ xem theo xÆ°á»Ÿng<br>
      â€¢ <b>GÄC</b>: theo dÃµi chung táº¥t cáº£
    </p>

    <div class="pill">
      <span>ğŸ“ Cáº¥u trÃºc:</span>
      <span>tk/tk1..3</span> Â· <span>to/to1..3</span> Â· <span>gdx/gdx1..3</span> Â·
      <span>gdc/gdc</span> Â· <span>gdh/gdc1..</span>
    </div>

    <div class="small">
      LÆ°u Ã½: sá»­a <b>API_URL</b> Ä‘Ãºng Worker Cloudflare.
    </div>
  </div>

  <div class="card">
    <h2>ÄÄƒng nháº­p</h2>

    <label>TÃ i khoáº£n</label>
    <input id="lgUser" autocomplete="username" placeholder="vd: tk1 / gdx1 / gdc / gdc1 ..." />

    <label>Máº­t kháº©u</label>
    <input id="lgPass" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />

    <button id="btnLogin" onclick="login()">ÄÄƒng nháº­p</button>

    <div class="row">
      <button class="ghost" onclick="clearSession()">XÃ³a phiÃªn</button>
      <button class="ghost" onclick="goIfLogged()">VÃ o há»‡ thá»‘ng</button>
    </div>

    <div class="msg" id="msg"></div>
    <div class="info" id="info"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";

/* ========= SESSION ========= */
const KEY = "NS_SESSION";
function getSession(){ try{ return JSON.parse(localStorage.getItem(KEY) || "null"); }catch{ return null; } }
function setSession(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
function clearSession(){
  localStorage.removeItem(KEY);
  document.getElementById("msg").innerText = "ÄÃ£ xÃ³a phiÃªn Ä‘Äƒng nháº­p.";
  renderInfo();
}

/* ========= URL helper (GH Pages safe) =========
   DÃ¹ng new URL Ä‘á»ƒ Ä‘áº£m báº£o:
   - Ä‘ang á»Ÿ /KiemKeMayVH/login.html -> nháº£y Ä‘Ãºng /KiemKeMayVH/gdc/gdc.html
   - khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi folder hiá»‡n táº¡i
*/
function goto(relPath){
  location.href = new URL(relPath, location.href).toString();
}

/* ========= ROUTE (Ä‘Ãºng theo báº¡n chá»‘t) ========= */
function routeByRole(sess){
  if(!sess || !sess.role) return;

  const role = String(sess.role || "").toLowerCase();
  const x = Number(sess.xuong || 0);
  const u = String(sess.username || "").toLowerCase().trim();

  if(role === "tk"){
    goto(`./tk/tk${x}.html`);
    return;
  }
  if(role === "to"){
    goto(`./to/to${x}.html`);
    return;
  }
  if(role === "gdx"){
    goto(`./gdx/gdx${x}.html`);
    return;
  }

  // âœ… GÄC: phÃ¢n biá»‡t theo username
  if(role === "gdc"){
    if(u === "gdc"){
      // gdc -> gdc/gdc.html
      goto(`./gdc/gdc.html`);
      return;
    }
    if(/^gdc\d+$/.test(u)){
      // gdc1, gdc2... -> gdh/gdc1.html, gdh/gdc2.html
      goto(`./gdh/${u}.html`);
      return;
    }
    // fallback
    goto(`./gdc/gdc.html`);
    return;
  }

  document.getElementById("msg").innerText = "Role khÃ´ng há»£p lá»‡: " + sess.role;
}

/* ========= API ========= */
async function apiPost(payload){
  const r = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  return await r.json();
}

/* ========= UI ========= */
function renderInfo(){
  const s = getSession();
  const info = document.getElementById("info");
  if(!s){
    info.innerText = "ChÆ°a cÃ³ phiÃªn Ä‘Äƒng nháº­p.";
    return;
  }
  info.innerText =
    `Äang lÆ°u phiÃªn: ${s.username} â€¢ role=${s.role} â€¢ xuong=${s.xuong ?? ""} â€¢ to=${s.to_nhom ?? ""}`;
}

async function login(){
  const msg = document.getElementById("msg");
  msg.innerText = "";

  const user = document.getElementById("lgUser").value.trim();
  const pass = document.getElementById("lgPass").value.trim();
  if(!user || !pass){
    msg.innerText = "Vui lÃ²ng nháº­p tÃ i khoáº£n vÃ  máº­t kháº©u.";
    return;
  }

  const btn = document.getElementById("btnLogin");
  btn.disabled = true;
  btn.innerText = "Äang Ä‘Äƒng nháº­p...";

  try{
    const res = await apiPost({ action:"login", user, pass });
    if(!res.success){
      msg.innerText = res.msg || "Sai tÃ i khoáº£n";
      return;
    }
    setSession(res);
    renderInfo();
    routeByRole(res);
  }catch(e){
    msg.innerText = "Lá»—i káº¿t ná»‘i: " + (e.message || e);
  }finally{
    btn.disabled = false;
    btn.innerText = "ÄÄƒng nháº­p";
  }
}

function goIfLogged(){
  const s = getSession();
  if(!s){
    document.getElementById("msg").innerText = "ChÆ°a Ä‘Äƒng nháº­p.";
    return;
  }
  routeByRole(s);
}

/* Enter Ä‘á»ƒ login */
document.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") login();
});

/* Auto show info */
renderInfo();
</script>

</body>
</html>
