<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GDC1 ‚Äì Dashboard NƒÉng su·∫•t</title>
<style>
  :root{
    --bg:#003366;
    --card:#111a2e;
    --card2:#0f172a;
    --line:rgba(255,255,255,.10);
    --text:#e5e7eb;
    --muted:rgba(229,231,235,.72);
    --primary:#60a5fa;
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;
    --shadow:0 18px 40px rgba(0,0,0,.28);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 500px at 20% 0%, rgba(96,165,250,.16), transparent 60%),
                radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,.12), transparent 60%),
                var(--bg);
    color:var(--text);
  }
  .topbar{
    position:sticky; top:0; z-index:50;
    background:linear-gradient(180deg, rgba(24,45,88,.92), rgba(16,34,68,.88));
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
    padding:12px 12px 10px;
  }
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .brand b{display:block; font-size:14px; letter-spacing:.2px}
  .brand span{display:block; font-size:12px; color:var(--muted); margin-top:2px}
  .ctlRow{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .ctl{
    display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    padding:8px 10px;
    border-radius:14px;
  }
  .ctl label{font-size:12px; color:var(--muted)}
  input[type="date"]{
    background:transparent;
    border:none; outline:none;
    color:var(--text);
    font-size:12px;
  }
  .btn{
    border:none; outline:none; cursor:pointer;
    padding:10px 12px;
    border-radius:14px;
    font-weight:900;
    font-size:12px;
    background:rgba(96,165,250,.18);
    color:var(--text);
    border:1px solid rgba(96,165,250,.35);
  }
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .btn.primary{
    background:linear-gradient(180deg, rgba(96,165,250,.38), rgba(96,165,250,.18));
    border:1px solid rgba(96,165,250,.45);
  }
  .btn.ghost{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
  }
  .btn.danger{
    background:linear-gradient(180deg, rgba(239,68,68,.40), rgba(239,68,68,.18));
    border:1px solid rgba(239,68,68,.45);
  }
  .status{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .dot{width:8px;height:8px;border-radius:999px;background:var(--good);box-shadow:0 0 0 5px rgba(34,197,94,.12)}
  .wrap{padding:12px; max-width:1200px; margin:0 auto}

  /* ticker ch·ªâ ƒë·∫°o (read-only) */
  .ticker{
    display:none;
    margin:10px 0 0;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    border-radius:16px;
    overflow:hidden;
  }
  .tickerTop{
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px;
    border-bottom:1px solid var(--line);
    font-size:12px;
    color:var(--muted);
  }
  .tickerTop b{color:var(--text)}
  .tickerMarquee{
    white-space:nowrap;
    overflow:hidden;
    position:relative;
    height:36px;
    display:flex; align-items:center;
  }
  .tickerMarquee .text{
    display:inline-block;
    padding-left:100%;
    font-weight:900;
    font-size:13px;
    animation: marquee 18s linear infinite;
  }
  @keyframes marquee{
    from{ transform:translateX(0); }
    to{ transform:translateX(-100%); }
  }

  /* tabs x∆∞·ªüng */
  .tabs{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    margin-top:12px;
  }
  .tab{
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    border-radius:16px;
    padding:10px;
    text-align:left;
    cursor:pointer;
    min-height:84px;
  }
  .tab.active{
    background:linear-gradient(180deg, rgba(96,165,250,.22), rgba(255,255,255,.05));
    border-color:rgba(96,165,250,.45);
    box-shadow:0 12px 30px rgba(96,165,250,.12);
  }
  .tab .t1{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .tab .name{font-weight:1000; font-size:13px}
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
  }
  .pill.good{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); color:#bbf7d0}
  .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#fde68a}
  .pill.bad{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10); color:#fecaca}
  .tab .kpis{
    margin-top:8px;
    display:grid;
    grid-template-columns:1fr;
    gap:4px;
    font-size:12px;
    color:var(--muted);
  }
  .tab .kpis b{color:var(--text)}
  .tab .reasons{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
  }

  /* section cards */
  .grid2{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
    margin-top:12px;
  }
  @media(min-width:980px){
    .grid2{ grid-template-columns:1.25fr .75fr; }
  }
  .card{
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .card .head{
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .card .head b{font-size:13px}
  .card .body{padding:10px 12px}

  /* table */
  .tableWrap{overflow:auto}
  table{width:max(900px,100%); border-collapse:collapse; font-size:12px}
  th,td{border:1px solid rgba(255,255,255,.10); padding:7px 8px; text-align:center; white-space:nowrap}
  th{background:rgba(255,255,255,.06); font-weight:1000}
  tbody tr:nth-child(even) td{background:rgba(255,255,255,.03)}
  .left{text-align:left; white-space:normal}
  .right{text-align:right}
  .pct{font-weight:1000}
  .pct.good{color:var(--good)} .pct.warn{color:var(--warn)} .pct.bad{color:var(--bad)}
  .hint{font-size:12px; color:var(--muted); line-height:1.45; margin-top:8px}

  /* ‚úÖ C·∫ÆT NG·∫ÆN C·ªòT M√É H√ÄNG TRONG B·∫¢NG THEO GI·ªú */
  .mhShort{
    max-width:140px;
    width:140px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap !important;
  }

  /* floating convert */
  .fabRow{
    position:fixed;
    right:14px;
    bottom:14px;
    z-index:80;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:flex-end;
  }
  .fab{
    width:54px; height:54px;
    border-radius:16px;
    border:1px solid rgba(96,165,250,.45);
    background:linear-gradient(180deg, rgba(96,165,250,.42), rgba(96,165,250,.18));
    box-shadow:0 18px 40px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center;
    font-size:20px;
    cursor:pointer;
    user-select:none;
  }
  .fab.smallFab{
    width:auto; height:auto;
    padding:10px 12px;
    font-size:12px;
    font-weight:1000;
    border-radius:14px;
  }

  /* modal convert */
  .modal{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:flex-end;
    z-index:90;
  }
  .sheet{
    width:100%;
    background:linear-gradient(180deg, rgba(17,26,46,.98), rgba(15,23,42,.98));
    border-top-left-radius:22px;
    border-top-right-radius:22px;
    border:1px solid rgba(255,255,255,.10);
    box-shadow:0 -18px 50px rgba(0,0,0,.45);
    padding:12px;
    max-height:88vh;
    overflow:auto;
  }
  .sheet .titleRow{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom:10px;
  }
  .sheet .titleRow b{font-size:14px}
  .sheet .close{
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    border-radius:12px;
    padding:8px 10px;
    cursor:pointer;
    font-weight:900;
  }
  .field{
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    border-radius:16px;
    padding:10px;
  }
  .convertTitle{
    font-weight:1000;
    font-size:13px;
    margin:2px 0 8px;
  }
  .xnSectionRow td{
    background:rgba(255,255,255,.06) !important;
    font-weight:1000;
    text-align:left;
  }
  .hl{background:rgba(245,158,11,.16) !important;}
  .sumRow td{
    background:rgba(96,165,250,.12) !important;
    font-weight:1000;
  }
  .muted{color:var(--muted)}
</style>
</head>
<body>

<div class="topbar">
  <div class="row">
    <div class="brand">
      <b>üè¢ Gi√°m ƒê·ªëc ‚Äì Theo d√µi nƒÉng su·∫•t (GDC1)</b>
      <span id="roleHint">‚Äî</span>
    </div>

    <div class="ctlRow">
      <div class="ctl">
        <label>Ng√†y</label>
        <input type="date" id="date" />
      </div>
      <button class="btn primary" id="btnReload">T·∫£i</button>
      <button class="btn ghost" id="btnLogout">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="status">
    <span class="dot"></span>
    <span id="status">ƒêang kh·ªüi t·∫°o‚Ä¶</span>
  </div>

  <!-- ‚úÖ Ticker ch·ªâ ƒë·∫°o: GDC1 ch·ªâ XEM (read-only) -->
  <div class="ticker" id="ticker">
    <div class="tickerTop">
      <div><b>üì£ Ch·ªâ ƒë·∫°o c·ªßa Gi√°m ƒê·ªëc</b> ‚Ä¢ <span id="tickerScope">‚Äî</span></div>
      <div id="tickerTime">‚Äî</div>
    </div>
    <div class="tickerMarquee">
      <div class="text" id="tickerText">‚Äî</div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="tabs" id="tabs"></div>

  <div class="grid2">
    <div class="card">
      <div class="head">
        <b id="hourTitle">‚è±Ô∏è NƒÉng su·∫•t theo gi·ªù ‚Äì XN1</b>
        <span class="pill" id="hourMeta">‚Äî</span>
      </div>
      <div class="body">
        <div class="tableWrap">
          <table id="hourTbl" style="width:max(1550px,100%)">
            <thead>
              <tr>
                <th>T·ªî</th>
                <th>LINE</th>
                <th class="left mhShort" title="M√É H√ÄNG">M√É H√ÄNG</th>
                <th>SL KH</th>
                <th>ƒêM NG√ÄY</th>
                <th>ƒêM GI·ªú</th>
                <th>USD/QT</th>
                <th id="hourHeadHours" colspan="9">S·∫¢N L∆Ø·ª¢NG THEO GI·ªú</th>
                <th>T·ªîNG SP</th>
                <th>USD/TH</th>
                <th>HI·ªÜU SU·∫§T</th>
              </tr>
              <tr id="hourHeadRow2"></tr>
            </thead>
            <tbody id="hourTbody"></tbody>
            <tfoot>
              <tr>
                <th colspan="4" class="right">T·ªîNG</th>
                <th id="hourSumDm" class="right">0</th>
                <th></th>
                <th id="hourSumUsdQt" class="right">0.00</th>
                <th colspan="9"></th>
                <th id="hourSumSp" class="right">0</th>
                <th id="hourSumUsd" class="right">0.00</th>
                <th id="hourSumHs">0.0%</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <b>üßæ Nguy√™n nh√¢n n·ªïi b·∫≠t</b>
        <span class="pill" id="reasonMeta">‚Äî</span>
      </div>
      <div class="body">
        <div class="tableWrap">
          <table style="width:100%">
            <thead>
              <tr>
                <th class="left">Nguy√™n nh√¢n</th>
                <th>S·ªë l·∫ßn</th>
              </tr>
            </thead>
            <tbody id="reasonTopTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="head">
      <b id="dayTitle">üìÑ NƒÉng su·∫•t ng√†y ‚Äì XN1</b>
      <span class="pill" id="dayMeta">‚Äî</span>
    </div>
    <div class="body">
      <div class="tableWrap">
        <table style="width:max(1180px,100%)">
          <thead>
            <tr>
              <th>T·ªî</th>
              <th>LINE</th>
              <th class="left">M√É H√ÄNG</th>
              <th>LƒêTT</th>
              <th>ƒêM/NG√ÄY</th>
              <th>TH</th>
              <th>ƒêG</th>
              <th>USD</th>
              <th>%NS</th>
              <th>USD/NG</th>
              <th>CD/NG√ÄY</th>
              <th class="left">GHI CH√ö</th>
            </tr>
          </thead>
          <tbody id="dayTbody"></tbody>
          <tfoot>
            <tr>
              <th colspan="7" class="right">T·ªîNG</th>
              <th id="daySumUsd">0.00</th>
              <th id="daySumHs">0%</th>
              <th id="daySumUsdPer">0.00</th>
              <th colspan="2"></th>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="hint" style="margin-top:10px">
        ‚úÖ Tab ch·ªçn x∆∞·ªüng ·ªü tr√™n s·∫Ω ƒë·ªïi b·∫£ng n√†y sang XN2/XN3 t∆∞∆°ng ·ª©ng.
      </div>
    </div>
  </div>
</div>

<!-- Floating buttons: ch·ªâ c√≤n Chuy·ªÉn ƒë·ªïi -->
<div class="fabRow">
  <div class="fab smallFab" id="fabConvert" title="Theo d√µi nƒÉng su·∫•t - chuy·ªÉn ƒë·ªïi">üìä Chuy·ªÉn ƒë·ªïi</div>
</div>

<!-- Modal: Convert (Theo d√µi nƒÉng su·∫•t - chuy·ªÉn ƒë·ªïi) -->
<div class="modal" id="convertModal">
  <div class="sheet">
    <div class="titleRow">
      <b>üìä THEO D√ïI NƒÇNG SU·∫§T ‚Äì CHUY·ªÇN ƒê·ªîI</b>
      <button class="close" id="btnConvertClose">ƒê√≥ng</button>
    </div>

    <div class="field" style="margin-bottom:10px">
      <div class="convertTitle">
        Ng√†y b√°o c√°o: <span id="convertDate" style="font-weight:1000"></span>
        <span class="muted">‚Ä¢ L≈©y k·∫ø USD th√°ng = t·ª´ ng√†y 01 ƒë·∫øn ng√†y ƒëang xem</span>
      </div>
      <div class="muted" id="convertProgress">‚Äî</div>
    </div>

    <div class="tableWrap">
      <table style="width:max(1120px,100%)">
        <thead>
          <tr>
            <th style="min-width:50px">T·ªî</th>
            <th class="left" style="min-width:150px">M√É H√ÄNG</th>
            <th style="min-width:70px">ƒê∆†N GI√Å</th>
            <th style="min-width:80px">TGCT</th>
            <th style="min-width:70px">NƒêSX</th>
            <th style="min-width:90px">Lƒê TT</th>
            <th style="min-width:90px">SƒêC</th>
            <th style="min-width:95px">ƒê·ªäNH M·ª®C<br/>Lƒê TT</th>
            <th class="hl" style="min-width:90px">TH·ª∞C HI·ªÜN</th>
            <th class="hl" style="min-width:90px">USD NG√ÄY</th>
            <th class="hl" style="min-width:120px">L≈®Y K·∫æ USD<br/>TH√ÅNG</th>
            <th style="min-width:95px">% NƒÇNG SU·∫§T<br/>ƒê·∫†T</th>
            <th style="min-width:80px">S·ªê NG√ÄY<br/>SX</th>
            <th class="left" style="min-width:180px">GHI CH√ö</th>
          </tr>
        </thead>
        <tbody id="convertTbody"></tbody>
        <tfoot>
          <tr class="sumRow">
            <td colspan="9" class="right">C·ªòNG</td>
            <td id="convertSumUsdDay" class="right">0.00</td>
            <td id="convertSumUsdMonth" class="right">0.00</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="hint" style="margin-top:10px">
      ‚úÖ TGCT l·∫•y t·ª´ <b>TG/QT</b> (thoi_gian_giay) b√™n th·ªëng k√™ x∆∞·ªüng nh·∫≠p.<br/>
      ‚úÖ S·ªë ng√†y SX l·∫•y t·ª´ <b>S·ªë ng√†y chuy·ªÉn ƒë·ªïi</b> (chuyen_doi_ngay) b√™n th·ªëng k√™ x∆∞·ªüng nh·∫≠p.
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const KEY="NS_SESSION";
const XUONGS = [1,2,3];

// ‚úÖ FIX khung gi·ªù:
// - XN1, XN2: KH√îNG c√≥ 11-12
// - XN3: KH√îNG c√≥ 12-13
const HOURS_BY_XUONG = {
  1:["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"],
  2:["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"],
  3:["7-8","8-9","9-10","10-11","11-12","13-14","14-15","15-16","16-17"]
};

const TO_BY_XUONG = {
  1:[1,3,5,7,9],
  2:[11,13,15,17],
  3:[19,21,23,25,27]
};

/* ================== FORMAT ================== */
const NF_INT   = new Intl.NumberFormat("en-US", { useGrouping:true, minimumFractionDigits:0, maximumFractionDigits:0 });
const NF_MONEY = new Intl.NumberFormat("en-US", { useGrouping:true, minimumFractionDigits:2, maximumFractionDigits:2 });
const NF_DG    = new Intl.NumberFormat("en-US", { useGrouping:false, minimumFractionDigits:0, maximumFractionDigits:2 });

function fmtInt(n){ return NF_INT.format(Math.round(Number(n)||0)); }
function fmtMoney(n){ return NF_MONEY.format(Number(n)||0); }
function fmtDg(n){ return NF_DG.format(Number(n)||0); }
function fmtPct1(n){ return (Number(n)||0).toFixed(1); }

function pctClass(hs){
  hs=Number(hs)||0;
  if(hs>=95) return "good";
  if(hs>=80) return "warn";
  return "bad";
}
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function normReason(s){
  s = String(s||"").trim();
  if(!s) return "";
  s = s.replace(/\s+/g," ").replace(/[.„ÄÇ]+$/,"");
  return s;
}
function toNum(v){
  let s = String(v ?? "").trim();
  if(!s) return 0;
  s = s.replace(/\s+/g,"").replaceAll(",","");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function todayISO(){
  const vn = new Date(Date.now() + 7*60*60*1000);
  return vn.toISOString().slice(0,10);
}
function ymOf(iso){ return String(iso||"").slice(0,7); }
function firstDayOfMonthISO(iso){
  const y = String(iso||"").slice(0,4);
  const m = String(iso||"").slice(5,7);
  return `${y}-${m}-01`;
}
function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); }
function addDaysISO(iso, delta){
  const d = new Date(iso+"T00:00:00");
  d.setDate(d.getDate()+delta);
  const yy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}

/* ================== SESSION ================== */
function sess(){ try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null} }
function mustLogin(){
  const s=sess();
  if(!s || !s.token){
    location.href="../login.html";
    return null;
  }
  return s;
}
function logout(){ localStorage.removeItem(KEY); location.href="../login.html"; }

/* ================== API ================== */
async function apiPost(payload){
  const s = mustLogin(); if(!s) return {success:false,msg:"NO_SESSION"};
  payload = { ...payload, token:s.token, _ts: Date.now() };
  const r = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload),
    cache:"no-store"
  });
  const text = await r.text();
  try{ return JSON.parse(text); }
  catch{ return { success:false, msg:`API kh√¥ng tr·∫£ JSON (HTTP ${r.status})`, raw:text.slice(0,240) }; }
}

/* ================== STATE ================== */
let S = null;
let activeXuong = 1;

let hourRawByXuong = {1:[],2:[],3:[]};
let dayRowsByXuong = {1:[],2:[],3:[]};
let dayAggByXuong  = {1:null,2:null,3:null};

function setStatus(t){ document.getElementById("status").innerText = t; }
function pillHS(hs){
  const cls = pctClass(hs);
  const icon = cls==="good" ? "‚úÖ" : (cls==="warn" ? "‚ö†Ô∏è" : "‚õî");
  return `<span class="pill ${cls}">${icon} ${fmtPct1(hs)}%</span>`;
}

/* ================== TICKER (READ-ONLY) ================== */
let tickerTimer=null;

function fmtTickerTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  const mo = String(d.getMonth()+1).padStart(2,"0");
  return `${da}/${mo} ${hh}:${mi}`;
}

async function loadTicker(){
  if(!S?.token) return;

  const ngay = document.getElementById("date").value || todayISO();
  let picked = null;

  // ∆Øu ti√™n ALL, n·∫øu kh√¥ng c√≥ th√¨ l·∫•y theo x∆∞·ªüng ƒëang xem
  const resAll = await apiPost({ action:"getDirectorMessage", scope:"ALL", ngay });
  if(resAll?.success && String(resAll.message||"").trim()) picked = resAll;

  if(!picked){
    const resX = await apiPost({ action:"getDirectorMessage", scope:String(activeXuong), ngay });
    if(resX?.success && String(resX.message||"").trim()) picked = resX;
  }

  const box = document.getElementById("ticker");
  if(!box) return;
  if(!picked){ box.style.display="none"; return; }

  const scope = String(picked.scope||picked.xuong||"").toUpperCase();
  const msg = String(picked.message||"").trim();
  if(!msg){ box.style.display="none"; return; }

  box.style.display="";
  document.getElementById("tickerScope").innerText = (scope==="ALL") ? "ALL" : `XN${scope}`;
  document.getElementById("tickerTime").innerText = fmtTickerTime(picked.updated_at) || "‚Äî";

  const textEl = document.getElementById("tickerText");
  textEl.style.animation="none"; textEl.offsetHeight;
  textEl.innerText = (scope==="ALL" ? "ALL: " : `XN${scope}: `) + msg;
  textEl.style.animation="marquee 18s linear infinite";
}

function startTicker(){
  stopTicker();
  loadTicker();
  tickerTimer = setInterval(loadTicker, 30000);
}
function stopTicker(){
  if(tickerTimer) clearInterval(tickerTimer);
  tickerTimer=null;
}
window.addEventListener("beforeunload", stopTicker);

/* ================== LOAD ================== */
let REQ=0;

async function reload(){
  if(!S?.token) return;
  const my = ++REQ;
  const ngay = document.getElementById("date").value || todayISO();
  const btn = document.getElementById("btnReload");
  btn.disabled = true;

  setStatus("‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...");
  try{
    // 1) getTkXuongDay cho 3 x∆∞·ªüng
    for(const x of XUONGS){
      setStatus(`‚è≥ ƒêang t·∫£i XN${x} (k·∫ø ho·∫°ch + theo gi·ªù)‚Ä¶`);
      const res = await apiPost({ action:"getTkXuongDay", ngay, xuong:x });
      if(my!==REQ) return;

      if(!res.success){
        setStatus(`‚õî L·ªói getTkXuongDay XN${x}: ${(res.msg||"")}${res.raw?(" ‚Ä¢ "+res.raw):""}`);
        dayRowsByXuong[x] = [];
        dayAggByXuong[x] = { usd:0, sp:0, dm:0, hs:0, topReasons:[] };
        continue;
      }

      const rows = res.rows || [];
      const allowTos = new Set((TO_BY_XUONG[x]||[]).map(Number));
      let filtered = rows.filter(r => allowTos.has(Number(r.to_nhom)));

      // b√π t·ªï thi·∫øu
      const existTo = new Set(filtered.map(r=>Number(r.to_nhom)));
      for(const to of allowTos){
        if(!existTo.has(to)){
          filtered.push({
            to_nhom:to, line_no:1, ma_hang:"",
            so_luong_ke_hoach:0, dinh_muc_ngay:0, dinh_muc_gio:0, usd_quy_trinh:0,
            don_gia:0, lao_dong_thuc_te:0, lao_dong_chuyen:0,
            thoi_gian_giay:0, chuyen_doi_ngay:0, ghi_chu:"", hours:[]
          });
        }
      }

      filtered.sort((a,b)=>Number(a.to_nhom)-Number(b.to_nhom) || Number(a.line_no||1)-Number(b.line_no||1));
      dayRowsByXuong[x] = filtered;

      // agg theo x∆∞·ªüng (ng√†y)
      let usd=0, sp=0, dm=0;
      for(const r of filtered){
        const hours = Array.isArray(r.hours) ? r.hours : [];
        const th = hours.reduce((a,b)=>a+toNum(b),0);
        sp += th;
        dm += toNum(r.dinh_muc_ngay);
        usd += th * toNum(r.don_gia);
      }
      const hs = dm>0 ? (sp/dm*100) : 0;
      dayAggByXuong[x] = { usd, sp, dm, hs, topReasons:[] };
    }

    // 2) getHourRange ƒë·ªÉ gom ‚Äúnguy√™n nh√¢n n·ªïi b·∫≠t‚Äù
    for(const x of XUONGS){
      setStatus(`‚è≥ ƒêang t·∫£i XN${x} (nguy√™n nh√¢n)‚Ä¶`);
      const hr = await apiPost({ action:"getHourRange", xuong:x, from:ngay, to:ngay });
      if(my!==REQ) return;

      if(!hr.success){
        setStatus(`‚õî L·ªói getHourRange XN${x}: ${(hr.msg||"")}${hr.raw?(" ‚Ä¢ "+hr.raw):""}`);
        hourRawByXuong[x] = [];
        if(dayAggByXuong[x]) dayAggByXuong[x].topReasons = [];
        continue;
      }

      const raw = hr.data || [];
      hourRawByXuong[x] = raw;

      const counter = new Map();
      for(const r of raw){
        const reason = normReason(r.nguyen_nhan||"");
        if(!reason) continue;
        counter.set(reason, (counter.get(reason)||0)+1);
      }
      const top = [...counter.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,c])=>({k,c}));
      if(dayAggByXuong[x]) dayAggByXuong[x].topReasons = top;
    }

    renderTabs();
    renderSelected();
    await loadTicker();

    setStatus(`‚úÖ ƒê√£ t·∫£i xong ‚Ä¢ ${new Date().toLocaleTimeString("vi-VN")}`);
  }catch(e){
    console.warn(e);
    setStatus("‚õî L·ªói t·∫£i d·ªØ li·ªáu: " + (e?.message || "unknown"));
  }finally{
    if(my===REQ) btn.disabled = false;
  }
}

/* ================== RENDER ================== */
function renderTabs(){
  const wrap = document.getElementById("tabs");

  wrap.innerHTML = XUONGS.map(x=>{
    const a = dayAggByXuong[x] || {usd:0,hs:0,sp:0,dm:0, topReasons:[]};
    const top = (a.topReasons||[]).slice(0,2);
    const reasons = top.length
      ? top.map(t=>`‚Ä¢ ${escapeHtml(t.k)} (${fmtInt(t.c)})`).join("<br/>")
      : "‚Ä¢ (Ch∆∞a c√≥ nguy√™n nh√¢n)";

    return `
      <div class="tab ${activeXuong===x?'active':''}" data-xuong="${x}">
        <div class="t1">
          <div class="name">XN${x}</div>
          ${pillHS(a.hs)}
        </div>
        <div class="kpis">
          <div>USD ƒë·∫°t: <b>${fmtMoney(a.usd)}</b></div>
          <div>SP: <b>${fmtInt(a.sp)}</b> ‚Ä¢ ƒêM: <b>${fmtInt(a.dm)}</b></div>
        </div>
        <div class="reasons">
          <b style="color:var(--text);font-size:12px">Top nguy√™n nh√¢n</b><br/>
          ${reasons}
        </div>
      </div>
    `;
  }).join("");

  wrap.querySelectorAll(".tab").forEach(el=>{
    el.addEventListener("click", ()=>{
      activeXuong = Number(el.dataset.xuong||1);
      renderTabs();
      renderSelected();
      loadTicker();
    });
  });
}

function renderSelected(){
  const xuong = activeXuong;
  const ngay = document.getElementById("date").value || todayISO();

  document.getElementById("hourTitle").innerText = `‚è±Ô∏è NƒÉng su·∫•t theo gi·ªù ‚Äì XN${xuong}`;
  document.getElementById("dayTitle").innerText  = `üìÑ NƒÉng su·∫•t ng√†y ‚Äì XN${xuong}`;

  renderHourTkStyle(xuong);
  renderReasonTop(xuong);
  renderDayTable(xuong, ngay);
}

function renderHourTkStyle(xuong){
  const hours = HOURS_BY_XUONG[xuong] || [];
  const rows = dayRowsByXuong[xuong] || [];

  const head2 = document.getElementById("hourHeadRow2");
  const headHours = document.getElementById("hourHeadHours");
  headHours.setAttribute("colspan", String(hours.length));

  head2.innerHTML = `
    <th colspan="7"></th>
    ${hours.map(h=>`<th>${escapeHtml(h)}</th>`).join("")}
    <th colspan="3"></th>
  `;

  let spSum=0, usdSum=0, dmSum=0, usdQtSum=0;

  const body = rows.map(r=>{
    const hArr = Array.isArray(r.hours) ? r.hours : Array(hours.length).fill(0);
    const normHours = hours.map((_,i)=>toNum(hArr[i]||0));

    const tongSP = normHours.reduce((a,b)=>a+b,0);
    const dmNgay = toNum(r.dinh_muc_ngay);
    const dg = toNum(r.don_gia);

    const dmGio = r.dinh_muc_gio ? toNum(r.dinh_muc_gio) : (dmNgay ? dmNgay / (hours.length||1) : 0);
    const usdQt = (dmNgay>0 && dg>0) ? (dmNgay*dg) : toNum(r.usd_quy_trinh||0);

    const usdTh = tongSP * dg;
    const hs = dmNgay ? (tongSP/dmNgay*100) : 0;

    spSum += tongSP;
    usdSum += usdTh;
    dmSum += dmNgay;
    usdQtSum += usdQt;

    const ln = Number(r.line_no||1);

    return `
      <tr>
        <td><b>${escapeHtml(r.to_nhom)}</b></td>
        <td><b>${ln}</b></td>
        <td class="left mhShort" title="${escapeHtml(r.ma_hang||"")}">${escapeHtml(r.ma_hang||"")}</td>
        <td>${fmtInt(r.so_luong_ke_hoach||0)}</td>
        <td>${fmtInt(dmNgay)}</td>
        <td class="right">${fmtMoney(dmGio)}</td>
        <td class="right">${fmtMoney(usdQt)}</td>
        ${normHours.map(v=>`<td>${fmtInt(v)}</td>`).join("")}
        <td class="right"><b>${fmtInt(tongSP)}</b></td>
        <td class="right"><b>${fmtMoney(usdTh)}</b></td>
        <td class="pct ${pctClass(hs)}">${fmtPct1(hs)}%</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="${7+hours.length+3}" class="left">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>`;

  document.getElementById("hourTbody").innerHTML = body;

  const hsAll = dmSum>0 ? (spSum/dmSum*100) : 0;

  document.getElementById("hourSumDm").innerText = fmtInt(dmSum);
  document.getElementById("hourSumUsdQt").innerText = fmtMoney(usdQtSum);
  document.getElementById("hourSumSp").innerText = fmtInt(spSum);
  document.getElementById("hourSumUsd").innerText = fmtMoney(usdSum);
  document.getElementById("hourSumHs").innerText = fmtPct1(hsAll) + "%";
  document.getElementById("hourMeta").innerHTML = pillHS(hsAll);
}

function renderReasonTop(xuong){
  const raw = hourRawByXuong[xuong] || [];
  const counter = new Map();
  for(const r of raw){
    const reason = normReason(r.nguyen_nhan||"");
    if(!reason) continue;
    counter.set(reason, (counter.get(reason)||0)+1);
  }
  const top = [...counter.entries()].sort((a,b)=>b[1]-a[1]).slice(0,14);

  document.getElementById("reasonMeta").innerText = `XN${xuong} ‚Ä¢ ${top.length} m·ª•c`;

  document.getElementById("reasonTopTbody").innerHTML = top.length
    ? top.map(([k,c])=>`
      <tr>
        <td class="left">${escapeHtml(k)}</td>
        <td><b>${fmtInt(c)}</b></td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" class="left">Ch∆∞a c√≥ nguy√™n nh√¢n.</td></tr>`;
}

function renderDayTable(xuong, ngay){
  const rows = dayRowsByXuong[xuong] || [];
  let usdSum=0, dmSum=0, spSum=0, ldSum=0;

  const body = rows.map(r=>{
    const hours = Array.isArray(r.hours) ? r.hours : [];
    const th = hours.reduce((a,b)=>a+toNum(b),0);

    const dm = toNum(r.dinh_muc_ngay);
    const dg = toNum(r.don_gia);
    const usd = th * dg;
    const hs = dm>0 ? (th/dm*100) : 0;

    const ld = toNum(r.lao_dong_thuc_te);
    const usdPer = ld>0 ? (usd/ld) : 0;

    usdSum += usd;
    dmSum += dm;
    spSum += th;
    ldSum += ld;

    const ln = Number(r.line_no||1);

    return `
      <tr>
        <td><b>${escapeHtml(r.to_nhom)}</b></td>
        <td><b>${ln}</b></td>
        <td class="left">${escapeHtml(r.ma_hang||"")}</td>
        <td>${fmtInt(ld)}</td>
        <td>${fmtInt(dm)}</td>
        <td>${fmtInt(th)}</td>
        <td class="right">${fmtDg(dg)}</td>
        <td class="right"><b>${fmtMoney(usd)}</b></td>
        <td class="pct ${pctClass(hs)}">${fmtPct1(hs)}%</td>
        <td class="right">${fmtMoney(usdPer)}</td>
        <td>${fmtInt(r.chuyen_doi_ngay||0)}</td>
        <td class="left">${escapeHtml(r.ghi_chu||"")}</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="12" class="left">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>`;

  document.getElementById("dayTbody").innerHTML = body;

  const hsAll = dmSum>0 ? (spSum/dmSum*100) : 0;
  const usdPerAll = ldSum>0 ? (usdSum/ldSum) : 0;

  document.getElementById("daySumUsd").innerText = fmtMoney(usdSum);
  document.getElementById("daySumHs").innerText = fmtPct1(hsAll) + "%";
  document.getElementById("daySumUsdPer").innerText = fmtMoney(usdPerAll);

  document.getElementById("dayMeta").innerHTML =
    `Ng√†y ${ngay} ‚Ä¢ USD <b>${fmtMoney(usdSum)}</b> ‚Ä¢ HS <b>${fmtPct1(hsAll)}%</b> ‚Ä¢ SP <b>${fmtInt(spSum)}</b>`;
}

/* ================== CONVERT (CHUY·ªÇN ƒê·ªîI) ================== */
const monthUsdCache = { 1:{}, 2:{}, 3:{} };

function openConvert(){
  const ngay = document.getElementById("date").value || todayISO();
  document.getElementById("convertDate").innerText = ngay;
  document.getElementById("convertModal").style.display="flex";
  renderConvertTable();
}
function closeConvert(){ document.getElementById("convertModal").style.display="none"; }
function convertProgress(text){
  const el = document.getElementById("convertProgress");
  if(el) el.innerText = text || "‚Äî";
}

function groupPlanByXuongTo(rows, xuong){
  const map = new Map();
  for(const r of rows){
    const to = Number(r.to_nhom);
    if(!map.has(to)){
      map.set(to, {
        to, bestLine:null, bestTh:0,
        ma_hang:"", don_gia:0, tgct:0,
        ndsx:0,
        ldtt:0, sdc:0, dm_ldtt:0,
        th:0, usd:0,
        so_ngay_sx:0,
        ghi_chu:""
      });
    }
    const a = map.get(to);

    const hours = Array.isArray(r.hours) ? r.hours : [];
    const th = hours.reduce((s,v)=>s+toNum(v),0);

    const dg = toNum(r.don_gia);
    const usd = th * dg;

    a.ldtt += toNum(r.lao_dong_thuc_te);
    a.sdc  += toNum(r.lao_dong_chuyen);
    a.dm_ldtt += toNum(r.dinh_muc_ngay);
    a.th += th;
    a.usd += usd;
    a.so_ngay_sx = Math.max(a.so_ngay_sx, toNum(r.chuyen_doi_ngay));
    if(String(r.ghi_chu||"").trim()){
      if(th >= a.bestTh) a.ghi_chu = String(r.ghi_chu||"").trim();
    }

    if(th > a.bestTh){
      a.bestTh = th;
      a.bestLine = r;
      a.ma_hang = String(r.ma_hang||"");
      a.don_gia = dg;
      a.tgct = toNum(r.thoi_gian_giay); // TG/QT
      a.ndsx = toNum(r.lao_dong_chuyen || 0); // gi·ªØ nh∆∞ gdc.html
    }
  }
  return map;
}

async function ensureMonthUsdToDate(xuong, ngay){
  const ym = ymOf(ngay);
  const cache = monthUsdCache[xuong][ym];

  if(cache && cache.computedToDate && cache.computedToDate >= ngay){
    return cache;
  }

  let byTo = cache?.byTo ? new Map(cache.byTo) : new Map();
  let total = cache?.total || 0;

  const from = firstDayOfMonthISO(ngay);
  const startDate = cache?.computedToDate ? addDaysISO(cache.computedToDate, 1) : from;

  if(startDate > ngay){
    monthUsdCache[xuong][ym] = { byTo, total, computedToDate: (cache?.computedToDate||ngay) };
    return monthUsdCache[xuong][ym];
  }

  const allowTos = new Set((TO_BY_XUONG[xuong]||[]).map(Number));
  const y = Number(ym.slice(0,4));
  const m = Number(ym.slice(5,7));
  const startD = Number(startDate.slice(8,10));
  const endD = Number(ngay.slice(8,10));
  const maxDay = daysInMonth(y, m);
  const endSafe = Math.min(endD, maxDay);

  for(let d = startD; d <= endSafe; d++){
    const iso = `${ym}-${String(d).padStart(2,"0")}`;
    convertProgress(`‚è≥ ƒêang t√≠nh l≈©y k·∫ø USD th√°ng‚Ä¶ XN${xuong} ‚Ä¢ ${iso}`);

    const res = await apiPost({ action:"getTkXuongDay", ngay: iso, xuong });
    if(!res?.success){
      console.warn("Month load fail", xuong, iso, res);
      continue;
    }
    const rows = (res.rows || []).filter(r => allowTos.has(Number(r.to_nhom)));

    for(const r of rows){
      const to = Number(r.to_nhom);
      const hours = Array.isArray(r.hours) ? r.hours : [];
      const th = hours.reduce((s,v)=>s+toNum(v),0);
      const usd = th * toNum(r.don_gia);

      if(usd !== 0){
        byTo.set(to, (byTo.get(to)||0) + usd);
        total += usd;
      }
    }
  }

  const out = { byTo, total, computedToDate: ngay };
  monthUsdCache[xuong][ym] = out;
  return out;
}

async function renderConvertTable(){
  const ngay = document.getElementById("date").value || todayISO();
  document.getElementById("convertDate").innerText = ngay;

  const tbody = document.getElementById("convertTbody");
  if(!tbody) return;

  convertProgress("‚è≥ ƒêang chu·∫©n b·ªã d·ªØ li·ªáu‚Ä¶");

  if(!dayRowsByXuong[1] || !dayRowsByXuong[2] || !dayRowsByXuong[3]){
    await reload();
  }

  let html = "";
  let sumUsdDayAll = 0;
  let sumUsdMonthAll = 0;

  for(const xuong of XUONGS){
    const rows = dayRowsByXuong[xuong] || [];
    const allowTos = new Set((TO_BY_XUONG[xuong]||[]).map(Number));
    const filtered = rows.filter(r => allowTos.has(Number(r.to_nhom)));

    const byToToday = groupPlanByXuongTo(filtered, xuong);
    const mtd = await ensureMonthUsdToDate(xuong, ngay);

    html += `<tr class="xnSectionRow"><td colspan="14">X√ç NGHI·ªÜP ${xuong}</td></tr>`;

    const tos = (TO_BY_XUONG[xuong]||[]).map(Number);
    for(const to of tos){
      const a = byToToday.get(to) || {
        to, ma_hang:"", don_gia:0, tgct:0, ndsx:0, ldtt:0, sdc:0, dm_ldtt:0, th:0, usd:0, so_ngay_sx:0, ghi_chu:""
      };

      const hs = a.dm_ldtt > 0 ? (a.th / a.dm_ldtt * 100) : 0;
      const usdMonth = (mtd?.byTo?.get(to) || 0);

      sumUsdDayAll += a.usd;
      sumUsdMonthAll += usdMonth;

      html += `
        <tr>
          <td><b>${to}</b></td>
          <td class="left">${escapeHtml(a.ma_hang||"")}</td>
          <td>${fmtDg(a.don_gia)}</td>
          <td>${fmtInt(a.tgct)}</td>
          <td>${fmtInt(a.ndsx)}</td>
          <td>${fmtInt(a.ldtt)}</td>
          <td>${fmtInt(a.sdc)}</td>
          <td>${fmtInt(a.dm_ldtt)}</td>

          <td class="hl"><b>${fmtInt(a.th)}</b></td>
          <td class="hl right"><b>${fmtMoney(a.usd)}</b></td>
          <td class="hl right"><b>${fmtMoney(usdMonth)}</b></td>

          <td class="pct ${pctClass(hs)}">${fmtPct1(hs)}%</td>
          <td>${fmtInt(a.so_ngay_sx)}</td>
          <td class="left">${escapeHtml(a.ghi_chu||"")}</td>
        </tr>
      `;
    }
  }

  tbody.innerHTML = html || `<tr><td colspan="14" class="left">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>`;
  document.getElementById("convertSumUsdDay").innerText = fmtMoney(sumUsdDayAll);
  document.getElementById("convertSumUsdMonth").innerText = fmtMoney(sumUsdMonthAll);

  convertProgress(`‚úÖ Xong ‚Ä¢ L≈©y k·∫ø th√°ng t√≠nh t·ª´ ${firstDayOfMonthISO(ngay)} ‚Üí ${ngay}`);
}

/* ================== EVENTS / BOOTSTRAP ================== */
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("btnLogout").addEventListener("click", logout);
  document.getElementById("btnReload").addEventListener("click", reload);

  // convert
  document.getElementById("fabConvert").addEventListener("click", openConvert);
  document.getElementById("btnConvertClose").addEventListener("click", closeConvert);
  document.getElementById("convertModal").addEventListener("click", (e)=>{
    if(e.target && e.target.id==="convertModal") closeConvert();
  });

  // date
  document.getElementById("date").value = todayISO();
  document.getElementById("date").addEventListener("change", async ()=>{
    await reload();
    await loadTicker();
    if(document.getElementById("convertModal").style.display === "flex"){
      renderConvertTable();
    }
  });

  S = mustLogin();
  if(!S) return;

  // ‚úÖ GDC1: v·∫´n y√™u c·∫ßu quy·ªÅn gdc ƒë·ªÉ xem (gi·ªëng gdc.html)
  if(S.role !== "gdc"){
    document.getElementById("roleHint").innerText = `‚õî Sai quy·ªÅn: role=${S.role} (c·∫ßn gdc)`;
    setStatus("‚õî Kh√¥ng ƒë√∫ng quy·ªÅn ƒë·ªÉ m·ªü GDC1");
    return;
  }

  document.getElementById("roleHint").innerText = `‚úÖ GƒêC: ${S.username} ‚Ä¢ xem 3 x∆∞·ªüng (read-only ch·ªâ ƒë·∫°o)`;
  setStatus("‚è≥ ƒêang t·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu‚Ä¶");

  startTicker();
  reload();
});
</script>

</body>
</html>
