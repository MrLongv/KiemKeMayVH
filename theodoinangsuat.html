<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>üìä Theo d√µi nƒÉng su·∫•t chuy·ªÅn may</title>

<style>
/* ===== STYLE GI·ªÆ NGUY√äN + B·ªî SUNG ===== */
:root{
  --blue:#2563eb;--green:#16a34a;--red:#dc2626;--yellow:#f59e0b;--bg:#f3f4f6;
}
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{margin:0;background:var(--bg)}
header{background:var(--blue);color:#fff;padding:12px;text-align:center;font-weight:600}
.box{background:#fff;margin:12px;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.hidden{display:none}
input,select,button{width:100%;padding:10px;margin:6px 0;font-size:16px}
button{border:none;border-radius:8px;cursor:pointer}
.btn-blue{background:var(--blue);color:#fff}
.btn-green{background:var(--green);color:#fff}
.btn-red{background:var(--red);color:#fff}
.ok{color:var(--green);font-weight:600}
.bad{color:var(--red);font-weight:600}
.alert{background:#fee2e2;border:2px solid #dc2626;padding:10px;border-radius:10px;margin-bottom:10px}
.alert h3{color:#dc2626;margin:0 0 5px 0}
</style>
</head>

<body>

<header>H·ªÜ TH·ªêNG THEO D√ïI NƒÇNG SU·∫§T CHUY·ªÄN MAY</header>

<!-- LOGIN -->
<div id="loginBox" class="box">
  <h3>üîê ƒêƒÉng nh·∫≠p</h3>
  <input id="lgUser" placeholder="T√†i kho·∫£n">
  <input id="lgPass" type="password" placeholder="M·∫≠t kh·∫©u">
  <button class="btn-blue" onclick="login()">ƒêƒÉng nh·∫≠p</button>
  <div id="lgMsg" style="color:red"></div>
</div>

<!-- INPUT T·ªî TR∆Ø·ªûNG -->
<div id="inputBox" class="box hidden">
  <h3>üßµ Nh·∫≠p nƒÉng su·∫•t chuy·ªÅn</h3>

  <div><b>X∆∞·ªüng:</b> <span id="iXuong"></span></div>
  <div><b>T·ªï:</b> <span id="iTo"></span></div>

  <!-- M√É H√ÄNG -->
  <select id="maHang">
    <option value="">-- Ch·ªçn m√£ h√†ng --</option>
    <option value="MH001" data-kh="800">MH001</option>
    <option value="MH002" data-kh="900">MH002</option>
    <option value="MH003" data-kh="1000">MH003</option>
  </select>

  <!-- K·∫æ HO·∫†CH -->
  <div class="box" style="background:#f1f5f9">
    <div><b>M√£ h√†ng:</b> <span id="showMaHang">-</span></div>
    <div><b>K·∫ø ho·∫°ch / ng√†y:</b> <span id="khNgay">0</span> sp</div>
    <div><b>K·∫ø ho·∫°ch / gi·ªù:</b> <span id="khGio">0</span> sp</div>
  </div>

  <!-- KHUNG GI·ªú -->
  <select id="timeSlot"></select>

  <!-- TH·ª∞C T·∫æ -->
  <input id="tt" type="number" placeholder="Th·ª±c t·∫ø gi·ªù n√†y (sp)">

  <!-- L·ªñI -->
  <select id="reason">
    <option value="">-- B√¨nh th∆∞·ªùng / Kh√¥ng l·ªói --</option>
    <option>M√°y may h∆∞</option>
    <option>Thi·∫øu ph·ª• li·ªáu</option>
    <option>Ph·ª• li·ªáu l·ªói (t√°i ch·∫ø)</option>
    <option>Thi·∫øu ng∆∞·ªùi</option>
    <option>Ch·ªù k·ªπ thu·∫≠t</option>
    <option>L·ªói ch·∫•t l∆∞·ª£ng</option>
    <option>Kh√°c</option>
  </select>

  <button class="btn-green" onclick="saveData()">üíæ L∆∞u d·ªØ li·ªáu</button>
  <button class="btn-red" onclick="logout()">ƒêƒÉng xu·∫•t</button>
  <div id="saveMsg"></div>
</div>

<!-- DASHBOARD -->
<div id="dashBox" class="box hidden">
  <h3>üìä Dashboard x∆∞·ªüng</h3>
  <div id="alertBox" class="hidden"></div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL="https://script.google.com/macros/s/AKfycbzBp504J32Fc1YnsY8zqNW4HscaT_fnvO0dKtl8QfYrnatFFAPfSQ92h5dJuzSbzQQm/exec";
const ALLOW_MINUTES=10;
const WORK_START=7, WORK_END=17;

const LUNCH_BY_FACTORY={
  1:{start:12,end:13},
  2:{start:11.5,end:12.5},
  3:{start:12,end:13}
};

/* ===== AUTH ===== */
function login(){
  fetch(API_URL,{method:"POST",body:new URLSearchParams({
    action:"login",user:lgUser.value,pass:lgPass.value
  })})
  .then(r=>r.json()).then(res=>{
    if(res.success!==true){lgMsg.innerText="Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u";return;}
    localStorage.setItem("USER",JSON.stringify(res));
    initByRole(res);
  });
}
function logout(){localStorage.clear();location.reload();}
function getUser(){return JSON.parse(localStorage.getItem("USER"));}

/* ===== ROLE ===== */
function initByRole(u){
  loginBox.classList.add("hidden");
  if(u.role==="to"){
    iXuong.innerText=u.xuong;
    iTo.innerText=u.to;
    buildTimeSlots(u.xuong);
    autoSelectCurrentSlot();
    inputBox.classList.remove("hidden");
  }
}

/* ===== TIME SLOT ===== */
function buildTimeSlots(xuong){
  timeSlot.innerHTML='<option value="">-- Ch·ªçn khung gi·ªù --</option>';
  const lunch=LUNCH_BY_FACTORY[xuong];
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();

  for(let h=WORK_START;h<WORK_END;h++){
    if(h>=lunch.start && h<lunch.end) continue;
    if(now.getDay()==6 && h>=16) continue;

    const start=h*60;
    const expired=nowMin>(start+ALLOW_MINUTES);

    timeSlot.innerHTML+=`
      <option value="${h}-${h+1}" ${expired?'disabled':''}>
        ${h}:00 - ${h+1}:00 ${expired?'(ƒë√£ kh√≥a)':''}
      </option>`;
  }
}

function autoSelectCurrentSlot(){
  const h=new Date().getHours();
  const v=`${h}-${h+1}`;
  [...timeSlot.options].forEach(o=>{
    if(o.value===v && !o.disabled) timeSlot.value=v;
  });
}

/* ===== MA H√ÄNG ===== */
maHang.addEventListener("change",()=>{
  const opt=maHang.options[maHang.selectedIndex];
  const khNgayVal=Number(opt.dataset.kh||0);
  showMaHang.innerText=opt.value||"-";
  khNgay.innerText=khNgayVal;
  const gioLam=[...timeSlot.options].length-1;
  khGio.innerText=gioLam?Math.round(khNgayVal/gioLam):0;
});

/* ===== TIME CHECK ===== */
function isInAllowedTime(slot){
  if(!slot) return false;
  const [f,t]=slot.split("-").map(Number);
  const now=new Date();
  const m=now.getHours()*60+now.getMinutes();
  return m>=(f*60-ALLOW_MINUTES)&&m<=(t*60+ALLOW_MINUTES);
}

/* ===== SAVE ===== */
function saveData(){
  if(!isInAllowedTime(timeSlot.value)){
    alert("‚è∞ Ch·ªâ cho nh·∫≠p trong ¬±10 ph√∫t c·ªßa khung gi·ªù!");
    return;
  }

  const hs=Math.round((Number(tt.value)/Number(khGio.innerText))*100);

  const u=getUser();
  fetch(API_URL,{method:"POST",body:new URLSearchParams({
    action:"save",
    user:u.user,
    xuong:u.xuong,
    to:u.to,
    maHang:maHang.value,
    kh:khNgay.innerText,
    tt:tt.value,
    hs:hs,
    timeSlot:timeSlot.value,
    reason:reason.value
  })})
  .then(r=>r.json()).then(res=>{
    saveMsg.innerHTML=res.success?"<span class='ok'>‚úî ƒê√£ l∆∞u</span>":"<span class='bad'>‚ùå "+res.msg+"</span>";
  });
}
</script>

</body>
</html>
