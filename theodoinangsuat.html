<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NÄƒng suáº¥t chuyá»n may</title>

<style>
body{font-family:Segoe UI;background:#f3f4f6;margin:0}
.box{background:#fff;margin:12px;padding:15px;border-radius:10px}
button,input,select{width:100%;padding:10px;margin:6px 0;font-size:16px}
.hidden{display:none}

.ok{color:#16a34a;font-weight:600}
.bad{color:#dc2626;font-weight:600}

.warn{
  background:#fee2e2;
  border:2px solid #dc2626;
  padding:10px;
  border-radius:8px;
  margin:10px 0;
}

.heatmap{
  display:grid;
  grid-auto-flow:column;
  gap:4px;
  overflow-x:auto;
}
.cell{
  min-width:60px;
  text-align:center;
  padding:6px;
  border-radius:6px;
  font-weight:600;
}
.red{background:#fecaca}
.yellow{background:#fde68a}
.green{background:#bbf7d0}
.gray{background:#e5e7eb}
</style>
</head>

<body>

<div class="box" id="loginBox">
  <h3>ğŸ” ÄÄƒng nháº­p</h3>
  <input id="lgUser" placeholder="TÃ i khoáº£n">
  <input id="lgPass" type="password" placeholder="Máº­t kháº©u">
  <button onclick="login()">ÄÄƒng nháº­p</button>
  <div id="lgMsg" class="bad"></div>
</div>

<div class="box hidden" id="inputBox">
  <h3>ğŸ§µ Nháº­p nÄƒng suáº¥t</h3>

  <div><b>XÆ°á»Ÿng:</b> <span id="iXuong"></span></div>
  <div><b>Tá»•:</b> <span id="iTo"></span></div>

  <input id="maHang" placeholder="MÃ£ hÃ ng">
  <select id="khungGio"></select>

  <input id="keHoach" type="number" placeholder="Káº¿ hoáº¡ch (sp/giá»)">
  <input id="thucTe" type="number" placeholder="Thá»±c táº¿ (sp)">
  <select id="nguyenNhan">
    <option value="">-- KhÃ´ng lá»—i --</option>
    <option>Thiáº¿u ngÆ°á»i</option>
    <option>MÃ¡y hÆ°</option>
    <option>Thiáº¿u phá»¥ liá»‡u</option>
    <option>Lá»—i cháº¥t lÆ°á»£ng</option>
  </select>

  <button onclick="save()">ğŸ’¾ LÆ°u</button>
  <div id="saveMsg"></div>
</div>
<!-- ===== DASHBOARD ===== -->
<div id="dashboardBox" class="box hidden">
  <h3>ğŸ“Š DASHBOARD ÄIá»€U HÃ€NH</h3>

 <div id="dashAlertBox" class="hidden"></div>

  <h3>ğŸ“‹ Tá»•ng há»£p theo tá»•</h3>
  <table id="dashTable">
    <thead>
      <tr>
        <th>NgÃ y</th>
        <th>XÆ°á»Ÿng</th>
        <th>Tá»•</th>
        <th>Giá»</th>
        <th>HS%</th>
        <th>Lá»—i</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>ğŸ”¥ Heatmap nÄƒng suáº¥t</h3>
  <div id="dashHeatmap"></div>

  <h3>ğŸ› ï¸ Top lá»—i áº£nh hÆ°á»Ÿng nÄƒng suáº¥t</h3>
  <div id="topErrors"></div>

  <button class="btn-red" onclick="logout()">ÄÄƒng xuáº¥t</button>
</div>
<div id="adminBox" class="box hidden">
  <h3>ğŸ‘‘ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</h3>

  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Role</th>
        <th>XÆ°á»Ÿng</th>
        <th>Tá»•</th>
        <th>Active</th>
        <th>LÆ°u</th>
      </tr>
    </thead>
    <tbody id="adminUsers"></tbody>
  </table>
</div>

<div class="box hidden" id="heatmapBox">
  <h3>ğŸ”¥ Heatmap nÄƒng suáº¥t</h3>
  <div id="heatmap"></div>
</div>

<script>
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";

const HOURS = [
  "07-08","08-09","09-10","10-11","11-12",
  "12-13","13-14","14-15","15-16","16-17"
];

document.addEventListener("DOMContentLoaded",init);

function init(){
  const u = getUser();
  if(!u) return;

  // áº¨n táº¥t cáº£
  loginBox.classList.add("hidden");
  inputBox.classList.add("hidden");
  heatmapBox.classList.add("hidden");
  dashboardBox.classList.add("hidden");
  adminBox.classList.add("hidden");

  /* ===== Tá»” TRÆ¯á»NG / Tá»” PHÃ“ ===== */
  if(u.role === "to_truong" || u.role === "to_pho"){
    inputBox.classList.remove("hidden");
    heatmapBox.classList.remove("hidden");
    iXuong.innerText = u.xuong;
    iTo.innerText = u.to;
    loadToday();
    return;
  }

  /* ===== GIÃM Äá»C XÆ¯á»NG ===== */
  if(u.role === "gdx_xuong"){
    dashboardBox.classList.remove("hidden");
    loadDashboard();
    return;
  }

  /* ===== GIÃM Äá»C CÃ”NG TY ===== */
 if(u.role === "gdc"){
  dashboardBox.classList.remove("hidden");
  loadDashboard();
  return;
}

  /* ===== ADMIN ===== */
  if(u.role === "admin"){
    adminBox.classList.remove("hidden");
    loadAdmin();
    return;
  }
}

function login(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"login",
      user:lgUser.value,
      pass:lgPass.value
    })
  }).then(r=>r.json()).then(res=>{
    if(!res.success){
      lgMsg.innerText="Sai tÃ i khoáº£n";
      return;
    }
    localStorage.setItem("USER",JSON.stringify(res));
    location.reload();
  });
}

function getUser(){
  return JSON.parse(localStorage.getItem("USER"));
}

/* ===== LOAD TODAY & HIDE USED HOURS ===== */
function loadToday(){
  const u=getUser();
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"getData",
      xuong:u.xuong
    })
  }).then(r=>r.json()).then(res=>{
    const today = new Date().toISOString().slice(0,10);
    const used = res.data.filter(r=>r.ngay===today && r.to_nhom==u.to);
    buildHourSelect(used);
    checkWarning(used);
    buildHeatmap(res.data);
  });
}

function buildHourSelect(rows){
  khungGio.innerHTML="";
  HOURS.forEach(h=>{
    const exist = rows.find(r=>r.khung_gio===h);
    const opt=document.createElement("option");
    opt.value=h;
    opt.textContent= exist ? `${h} (ÄÃ£ nháº­p)` : h;
    opt.disabled=!!exist;
    khungGio.appendChild(opt);
  });
}

/* ===== SAVE ===== */
function save(){
  const u=getUser();
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"save",
      user:u.user,
      xuong:u.xuong,
      to:u.to,
      ngay:new Date().toISOString().slice(0,10),
      khung_gio:khungGio.value,
      ma_hang:maHang.value,
      ke_hoach:keHoach.value,
      thuc_te:thucTe.value,
      nguyen_nhan:nguyenNhan.value
    })
  }).then(r=>r.json()).then(res=>{
    saveMsg.innerHTML = res.success
      ? `<span class="ok">âœ” ÄÃ£ lÆ°u (${res.hieu_suat}%)</span>`
      : `<span class="bad">${res.msg}</span>`;
    loadToday();
  });
}

/* ===== WARNING 2 HOURS <80% ===== */
function checkWarning(rows){
  rows.sort((a,b)=>HOURS.indexOf(a.khung_gio)-HOURS.indexOf(b.khung_gio));
  for(let i=1;i<rows.length;i++){
    if(rows[i].hieu_suat<80 && rows[i-1].hieu_suat<80){
      alertBox.classList.remove("hidden");
      alertBox.innerHTML=`
        <div class="warn">
          ğŸš¨ Cáº¢NH BÃO: ${rows[i-1].khung_gio} & ${rows[i].khung_gio}
          Ä‘á»u dÆ°á»›i 80%
        </div>`;
      return;
    }
  }
  alertBox.classList.add("hidden");
}

/* ===== HEATMAP ===== */
function buildHeatmap(data){
  const div=document.getElementById("heatmap");
  div.innerHTML="";
  const days=[...new Set(data.map(r=>r.ngay))].slice(0,7);

  const grid=document.createElement("div");
  grid.className="heatmap";

  HOURS.forEach(h=>{
    const col=document.createElement("div");
    col.innerHTML=`<b>${h}</b>`;
    days.forEach(d=>{
      const u = getUser();
const r = data.find(x =>
  x.khung_gio === h &&
  x.ngay === d &&
  x.to_nhom == u.to
);

      const cell=document.createElement("div");
      cell.className="cell";
      if(!r){cell.classList.add("gray");cell.innerText="-";}
      else if(r.hieu_suat<80){cell.classList.add("red");cell.innerText=r.hieu_suat;}
      else if(r.hieu_suat<95){cell.classList.add("yellow");cell.innerText=r.hieu_suat;}
      else{cell.classList.add("green");cell.innerText=r.hieu_suat;}
      col.appendChild(cell);
    });
    grid.appendChild(col);
  });

  div.appendChild(grid);
}
  /* ================= DASHBOARD ================= */

/* LOAD DASHBOARD */
function loadDashboard(){
  const u=getUser();
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"getData",
      role:u.role,
      xuong:u.xuong
    })
  }).then(r=>r.json()).then(res=>{
    if(!res.success) return;
    renderDashTable(res.data);
    renderDashAlert(res.data);
    renderDashHeatmap(res.data);
    renderTopErrors(res.data);
  });
}

/* ğŸš¨ ALERT 2 GIá»œ <80% */
function renderDashAlert(rows){
  const map={};

  rows.forEach(r=>{
    const key = r.xuong+"-"+r.to_nhom+"-"+r.ngay;
    if(!map[key]) map[key]=[];
    map[key].push(r);
  });

  const warns=[];
  Object.values(map).forEach(list=>{
    list.sort((a,b)=>HOURS.indexOf(a.khung_gio)-HOURS.indexOf(b.khung_gio));
    for(let i=1;i<list.length;i++){
      if(list[i].hieu_suat<80 && list[i-1].hieu_suat<80){
        warns.push(`XÆ°á»Ÿng ${list[i].xuong} â€“ Tá»• ${list[i].to_nhom}`);
        break;
      }
    }
  });

  const box = document.getElementById("dashAlertBox");
  if(warns.length===0){
    box.classList.add("hidden");
    return;
  }

  box.classList.remove("hidden");
  box.innerHTML=`
    <div class="alert">
      <h3>ğŸš¨ Cáº¢NH BÃO Tá»” NGUY HIá»‚M</h3>
      ${warns.join("<br>")}
    </div>`;
}

/* ğŸ“‹ Báº¢NG DASHBOARD */
function renderDashTable(rows){
  const tb=document.querySelector("#dashTable tbody");
  tb.innerHTML="";
  rows.slice(0,100).forEach(r=>{
    tb.innerHTML+=`
      <tr>
        <td>${r.ngay}</td>
        <td>${r.xuong}</td>
        <td>${r.to_nhom}</td>
        <td>${r.khung_gio}</td>
        <td class="${r.hieu_suat<80?'bad':'ok'}">${r.hieu_suat}</td>
        <td>${r.nguyen_nhan||""}</td>
      </tr>`;
  });
}

/* ğŸ”¥ HEATMAP DASHBOARD */
function renderDashHeatmap(data){
  const div=document.getElementById("dashHeatmap");
  div.innerHTML="";
  const days=[...new Set(data.map(r=>r.ngay))].slice(0,7);

  const grid=document.createElement("div");
  grid.className="heatmap";

  HOURS.forEach(h=>{
    const col=document.createElement("div");
    col.innerHTML=`<b>${h}</b>`;
    days.forEach(d=>{
      const list=data.filter(x=>x.khung_gio===h && x.ngay===d);
      const avg=list.length
        ? Math.round(list.reduce((a,b)=>a+b.hieu_suat,0)/list.length)
        : null;

      const cell=document.createElement("div");
      cell.className="cell";
      if(avg===null){cell.classList.add("gray");cell.innerText="-";}
      else if(avg<80){cell.classList.add("red");cell.innerText=avg;}
      else if(avg<95){cell.classList.add("yellow");cell.innerText=avg;}
      else{cell.classList.add("green");cell.innerText=avg;}
      col.appendChild(cell);
    });
    grid.appendChild(col);
  });

  div.appendChild(grid);
}

/* ğŸ› ï¸ TOP Lá»–I */
function renderTopErrors(rows){
  const map={};
  rows.forEach(r=>{
    if(r.hieu_suat<95 && r.nguyen_nhan){
      map[r.nguyen_nhan]=(map[r.nguyen_nhan]||0)+1;
    }
  });

  const div=document.getElementById("topErrors");
  div.innerHTML="";

  Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)
    .forEach(([k,v])=>{
      div.innerHTML+=`
        <div class="error-bar">${k}: ${v} láº§n</div>`;
    });
}
function loadAdmin(){
  const u=getUser();
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"admin_users",
      role:u.role
    })
  }).then(r=>r.json()).then(res=>{
    if(!res.success) return;
    const tb=document.getElementById("adminUsers");
    tb.innerHTML="";
    res.data.forEach(x=>{
      tb.innerHTML+=`
        <tr>
          <td>${x.username}</td>
          <td>
            <select id="r_${x.username}">
              <option ${x.role==="to_truong"?"selected":""}>to_truong</option>
              <option ${x.role==="to_pho"?"selected":""}>to_pho</option>
              <option ${x.role==="gdx_xuong"?"selected":""}>gdx_xuong</option>
              <option ${x.role==="gdc"?"selected":""}>gdc</option>
              <option ${x.role==="admin"?"selected":""}>admin</option>
            </select>
          </td>
          <td><input id="x_${x.username}" value="${x.xuong||""}"></td>
          <td><input id="t_${x.username}" value="${x.to_nhom||""}"></td>
          <td>
            <input type="checkbox" id="a_${x.username}" ${x.active? "checked":""}>
          </td>
          <td>
            <button onclick="saveUser('${x.username}')">ğŸ’¾</button>
          </td>
        </tr>`;
    });
  });
}

function saveUser(username){
  const u=getUser();
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"admin_save_user",
      admin:u.user,
      role:u.role,
      username,
      role_new:document.getElementById("r_"+username).value,
      xuong:document.getElementById("x_"+username).value,
      to_nhom:document.getElementById("t_"+username).value,
      active:document.getElementById("a_"+username).checked?1:0
    })
  }).then(()=>alert("ÄÃ£ lÆ°u"));
}
function logout(){
  localStorage.removeItem("USER");
  location.reload();
}

</script>

</body>
</html>
