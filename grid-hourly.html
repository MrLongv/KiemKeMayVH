<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nh·∫≠p nƒÉng su·∫•t theo gi·ªù</title>
<style>
body{font-family:Segoe UI;background:#f3f4f6;padding:20px}
table{border-collapse:collapse;width:100%;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#2563eb;color:#fff}
input,select{width:100%;border:none;text-align:center}
.low{background:#fee2e2}
.mid{background:#fef9c3}
.high{background:#dcfce7}
.locked{color:#16a34a;font-weight:600}
tfoot td{font-weight:bold;background:#e5e7eb}
</style>
</head>
<body>

<h2>üìä Nh·∫≠p nƒÉng su·∫•t theo gi·ªù</h2>

<div style="margin-bottom:10px">
  Ng√†y: <input type="date" id="ngay">
  M√£ h√†ng: <input id="maHang" style="width:120px">
</div>

<table id="grid">
<thead>
<tr>
  <th>Gi·ªù</th>
  <th>K·∫ø ho·∫°ch</th>
  <th>Th·ª±c t·∫ø</th>
  <th>% HS</th>
  <th>Nguy√™n nh√¢n</th>
  <th>Tr·∫°ng th√°i</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
  <td colspan="2">T·ªîNG NG√ÄY</td>
  <td id="sumTT">0</td>
  <td id="avgHS">0%</td>
  <td colspan="2"></td>
</tr>
</tfoot>
</table>

<div style="margin-top:10px" id="saveMsg"></div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const HOURS = [
  "07-08","08-09","09-10","10-11","12-13",
  "13-14","14-15","15-16","16-17"
];

const tbody = document.querySelector("#grid tbody");
let hourlyMap = {};

/* ================= INIT ================= */
document.getElementById("ngay").value =
  new Date().toISOString().slice(0,10);

renderGrid();
loadToday();

/* ================= RENDER GRID ================= */
function renderGrid(){
  tbody.innerHTML="";
  HOURS.forEach(h=>{
    const r = hourlyMap[h] || null;

    const tr=document.createElement("tr");
    tr.dataset.hour = h;

    tr.innerHTML=`
      <td>${h}</td>
      <td><input type="number" class="kh" ${r?'disabled':''} value="${r?.ke_hoach_gio||''}"></td>
      <td><input type="number" class="tt" ${r?'disabled':''} value="${r?.thuc_te||''}"></td>
      <td class="hs">${r? r.hieu_suat+"%":"0%"}</td>
      <td>
        <select class="lyDo" ${r?'disabled':''}>
          <option value="">-</option>
          <option ${r?.nguyen_nhan==="M√°y h∆∞"?"selected":""}>M√°y h∆∞</option>
          <option ${r?.nguyen_nhan==="Thi·∫øu ph·ª• li·ªáu"?"selected":""}>Thi·∫øu ph·ª• li·ªáu</option>
          <option ${r?.nguyen_nhan==="Thi·∫øu ng∆∞·ªùi"?"selected":""}>Thi·∫øu ng∆∞·ªùi</option>
          <option ${r?.nguyen_nhan==="L·ªói ch·∫•t l∆∞·ª£ng"?"selected":""}>L·ªói ch·∫•t l∆∞·ª£ng</option>
        </select>
      </td>
      <td>
        ${r
          ? `<span class="locked">‚úî ƒê√£ nh·∫≠p</span>`
          : `<button onclick="saveRow('${h}',this)">üíæ L∆∞u</button>`
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ================= CALC ================= */
tbody.addEventListener("input",calc);

function calc(){
  let sumTT=0,sumHS=0,c=0;

  document.querySelectorAll("tbody tr").forEach(tr=>{
    const kh=+tr.querySelector(".kh")?.value;
    const tt=+tr.querySelector(".tt")?.value;
    const hsCell=tr.querySelector(".hs");

    if(kh>0 && tt>=0){
      const hs=Math.round(tt/kh*100);
      hsCell.innerText=hs+"%";
      hsCell.className="hs "+(hs<80?"low":hs<95?"mid":"high");
      sumTT+=tt; sumHS+=hs; c++;
    }
  });

  sumTT && (sumTT=document.getElementById("sumTT").innerText=sumTT);
  document.getElementById("avgHS").innerText=c?Math.round(sumHS/c)+"%":"0%";
}

/* ================= LOAD DATA ================= */
function loadToday(){
  const u = JSON.parse(localStorage.getItem("USER"));
  if(!u) return;

  const ngay = document.getElementById("ngay").value;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"getData",
      xuong:u.xuong
    })
  })
  .then(r=>r.json())
  .then(res=>{
    hourlyMap={};
    res.data
      .filter(r=>r.ngay===ngay && r.to_nhom==u.to)
      .forEach(r=>{
        hourlyMap[r.khung_gio]=r;
      });

    renderGrid();
  });
}

/* ================= SAVE 1 ROW ================= */
function saveRow(khungGio,btn){
  const tr=btn.closest("tr");
  const kh=tr.querySelector(".kh").value;
  const tt=tr.querySelector(".tt").value;
  const lyDo=tr.querySelector(".lyDo").value;

  if(!kh || !tt){
    alert("Nh·∫≠p ƒë·ªß k·∫ø ho·∫°ch & th·ª±c t·∫ø");
    return;
  }

  const u = JSON.parse(localStorage.getItem("USER"));

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"save",
      user:u.user,
      xuong:u.xuong,
      to:u.to,
      ngay:document.getElementById("ngay").value,
      khung_gio:khungGio,
      ma_hang:document.getElementById("maHang").value||"",
      ke_hoach:kh,
      thuc_te:tt,
      nguyen_nhan:lyDo
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){
      alert(res.msg);
      return;
    }
    saveMsg.innerText="‚úî ƒê√£ l∆∞u khung "+khungGio;
    loadToday();
  });
}
</script>

</body>
</html>
