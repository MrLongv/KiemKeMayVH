<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nháº­p nÄƒng suáº¥t theo giá»</title>
<style>
body{font-family:Segoe UI;background:#f3f4f6;padding:20px}
table{border-collapse:collapse;width:100%;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#2563eb;color:#fff}
input,select{width:100%;border:none;text-align:center}
.low{background:#fee2e2}
.mid{background:#fef9c3}
.high{background:#dcfce7}
tfoot td{font-weight:bold;background:#e5e7eb}
</style>
</head>
<body>

<h2>ğŸ“Š Nháº­p nÄƒng suáº¥t theo giá» â€“ XN1</h2>

<table id="grid">
<thead>
<tr>
  <th>Giá»</th>
  <th>MÃ£ hÃ ng</th>
  <th>Káº¿ hoáº¡ch</th>
  <th>Thá»±c táº¿</th>
  <th>% HS</th>
  <th>NguyÃªn nhÃ¢n</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
  <td colspan="3">Tá»”NG NGÃ€Y</td>
  <td id="sumTT">0</td>
  <td id="avgHS">0%</td>
  <td></td>
</tr>
</tfoot>
</table>
<button onclick="saveGrid()">ğŸ’¾ LÆ¯U Dá»® LIá»†U</button>
<div id="saveMsg"></div>

<script>
const HOURS = [
  "07-08","08-09","09-10","10-11","12-13",
  "13-14","14-15","15-16","16-17"
];

const tbody = document.querySelector("#grid tbody");

HOURS.forEach(h=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>${h}</td>
    <td><input></td>
    <td><input type="number" class="kh"></td>
    <td><input type="number" class="tt"></td>
    <td class="hs">0%</td>
    <td>
      <select>
        <option value="">-</option>
        <option>MÃ¡y hÆ°</option>
        <option>Thiáº¿u phá»¥ liá»‡u</option>
        <option>Thiáº¿u ngÆ°á»i</option>
        <option>Lá»—i cháº¥t lÆ°á»£ng</option>
      </select>
    </td>
  `;
  tbody.appendChild(tr);
});

tbody.addEventListener("input",calc);

function calc(){
  let sumTT=0,sumHS=0,c=0;

  document.querySelectorAll("tbody tr").forEach(tr=>{
    const kh=+tr.querySelector(".kh").value;
    const tt=+tr.querySelector(".tt").value;
    const hsCell=tr.querySelector(".hs");

    if(kh>0 && tt>=0){
      const hs=Math.round(tt/kh*100);
      hsCell.innerText=hs+"%";
      hsCell.className="hs "+(hs<80?"low":hs<95?"mid":"high");
      sumTT+=tt; sumHS+=hs; c++;
    }
  });

  document.getElementById("sumTT").innerText=sumTT;
  document.getElementById("avgHS").innerText=c?Math.round(sumHS/c)+"%":"0%";
}
 const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";

function saveGrid(){
  const user = JSON.parse(localStorage.getItem("USER")) || {
    xuong: 1,
    to: 1,
    user: "test"
  };

  const ngay = document.getElementById("ngay").value;
  const ma_hang = document.getElementById("maHang").value;

  const rows = document.querySelectorAll("tbody tr");
  let count = 0;

  rows.forEach(tr => {
    const khung_gio = tr.dataset.hour;
    const keHoach = Number(tr.querySelector(".keHoach").value);
    const thucTe = Number(tr.querySelector(".thucTe").value);
    const lyDo = tr.querySelector(".lyDo").value;

    if (!keHoach && !thucTe) return;

    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        action:"saveHour",
        ngay,
        xuong:user.xuong,
        to_nhom:user.to,
        khung_gio,
        ma_hang,
        ke_hoach_gio: keHoach,
        thuc_te: thucTe,
        nguyen_nhan: lyDo,
        user: user.user
      })
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.success) count++;
      saveMsg.innerText = "âœ” ÄÃ£ lÆ°u "+count+" dÃ²ng";
    });
  });
} 
</script>

</body>
</html>
