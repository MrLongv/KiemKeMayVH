<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“¦ Kiá»ƒm kÃª CÃ´ng Cá»¥ - Viá»‡t Há»“ng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* Giá»¯ nguyÃªn style giá»‘ng trang mÃ¡y nhÆ°ng rÃºt gá»n cá»™t */
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{display:flex;justify-content:center;align-items:center;background:#0b74d1;color:#fff;padding:16px 0;font-size:24px;font-weight:bold;letter-spacing:1px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls select{padding:6px 8px;border:1px solid #ccc;border-radius:4px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap}
th{background:#0b74d1;color:#fff}
tr.highlight{background:#ffeaa7 !important}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:9999;display:flex;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:380px;max-width:95%;max-height:80vh;overflow-y:auto;-webkit-overflow-scrolling:touch;box-sizing:border-box}
body.modal-open{position:fixed;width:100%;overflow:hidden;height:100%;top:0}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){.controls{flex-direction:column;align-items:stretch}.controls input[type="text"],.controls select{width:100%}}
.highlight-row{background:yellow!important;transition:background .2s}
</style>
</head>
<body>
<header>ğŸ“¦ Kiá»ƒm kÃª CÃ´ng Cá»¥ - Viá»‡t Há»“ng</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo mÃ£ cÃ´ng cá»¥ / chá»§ng loáº¡i / vá»‹ trÃ­" />
  <select id="filterBox">
    <option value="all">ğŸ“‹ Hiá»‡n táº¥t cáº£</option>
    <option value="daKiemKe">âœ… ÄÃ£ kiá»ƒm kÃª</option>
    <option value="chuaKiemKe">â¬œ ChÆ°a kiá»ƒm kÃª</option>
    <option value="daIn">ğŸ–¨ï¸ ÄÃ£ chá»n in</option>
    <option value="chuaIn">ğŸ“„ ChÆ°a chá»n in</option>
  </select>
  <button id="btnAdd">â• ThÃªm</button>
  <button id="btnSync">â˜ï¸ Äá»“ng bá»™ lÃªn Sheet</button>
  <button id="btnRefresh" class="ghost">ğŸ”„ Táº£i láº¡i tá»« Sheet</button>
  <button id="btnPrint">ğŸ–¨ï¸ In tem QR</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
</div>

<div class="note">MÃ£ cÃ´ng cá»¥ (nháº­p sá»‘/chuá»—i) => dÃ¹ng Ä‘á»ƒ in QR; ngÃ y mua dd/MM/yyyy</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>MÃ£ cÃ´ng cá»¥</th>
        <th>Chá»§ng loáº¡i</th>
        <th>Vá»‹ trÃ­</th>
        <th>Sá»‘ tiá»n</th>
        <th>NgÃ y mua</th>
        <th>TÃ¬nh tráº¡ng</th>
        <th>Ghi chÃº</th>
        <th>HÃ nh Ä‘á»™ng</th>
        <th style="text-align:center;">ÄÃ£ KK<br><input type="checkbox" id="checkAllKK"></th>
        <th style="text-align:center;">In QR<br><input type="checkbox" id="checkAllQR"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- modal edit giá»‘ng mÃ¡y nhÆ°ng fields rÃºt gá»n -->
<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a cÃ´ng cá»¥</h3>
    <label>MÃ£ cÃ´ng cá»¥</label><input id="m_ma" />
    <label>Chá»§ng loáº¡i</label><input id="m_chungLoai" />
    <label>Vá»‹ trÃ­</label><input id="m_viTri" />
    <label>Sá»‘ tiá»n</label><input id="m_soTien" />
    <label>NgÃ y mua</label><input id="m_ngayMua" placeholder="dd/MM/yyyy" />
    <label>TÃ¬nh tráº¡ng</label><input id="m_tinhTrang" />
    <label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
    <label>ÄÃ£ kiá»ƒm kÃª</label><input type="checkbox" id="m_daKiemKe" />
    <label>Chá»n Ä‘á»ƒ in</label><input type="checkbox" id="m_chonIn" />
    <div class="actions">
      <button id="cancelBtn" class="ghost">Há»§y</button>
      <button id="saveBtn">Cáº­p nháº­t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
/*
  LÆ°u Ã½: frontend sáº½ gá»­i param `sheet=DanhSachCongCu` Ä‘áº¿n webapp Ä‘á»ƒ Ä‘á»c/ghi sheet tÆ°Æ¡ng á»©ng.
  WebApp (Code.gs) cáº§n há»— trá»£ e.parameter.sheet (mÃ¬nh sáº½ gá»­i patch Code.gs phÃ­a dÆ°á»›i).
*/
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxWXBadT5qZ6Ivdrhi-fwIyq8roqPHzGdApj4CQgEZXfpB5NVR39p8DcEyqBnsq1awg/exec';
const SHEET_NAME = 'DanhSachCongCu'; // frontend máº·c Ä‘á»‹nh dÃ¹ng sheet nÃ y

const statusEl = document.getElementById('status'), tbody = document.querySelector('#dataTable tbody');
const filterBox = document.getElementById('filterBox'), searchBox = document.getElementById('searchBox');
const modal = document.getElementById('editModal');
const m_ma = document.getElementById('m_ma'),
      m_chungLoai = document.getElementById('m_chungLoai'),
      m_viTri = document.getElementById('m_viTri'),
      m_soTien = document.getElementById('m_soTien'),
      m_ngayMua = document.getElementById('m_ngayMua'),
      m_tinhTrang = document.getElementById('m_tinhTrang'),
      m_ghiChu = document.getElementById('m_ghiChu'),
      m_daKiemKe = document.getElementById('m_daKiemKe'),
      m_chonIn = document.getElementById('m_chonIn');

let allData = [], editingIndex = null;

function setStatus(txt, ok = true){ statusEl.innerText = 'Tráº¡ng thÃ¡i: ' + txt; statusEl.style.color = ok ? '#0b74d1' : '#c0392b'; }
function safeText(v){ return v == null ? '' : String(v); }

function formatDateDDMMYYYY(d){
  if (!d && d !== 0) return "";
  if (typeof d === 'string' && d.includes('/')) return d;
  if (typeof d === 'string'){
    const m = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) return `${m[3]}/${m[2]}/${m[1]}`;
  }
  const date = (d instanceof Date) ? d : new Date(d);
  if (isNaN(date)) return String(d);
  const day = String(date.getDate()).padStart(2,'0');
  const month = String(date.getMonth()+1).padStart(2,'0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// hide UI until password (reuse same simple password behavior)
const PASSWORD = '12345';
const mainUI = [document.querySelector('header'), document.querySelector('.controls'), document.querySelector('.note'), document.querySelector('.table-wrap')];
mainUI.forEach(el => el.style.display = 'none');
const pwdModal = document.createElement('div');
pwdModal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999';
pwdModal.innerHTML = `<div style="background:#fff;padding:20px;border-radius:8px;width:320px;text-align:center">
  <h3>ğŸ”’ Nháº­p máº­t kháº©u</h3>
  <input id="pwdInput" type="password" style="width:80%;padding:6px;margin-top:10px" />
  <div style="margin-top:12px"><button id="pwdBtn" style="padding:6px 12px;background:#0b74d1;color:#fff;border:none;border-radius:4px;cursor:pointer">ÄÄƒng nháº­p</button></div>
</div>`;
document.body.appendChild(pwdModal);
const pwdInput = document.getElementById('pwdInput'), pwdBtn = document.getElementById('pwdBtn');
function initUI(){ pwdModal.style.display='none'; mainUI.forEach(el=>el.style.display='flex'); loadData(); }
const loginTime = localStorage.getItem('loginTime');
if (loginTime && Date.now() - loginTime < 3600*1000) initUI();
else { pwdInput.focus(); pwdBtn.onclick = ()=>{ if(pwdInput.value===PASSWORD){ localStorage.setItem('loginTime', Date.now()); initUI(); } else { alert('Máº­t kháº©u sai!'); pwdInput.value=''; pwdInput.focus(); } }; }

modal.style.display='none';

// RENDER TABLE
function renderTable(){
  const filter = filterBox.value;
  const search = (searchBox.value||'').toLowerCase();
  tbody.innerHTML = '';
  allData.forEach((r,idx) => {
    let show = true;
    if (filter==='daKiemKe' && !r.daKiemKe) show = false;
    if (filter==='chuaKiemKe' && r.daKiemKe) show = false;
    if (filter==='daIn' && !r.chonIn) show = false;
    if (filter==='chuaIn' && r.chonIn) show = false;
    if (search){
      const hay = [r.ma, r.chungLoai, r.viTri, r.tinhTrang, r.ghiChu, r.ngayMua, r.soTien].map(x => (x||'').toString().toLowerCase()).join(' ');
      if (!hay.includes(search)) show = false;
    }
    if (show){
      const tr = document.createElement('tr'); tr.dataset.index = idx;
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="col-ma">${safeText(r.ma)}</td>
        <td>${safeText(r.chungLoai)}</td>
        <td>${safeText(r.viTri)}</td>
        <td>${safeText(r.soTien)}</td>
        <td>${r.ngayMua?formatDateDDMMYYYY(r.ngayMua):''}</td>
        <td>${safeText(r.tinhTrang)}</td>
        <td>${safeText(r.ghiChu)}</td>
        <td>
          <button data-act="edit" data-i="${idx}">âœï¸</button>
          <button data-act="qr" data-i="${idx}">ğŸ”—</button>
        </td>
        <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
        <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
      `;
      tbody.appendChild(tr);
    }
  });
}

// LOAD DATA JSONP (request sheet=DanhSachCongCu)
function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  const cb = '__load_cb_' + Date.now();
  window[cb] = function(res){
    try{
      if (res && res.success && Array.isArray(res.data)){
        allData = res.data.map(r => ({
          ma: r.ma || '',
          chungLoai: r.chungLoai || '',
          viTri: r.viTri || '',
          soTien: r.soTien || '',
          ngayMua: r.ngayMua || '',
          tinhTrang: r.tinhTrang || '',
          ghiChu: r.ghiChu || '',
          daKiemKe: !!r.daKiemKe,
          chonIn: !!r.chonIn
        }));
        allData.forEach(r => { if (r.ngayMua) r.ngayMua = formatDateDDMMYYYY(r.ngayMua); });
        renderTable();
        setStatus('ÄÃ£ táº£i '+allData.length+' dÃ²ng');
        highlightFromHash();
      } else setStatus('Lá»—i táº£i dá»¯ liá»‡u', false);
    } finally { delete window[cb]; script.remove(); }
  };
  const script = document.createElement('script');
  script.src = GAS_URL + '?callback=' + cb + '&sheet=' + encodeURIComponent(SHEET_NAME) + '&_=' + Date.now();
  script.onerror = ()=>{ setStatus('Lá»—i táº£i dá»¯ liá»‡u', false); delete window[cb]; script.remove(); };
  document.head.appendChild(script);
}

// AUTO SYNC ROW (JSONP)
function autoSyncRow(i){
  if (i == null || !allData[i]) return;
  const row = allData[i], encoded = encodeURIComponent(JSON.stringify(row));
  const cb = '__auto_cb_' + Date.now();
  window[cb] = function(res){
    try{ if (res && res.success) setStatus('âœ… ÄÃ£ lÆ°u dÃ²ng '+(i+1)); else setStatus('âŒ Lá»—i lÆ°u dÃ²ng '+(i+1), false); }
    finally { delete window[cb]; script.remove(); }
  };
  const script = document.createElement('script');
  script.src = GAS_URL + '?sheet=' + encodeURIComponent(SHEET_NAME) + '&update=1&row=' + (i+1) + '&data=' + encoded + '&callback=' + cb + '&_=' + Date.now();
  script.onerror = ()=>{ console.warn('âš ï¸ AutoSync lá»—i máº¡ng'); delete window[cb]; script.remove(); };
  document.head.appendChild(script);
}

// EVENTS
filterBox.addEventListener('change', renderTable);
searchBox.addEventListener('input', renderTable);

tbody.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if (!btn) return;
  const act = btn.dataset.act, i = Number(btn.dataset.i);
  if (act === 'edit') openEditModal(i);
  if (act === 'qr') {
    const code = encodeURIComponent(allData[i].ma || '');
    const url = location.href.split('#')[0] + '#' + code;
    prompt('Link QR (copy & in tem):', url);
  }
});

tbody.addEventListener('change', e=>{
  const tr = e.target.closest('tr'); if (!tr) return;
  const idx = Number(tr.dataset.index);
  if (e.target.classList.contains('daKiemKe')){ allData[idx].daKiemKe = e.target.checked; autoSyncRow(idx); }
  if (e.target.classList.contains('chonIn')){ allData[idx].chonIn = e.target.checked; autoSyncRow(idx); }
  renderTable();
});

let lastScrollY = 0;
function openEditModal(idx){
  lastScrollY = window.scrollY;
  if (idx === null || idx === undefined){
    editingIndex = null;
    m_ma.value = ''; m_chungLoai.value=''; m_viTri.value=''; m_soTien.value=''; m_ngayMua.value=''; m_tinhTrang.value=''; m_ghiChu.value=''; m_daKiemKe.checked=false; m_chonIn.checked=false;
  } else {
    editingIndex = idx;
    const r = allData[idx] || {};
    m_ma.value = r.ma || '';
    m_chungLoai.value = r.chungLoai || '';
    m_viTri.value = r.viTri || '';
    m_soTien.value = r.soTien || '';
    m_ngayMua.value = r.ngayMua ? formatDateDDMMYYYY(r.ngayMua) : '';
    m_tinhTrang.value = r.tinhTrang || '';
    m_ghiChu.value = r.ghiChu || '';
    m_daKiemKe.checked = !!r.daKiemKe;
    m_chonIn.checked = !!r.chonIn;
  }
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  const scrollY = window.scrollY;
  document.body.style.top = `-${scrollY}px`;
  setTimeout(()=> m_ma.scrollIntoView({behavior:'smooth', block:'center'}), 200);
  m_ma.focus();
}
function closeModal(){
  modal.style.display = 'none';
  editingIndex = null;
  document.body.classList.remove('modal-open');
  document.body.style.top = '';
  document.body.style.overflow = '';
  window.scrollTo(0, lastScrollY);
}
document.getElementById('cancelBtn').onclick = closeModal;
document.getElementById('saveBtn').onclick = ()=>{
  // validate mÃ£
  const maVal = m_ma.value.trim();
  if (!maVal){ alert('MÃ£ cÃ´ng cá»¥ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng'); m_ma.focus(); return; }
  // format ngÃ y
  let ngay = m_ngayMua.value.trim();
  if (ngay){
    const parts = ngay.split('/');
    if (parts.length !== 3){ alert('NgÃ y mua khÃ´ng há»£p lá»‡, dÃ¹ng dd/MM/yyyy'); m_ngayMua.focus(); return; }
  } else if (editingIndex !== null && allData[editingIndex] && allData[editingIndex].ngayMua) ngay = allData[editingIndex].ngayMua;

  const obj = {
    ma: maVal,
    chungLoai: m_chungLoai.value.trim(),
    viTri: m_viTri.value.trim(),
    soTien: m_soTien.value.trim(),
    ngayMua: ngay || '',
    tinhTrang: m_tinhTrang.value.trim(),
    ghiChu: m_ghiChu.value.trim(),
    daKiemKe: m_daKiemKe.checked,
    chonIn: m_chonIn.checked
  };

  if (editingIndex === null){ allData.push(obj); autoSyncRow(allData.length - 1); }
  else { allData[editingIndex] = obj; autoSyncRow(editingIndex); }

  closeModal(); renderTable(); highlightFromHash();
}

// Scroll modal khi focus input (Ä‘iá»‡n thoáº¡i)
Array.from(modal.querySelectorAll('input,textarea')).forEach(input=>{
  input.addEventListener('focus', ()=> {
    setTimeout(()=> {
      const rect = input.getBoundingClientRect();
      const offset = window.innerHeight/2 - rect.height/2;
      modal.scrollTop += rect.top - offset;
    }, 250);
  });
});

// SYNC THá»¦ CÃ”NG - ghi Ä‘Ã¨ toÃ n bá»™
document.getElementById('btnSync').onclick = ()=>{
  const payload = allData, encoded = encodeURIComponent(JSON.stringify(payload));
  const cb = '__sync_cb_'+Date.now();
  window[cb] = function(res){ try{ if (res && res.success) setStatus('âœ… Äá»“ng bá»™ thÃ nh cÃ´ng'); else setStatus('âŒ Lá»—i Ä‘á»“ng bá»™', false); } finally { delete window[cb]; script.remove(); } };
  const script = document.createElement('script');
  script.src = GAS_URL + '?sheet=' + encodeURIComponent(SHEET_NAME) + '&save=1&data=' + encoded + '&callback=' + cb + '&_=' + Date.now();
  document.head.appendChild(script);
};
document.getElementById('btnRefresh').onclick = loadData;

// SCROLL & HIGHLIGHT FROM HASH (QR)
let hashScrollDone = false;
function highlightFromHash(retry = 40){
  const code = location.hash.slice(1);
  if (!code) return;
  const rows = document.querySelectorAll('#dataTable tbody tr');
  let found = false;
  rows.forEach(row=>{
    const cell = row.querySelector('.col-ma');
    if (!cell) return;
    if (cell.textContent.trim() === code){
      row.classList.add('highlight-row');
      if (!hashScrollDone){ row.scrollIntoView({behavior:'smooth', block:'center'}); hashScrollDone = true; }
      found = true;
    }
  });
  if (!found && retry > 0) setTimeout(()=> highlightFromHash(retry - 1), 150);
}
window.addEventListener('hashchange', ()=>{ hashScrollDone = false; setTimeout(()=> highlightFromHash(), 100); });

// PRINT QR (giá»‘ng trang mÃ¡y, dÃ¹ng mÃ£ cÃ´ng cá»¥)
document.getElementById('btnPrint').onclick = ()=>{
  const printData = allData.filter(r => r.chonIn);
  if (printData.length === 0){ alert('Chá»n Ã­t nháº¥t 1 dÃ²ng Ä‘á»ƒ in'); return; }

  const w = window.open('', '_blank');
  w.document.write('<html><head><title>In Tem QR</title>');
  w.document.write('<style>');
  w.document.write(`@page{size:A4 portrait;margin:4mm;}body{font-family:Arial;margin:0;padding:0;display:grid;grid-template-columns:repeat(5,1fr);grid-auto-rows:auto;gap:2mm;justify-items:center;align-items:center}.tem{width:34mm;height:40mm;border:1px solid #000;border-radius:2px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:1mm;box-sizing:border-box;text-align:center;page-break-inside:avoid}.tem .top{font-weight:bold;font-size:13px;margin:0.2mm 0}.tem .qr{margin:0;padding:0;line-height:0}.tem .bottom{font-weight:bold;font-size:12px;margin:1mm 0 0.2mm 0}canvas{display:block;margin:0;width:82px!important;height:75px!important}`);
  w.document.write('</style></head><body>');
  printData.forEach(r=>{
    const code = encodeURIComponent(r.ma || '');
    const ma = r.ma || '';
    const label = r.chungLoai || '';
    w.document.write(`<div class="tem"><div class="top">CC-${ma}</div><div class="qr" id="qr_${code}"></div><div class="bottom">${label}</div></div>`);
  });
  w.document.write('</body></html>');
  w.document.close();
  w.onload = ()=>{
    printData.forEach(r=>{
      const code = encodeURIComponent(r.ma || '');
      const qrDiv = w.document.getElementById('qr_' + code);
      if (qrDiv){
        new QRCode(qrDiv, { text: location.href.split('#')[0] + '#' + code, width: 90, height: 90 });
      }
    });
    setTimeout(()=> { w.focus(); w.print(); }, 500);
  };
};

// check all
document.getElementById('checkAllKK').addEventListener('change', function(){
  const items = document.querySelectorAll('.daKiemKe');
  items.forEach(cb => { cb.checked = this.checked; const idx = Number(cb.closest('tr').dataset.index); allData[idx].daKiemKe = this.checked; autoSyncRow(idx); });
  renderTable(); highlightFromHash();
});
document.getElementById('checkAllQR').addEventListener('change', function(){
  const items = document.querySelectorAll('.chonIn');
  items.forEach(cb => { cb.checked = this.checked; const idx = Number(cb.closest('tr').dataset.index); allData[idx].chonIn = this.checked; autoSyncRow(idx); });
  renderTable();
});

// add new
document.getElementById('btnAdd').onclick = ()=> openEditModal(null);

loadData();
</script>
</body>
</html>
