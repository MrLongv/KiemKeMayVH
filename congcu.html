<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üì¶ Ki·ªÉm k√™ C√¥ng C·ª•</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{font-family:Arial;margin:0;background:#f5f5f5}
header{background:#2b7cff;color:#fff;padding:15px;font-size:20px;text-align:center}
.container{padding:15px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;font-size:14px}
th{background:#e8f0ff}
tr.highlight{background:#fff3bf!important}
input[type="text"],select{width:100%;padding:6px}
.btn{background:#2b7cff;color:#fff;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;margin:5px 0}
.btn:active{opacity:0.7}
.topbar{display:flex;gap:10px;margin-bottom:10px}
</style>
</head>
<body>
<header>üì¶ Ki·ªÉm k√™ C√¥ng C·ª•</header>
<div class="container">
<div class="topbar">
<input id="searchBox" placeholder="T√¨m ki·∫øm..." />
<button class="btn" id="btnSave">üíæ L∆∞u to√†n b·ªô</button>
</div>
<table id="tbl">
<thead>
<tr>
<th>STT</th>
<th>Ch·ªßng lo·∫°i</th>
<th>V·ªã tr√≠</th>
<th>S·ªë ti·ªÅn</th>
<th>Ng√†y mua</th>
<th>T√¨nh tr·∫°ng</th>
<th>Ghi ch√∫</th>
<th>ƒê√£ KK</th>
<th>In</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbzA9aBINlKCZRGFnNWK3echEmEKG96AUpG_SWysHjnhlNEoGXh3JGvPUjpEoEEOeyyz/exec";
let allData = [];

function loadData(){
  const url = `${webAppUrl}?mode=congcu&callback=callback`;
  let s = document.createElement("script");
  s.src = url;
  document.body.appendChild(s);
}

function callback(res){
  if(!res.success){alert("L·ªói t·∫£i d·ªØ li·ªáu: "+res.message);return;}
  allData = res.data;
  renderTable();
}

function renderTable(){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML="";
  const keyword = document.getElementById("searchBox").value.toLowerCase();
  allData.forEach((r,i)=>{
    let rowText = JSON.stringify(r).toLowerCase();
    if(!rowText.includes(keyword)) return;

    let tr=document.createElement("tr");
    tr.dataset.index=i;
    tr.innerHTML = `
      <td><input value="${r.stt||""}" class="stt" /></td>
      <td><input value="${r.chungLoai||""}" class="chungLoai" /></td>
      <td><input value="${r.viTri||""}" class="viTri" /></td>
      <td><input value="${r.soTien||""}" class="soTien" /></td>
      <td><input value="${r.ngayMua||""}" class="ngayMua" /></td>
      <td><input value="${r.tinhTrang||""}" class="tinhTrang" /></td>
      <td><input value="${r.ghiChu||""}" class="ghiChu" /></td>
      <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?"checked":""}></td>
      <td><input type="checkbox" class="chonIn" ${r.chonIn?"checked":""}></td>
    `;
    tb.appendChild(tr);

    tr.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("change",()=>{
        updateRow(i,tr);
      });
    });
  });
}

function updateRow(i,tr){
  allData[i] = {
    stt: tr.querySelector(".stt").value,
    chungLoai: tr.querySelector(".chungLoai").value,
    viTri: tr.querySelector(".viTri").value,
    soTien: tr.querySelector(".soTien").value,
    ngayMua: tr.querySelector(".ngayMua").value,
    tinhTrang: tr.querySelector(".tinhTrang").value,
    ghiChu: tr.querySelector(".ghiChu").value,
    daKiemKe: tr.querySelector(".daKiemKe").checked,
    chonIn: tr.querySelector(".chonIn").checked
  };
  autoSyncRow(i);
}

function autoSyncRow(i){
  const url = `${webAppUrl}?mode=congcu&update=1&row=${i}&callback=callback2&data=`+encodeURIComponent(JSON.stringify(allData[i]));
  let s=document.createElement("script");
  s.src=url;
  document.body.appendChild(s);
}
function callback2(){ /* kh√¥ng c·∫ßn x·ª≠ l√Ω */ }

// L∆∞u to√†n b·ªô
btnSave.addEventListener("click",()=>{
  if(!confirm("Ghi ƒë√® to√†n b·ªô danh s√°ch?")) return;
  const url = `${webAppUrl}?mode=congcu&save=1&callback=callback3&data=` + encodeURIComponent(JSON.stringify(allData));
  let s=document.createElement("script");
  s.src=url;
  document.body.appendChild(s);
});
function callback3(res){
  alert("ƒê√£ l∆∞u: " + res.written + " d√≤ng");
}

searchBox.addEventListener("input",renderTable);
loadData();
</script>
</body>
</html>
