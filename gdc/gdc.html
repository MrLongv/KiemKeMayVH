<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GDC ‚Äì B√°o c√°o nƒÉng su·∫•t (T·∫•t c·∫£ x∆∞·ªüng)</title>
<style>
  :root{
    --bg:#f3f4f6;--card:#fff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
    --head:#eef2f7;--primary:#2563eb;
    --good:#16a34a;--warn:#f59e0b;--bad:#dc2626;--shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .topbar{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,#0b1b3a,#0e2552);color:#fff;padding:12px 14px;box-shadow:0 10px 24px rgba(0,0,0,.18)}
  .topbar .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .brand b{display:block}
  .brand span{font-size:12px;opacity:.85}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .ctl{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);padding:6px 8px;border-radius:12px}
  .ctl label{font-size:12px;opacity:.9}
  .ctl input,.ctl select{
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.18);
    color:#fff;padding:6px 8px;border-radius:10px;outline:none;font-size:12px
  }
  .ctl select option{color:#111}
  .btn{border:none;background:var(--primary);color:#fff;padding:8px 10px;border-radius:12px;font-weight:900;cursor:pointer;font-size:12px}
  .btn.ghost{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.20)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.warn{background:#f59e0b}
  .btn.danger{background:#dc2626}
  .status{font-size:12px;opacity:.95;padding:6px 10px;background:rgba(255,255,255,.10);border:1px dashed rgba(255,255,255,.25);border-radius:12px;max-width:520px}

  .wrap{padding:14px}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:10px;margin-bottom:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .card .label{font-size:12px;color:var(--muted)}
  .card .value{font-size:20px;font-weight:900;margin-top:4px}
  .card .sub{font-size:12px;color:var(--muted);margin-top:2px}

  .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
  @media(max-width:1000px){ .kpi{grid-template-columns:1fr 1fr} .grid2{grid-template-columns:1fr} }

  .tableWrap{background:#fff;border:1px solid var(--line);border-radius:16px;overflow:auto;box-shadow:var(--shadow)}
  table{width:max(1200px,100%);border-collapse:collapse;font-size:12.5px}
  th,td{border:1px solid var(--line);padding:6px;text-align:center;white-space:nowrap}
  thead th{background:var(--head);font-weight:900}
  tbody tr:nth-child(even) td{background:#fafafa}
  .left{text-align:left}
  .right{text-align:right}
  .pct{font-weight:900}
  .pct.good{color:var(--good)} .pct.warn{color:var(--warn)} .pct.bad{color:var(--bad)}
  .small{font-size:12px;color:var(--muted);line-height:1.45}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{
    padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;
    font-weight:800;font-size:12px
  }
  .tab.active{background:#0e2552;color:#fff;border-color:#0e2552}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#fff}
  .bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden;border:1px solid #e5e7eb}
  .bar > i{display:block;height:100%;background:#2563eb;width:0%}

  .reasonGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:980px){ .reasonGrid{grid-template-columns:1fr} }
  .input2{padding:8px 10px;border:1px solid var(--line);border-radius:12px;outline:none;width:240px;background:#fff}
  .select2{padding:8px 10px;border:1px solid var(--line);border-radius:12px;outline:none;background:#fff}

  /* ====== TICKER ====== */
  .tickerWrap{
    margin-top:10px;background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.18);border-radius:14px;
    overflow:hidden;height:34px;display:flex;align-items:center;
  }
  .tickerLabel{
    flex:0 0 auto;padding:0 10px;font-weight:900;font-size:12px;
    background:rgba(245,158,11,.22);border-right:1px solid rgba(255,255,255,.18);
    height:34px;display:flex;align-items:center;
  }
  .tickerTrack{position:relative;flex:1;overflow:hidden;height:34px}
  .tickerRun{
    position:absolute;white-space:nowrap;will-change:transform;
    animation: marquee 18s linear infinite;
    padding-left:100%;
    font-size:12.5px;font-weight:800;opacity:.95;
  }
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  /* ====== CH·ªà ƒê·∫†O ====== */
  .msgGrid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px;margin-bottom:12px}
  @media(max-width:1000px){ .msgGrid{grid-template-columns:1fr} }
  .msgBox{
    width:100%;min-height:120px;resize:vertical;
    border:1px solid var(--line);border-radius:14px;padding:10px;
    font:inherit;font-size:13px;outline:none;background:#fff;
  }
  .msgBox:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15);border-color:#93c5fd}
  .msgRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .badgeScope{
    display:inline-flex;align-items:center;justify-content:center;
    padding:2px 8px;border-radius:999px;font-weight:900;font-size:12px;
    border:1px solid var(--line);background:#fff;
  }
  .miniTableWrap{overflow:auto;max-height:360px;border:1px solid var(--line);border-radius:14px}
  .btnMini{padding:6px 8px;border-radius:10px;font-size:12px;font-weight:900;border:none;cursor:pointer;background:#111827;color:#fff}
  .btnMini.danger{background:#dc2626}
  .btnMini.gray{background:#6b7280}
  .dangerBox{
    border:1px solid rgba(220,38,38,.25);background:rgba(220,38,38,.06);
    border-radius:14px;padding:10px;color:#7f1d1d;font-size:13px
  }
</style>
</head>

<body>
<div class="topbar">
  <div class="row">
    <div class="brand">
      <b>üè¢ GDC ‚Äì B√ÅO C√ÅO NƒÇNG SU·∫§T (T·∫§T C·∫¢ X∆Ø·ªûNG)</b>
      <span id="roleHint">‚Äî</span>

      <div class="tickerWrap" title="Ch·ªâ ƒë·∫°o hi·ªÉn th·ªã cho TK/T·ªï tr∆∞·ªüng theo t·ª´ng x∆∞·ªüng">
        <div class="tickerLabel">üì¢ CH·ªà ƒê·∫†O</div>
        <div class="tickerTrack">
          <div class="tickerRun" id="tickerText">ƒêang t·∫£i ch·ªâ ƒë·∫°o...</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="ctl">
        <label>Ch·∫ø ƒë·ªô</label>
        <select id="mode">
          <option value="day">Ng√†y</option>
          <option value="week">Tu·∫ßn</option>
          <option value="month">Th√°ng</option>
          <option value="quarter">Qu√Ω</option>
          <option value="year">NƒÉm</option>
        </select>
      </div>
      <div class="ctl">
        <label>Ng√†y</label>
        <input type="date" id="date" />
      </div>

      <button class="btn" onclick="reload()">T·∫£i d·ªØ li·ªáu</button>
      <button class="btn ghost" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      <div class="status" id="status">Ch∆∞a t·∫£i d·ªØ li·ªáu</div>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- KPI t·ªïng -->
  <div class="kpi">
    <div class="card">
      <div class="label">T·ªïng USD (∆∞·ªõc t√≠nh)</div>
      <div class="value" id="kpiUsd">0.00</div>
      <div class="sub">USD/TH = T·ªïng SP * ƒê∆°n gi√°</div>
    </div>
    <div class="card">
      <div class="label">T·ªïng SP</div>
      <div class="value" id="kpiSp">0</div>
      <div class="sub">T·∫•t c·∫£ x∆∞·ªüng</div>
    </div>
    <div class="card">
      <div class="label">Hi·ªáu su·∫•t TB</div>
      <div class="value" id="kpiHs">0%</div>
      <div class="sub">T·ªïng TH / T·ªïng ƒêM</div>
    </div>
    <div class="card">
      <div class="label">So s√°nh nhanh</div>
      <div class="value" id="kpiBest">‚Äî</div>
      <div class="sub">X∆∞·ªüng HS cao nh·∫•t</div>
    </div>
  </div>

  <!-- ‚úÖ CH·ªà ƒê·∫†O -->
  <div class="msgGrid">
    <!-- LEFT -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <b>üß≠ CH·ªà ƒê·∫†O GƒêC</b>
        <span class="pill">√Åp d·ª•ng: <b id="scopeShow">ALL</b> ‚Ä¢ <b id="msgDayShow">‚Äî</b></span>
      </div>

      <div class="small" style="margin-top:6px">
        ‚Ä¢ L∆∞u <b>ALL</b> s·∫Ω t·ª± ‚Äúph√°t xu·ªëng‚Äù c·∫£ XN1‚ÄìXN3 ƒë·ªÉ TK/T·ªï tr∆∞·ªüng lu√¥n nh√¨n th·∫•y.<br/>
        ‚Ä¢ Khung ph·∫£i s·∫Ω hi·ªÉn th·ªã <b>t·∫•t c·∫£</b> ch·ªâ ƒë·∫°o h√¥m nay (ALL + XN1 + XN2 + XN3).
      </div>

      <div class="msgRow" style="margin-top:10px">
        <span class="badgeScope">Scope</span>
        <select id="msgScope" class="select2" style="width:220px" onchange="onScopeChange()">
          <option value="ALL">ALL (c·∫£ 3 x∆∞·ªüng)</option>
          <option value="XN1">XN1</option>
          <option value="XN2">XN2</option>
          <option value="XN3">XN3</option>
        </select>

        <button class="btn warn" onclick="saveDirectorMessage()">L∆∞u</button>
        <button class="btn ghost" onclick="clearDirectorBox()">X√≥a √¥ nh·∫≠p</button>
      </div>

      <textarea id="msgBox" class="msgBox" placeholder="Nh·∫≠p ch·ªâ ƒë·∫°o... (ng·∫Øn g·ªçn, r√µ vi·ªác, c√≥ deadline)"></textarea>

      <div id="msgMeta" class="small">‚Äî</div>
      <div id="msgApiHint" class="small" style="margin-top:8px;display:none"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <b>üìã T·∫§T C·∫¢ CH·ªà ƒê·∫†O H√îM NAY</b>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn ghost" onclick="loadMessageHistoryAll()">T·∫£i l·∫°i</button>
        </div>
      </div>
      <div class="small" style="margin-top:6px">
        Danh s√°ch g·ªôp: <b>ALL</b> + <b>XN1</b> + <b>XN2</b> + <b>XN3</b>. (B·∫•m <b>X√≥a</b> n·∫øu Worker h·ªó tr·ª£)
      </div>

      <div class="miniTableWrap" style="margin-top:10px">
        <table style="width:100%">
          <thead>
            <tr>
              <th style="min-width:80px">Scope</th>
              <th class="left" style="min-width:420px;text-align:left;padding-left:10px">N·ªôi dung</th>
              <th style="min-width:140px">C·∫≠p nh·∫≠t</th>
              <th style="min-width:120px">Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="msgHistoryTbody">
            <tr><td colspan="4" class="left" style="text-align:left;padding-left:10px;color:var(--muted)">Ch∆∞a t·∫£i.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="small" style="margin-top:8px">
        * N·∫øu Worker ch∆∞a c√≥ <code>listDirectorMessages</code>/<code>deleteDirectorMessage</code> th√¨ b·∫£ng s·∫Ω fallback l·∫•y ‚Äú1 d√≤ng m·ªõi nh·∫•t‚Äù cho t·ª´ng scope.
      </div>
    </div>
  </div>

  <!-- So s√°nh 3 x∆∞·ªüng -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <b>üìå T·ªïng h·ª£p & so s√°nh 3 x∆∞·ªüng</b>
      <span class="pill" id="rangeInfo">‚Äî</span>
    </div>
    <div class="small" style="margin-top:6px" id="compareHint">‚Äî</div>

    <div style="margin-top:10px;overflow:auto">
      <table style="width:max(860px,100%)">
        <thead>
          <tr>
            <th>X∆∞·ªüng</th>
            <th>T·ªïng SP</th>
            <th>T·ªïng ƒêM</th>
            <th>HS</th>
            <th style="min-width:220px">Thanh so s√°nh HS</th>
            <th>USD ∆∞·ªõc t√≠nh</th>
          </tr>
        </thead>
        <tbody id="cmpTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Tabs: chi ti·∫øt theo x∆∞·ªüng (ch·ªâ hi·ªÉn th·ªã khi mode=day) -->
  <div id="dayDetailBlock" style="display:none">
    <div class="tabs">
      <button class="tab active" id="tab1" onclick="setTab(1)">Chi ti·∫øt XN1</button>
      <button class="tab" id="tab2" onclick="setTab(2)">Chi ti·∫øt XN2</button>
      <button class="tab" id="tab3" onclick="setTab(3)">Chi ti·∫øt XN3</button>
    </div>

    <div class="grid2">
      <!-- b·∫£ng chi ti·∫øt -->
      <div class="card">
        <b id="detailTitle">üìÑ B√°o c√°o cu·ªëi ng√†y ‚Äì XN1</b>
        <div class="small" id="detailMeta" style="margin-top:6px">‚Äî</div>

        <div class="tableWrap" style="margin-top:10px">
          <table id="detailTbl" style="width:max(1180px,100%)">
            <thead>
              <tr>
                <th>T·ªî</th>
                <th>LINE</th>
                <th class="left" style="min-width:180px;text-align:left;padding-left:10px">M√É H√ÄNG</th>
                <th>LƒêTT</th>
                <th>ƒêM/NG√ÄY</th>
                <th>TH·ª∞C HI·ªÜN</th>
                <th>ƒê∆†N GI√Å</th>
                <th>USD ƒê·∫†T/NG√ÄY</th>
                <th>% ƒê·∫†T NS</th>
                <th>USD/NG∆Ø·ªúI</th>
                <th>CHUY·ªÇN ƒê·ªîI/NG√ÄY</th>
                <th class="left" style="min-width:260px;text-align:left;padding-left:10px">GHI CH√ö</th>
              </tr>
            </thead>
            <tbody id="detailTbody"></tbody>
            <tfoot>
              <tr>
                <td colspan="7" class="right" style="padding-right:10px;font-weight:900">T·ªîNG</td>
                <td id="detailUsd" style="font-weight:900">0.00</td>
                <td id="detailHs" style="font-weight:900">0%</td>
                <td id="detailUsdPer" style="font-weight:900">0.00</td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="small" style="margin-top:8px">
          * USD = TH * ƒê∆°n gi√° ‚Ä¢ %NS = TH/ƒêM ‚Ä¢ USD/ng∆∞·ªùi = USD/LƒêTT.
        </div>
      </div>

      <!-- nguy√™n nh√¢n gi·∫£m NS -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <b>üßæ Nguy√™n nh√¢n gi·∫£m nƒÉng su·∫•t (XN ƒëang ch·ªçn)</b>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="reasonSearch" class="input2" placeholder="T√¨m nguy√™n nh√¢n..." />
            <select id="reasonFilter" class="select2">
              <option value="all">T·∫•t c·∫£ gi·ªù</option>
              <option value="bad">Ch·ªâ gi·ªù ƒë·ªè (HS&lt;80%)</option>
            </select>
            <button class="btn" onclick="renderReasons()">L·ªçc</button>
          </div>
        </div>
        <div class="small" id="reasonMeta" style="margin-top:6px">‚Äî</div>

        <div class="reasonGrid" style="margin-top:10px">
          <div class="card" style="box-shadow:none">
            <b>Top nguy√™n nh√¢n</b>
            <div style="margin-top:8px;overflow:auto;max-height:320px">
              <table style="width:100%">
                <thead>
                  <tr>
                    <th class="left" style="text-align:left;padding-left:10px">Nguy√™n nh√¢n</th>
                    <th>S·ªë l·∫ßn</th>
                  </tr>
                </thead>
                <tbody id="reasonTopTbody"></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <b>Gi·ªù ƒë·ªè (HS&lt;80%)</b>
            <div class="small">Click ƒë·ªÉ xem full nguy√™n nh√¢n</div>
            <div style="margin-top:8px;overflow:auto;max-height:320px">
              <table style="width:100%">
                <thead>
                  <tr>
                    <th>T·ªï</th>
                    <th>Khung</th>
                    <th>KH</th>
                    <th>TT</th>
                    <th>HS</th>
                    <th class="left" style="text-align:left;padding-left:10px">Nguy√™n nh√¢n</th>
                  </tr>
                </thead>
                <tbody id="reasonBadTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="small" style="margin-top:10px">
          G·ª£i √Ω: sau n√†y c√≥ th·ªÉ th√™m ‚ÄúTop t·ªï gi·∫£m NS‚Äù, ‚ÄúTop gi·ªù gi·∫£m NS‚Äù, ‚Äúc·∫£nh b√°o realtime‚Äù.
        </div>
      </div>
    </div>
  </div>

  <div class="small" style="margin-top:10px">
    <b>Ghi ch√∫ k·ªπ thu·∫≠t:</b> Mode Tu·∫ßn/Th√°ng/Qu√Ω/NƒÉm d√πng `summary_xuong_day`. Mode Ng√†y d√πng `getTkXuongDay` + `getHourRange`.
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const KEY="NS_SESSION";
const XUONGS = [1,2,3];
const TO_BY_XUONG = { 1:[1,3,5,7,9], 2:[11,13,15,17], 3:[19,21,23,25,27] };

/* ================== SESSION ================== */
function sess(){ try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null} }
function mustLogin(){ const s=sess(); if(!s||!s.token){ location.href="../login.html"; return null;} return s; }
function logout(){ localStorage.removeItem(KEY); location.href="../login.html"; }
function roleOf(s){ return String(s?.role||"").toLowerCase().trim(); }

/* ================== UTIL ================== */
async function apiPost(payload){
  const r = await fetch(API_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload) });
  const text = await r.text();
  try{ return JSON.parse(text); }
  catch{ return { success:false, msg:`API kh√¥ng tr·∫£ JSON (HTTP ${r.status})`, raw:text.slice(0,240) }; }
}
function setStatus(t){ document.getElementById("status").innerText=t; }
function todayISO(){
  const d = new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function toNum(v){ const n=Number(String(v??"").replaceAll(",","").trim()); return Number.isFinite(n)?n:0; }
function fmt2(n){ return (Number(n)||0).toFixed(2); }
function fmt1(n){ return (Number(n)||0).toFixed(1); }
function fmt0(n){ return String(Math.round(Number(n)||0)); }
function escapeHtml(s){
  return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function pctClass(hs){
  hs = Number(hs)||0;
  if(hs>=95) return "good";
  if(hs>=80) return "warn";
  return "bad";
}
function normReason(s){
  s = String(s||"").trim();
  if(!s) return "";
  s = s.replace(/\s+/g," ").replace(/[.„ÄÇ]+$/,"");
  return s;
}
function getRange(mode, dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const yyyy = d.getFullYear();
  const mm = d.getMonth();
  const dd = d.getDate();
  const toISO = (x)=>{
    const m=String(x.getMonth()+1).padStart(2,"0");
    const da=String(x.getDate()).padStart(2,"0");
    return `${x.getFullYear()}-${m}-${da}`;
  };
  if(mode === "day") return { from: dateStr, to: dateStr, label:`Ng√†y ${dateStr}` };
  if(mode === "week"){
    const day = (d.getDay()+6)%7;
    const start = new Date(d); start.setDate(dd - day);
    const end = new Date(start); end.setDate(start.getDate()+6);
    return { from: toISO(start), to: toISO(end), label:`Tu·∫ßn ${toISO(start)} ‚Üí ${toISO(end)}` };
  }
  if(mode === "month"){
    const start = new Date(yyyy, mm, 1);
    const end = new Date(yyyy, mm+1, 0);
    return { from: toISO(start), to: toISO(end), label:`Th√°ng ${yyyy}-${String(mm+1).padStart(2,"0")}` };
  }
  if(mode === "quarter"){
    const q = Math.floor(mm/3);
    const start = new Date(yyyy, q*3, 1);
    const end = new Date(yyyy, q*3+3, 0);
    return { from: toISO(start), to: toISO(end), label:`Qu√Ω ${q+1}/${yyyy}` };
  }
  const start = new Date(yyyy, 0, 1);
  const end = new Date(yyyy, 12, 0);
  return { from: toISO(start), to: toISO(end), label:`NƒÉm ${yyyy}` };
}

/* ================== SCOPE ================== */
function normScope(v){
  v = String(v||"").trim();
  if(!v) return "ALL";
  const s = v.toUpperCase().replace(/\s+/g,"");
  if(s === "ALL" || s === "ALLXUONG" || s === "TATCA" || s === "T·∫§TCA") return "ALL";
  const m = s.match(/(\d+)/);
  if(m && m[1]){
    const n = Number(m[1]);
    if([1,2,3].includes(n)) return String(n);
  }
  if(["XN1","XUONG1"].includes(s)) return "1";
  if(["XN2","XUONG2"].includes(s)) return "2";
  if(["XN3","XUONG3"].includes(s)) return "3";
  return "ALL";
}
function scopeLabel(sc){
  sc = normScope(sc);
  return sc === "ALL" ? "ALL" : ("XN"+sc);
}
function uiScopeValue(){
  // select returns "ALL" or "XN1"...
  return normScope(document.getElementById("msgScope").value);
}

/* ================== STATE ================== */
let S = mustLogin();
let activeTab = 1;
let dayDetail = { 1:[], 2:[], 3:[] };
let dayHoursRaw = { 1:[], 2:[], 3:[] };

/* ================== INIT ================== */
document.getElementById("date").value = todayISO();
document.getElementById("msgDayShow").innerText = `H√¥m nay: ${todayISO()}`;

if(S){
  const ok = (roleOf(S)==="gdc");
  document.getElementById("roleHint").innerText = ok
    ? `‚úÖ GƒêC: ${S.username} ‚Ä¢ xem t·∫•t c·∫£ x∆∞·ªüng`
    : `‚õî Kh√¥ng ƒë√∫ng quy·ªÅn: role=${S.role} (c·∫ßn gdc)`;
  if(!ok){
    setStatus("Kh√¥ng ƒë√∫ng quy·ªÅn");
  }else{
    document.getElementById("msgScope").value = "ALL";
    onScopeChange();
    loadMessageHistoryAll();
    reload();
  }
}

/* ================== UI HELPERS ================== */
function clearDirectorBox(){ document.getElementById("msgBox").value = ""; }
function showApiHint(html){
  const el = document.getElementById("msgApiHint");
  el.style.display = "";
  el.innerHTML = html;
}
function hideApiHint(){
  const el = document.getElementById("msgApiHint");
  el.style.display = "none";
  el.innerHTML = "";
}

/* ================== DIRECTOR MSG API ================== */
async function apiGetMsg(scope, ngay){
  const sc = normScope(scope);
  let res = await apiPost({ action:"getDirectorMessage", token:S.token, scope: sc, ngay });
  if(res?.success) return res;
  res = await apiPost({ action:"getDirectorMessage", token:S.token, scope: sc });
  return res;
}

/* ===== SAVE: l∆∞u ALL -> ph√°t xu·ªëng ALL + 1 + 2 + 3 ===== */
async function setMsg(scope, ngay, message){
  // th·ª≠ worker m·ªõi
  let res = await apiPost({ action:"setDirectorMessage", token:S.token, scope, ngay, message });
  if(res?.success) return res;
  // fallback worker c≈©
  res = await apiPost({ action:"setDirectorMessage", token:S.token, scope, message });
  return res;
}

async function saveDirectorMessage(){
  S = mustLogin(); if(!S) return;
  if(roleOf(S)!=="gdc"){ setStatus("‚õî Ch·ªâ gdc ƒë∆∞·ª£c l∆∞u ch·ªâ ƒë·∫°o"); return; }

  const scope = uiScopeValue();          // "ALL" | "1" | "2" | "3"
  const ngay  = todayISO();
  const message = String(document.getElementById("msgBox").value||"").trim();
  if(!message){ setStatus("‚ö†Ô∏è Ch∆∞a nh·∫≠p n·ªôi dung ch·ªâ ƒë·∫°o"); return; }

  hideApiHint();
  setStatus(`ƒêang l∆∞u ch·ªâ ƒë·∫°o (${scopeLabel(scope)})...`);

  // FIX 1: n·∫øu ALL th√¨ l∆∞u xu·ªëng c·∫£ 4 scope ƒë·ªÉ TK/TO ch·∫Øc ch·∫Øn th·∫•y
  const scopesToWrite = (scope==="ALL") ? ["ALL","1","2","3"] : [scope];

  let okAny = false;
  const errors = [];

  for(const sc of scopesToWrite){
    const r = await setMsg(sc, ngay, message);
    if(r?.success){ okAny = true; }
    else errors.push(`(${scopeLabel(sc)}) ${r?.msg||"fail"}`);
  }

  if(!okAny){
    setStatus("L·ªói l∆∞u ch·ªâ ƒë·∫°o");
    showApiHint(`<div class="dangerBox">
      ‚ö†Ô∏è Kh√¥ng l∆∞u ƒë∆∞·ª£c. Chi ti·∫øt:<br/>
      ${escapeHtml(errors.join(" | ") || "unknown")}
    </div>`);
    return;
  }

  setStatus(scope==="ALL" ? "‚úÖ ƒê√£ l∆∞u (ALL + ph√°t xu·ªëng XN1‚ÄìXN3)" : "‚úÖ ƒê√£ l∆∞u ch·ªâ ƒë·∫°o");
  document.getElementById("msgMeta").innerText =
    scope==="ALL"
      ? `ƒê√£ l∆∞u ‚Ä¢ Scope: ALL + XN1‚ÄìXN3 ‚Ä¢ Ng√†y: ${ngay}`
      : `ƒê√£ l∆∞u ‚Ä¢ Scope: ${scopeLabel(scope)} ‚Ä¢ Ng√†y: ${ngay}`;

  clearDirectorBox();
  await loadMessageHistoryAll();
  await refreshTicker();
}

/* ================== LIST RIGHT: lu√¥n hi·ªán ALL + 1 + 2 + 3 ================== */
async function tryList(scope, ngay){
  // worker m·ªõi
  const res = await apiPost({ action:"listDirectorMessages", token:S.token, scope, ngay });
  if(res?.success && Array.isArray(res.items)) return res.items.map(it=>({
    id: it.id,
    scope: normScope(it.scope || scope),
    message: String(it.message||""),
    updated_at: it.updated_at || it.created_at || ""
  }));
  return null;
}

async function listNewestFallback(scope, ngay){
  const r = await apiGetMsg(scope, ngay);
  if(!r?.success) return [];
  const msg = String(r.message||"").trim();
  if(!msg) return [];
  return [{
    id: null,
    scope: normScope(scope),
    message: msg,
    updated_at: r.updated_at || ""
  }];
}

function rowKey(it){
  // ch·ªëng tr√πng khi ALL ƒë∆∞·ª£c ph√°t xu·ªëng 1/2/3
  const t = String(it.updated_at||"").slice(0,16);
  return `${it.scope}||${it.message.trim()}||${t}`;
}

async function loadMessageHistoryAll(){
  S = mustLogin(); if(!S) return;
  if(roleOf(S)!=="gdc") return;

  const ngay  = todayISO();
  const tb = document.getElementById("msgHistoryTbody");
  tb.innerHTML = `<tr><td colspan="4" class="left" style="text-align:left;padding-left:10px;color:var(--muted)">ƒêang t·∫£i...</td></tr>`;
  hideApiHint();

  const scopes = ["ALL","1","2","3"];

  // 1) th·ª≠ list (worker m·ªõi)
  let allItems = [];
  let hasList = false;

  for(const sc of scopes){
    const items = await tryList(sc, ngay);
    if(items){
      hasList = true;
      allItems = allItems.concat(items);
    }
  }

  // 2) fallback worker c≈©: get newest cho t·ª´ng scope
  if(!hasList){
    for(const sc of scopes){
      const items = await listNewestFallback(sc, ngay);
      allItems = allItems.concat(items);
    }
    showApiHint(`<div class="dangerBox">
      ‚ö†Ô∏è Worker ƒëang ki·ªÉu c≈© (kh√¥ng c√≥ list/delete). B·∫£ng n√†y ƒëang hi·ªÉn th·ªã ‚Äúm·ªõi nh·∫•t‚Äù c·ªßa t·ª´ng scope.<br/>
      Mu·ªën c√≥ l·ªãch s·ª≠ + x√≥a: c·∫ßn th√™m <code>listDirectorMessages</code> v√† <code>deleteDirectorMessage</code>.
    </div>`);
  }

  // g·ªôp + b·ªè tr√πng
  const uniq = new Map();
  for(const it of allItems){
    if(!it.message || !it.message.trim()) continue;
    const k = rowKey(it);
    if(!uniq.has(k)) uniq.set(k, it);
  }

  const items = [...uniq.values()]
    .sort((a,b)=>{
      // ∆∞u ti√™n ALL tr∆∞·ªõc, r·ªìi XN1,2,3; sau ƒë√≥ th·ªùi gian desc
      const ord = (s)=> s==="ALL"?0:Number(s);
      const ao = ord(a.scope), bo = ord(b.scope);
      if(ao!==bo) return ao-bo;
      return String(b.updated_at||"").localeCompare(String(a.updated_at||""));
    });

  if(!items.length){
    tb.innerHTML = `<tr><td colspan="4" class="left" style="text-align:left;padding-left:10px;color:var(--muted)">H√¥m nay ch∆∞a c√≥ ch·ªâ ƒë·∫°o.</td></tr>`;
    return;
  }

  tb.innerHTML = items.map(it=>{
    const sc = normScope(it.scope);
    const t = it.updated_at ? String(it.updated_at).replace("T"," ").slice(0,16) : "‚Äî";
    const canDelete = !!it.id; // ch·ªâ x√≥a ƒë∆∞·ª£c khi worker list tr·∫£ id
    return `
      <tr>
        <td><b>${escapeHtml(scopeLabel(sc))}</b></td>
        <td class="left" style="text-align:left;padding-left:10px;white-space:normal">${escapeHtml(it.message)}</td>
        <td>${escapeHtml(t)}</td>
        <td>
          ${
            canDelete
              ? `<button class="btnMini danger" onclick="deleteHistoryItem('${escapeHtml(sc)}','${escapeHtml(it.id)}')">X√≥a</button>`
              : `<span class="pill">‚Äî</span>`
          }
        </td>
      </tr>
    `;
  }).join("");
}

async function deleteHistoryItem(scope, id){
  S = mustLogin(); if(!S) return;
  if(roleOf(S)!=="gdc") return;

  if(!id){ alert("Worker hi·ªán t·∫°i kh√¥ng h·ªó tr·ª£ x√≥a (thi·∫øu id)."); return; }

  const ngay = todayISO();
  const sc = normScope(scope);

  if(!confirm(`X√≥a th√¥ng b√°o c·ªßa ${scopeLabel(sc)}?`)) return;

  const res = await apiPost({ action:"deleteDirectorMessage", token:S.token, scope: sc, ngay, id });
  if(!res?.success){
    setStatus("‚õî X√≥a th·∫•t b·∫°i: " + (res.msg||""));
    showApiHint(`<div class="dangerBox">
      ‚ö†Ô∏è Worker ch∆∞a h·ªó tr·ª£ <code>deleteDirectorMessage</code> ho·∫∑c ƒëang l·ªói.<br/>
      Chi ti·∫øt: ${escapeHtml(res.msg||"")}
    </div>`);
    return;
  }

  setStatus("‚úÖ ƒê√£ x√≥a th√¥ng b√°o");
  await loadMessageHistoryAll();
  await refreshTicker();
}

/* ================== TICKER: lu√¥n (ALL) + (XN tab) ================== */
async function refreshTicker(){
  const s = sess();
  if(!s?.token) return;
  S = s;

  const mode = document.getElementById("mode").value;
  const scopeX = (mode==="day") ? String(activeTab) : null;
  const ngay = todayISO();

  const all = await apiGetMsg("ALL", ngay);
  const allMsg = (all?.success ? String(all.message||"") : "").trim();

  let xMsg = "";
  if(scopeX){
    const sc = await apiGetMsg(scopeX, ngay);
    xMsg = (sc?.success ? String(sc.message||"") : "").trim();
  }

  const parts = [];
  if(allMsg) parts.push(`(ALL) ${allMsg}`);
  if(scopeX && xMsg) parts.push(`(XN${scopeX}) ${xMsg}`);

  const text = parts.length ? parts.join("  ‚Ä¢  ") : "Ch∆∞a c√≥ ch·ªâ ƒë·∫°o h√¥m nay";
  const el = document.getElementById("tickerText");
  el.innerHTML = escapeHtml(text);

  el.style.animation = "none";
  void el.offsetHeight;
  el.style.animation = "";
}

/* ================== UI change ================== */
function onScopeChange(){
  const v = uiScopeValue();
  document.getElementById("scopeShow").innerText = scopeLabel(v);
  // khung ph·∫£i b√¢y gi·ªù lu√¥n all scopes, n√™n scopeShow2 ch·ªâ ƒë·ªÉ tham kh·∫£o
  document.getElementById("scopeShow2").innerText = "ALL + XN1‚ÄìXN3";
  refreshTicker();
}

/* ================== TABS ================== */
function setTab(x){
  activeTab = Number(x)||1;
  document.getElementById("tab1").classList.toggle("active", activeTab===1);
  document.getElementById("tab2").classList.toggle("active", activeTab===2);
  document.getElementById("tab3").classList.toggle("active", activeTab===3);

  const date = document.getElementById("date").value;
  renderDayDetailForXuong(activeTab, date);
  renderReasons();
  refreshTicker();
}

/* ================== MAIN LOAD ================== */
async function reload(){
  S = mustLogin(); if(!S) return;
  if(roleOf(S)!=="gdc"){ setStatus("‚õî Ch·ªâ gdc ƒë∆∞·ª£c xem trang n√†y"); return; }

  const mode = document.getElementById("mode").value;
  const date = document.getElementById("date").value;
  const range = getRange(mode, date);

  document.getElementById("rangeInfo").innerText = range.label;
  setStatus("ƒêang t·∫£i d·ªØ li·ªáu...");

  if(mode === "day"){
    document.getElementById("dayDetailBlock").style.display = "";
    await loadDayAllXuong(date);
    setTab(activeTab);
    document.getElementById("compareHint").innerText = "Mode Ng√†y: so s√°nh d·ª±a tr√™n d·ªØ li·ªáu th·ª±c t·∫ø trong ng√†y (t√≠nh qua t·∫•t c·∫£ line_no).";
  }else{
    document.getElementById("dayDetailBlock").style.display = "none";
    await loadRangeAll(range.from, range.to);
    document.getElementById("compareHint").innerText = "Mode Tu·∫ßn/Th√°ng/Qu√Ω/NƒÉm: so s√°nh d·ª±a tr√™n summary_xuong_day (nhanh).";
  }

  setStatus(`‚úÖ ƒê√£ t·∫£i ‚Ä¢ ${range.label}`);
  await loadMessageHistoryAll();
  refreshTicker();
}

/* ================== LOAD: RANGE (all xuong) ================== */
async function loadRangeAll(from, to){
  const res = await apiPost({ action:"getDayRangeAll", token:S.token, from, to });
  if(!res.success){
    setStatus("L·ªói t·∫£i range: " + (res.msg||""));
    renderCompare({1:{sp:0,dm:0,usd:0,hs:0},2:{sp:0,dm:0,usd:0,hs:0},3:{sp:0,dm:0,usd:0,hs:0}});
    setKpi(0,0,0,"‚Äî");
    return;
  }

  const agg = {1:{sp:0,dm:0,usd:0},2:{sp:0,dm:0,usd:0},3:{sp:0,dm:0,usd:0}};
  for(const r of (res.data||[])){
    const x = Number(r.xuong);
    if(!agg[x]) continue;
    agg[x].sp += toNum(r.tong_sp);
    agg[x].dm += toNum(r.tong_ke_hoach);
  }
  for(const x of XUONGS){
    agg[x].hs = agg[x].dm>0 ? (agg[x].sp/agg[x].dm*100) : 0;
  }

  renderCompare(agg);

  const spAll = XUONGS.reduce((s,x)=>s+agg[x].sp,0);
  const dmAll = XUONGS.reduce((s,x)=>s+agg[x].dm,0);
  const hsAll = dmAll>0 ? (spAll/dmAll*100) : 0;
  const best = bestXuongLabel(agg);
  setKpi(0, spAll, hsAll, best);
}

/* ================== LOAD: DAY (all xuong) ================== */
async function loadDayAllXuong(ngay){
  for(const x of XUONGS){
    const res = await apiPost({ action:"getTkXuongDay", token:S.token, ngay, xuong:x });
    const rows = res.success ? (res.rows||[]) : [];

    const allowTos = new Set((TO_BY_XUONG[x]||[]).map(Number));
    let filtered = rows.filter(r => allowTos.has(Number(r.to_nhom)));

    const existingTo = new Set(filtered.map(r=>Number(r.to_nhom)));
    for(const to of allowTos){
      if(!existingTo.has(to)){
        filtered.push({ to_nhom: to, line_no: 1, ma_hang:"", dinh_muc_ngay:0, don_gia:0, lao_dong_thuc_te:0, chuyen_doi_ngay:0, ghi_chu:"", hours: [] });
      }
    }

    filtered.sort((a,b)=> Number(a.to_nhom)-Number(b.to_nhom) || Number(a.line_no||1)-Number(b.line_no||1));
    dayDetail[x] = filtered;
  }

  for(const x of XUONGS){
    const hr = await apiPost({ action:"getHourRange", token:S.token, xuong:x, from:ngay, to:ngay });
    dayHoursRaw[x] = hr.success ? (hr.data||[]) : [];
  }

  const agg = {};
  for(const x of XUONGS){
    const rows = dayDetail[x] || [];
    let sp=0, dm=0, usd=0;
    for(const r of rows){
      const hours = Array.isArray(r.hours) ? r.hours : [];
      const tongSP = hours.reduce((a,b)=>a+toNum(b),0);
      sp += tongSP;
      dm += toNum(r.dinh_muc_ngay);
      usd += tongSP * toNum(r.don_gia);
    }
    const hs = dm>0 ? (sp/dm*100) : 0;
    agg[x] = { sp, dm, usd, hs };
  }

  renderCompare(agg);

  const spAll = XUONGS.reduce((s,x)=>s+(agg[x]?.sp||0),0);
  const dmAll = XUONGS.reduce((s,x)=>s+(agg[x]?.dm||0),0);
  const usdAll = XUONGS.reduce((s,x)=>s+(agg[x]?.usd||0),0);
  const hsAll = dmAll>0 ? (spAll/dmAll*100) : 0;
  const best = bestXuongLabel(agg);

  setKpi(usdAll, spAll, hsAll, best);
}

/* ================== RENDER: COMPARE TABLE ================== */
function renderCompare(agg){
  const tb = document.getElementById("cmpTbody");
  const hsMax = Math.max(...XUONGS.map(x=>Number(agg[x]?.hs||0)), 0) || 1;

  tb.innerHTML = XUONGS.map(x=>{
    const sp = agg[x]?.sp||0;
    const dm = agg[x]?.dm||0;
    const hs = agg[x]?.hs||0;
    const usd = agg[x]?.usd||0;
    const w = Math.max(0, Math.min(100, (hs/hsMax)*100));
    return `
      <tr>
        <td><b>XN${x}</b></td>
        <td>${fmt0(sp)}</td>
        <td>${fmt0(dm)}</td>
        <td class="pct ${pctClass(hs)}">${fmt1(hs)}%</td>
        <td><div class="bar"><i style="width:${w.toFixed(1)}%"></i></div></td>
        <td>${fmt2(usd)}</td>
      </tr>
    `;
  }).join("");
}
function bestXuongLabel(agg){
  let best = {x:null, hs:-1};
  for(const x of XUONGS){
    const hs = Number(agg[x]?.hs||0);
    if(hs > best.hs){ best = {x, hs}; }
  }
  return best.x ? `XN${best.x} (${fmt1(best.hs)}%)` : "‚Äî";
}
function setKpi(usd, sp, hs, best){
  document.getElementById("kpiUsd").innerText = fmt2(usd);
  document.getElementById("kpiSp").innerText = fmt0(sp);
  document.getElementById("kpiHs").innerText = fmt1(hs) + "%";
  document.getElementById("kpiBest").innerText = best || "‚Äî";
}

/* ================== RENDER: DAY DETAIL TABLE ================== */
function renderDayDetailForXuong(xuong, ngay){
  document.getElementById("detailTitle").innerText = `üìÑ B√°o c√°o cu·ªëi ng√†y ‚Äì XN${xuong}`;
  const rows = dayDetail[xuong] || [];

  let usdSum=0, dmSum=0, spSum=0, ldSum=0;

  const body = rows.map(r=>{
    const hours = Array.isArray(r.hours) ? r.hours : [];
    const th = hours.reduce((a,b)=>a+toNum(b),0);

    const dm = toNum(r.dinh_muc_ngay);
    const dg = toNum(r.don_gia);
    const usd = th * dg;
    const hs = dm>0 ? (th/dm*100) : 0;

    const ld = toNum(r.lao_dong_thuc_te);
    const usdPer = ld>0 ? (usd/ld) : 0;

    usdSum += usd; dmSum += dm; spSum += th; ldSum += ld;

    const ln = Number(r.line_no||1);

    return `
      <tr>
        <td><b>${escapeHtml(r.to_nhom)}</b></td>
        <td><b>${ln}</b></td>
        <td class="left" style="text-align:left;padding-left:10px;white-space:normal">${escapeHtml(r.ma_hang||"")}</td>
        <td>${fmt0(ld)}</td>
        <td>${fmt0(dm)}</td>
        <td>${fmt0(th)}</td>
        <td>${fmt2(dg)}</td>
        <td><b>${fmt2(usd)}</b></td>
        <td class="pct ${pctClass(hs)}">${fmt1(hs)}%</td>
        <td>${fmt2(usdPer)}</td>
        <td>${fmt0(r.chuyen_doi_ngay||0)}</td>
        <td class="left" style="text-align:left;padding-left:10px;white-space:normal">${escapeHtml(r.ghi_chu||"")}</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="12" class="left" style="text-align:left;padding-left:10px;color:var(--muted)">Ch∆∞a c√≥ d·ªØ li·ªáu k·∫ø ho·∫°ch/gi·ªù.</td></tr>`;

  document.getElementById("detailTbody").innerHTML = body;

  const hsAll = dmSum>0 ? (spSum/dmSum*100) : 0;
  const usdPerAll = ldSum>0 ? (usdSum/ldSum) : 0;

  document.getElementById("detailUsd").innerText = fmt2(usdSum);
  document.getElementById("detailHs").innerText = fmt1(hsAll) + "%";
  document.getElementById("detailUsdPer").innerText = fmt2(usdPerAll);

  document.getElementById("detailMeta").innerText =
    `Ng√†y: ${ngay} ‚Ä¢ T·ªïng SP: ${fmt0(spSum)} ‚Ä¢ T·ªïng ƒêM: ${fmt0(dmSum)} ‚Ä¢ T·ªïng USD: ${fmt2(usdSum)}`;
}

/* ================== REASONS (active tab only) ================== */
function renderReasons(){
  const ngay = document.getElementById("date").value;
  const xuong = activeTab;

  const filter = document.getElementById("reasonFilter")?.value || "all";
  const q = String(document.getElementById("reasonSearch")?.value||"").trim().toLowerCase();

  let rows = Array.isArray(dayHoursRaw[xuong]) ? dayHoursRaw[xuong].slice() : [];

  if(filter === "bad") rows = rows.filter(r => Number(r.hieu_suat||0) < 80);
  if(q) rows = rows.filter(r => String(r.nguyen_nhan||"").toLowerCase().includes(q));

  const badCount = rows.filter(r => Number(r.hieu_suat||0) < 80).length;
  document.getElementById("reasonMeta").innerText =
    `XN${xuong} ‚Ä¢ Ng√†y ${ngay} ‚Ä¢ T·ªïng b·∫£n ghi gi·ªù: ${rows.length} ‚Ä¢ Gi·ªù ƒë·ªè (HS<80%): ${badCount}`;

  const counter = new Map();
  for(const r of rows){
    const reason = normReason(r.nguyen_nhan);
    if(!reason) continue;
    counter.set(reason, (counter.get(reason)||0) + 1);
  }
  const top = [...counter.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);

  document.getElementById("reasonTopTbody").innerHTML = top.length
    ? top.map(([reason,c])=>`
      <tr>
        <td class="left" style="text-align:left;padding-left:10px;white-space:normal">${escapeHtml(reason)}</td>
        <td><b>${c}</b></td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" class="left" style="text-align:left;padding-left:10px;color:var(--muted)">Ch∆∞a c√≥ nguy√™n nh√¢n.</td></tr>`;

  const bad = rows
    .filter(r => Number(r.hieu_suat||0) < 80)
    .sort((a,b)=> String(a.khung_gio).localeCompare(String(b.khung_gio)) || (Number(a.to_nhom)-Number(b.to_nhom)));

  document.getElementById("reasonBadTbody").innerHTML = bad.length
    ? bad.map(r=>{
        const hs = Number(r.hieu_suat||0);
        const shortReason = normReason(r.nguyen_nhan);
        const show = shortReason ? (shortReason.length>55 ? shortReason.slice(0,55)+"‚Ä¶" : shortReason) : "";
        return `
          <tr style="cursor:pointer" onclick="alertReason('${escapeHtml(r.to_nhom)}','${escapeHtml(r.khung_gio)}','${escapeHtml(shortReason||"")}')">
            <td><b>${escapeHtml(r.to_nhom)}</b></td>
            <td>${escapeHtml(r.khung_gio)}</td>
            <td>${fmt0(r.ke_hoach_gio||0)}</td>
            <td>${fmt0(r.thuc_te||0)}</td>
            <td class="pct ${pctClass(hs)}">${fmt1(hs)}%</td>
            <td class="left" style="text-align:left;padding-left:10px;white-space:normal">${escapeHtml(show||"(Kh√¥ng c√≥)")}</td>
          </tr>
        `;
      }).join("")
    : `<tr><td colspan="6" class="left" style="text-align:left;padding-left:10px;color:var(--muted)">Kh√¥ng c√≥ gi·ªù ƒë·ªè.</td></tr>`;
}
function alertReason(to, khung, reason){
  reason = reason || "(Kh√¥ng c√≥ ghi ch√∫)";
  alert(`T·ªï ${to} ‚Ä¢ Khung ${khung}\n\nNguy√™n nh√¢n:\n${reason}`);
}

/* ================== EVENTS ================== */
document.getElementById("date").addEventListener("change", reload);
document.getElementById("mode").addEventListener("change", reload);
document.addEventListener("input",(e)=>{
  if(e.target && e.target.id==="reasonSearch") renderReasons();
});
document.addEventListener("change",(e)=>{
  if(e.target && e.target.id==="reasonFilter") renderReasons();
});

/* auto refresh ticker m·ªói 30s */
setInterval(()=>{ refreshTicker(); }, 30000);
</script>
</body>
</html>
