<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GDC ‚Äì ƒêi·ªÅu h√†nh & Ch·ªâ ƒë·∫°o (XN1/XN2/XN3)</title>
<style>
  :root{
    --bg:#f3f4f6;--card:#fff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
    --head:#eef2f7;--head2:#e5e7eb;--primary:#2563eb;
    --good:#16a34a;--warn:#f59e0b;--bad:#dc2626;--shadow:0 10px 24px rgba(0,0,0,.06);
    --nav:#0e2552;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  a{color:inherit;text-decoration:none}
  .topbar{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,#0b1b3a,#0e2552);color:#fff;padding:12px 14px;box-shadow:0 10px 24px rgba(0,0,0,.18)}
  .topbar .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .brand b{display:block}
  .brand span{font-size:12px;opacity:.9}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .ctl{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);padding:6px 8px;border-radius:12px}
  .ctl label{font-size:12px;opacity:.9}
  .ctl input,.ctl select{
    background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);
    color:#fff;padding:6px 8px;border-radius:10px;outline:none;font-size:12px
  }
  .ctl select option{color:#111}
  .btn{border:none;background:var(--primary);color:#fff;padding:8px 10px;border-radius:12px;font-weight:900;cursor:pointer;font-size:12px}
  .btn.ghost{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.20)}
  .btn.warn{background:#f59e0b}
  .btn.danger{background:#dc2626}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .status{font-size:12px;opacity:.95;padding:6px 10px;background:rgba(255,255,255,.10);border:1px dashed rgba(255,255,255,.25);border-radius:12px;max-width:520px}

  /* ticker */
  .ticker{
    margin-top:10px;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.18);
    border-radius:14px;
    overflow:hidden;
    height:34px;
    display:flex;align-items:center;
  }
  .ticker .label{
    flex:0 0 auto;
    padding:0 10px;
    font-weight:900;
    font-size:12px;
    letter-spacing:.2px;
    background:rgba(245,158,11,.25);
    border-right:1px solid rgba(255,255,255,.18);
    height:34px;display:flex;align-items:center;
  }
  .ticker .track{
    position:relative;flex:1;overflow:hidden;height:34px;
  }
  .ticker .run{
    position:absolute;white-space:nowrap;will-change:transform;
    animation: marquee 18s linear infinite;
    padding-left:100%;
    font-size:12.5px;
    font-weight:800;
    opacity:.95;
  }
  @keyframes marquee{
    0%{transform:translateX(0)}
    100%{transform:translateX(-100%)}
  }
  .ticker small{opacity:.85;font-weight:700}

  .wrap{padding:14px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .card h3{margin:0 0 8px 0;font-size:14px}
  .muted{color:var(--muted);font-size:12px}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:10px}
  .kpi .value{font-size:20px;font-weight:1000;margin-top:4px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .pillRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .pill{
    border:1px solid var(--line);background:#fff;border-radius:999px;
    padding:6px 10px;font-size:12px;font-weight:900;cursor:pointer;
  }
  .pill.active{background:var(--nav);color:#fff;border-color:transparent}
  .row2{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  textarea{
    width:100%;min-height:110px;resize:vertical;
    border:1px solid var(--line);border-radius:14px;padding:10px;
    font:inherit;font-size:13px;outline:none;
  }
  textarea:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15);border-color:#93c5fd}
  .mini{font-size:12px}
  .tableWrap{background:#fff;border:1px solid var(--line);border-radius:16px;overflow:auto;box-shadow:var(--shadow)}
  table{width:max(1100px,100%);border-collapse:collapse;font-size:12.5px}
  th,td{border:1px solid var(--line);padding:7px;text-align:center;white-space:nowrap}
  thead th{background:var(--head);font-weight:900;position:sticky;top:0;z-index:2}
  tbody tr:nth-child(even) td{background:#fafafa}
  .right{text-align:right}
  .left{text-align:left}
  .badge{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;font-weight:900;font-size:12px}
  .b1{background:#e0f2fe;color:#075985}
  .b2{background:#dcfce7;color:#166534}
  .b3{background:#fef3c7;color:#92400e}
  .bAll{background:#ede9fe;color:#5b21b6}
  .hs.good{color:var(--good);font-weight:1000}
  .hs.warn{color:var(--warn);font-weight:1000}
  .hs.bad{color:var(--bad);font-weight:1000}
  .split{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .linkBtn{
    display:inline-flex;gap:6px;align-items:center;
    border:1px solid rgba(255,255,255,.22);
    background:rgba(255,255,255,.10);
    color:#fff;border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="row">
    <div class="brand">
      <b>üß≠ GDC ‚Äì ƒêI·ªÄU H√ÄNH & CH·ªà ƒê·∫†O (XN1/XN2/XN3)</b>
      <span id="roleHint">Ch·ªâ t√†i kho·∫£n GDC ƒë∆∞·ª£c ph√©p v√†o trang n√†y</span>

      <div class="ticker" title="Ch·ªâ ƒë·∫°o ƒëang ph√°t ra cho to√†n h·ªá th·ªëng">
        <div class="label">üì¢ CH·ªà ƒê·∫†O</div>
        <div class="track">
          <div class="run" id="tickerText">ƒêang t·∫£i ch·ªâ ƒë·∫°o...</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="split">
        <a class="linkBtn" href="../tk/tk1.html">TK1</a>
        <a class="linkBtn" href="../tk/tk2.html">TK2</a>
        <a class="linkBtn" href="../tk/tk3.html">TK3</a>
      </div>

      <div class="ctl">
        <label>Ch·∫ø ƒë·ªô</label>
        <select id="mode">
          <option value="week">Tu·∫ßn</option>
          <option value="month">Th√°ng</option>
          <option value="quarter">Qu√Ω</option>
          <option value="year">NƒÉm</option>
          <option value="day">Ng√†y</option>
        </select>
      </div>

      <div class="ctl">
        <label>Ng√†y</label>
        <input type="date" id="date" />
      </div>

      <button class="btn ghost" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      <button class="btn" onclick="reload()">T·∫£i d·ªØ li·ªáu</button>

      <div class="status" id="status">Ch∆∞a t·∫£i d·ªØ li·ªáu</div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid">
    <!-- MESSAGE CARD -->
    <div class="card" style="grid-column: span 5;">
      <h3>üì£ Nh·∫≠p ch·ªâ ƒë·∫°o GƒêC</h3>
      <div class="muted">
        Ch·ªâ ƒë·∫°o c√≥ th·ªÉ g·ª≠i theo XN1 / XN2 / XN3 ri√™ng, ho·∫∑c <b>ALL</b> ƒë·ªÉ √°p d·ª•ng cho c·∫£ 3.
        TK + T·ªï tr∆∞·ªüng + GƒêC ƒë·ªÅu th·∫•y (m√†n h√¨nh c·ªßa ƒë√∫ng x∆∞·ªüng).
      </div>

      <div class="pillRow">
        <button class="pill active" data-scope="ALL" onclick="pickScope('ALL')">ALL</button>
        <button class="pill" data-scope="1" onclick="pickScope('1')">XN1</button>
        <button class="pill" data-scope="2" onclick="pickScope('2')">XN2</button>
        <button class="pill" data-scope="3" onclick="pickScope('3')">XN3</button>
      </div>

      <div class="row2">
        <div class="muted mini">
          Scope ƒëang ch·ªçn: <b id="scopeName">ALL</b> ‚Ä¢
          <span>G·ª£i √Ω: n·ªôi dung ng·∫Øn g·ªçn, r√µ vi·ªác, c√≥ deadline</span>
        </div>

        <textarea id="msgBox" placeholder="Nh·∫≠p ch·ªâ ƒë·∫°o t·∫°i ƒë√¢y..."></textarea>

        <div class="split">
          <button class="btn warn" onclick="saveMessage()">üíæ L∆∞u ch·ªâ ƒë·∫°o</button>
          <button class="btn ghost" onclick="loadMessage()">‚Üª N·∫°p l·∫°i</button>
          <button class="btn danger" onclick="clearBox()">‚úñ X√≥a n·ªôi dung</button>
        </div>

        <div class="muted mini" id="msgMeta">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
      </div>
    </div>

    <!-- KPI CARD -->
    <div class="card" style="grid-column: span 7;">
      <h3>üìä T·ªïng h·ª£p s·∫£n l∆∞·ª£ng & hi·ªáu su·∫•t (ALL x∆∞·ªüng)</h3>
      <div class="muted" id="rangeInfo">‚Äî</div>

      <div class="kpi" style="margin-top:10px">
        <div class="card" style="box-shadow:none;border-radius:14px;padding:10px">
          <div class="label">T·ªïng SP (ALL)</div>
          <div class="value" id="kpiSpAll">0</div>
          <div class="muted">C·ªông XN1+XN2+XN3 theo kho·∫£ng</div>
        </div>
        <div class="card" style="box-shadow:none;border-radius:14px;padding:10px">
          <div class="label">T·ªïng K·∫ø ho·∫°ch (ALL)</div>
          <div class="value" id="kpiKeAll">0</div>
          <div class="muted">T·ªïng ƒêM ng√†y (t·ª´ production_day)</div>
        </div>
        <div class="card" style="box-shadow:none;border-radius:14px;padding:10px">
          <div class="label">Hi·ªáu su·∫•t (ALL)</div>
          <div class="value" id="kpiHsAll">0%</div>
          <div class="muted">SP / K·∫ø ho·∫°ch</div>
        </div>
        <div class="card" style="box-shadow:none;border-radius:14px;padding:10px">
          <div class="label">Ng√†y c√≥ HS cao nh·∫•t</div>
          <div class="value" id="kpiBest">‚Äî</div>
          <div class="muted">D·ª±a tr√™n HS ALL theo ng√†y</div>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="tableWrap" style="grid-column: span 12;">
      <table>
        <thead>
          <tr>
            <th style="min-width:110px">NG√ÄY</th>
            <th style="min-width:90px">X∆Ø·ªûNG</th>
            <th style="min-width:140px">T·ªîNG SP</th>
            <th style="min-width:160px">T·ªîNG K·∫æ HO·∫†CH</th>
            <th style="min-width:120px">HI·ªÜU SU·∫§T</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
        </tbody>
      </table>
    </div>

    <div class="muted" style="grid-column: span 12;">
      ‚öôÔ∏è L∆∞u √Ω: ƒë·ªÉ ticker/‚Äúch·ªâ ƒë·∫°o‚Äù hi·ªÉn th·ªã ·ªü TK & TO, c√°c trang ƒë√≥ s·∫Ω g·ªçi API:
      <b>getDirectorMessage</b> v·ªõi scope = x∆∞·ªüng (1/2/3) v√† merge v·ªõi scope ALL.
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const KEY = "NS_SESSION";

/* ================== FORMAT ==================
   - S·ªë nguy√™n: 10,000
   - %: 1 decimal
================================================ */
const NF_INT = new Intl.NumberFormat("en-US", { useGrouping:true, minimumFractionDigits:0, maximumFractionDigits:0 });
function fmtInt(n){ return NF_INT.format(Math.round(Number(n)||0)); }
function fmtPct1(n){ return (Number(n)||0).toFixed(1); }
function pctClass(hs){
  if(hs>=95) return "good";
  if(hs>=80) return "warn";
  return "bad";
}

/* ================== SESSION ================== */
function sess(){ try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null} }
function mustLogin(){
  const s=sess();
  if(!s||!s.token){ location.href="../login.html"; return null; }
  return s;
}
function logout(){ localStorage.removeItem(KEY); location.href="../login.html"; }

/* ================== UTIL ================== */
async function apiPost(payload){
  const r = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  return await r.json();
}
function setStatus(t){ document.getElementById("status").innerText = t; }
function todayISO(){
  const d=new Date();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function badgeXuong(x){
  if(String(x)==="1") return `<span class="badge b1">XN1</span>`;
  if(String(x)==="2") return `<span class="badge b2">XN2</span>`;
  if(String(x)==="3") return `<span class="badge b3">XN3</span>`;
  return `<span class="badge bAll">ALL</span>`;
}

/* ================== RANGE ================== */
function getRange(mode, dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const yyyy = d.getFullYear();
  const mm = d.getMonth();
  const dd = d.getDate();
  const toISO = (x)=>{
    const m=String(x.getMonth()+1).padStart(2,"0");
    const da=String(x.getDate()).padStart(2,"0");
    return `${x.getFullYear()}-${m}-${da}`;
  };

  if(mode === "day") return { from: dateStr, to: dateStr, label:`Ng√†y ${dateStr}` };
  if(mode === "week"){
    const day = (d.getDay()+6)%7;
    const start = new Date(d); start.setDate(dd - day);
    const end = new Date(start); end.setDate(start.getDate()+6);
    return { from: toISO(start), to: toISO(end), label:`Tu·∫ßn ${toISO(start)} ‚Üí ${toISO(end)}` };
  }
  if(mode === "month"){
    const start = new Date(yyyy, mm, 1);
    const end = new Date(yyyy, mm+1, 0);
    return { from: toISO(start), to: toISO(end), label:`Th√°ng ${yyyy}-${String(mm+1).padStart(2,"0")}` };
  }
  if(mode === "quarter"){
    const q = Math.floor(mm/3);
    const start = new Date(yyyy, q*3, 1);
    const end = new Date(yyyy, q*3+3, 0);
    return { from: toISO(start), to: toISO(end), label:`Qu√Ω ${q+1}/${yyyy}` };
  }
  const start = new Date(yyyy, 0, 1);
  const end = new Date(yyyy, 12, 0);
  return { from: toISO(start), to: toISO(end), label:`NƒÉm ${yyyy}` };
}

/* ================== MESSAGE STATE/UI ================== */
let S = mustLogin();
let currentScope = "ALL";

function pickScope(scope){
  currentScope = scope;
  document.querySelectorAll(".pill").forEach(p=>{
    p.classList.toggle("active", p.dataset.scope === scope);
  });
  document.getElementById("scopeName").innerText =
    scope==="ALL" ? "ALL (c·∫£ 3 x∆∞·ªüng)" : `XN${scope}`;
  loadMessage();
}

function clearBox(){
  document.getElementById("msgBox").value = "";
}

async function loadMessage(){
  S = mustLogin(); if(!S) return;
  if(S.role !== "gdc"){
    document.getElementById("roleHint").innerText = "‚õî Kh√¥ng ƒë√∫ng quy·ªÅn (ch·ªâ GDC)";
    setStatus("‚õî Kh√¥ng ƒë√∫ng quy·ªÅn");
    return;
  }

  setStatus(`ƒêang t·∫£i ch·ªâ ƒë·∫°o scope ${currentScope}...`);

  // Worker b·∫°n c·∫ßn b·ªï sung action: getDirectorMessage
  const res = await apiPost({ action:"getDirectorMessage", token:S.token, scope: currentScope });
  if(!res.success){
    setStatus("L·ªói t·∫£i ch·ªâ ƒë·∫°o: " + (res.msg||""));
    return;
  }

  document.getElementById("msgBox").value = res.message || "";
  document.getElementById("msgMeta").innerHTML =
    `C·∫≠p nh·∫≠t l√∫c: <b>${res.updated_at || "‚Äî"}</b> ‚Ä¢ b·ªüi: <b>${res.updated_by || "‚Äî"}</b>`;

  setStatus("‚úÖ ƒê√£ n·∫°p ch·ªâ ƒë·∫°o");
  await refreshTicker(); // ticker ∆∞u ti√™n ALL + scope ƒëang ch·ªçn
}

async function saveMessage(){
  S = mustLogin(); if(!S) return;
  if(S.role !== "gdc"){ setStatus("‚õî Kh√¥ng ƒë√∫ng quy·ªÅn"); return; }

  const message = String(document.getElementById("msgBox").value || "").trim();
  if(!message){
    setStatus("‚ö†Ô∏è Ch∆∞a nh·∫≠p n·ªôi dung ch·ªâ ƒë·∫°o");
    return;
  }

  setStatus(`ƒêang l∆∞u ch·ªâ ƒë·∫°o scope ${currentScope}...`);

  // Worker b·∫°n c·∫ßn b·ªï sung action: setDirectorMessage
  const res = await apiPost({
    action:"setDirectorMessage",
    token:S.token,
    scope: currentScope,
    message
  });

  if(!res.success){
    setStatus("L·ªói l∆∞u: " + (res.msg||""));
    return;
  }

  setStatus("‚úÖ ƒê√£ l∆∞u ch·ªâ ƒë·∫°o");
  await loadMessage();
}

/* Ticker: hi·ªÉn th·ªã ALL + XN ƒëang ch·ªçn (n·∫øu ƒëang ch·ªçn XN1/2/3) */
async function refreshTicker(){
  S = mustLogin(); if(!S) return;

  // l·∫•y ALL
  const all = await apiPost({ action:"getDirectorMessage", token:S.token, scope:"ALL" });
  // l·∫•y scope ƒëang ch·ªçn n·∫øu kh√¥ng ph·∫£i ALL
  let sc = { success:true, message:"" };
  if(currentScope !== "ALL"){
    sc = await apiPost({ action:"getDirectorMessage", token:S.token, scope: currentScope });
  }

  const parts = [];
  if(all?.success && all.message) parts.push(`(ALL) ${all.message}`);
  if(currentScope!=="ALL" && sc?.success && sc.message) parts.push(`(XN${currentScope}) ${sc.message}`);

  const text = parts.length ? parts.join("  ‚Ä¢  ") : "Ch∆∞a c√≥ ch·ªâ ƒë·∫°o";
  document.getElementById("tickerText").innerHTML = `${escapeHtml(text)} <small>‚Ä¢ c·∫≠p nh·∫≠t t·ª± ƒë·ªông</small>`;

  // reset animation ƒë·ªÉ ch·∫°y l·∫°i m∆∞·ª£t
  const el = document.getElementById("tickerText");
  el.style.animation = "none";
  // reflow
  void el.offsetHeight;
  el.style.animation = "";
}

function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ================== DATA (summary_xuong_day) ================== */
async function reload(){
  S = mustLogin(); if(!S) return;

  if(S.role !== "gdc"){
    document.getElementById("roleHint").innerText = "‚õî Kh√¥ng ƒë√∫ng quy·ªÅn (ch·ªâ GDC)";
    setStatus("‚õî B·∫°n kh√¥ng c√≥ quy·ªÅn m·ªü GDC");
    return;
  }else{
    document.getElementById("roleHint").innerText = "‚úÖ GDC: xem ALL x∆∞·ªüng + nh·∫≠p ch·ªâ ƒë·∫°o";
  }

  const mode = document.getElementById("mode").value;
  const date = document.getElementById("date").value;
  const range = getRange(mode, date);

  document.getElementById("rangeInfo").innerText = `B·ªô l·ªçc: ${range.label} ‚Ä¢ Ngu·ªìn: summary_xuong_day`;
  setStatus("ƒêang t·∫£i t·ªïng h·ª£p ALL...");

  const res = await apiPost({ action:"getDayRangeAll", token:S.token, from: range.from, to: range.to });
  if(!res.success){
    setStatus("L·ªói: " + (res.msg||""));
    document.getElementById("tbody").innerHTML = `<tr><td colspan="5" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
    return;
  }

  const data = Array.isArray(res.data) ? res.data : [];
  renderTable(data);
  calcKpi(data);

  setStatus(`‚úÖ ƒê√£ t·∫£i ‚Ä¢ ${range.from} ‚Üí ${range.to}`);
  await refreshTicker();
}

function renderTable(data){
  const tb = document.getElementById("tbody");
  if(!data.length){
    tb.innerHTML = `<tr><td colspan="5" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
    return;
  }

  tb.innerHTML = data.map(r=>{
    const hs = Number(r.hieu_suat)||0;
    const cls = pctClass(hs);
    return `
      <tr>
        <td><b>${escapeHtml(r.ngay||"")}</b></td>
        <td>${badgeXuong(r.xuong)}</td>
        <td class="right">${fmtInt(r.tong_sp||0)}</td>
        <td class="right">${fmtInt(r.tong_ke_hoach||0)}</td>
        <td class="hs ${cls}">${fmtPct1(hs)}%</td>
      </tr>
    `;
  }).join("");
}

function calcKpi(data){
  // KPI ALL theo to√†n kho·∫£ng: t·ªïng sp / t·ªïng k·∫ø ho·∫°ch
  let spAll=0, keAll=0;

  // t√¨m ng√†y t·ªët nh·∫•t (theo ALL: c·ªông 3 x∆∞·ªüng t·ª´ng ng√†y)
  const byDay = new Map(); // ngay -> {sp,ke}
  data.forEach(r=>{
    const ngay = String(r.ngay||"");
    const sp = Number(r.tong_sp)||0;
    const ke = Number(r.tong_ke_hoach)||0;
    spAll += sp; keAll += ke;

    if(!byDay.has(ngay)) byDay.set(ngay,{sp:0,ke:0});
    const x = byDay.get(ngay);
    x.sp += sp; x.ke += ke;
  });

  const hsAll = keAll>0 ? (spAll/keAll*100) : 0;

  let bestDay = "‚Äî";
  let bestHs = -1;
  for(const [ngay,val] of byDay.entries()){
    const hs = val.ke>0 ? (val.sp/val.ke*100) : 0;
    if(hs > bestHs){
      bestHs = hs;
      bestDay = `${ngay} (${fmtPct1(hs)}%)`;
    }
  }

  document.getElementById("kpiSpAll").innerText = fmtInt(spAll);
  document.getElementById("kpiKeAll").innerText = fmtInt(keAll);
  document.getElementById("kpiHsAll").innerText = fmtPct1(hsAll) + "%";
  document.getElementById("kpiBest").innerText = bestDay;
}

/* ================== INIT ================== */
document.getElementById("date").value = todayISO();

document.getElementById("mode").addEventListener("change", reload);
document.getElementById("date").addEventListener("change", reload);

if(S){
  if(S.role !== "gdc"){
    document.getElementById("roleHint").innerText = "‚õî Kh√¥ng ƒë√∫ng quy·ªÅn (ch·ªâ GDC)";
    setStatus("‚õî B·∫°n kh√¥ng c√≥ quy·ªÅn m·ªü GDC");
  }else{
    document.getElementById("roleHint").innerText = "‚úÖ GDC: xem ALL x∆∞·ªüng + nh·∫≠p ch·ªâ ƒë·∫°o";
    pickScope("ALL");
    reload();
  }
}

/* auto refresh ticker m·ªói 30s */
setInterval(()=>{
  const s = sess();
  if(s?.token) refreshTicker();
}, 30000);
</script>

</body>
</html>
