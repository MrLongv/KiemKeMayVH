<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GDC ‚Äì Mobile Dashboard</title>
<style>
  :root{
    --bg:#f3f4f6;--card:#fff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
    --head:#eef2f7;--head2:#e5e7eb;--primary:#2563eb;
    --good:#16a34a;--warn:#f59e0b;--bad:#dc2626;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0f3a8a,#1d4ed8);color:#fff;padding:10px 12px;box-shadow:0 10px 24px rgba(0,0,0,.18)}
  .topbar .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .brand b{display:block;font-size:14px}
  .brand span{font-size:12px;opacity:.88}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctl{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);padding:6px 8px;border-radius:12px}
  .ctl label{font-size:12px;opacity:.9}
  .ctl input,.ctl select{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;padding:6px 8px;border-radius:10px;outline:none;font-size:12px}
  .ctl select option{color:#111}
  .btn{border:none;background:var(--primary);color:#fff;padding:8px 10px;border-radius:12px;font-weight:900;cursor:pointer;font-size:12px}
  .btn.ghost{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.20)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .status{font-size:12px;opacity:.95;padding:6px 10px;background:rgba(255,255,255,.10);border:1px dashed rgba(255,255,255,.25);border-radius:12px;max-width:520px}

  .wrap{padding:12px;display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .card .label{font-size:12px;color:var(--muted)}
  .card .value{font-size:20px;font-weight:900;margin-top:4px}
  .small{font-size:12px;color:var(--muted);line-height:1.45}
  .pct{font-weight:900}
  .pct.good{color:var(--good)} .pct.warn{color:var(--warn)} .pct.bad{color:var(--bad)}

  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg button{
    flex:1 1 auto;
    padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;
    font-weight:900;font-size:12px;cursor:pointer
  }
  .seg button.active{background:#0e2552;border-color:#0e2552;color:#fff}
  .seg small{display:block;font-weight:700;opacity:.9}

  .kpiGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:420px){ .kpiGrid{grid-template-columns:1fr 1fr} }
  .kpi{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:18px;font-weight:900;margin-top:4px}

  .tableWrap{background:#fff;border:1px solid var(--line);border-radius:16px;overflow:auto;box-shadow:var(--shadow)}
  table{width:max(980px,100%);border-collapse:collapse;font-size:12.5px}
  th,td{border:1px solid var(--line);padding:6px;text-align:center;white-space:nowrap}
  thead tr:nth-child(1) th{background:var(--head);font-weight:900}
  thead tr:nth-child(2) th{background:var(--head2);font-weight:800}
  thead th{position:sticky;top:0;z-index:5}
  thead tr:nth-child(2) th{top:34px}
  tbody tr:nth-child(even) td{background:#fafafa}
  tfoot td{background:#f1f5f9;font-weight:900}

  /* Sticky 2 c·ªôt ƒë·∫ßu */
  .sticky1{position:sticky;left:0;z-index:6;background:#fff}
  .sticky2{position:sticky;left:62px;z-index:6;background:#fff}
  thead .sticky1, thead .sticky2{z-index:10;background:var(--head)}
  thead tr:nth-child(2) .sticky1, thead tr:nth-child(2) .sticky2{background:var(--head2)}

  /* ‚úÖ M√É H√ÄNG NG·∫ÆN L·∫†I */
  td.codeCell{max-width:150px;width:150px}
  td.codeCell .ellipsis{
    display:block;max-width:150px;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    text-align:left;padding-left:6px;
  }

  .left{text-align:left}
  .right{text-align:right}

  /* Reason list */
  .reasonBox{border:1px dashed var(--line);border-radius:14px;padding:10px;background:#fff}
  .reasonItem{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid #eee}
  .reasonItem:last-child{border-bottom:none}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid var(--line);background:#fff}
  .pill.bad{background:rgba(220,38,38,.10);color:#991b1b;border-color:rgba(220,38,38,.25)}
  .pill.warn{background:rgba(245,158,11,.12);color:#92400e;border-color:rgba(245,158,11,.25)}
  .pill.good{background:rgba(22,163,74,.10);color:#166534;border-color:rgba(22,163,74,.22)}

  /* Modal ch·ªâ ƒë·∫°o */
  .fab{
    position:fixed;right:14px;bottom:14px;z-index:80;
    width:54px;height:54px;border-radius:999px;border:none;
    background:#0e2552;color:#fff;font-size:22px;font-weight:900;
    box-shadow:0 14px 28px rgba(0,0,0,.22);
    cursor:pointer;
  }
  .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:90;padding:14px}
  .modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 20px 50px rgba(0,0,0,.30);padding:12px}
  .modal h3{margin:0 0 8px 0}
  .mRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .mRow select,.mRow input{padding:10px;border:1px solid var(--line);border-radius:12px;outline:none}
  .mRow select{min-width:130px}
  .mRow input{flex:1}
  .mTxt{width:100%;min-height:110px;resize:vertical;padding:10px;border:1px solid var(--line);border-radius:12px;outline:none;margin-top:10px;font-family:inherit}
  .mBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .btnDanger{background:#b91c1c}

</style>
</head>
<body>

<div class="topbar">
  <div class="row">
    <div class="brand">
      <b>üè¢ GDC ‚Äì Dashboard (Mobile)</b>
      <span id="roleHint">‚Äî</span>
    </div>

    <div class="controls">
      <div class="ctl">
        <label>Ng√†y</label>
        <input type="date" id="date" />
      </div>
      <button class="btn" onclick="reload()">T·∫£i</button>
      <button class="btn ghost" onclick="logout()">Tho√°t</button>
      <div class="status" id="status">Ch∆∞a t·∫£i d·ªØ li·ªáu</div>
    </div>
  </div>
</div>

<div class="wrap">

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <b>üìå Ch·ªçn x∆∞·ªüng ƒë·ªÉ xem chi ti·∫øt</b>
      <span class="pill" id="rangeInfo">‚Äî</span>
    </div>
    <div class="seg" style="margin-top:10px">
      <button id="seg1" class="active" onclick="setXuong(1)">XN1 <small>7-8..16-17</small></button>
      <button id="seg2" onclick="setXuong(2)">XN2 <small>7-8..16-17</small></button>
      <button id="seg3" onclick="setXuong(3)">XN3 <small>7-8..16-17</small></button>
    </div>

    <div class="kpiGrid" style="margin-top:10px">
      <div class="kpi">
        <div class="label">USD (∆∞·ªõc t√≠nh)</div>
        <div class="value" id="kpiUsd">0.00</div>
      </div>
      <div class="kpi">
        <div class="label">T·ªïng SP</div>
        <div class="value" id="kpiSp">0</div>
      </div>
      <div class="kpi">
        <div class="label">Hi·ªáu su·∫•t</div>
        <div class="value" id="kpiHs">0.0%</div>
      </div>
    </div>

    <div class="reasonBox" style="margin-top:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <b>üßæ Top nguy√™n nh√¢n (HS&lt;80%)</b>
        <span class="small" id="reasonMeta">‚Äî</span>
      </div>
      <div id="reasonList" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- =========================
       ‚è±Ô∏è B·∫¢NG NƒÇNG SU·∫§T GI·ªú
       (gi·ªëng TK1, b·ªè t·ª´ Lao ƒë·ªông tr·ªü v·ªÅ sau)
  ========================== -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <b id="hourTitle">‚è±Ô∏è NƒÉng su·∫•t theo gi·ªù ‚Äì XN1</b>
      <span class="small" id="hourMeta">‚Äî</span>
    </div>

    <div class="tableWrap" style="margin-top:10px">
      <table id="tblHour">
        <thead>
          <tr>
            <th class="sticky1" rowspan="2" style="min-width:62px;">T·ªî</th>
            <th class="sticky2" rowspan="2" style="min-width:150px;">M√É H√ÄNG</th>
            <th rowspan="2" style="min-width:90px;">SL KH</th>
            <th rowspan="2" style="min-width:90px;">ƒêM NG√ÄY</th>
            <th rowspan="2" style="min-width:90px;">ƒêM GI·ªú</th>
            <th rowspan="2" style="min-width:95px;">USD/QT</th>
            <th colspan="9">S·∫¢N L∆Ø·ª¢NG THEO GI·ªú</th>
            <th rowspan="2" style="min-width:90px;">T·ªîNG SP</th>
            <th rowspan="2" style="min-width:110px;">USD/TH</th>
            <th rowspan="2" style="min-width:105px;">HI·ªÜU SU·∫§T</th>
            <th rowspan="2" style="min-width:90px;">ƒêG</th>
            <th rowspan="2" style="min-width:100px;">TG/QT</th>
            <th rowspan="2" style="min-width:140px;">CHUY·ªÇN ƒê·ªîI/NG√ÄY</th>
            <th rowspan="2" style="min-width:220px;">GHI CH√ö</th>
          </tr>
          <tr id="hourHead"></tr>
        </thead>
        <tbody id="tbodyHour"></tbody>
        <tfoot>
          <!-- ‚úÖ TH√äM T·ªîNG USD/QT + T·ªîNG USD/GI·ªú -->
          <tr>
            <td class="sticky1 left" colspan="5" style="padding-left:10px;">T·ªîNG USD/QT</td>
            <td class="right" id="sumUsdQt">0.00</td>
            <td colspan="13"></td>
          </tr>
          <tr>
            <td class="sticky1 left" colspan="6" style="padding-left:10px;">T·ªîNG USD / GI·ªú</td>
            <td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td>
            <td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td>
            <td colspan="7"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- =========================
       üìÖ NƒÉng su·∫•t ng√†y (XN ƒëang ch·ªçn)
       + nguy√™n nh√¢n t·ªïng h·ª£p ph√≠a sau
  ========================== -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <b id="dayTitle">üìÖ NƒÉng su·∫•t ng√†y ‚Äì XN1</b>
      <span class="small" id="dayMeta">‚Äî</span>
    </div>

    <div class="tableWrap" style="margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>T·ªî</th>
            <th>TH·ª∞C HI·ªÜN</th>
            <th>ƒêM NG√ÄY</th>
            <th>HS</th>
          </tr>
        </thead>
        <tbody id="tbodyDay"></tbody>
        <tfoot>
          <tr>
            <td><b>T·ªîNG</b></td>
            <td id="sumDaySp"><b>0</b></td>
            <td id="sumDayDm"><b>0</b></td>
            <td id="sumDayHs"><b>0.0%</b></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="reasonBox" style="margin-top:10px">
      <b>üß© Nguy√™n nh√¢n t·ªïng h·ª£p trong ng√†y (XN ƒëang ch·ªçn)</b>
      <div class="small" id="reasonMetaDay" style="margin-top:4px">‚Äî</div>
      <div id="reasonListDay" style="margin-top:6px"></div>
    </div>
  </div>

</div>

<button class="fab" title="Ch·ªâ ƒë·∫°o" onclick="openModal()">‚úçÔ∏è</button>

<div class="modalMask" id="modalMask" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>üì£ Ch·ªâ ƒë·∫°o GƒêC</h3>
    <div class="small">Ch·ªçn ph·∫°m vi v√† l∆∞u. TO/TK/GDX s·∫Ω th·∫•y (ALL + XN).</div>

    <div class="mRow" style="margin-top:10px">
      <select id="mScope">
        <option value="ALL">ALL</option>
        <option value="1">XN1</option>
        <option value="2">XN2</option>
        <option value="3">XN3</option>
      </select>
      <input id="mNgay" type="date" />
    </div>

    <textarea id="mText" class="mTxt" placeholder="Nh·∫≠p ch·ªâ ƒë·∫°o..."></textarea>

    <div class="mBtns">
      <button class="btn ghost" onclick="closeModal()">ƒê√≥ng</button>
      <button class="btn" onclick="saveDirective()">L∆∞u</button>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const KEY="NS_SESSION";

const HOURS_XN12 = ["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"];
const HOURS_XN3  = ["7-8","8-9","9-10","10-11","11-12","13-14","14-15","15-16","16-17"];

const TO_BY_XUONG = {
  1:[1,3,5,7,9],
  2:[11,13,15,17],
  3:[19,21,23,25,27]
};

/* ================== FORMAT (EN-US nh∆∞ b·∫°n ch·ªët) ================== */
const NF_INT   = new Intl.NumberFormat("en-US", { useGrouping:true, minimumFractionDigits:0, maximumFractionDigits:0 });
const NF_MONEY = new Intl.NumberFormat("en-US", { useGrouping:true, minimumFractionDigits:2, maximumFractionDigits:2 });
const NF_DG    = new Intl.NumberFormat("en-US", { useGrouping:false, minimumFractionDigits:0, maximumFractionDigits:2 });

function fmtInt(n){ return NF_INT.format(Math.round(Number(n)||0)); }
function fmtMoney(n){ return NF_MONEY.format(Number(n)||0); }
function fmtDg(n){ return NF_DG.format(Number(n)||0); }
function fmtPct1(n){ return (Number(n)||0).toFixed(1); }

function toNum(v){
  let s = String(v ?? "").trim();
  if(!s) return 0;
  s = s.replace(/\s+/g,"").replaceAll(",","");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function pctClass(hs){
  hs = Number(hs)||0;
  if(hs>=95) return "good";
  if(hs>=80) return "warn";
  return "bad";
}
function pill(hs){
  hs = Number(hs)||0;
  if(hs>=95) return `<span class="pill good">‚úÖ ${fmtPct1(hs)}%</span>`;
  if(hs>=80) return `<span class="pill warn">‚ö†Ô∏è ${fmtPct1(hs)}%</span>`;
  return `<span class="pill bad">‚õî ${fmtPct1(hs)}%</span>`;
}
function normReason(s){
  s = String(s||"").trim();
  if(!s) return "";
  s = s.replace(/\s+/g," ").replace(/[.„ÄÇ]+$/,"");
  return s;
}

/* ================== SESSION ================== */
function sess(){ try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null} }
function mustLogin(){ const s=sess(); if(!s||!s.token){ location.href="../login.html"; return null;} return s; }
function logout(){ localStorage.removeItem(KEY); location.href="../login.html"; }

/* ================== UTIL ================== */
async function apiPost(payload){
  const r = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
  const text = await r.text();
  try{ return JSON.parse(text); }
  catch{ return { success:false, msg:`API kh√¥ng tr·∫£ JSON (HTTP ${r.status})`, raw:text.slice(0,240) }; }
}
function setStatus(t){ document.getElementById("status").innerText=t; }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* ================== STATE ================== */
let S = mustLogin();
let activeXuong = 1;

let cacheDayRows = {1:[],2:[],3:[]};       // getTkXuongDay (rows c√≥ hours)
let cacheHoursRaw = {1:[],2:[],3:[]};      // getHourRange (raw per day)

/* ================== INIT ================== */
document.getElementById("date").value = todayISO();
document.getElementById("mNgay").value = todayISO();

if(S){
  const ok = (S.role==="gdc");
  document.getElementById("roleHint").innerText = ok
    ? `‚úÖ GƒêC: ${S.username} ‚Ä¢ xem t·∫•t c·∫£ x∆∞·ªüng`
    : `‚õî Kh√¥ng ƒë√∫ng quy·ªÅn: role=${S.role} (c·∫ßn gdc)`;
  if(!ok){
    setStatus("Kh√¥ng ƒë√∫ng quy·ªÅn");
  }else{
    reload();
  }
}

/* ================== HOURS PER XUONG ================== */
function hoursOf(x){
  return (Number(x)===3) ? HOURS_XN3 : HOURS_XN12;
}

/* ================== UI: Segments ================== */
function setXuong(x){
  activeXuong = Number(x)||1;
  document.getElementById("seg1").classList.toggle("active", activeXuong===1);
  document.getElementById("seg2").classList.toggle("active", activeXuong===2);
  document.getElementById("seg3").classList.toggle("active", activeXuong===3);

  document.getElementById("hourTitle").innerText = `‚è±Ô∏è NƒÉng su·∫•t theo gi·ªù ‚Äì XN${activeXuong}`;
  document.getElementById("dayTitle").innerText = `üìÖ NƒÉng su·∫•t ng√†y ‚Äì XN${activeXuong}`;

  renderAllForActive();
}

/* ================== LOAD ================== */
async function reload(){
  S = mustLogin(); if(!S) return;
  if(S.role!=="gdc"){ setStatus("‚õî Ch·ªâ gdc ƒë∆∞·ª£c xem"); return; }

  const ngay = document.getElementById("date").value || todayISO();
  document.getElementById("mNgay").value = ngay;
  document.getElementById("rangeInfo").innerText = `Ng√†y ${ngay}`;

  setStatus("ƒêang t·∫£i d·ªØ li·ªáu...");
  const t0 = Date.now();

  for(const x of [1,2,3]){
    const res = await apiPost({ action:"getTkXuongDay", token:S.token, ngay, xuong:x });
    cacheDayRows[x] = (res && res.success) ? (res.rows||[]) : [];

    const hr = await apiPost({ action:"getHourRange", token:S.token, xuong:x, from:ngay, to:ngay });
    cacheHoursRaw[x] = (hr && hr.success) ? (hr.data||[]) : [];
  }

  const ms = Date.now()-t0;
  setStatus(`‚úÖ ƒê√£ t·∫£i ‚Ä¢ ${ngay} ‚Ä¢ ${ms}ms`);

  renderAllForActive();
}

/* ================== RENDER ALL ================== */
function renderAllForActive(){
  const ngay = document.getElementById("date").value || todayISO();
  const x = activeXuong;
  const hours = hoursOf(x);

  // header gi·ªù
  document.getElementById("hourHead").innerHTML =
    hours.map(h=>`<th>${escapeHtml(h)}</th>`).join("");

  // render hour table
  renderHourTable(x, hours, ngay);

  // render kpi + reasons (top)
  renderTopKpiAndReasons(x, hours, ngay);

  // render day table
  renderDayTable(x, ngay);

  // render day reason summary
  renderDayReasonSummary(x, ngay);
}

/* ================== HOUR TABLE ================== */
function renderHourTable(x, hours, ngay){
  const rows = Array.isArray(cacheDayRows[x]) ? cacheDayRows[x].slice() : [];
  const allowTos = new Set((TO_BY_XUONG[x]||[]).map(Number));

  let filtered = rows.filter(r => allowTos.has(Number(r.to_nhom)));

  // placeholder cho t·ªï ch∆∞a c√≥
  const existingTo = new Set(filtered.map(r=>Number(r.to_nhom)));
  for(const to of (TO_BY_XUONG[x]||[])){
    if(!existingTo.has(Number(to))){
      filtered.push({ to_nhom:Number(to), line_no:1, ma_hang:"", so_luong_ke_hoach:0, dinh_muc_ngay:0, dinh_muc_gio:0, usd_quy_trinh:0, don_gia:0, thoi_gian_giay:0, chuyen_doi_ngay:0, ghi_chu:"", hours:[] });
    }
  }

  filtered.sort((a,b)=> Number(a.to_nhom)-Number(b.to_nhom) || Number(a.line_no||1)-Number(b.line_no||1));

  // footer USD/GI·ªú v√† ‚úÖ t·ªïng USD/QT
  const usdGio = Array(hours.length).fill(0);
  let sumUsdQt = 0;

  const body = filtered.map(r=>{
    const hsArr = Array.isArray(r.hours) ? r.hours : [];
    const hoursVals = hours.map((_,i)=> toNum(hsArr[i]||0));
    const tongSP = hoursVals.reduce((a,b)=>a+b,0);

    const dmNgay = toNum(r.dinh_muc_ngay);
    const dg = toNum(r.don_gia);

    const dmGio = r.dinh_muc_gio ? toNum(r.dinh_muc_gio) : (dmNgay ? dmNgay/9 : 0);
    const usdQt = (dmNgay>0 && dg>0) ? (dmNgay*dg) : toNum(r.usd_quy_trinh||0);
    const usdTh = tongSP * dg;
    const hs = dmNgay ? (tongSP/dmNgay*100) : 0;

    sumUsdQt += usdQt;

    hoursVals.forEach((v,i)=>{ usdGio[i] += v * dg; });

    // ‚úÖ m√£ h√†ng ellipsis + title
    const ma = String(r.ma_hang||"");
    const maSafe = escapeHtml(ma);

    return `
      <tr>
        <td class="sticky1"><b>${escapeHtml(r.to_nhom)}</b></td>
        <td class="sticky2 codeCell" title="${maSafe}">
          <span class="ellipsis">${maSafe}</span>
        </td>

        <td>${fmtInt(r.so_luong_ke_hoach||0)}</td>
        <td>${fmtInt(dmNgay)}</td>
        <td class="right">${fmtMoney(dmGio)}</td>
        <td class="right">${fmtMoney(usdQt)}</td>

        ${hoursVals.map(v=>`<td>${fmtInt(v)}</td>`).join("")}

        <td><b>${fmtInt(tongSP)}</b></td>
        <td class="right"><b>${fmtMoney(usdTh)}</b></td>
        <td class="pct ${pctClass(hs)}">${fmtPct1(hs)}%</td>
        <td class="right">${fmtDg(dg)}</td>
        <td>${fmtInt(r.thoi_gian_giay||0)}</td>
        <td>${fmtInt(r.chuyen_doi_ngay||0)}</td>
        <td class="left" style="padding-left:6px;white-space:normal;min-width:220px">${escapeHtml(r.ghi_chu||"")}</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="${6+hours.length+6}" class="left" style="text-align:left;padding-left:10px;color:var(--muted)">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>`;

  document.getElementById("tbodyHour").innerHTML = body;

  document.querySelectorAll(".usdGio").forEach((td,i)=> td.innerText = fmtMoney(usdGio[i]||0));
  document.getElementById("sumUsdQt").innerText = fmtMoney(sumUsdQt);

  document.getElementById("hourMeta").innerText =
    `Ng√†y ${ngay} ‚Ä¢ ${filtered.length} d√≤ng (bao g·ªìm line) ‚Ä¢ USD/QT t·ªïng = ${fmtMoney(sumUsdQt)}`;
}

/* ================== KPI + REASON TOP (HS<80) ================== */
function renderTopKpiAndReasons(x, hours, ngay){
  const rows = Array.isArray(cacheDayRows[x]) ? cacheDayRows[x] : [];
  const allowTos = new Set((TO_BY_XUONG[x]||[]).map(Number));
  const filtered = rows.filter(r => allowTos.has(Number(r.to_nhom)));

  let usdSum=0, spSum=0, dmSum=0;
  for(const r of filtered){
    const hsArr = Array.isArray(r.hours) ? r.hours : [];
    const tt = hours.reduce((a,_,i)=> a + toNum(hsArr[i]||0), 0);
    spSum += tt;
    dmSum += toNum(r.dinh_muc_ngay);
    usdSum += tt * toNum(r.don_gia);
  }
  const hsAll = dmSum>0 ? (spSum/dmSum*100) : 0;

  document.getElementById("kpiUsd").innerText = fmtMoney(usdSum);
  document.getElementById("kpiSp").innerText = fmtInt(spSum);
  document.getElementById("kpiHs").innerText = fmtPct1(hsAll) + "%";

  // reasons top (HS<80) t·ª´ raw hours
  const raw = Array.isArray(cacheHoursRaw[x]) ? cacheHoursRaw[x] : [];
  const counter = new Map();
  let badCnt = 0;

  for(const r of raw){
    const hs = toNum(r.hieu_suat);
    if(hs>0 && hs<80){
      badCnt++;
      const rs = normReason(r.nguyen_nhan||"");
      if(rs) counter.set(rs, (counter.get(rs)||0)+1);
    }
  }
  const top = [...counter.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8);

  document.getElementById("reasonMeta").innerText = `${badCnt} gi·ªù ƒë·ªè`;

  const list = document.getElementById("reasonList");
  if(!top.length){
    list.innerHTML = `<div class="small" style="margin-top:6px">Ch∆∞a c√≥ nguy√™n nh√¢n / ch∆∞a c√≥ gi·ªù ƒë·ªè.</div>`;
  }else{
    list.innerHTML = top.map(([reason,c])=>`
      <div class="reasonItem">
        <div class="left" style="min-width:0;flex:1;white-space:normal">${escapeHtml(reason)}</div>
        <div><b>${fmtInt(c)}</b></div>
      </div>
    `).join("");
  }
}

/* ================== DAY TABLE ================== */
async function renderDayTable(x, ngay){
  // g·ªçi getDayByXuong ƒë·ªÉ ƒë√∫ng logic t·ªïng h·ª£p (nhanh & chu·∫©n)
  const res = await apiPost({ action:"getDayByXuong", token:S.token, ngay, xuong:x });
  const data = (res && res.success) ? (res.data||[]) : [];

  const allowTos = new Set((TO_BY_XUONG[x]||[]).map(Number));
  let filtered = data.filter(r => allowTos.has(Number(r.to_nhom)));

  // placeholder cho ƒë·ªß t·ªï
  const existingTo = new Set(filtered.map(r=>Number(r.to_nhom)));
  for(const to of (TO_BY_XUONG[x]||[])){
    if(!existingTo.has(Number(to))){
      filtered.push({ to_nhom:Number(to), tong_sp:0, dinh_muc_ngay:0, hieu_suat_ngay:0 });
    }
  }
  filtered.sort((a,b)=>Number(a.to_nhom)-Number(b.to_nhom));

  let sumSp=0, sumDm=0;
  document.getElementById("tbodyDay").innerHTML = filtered.map(r=>{
    const sp = toNum(r.tong_sp);
    const dm = toNum(r.dinh_muc_ngay);
    const hs = dm>0 ? (sp/dm*100) : 0;

    sumSp += sp; sumDm += dm;

    return `
      <tr>
        <td><b>${escapeHtml(r.to_nhom)}</b></td>
        <td>${fmtInt(sp)}</td>
        <td>${fmtInt(dm)}</td>
        <td class="pct ${pctClass(hs)}">${fmtPct1(hs)}%</td>
      </tr>
    `;
  }).join("");

  const hsAll = sumDm>0 ? (sumSp/sumDm*100) : 0;
  document.getElementById("sumDaySp").innerHTML = `<b>${fmtInt(sumSp)}</b>`;
  document.getElementById("sumDayDm").innerHTML = `<b>${fmtInt(sumDm)}</b>`;
  document.getElementById("sumDayHs").innerHTML = `<b>${fmtPct1(hsAll)}%</b>`;

  document.getElementById("dayMeta").innerText =
    `Ng√†y ${ngay} ‚Ä¢ T·ªïng SP ${fmtInt(sumSp)} ‚Ä¢ T·ªïng ƒêM ${fmtInt(sumDm)} ‚Ä¢ HS ${fmtPct1(hsAll)}%`;
}

/* ================== DAY REASON SUMMARY ================== */
function renderDayReasonSummary(x, ngay){
  const raw = Array.isArray(cacheHoursRaw[x]) ? cacheHoursRaw[x] : [];
  const counter = new Map();
  let total = 0;

  for(const r of raw){
    const rs = normReason(r.nguyen_nhan||"");
    if(!rs) continue;
    total++;
    counter.set(rs, (counter.get(rs)||0)+1);
  }
  const top = [...counter.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);

  document.getElementById("reasonMetaDay").innerText = `C√≥ ${fmtInt(total)} ghi ch√∫ nguy√™n nh√¢n trong ng√†y`;
  const box = document.getElementById("reasonListDay");

  if(!top.length){
    box.innerHTML = `<div class="small" style="margin-top:6px">Ch∆∞a c√≥ nguy√™n nh√¢n.</div>`;
  }else{
    box.innerHTML = top.map(([reason,c])=>`
      <div class="reasonItem">
        <div class="left" style="min-width:0;flex:1;white-space:normal">${escapeHtml(reason)}</div>
        <div><b>${fmtInt(c)}</b></div>
      </div>
    `).join("");
  }
}

/* ================== MODAL DIRECTOR ================== */
function openModal(){
  document.getElementById("modalMask").style.display = "flex";
  document.getElementById("mText").focus();
}
function closeModal(e){
  if(e && e.target && e.target.id !== "modalMask") return;
  document.getElementById("modalMask").style.display = "none";
}
async function saveDirective(){
  S = mustLogin(); if(!S) return;
  if(S.role!=="gdc"){ alert("Ch·ªâ GDC m·ªõi l∆∞u ch·ªâ ƒë·∫°o"); return; }

  const scope = document.getElementById("mScope").value;
  const ngay  = document.getElementById("mNgay").value || (document.getElementById("date").value || todayISO());
  const message = String(document.getElementById("mText").value||"").trim();
  if(!message){ alert("N·ªôi dung tr·ªëng"); return; }

  const res = await apiPost({ action:"setDirectorMessage", token:S.token, scope, ngay, message });
  if(!res || !res.success){
    alert("L·ªói l∆∞u ch·ªâ ƒë·∫°o: " + (res?.msg||""));
    return;
  }
  document.getElementById("mText").value = "";
  alert("‚úÖ ƒê√£ l∆∞u ch·ªâ ƒë·∫°o");
  closeModal();
}

/* ================== EVENTS ================== */
document.getElementById("date").addEventListener("change", ()=>{
  reload();
});
</script>
</body>
</html>
