<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TO ‚Äì Nh·∫≠p nƒÉng su·∫•t gi·ªù (Mobile)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --line:#e5e7eb; --text:#111827; --muted:#6b7280;
    --primary:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
    --shadow:0 10px 22px rgba(0,0,0,.06);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .top{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg,#0b1b3a,#0e2552);
    color:#fff;padding:12px 14px;box-shadow:0 10px 18px rgba(0,0,0,.18)
  }
  .top .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .title{font-weight:900;font-size:14px;letter-spacing:.2px}
  .sub{font-size:12px;opacity:.9}
  .btn{
    border:none;border-radius:999px;padding:8px 12px;
    font-weight:900;font-size:12px;cursor:pointer
  }
  .btn.primary{background:var(--primary);color:#fff}
  .btn.ghost{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .wrap{max-width:720px;margin:0 auto;padding:12px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:12px;
    margin-bottom:12px;
  }
  .card h3{margin:0 0 10px;font-size:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{
    width:100%;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:14px;
    outline:none;
    font-size:14px;
    background:#fff;
  }
  input:focus,select:focus,textarea:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
  textarea{min-height:86px;resize:vertical}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media(max-width:420px){
    .grid2,.grid3{grid-template-columns:1fr}
  }

  .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;
    border:1px solid rgba(245,158,11,.25);background:rgba(245,158,11,.12);color:#7c2d12
  }
  .pill.ok{border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.10);color:#14532d}
  .pill.bad{border-color:rgba(220,38,38,.25);background:rgba(220,38,38,.08);color:#7f1d1d}

  .planBox{
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    padding:10px;border:1px dashed rgba(17,24,39,.18);border-radius:14px;background:#fafafa;
  }
  .planMeta{font-size:12px;color:var(--muted);line-height:1.35}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden;font-size:13px}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:center;white-space:nowrap}
  th{background:#f1f5f9;font-weight:900}
  tbody tr:last-child td{border-bottom:none}
  tbody tr:nth-child(even) td{background:#fafafa}
  .left{text-align:left;white-space:normal}
  .pct{font-weight:900}
  .pct.ok{color:var(--ok)} .pct.warn{color:var(--warn)} .pct.bad{color:var(--bad)}

  .status{
    margin-top:8px;font-size:12px;color:#fff;opacity:.9;
    padding:6px 10px;border-radius:12px;background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.18);
  }
  .danger{
    margin-top:10px;
    border:1px solid rgba(220,38,38,.25);
    background:rgba(220,38,38,.06);
    color:#7f1d1d;
    border-radius:14px;
    padding:10px;
    font-size:13px;
    display:none;
  }
  .hint{font-size:12px;color:var(--muted);line-height:1.4;margin-top:8px}
</style>
</head>
<body>

<div class="top">
  <div class="row">
    <div>
      <div class="title">üßµ TO ‚Äì Nh·∫≠p nƒÉng su·∫•t gi·ªù (XN1)</div>
      <div class="sub" id="who">‚Äî</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ghost" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      <button class="btn primary" onclick="reload()">T·∫£i l·∫°i</button>
    </div>
  </div>
  <div class="status" id="status">Ch∆∞a t·∫£i</div>
</div>

<div class="wrap">

  <!-- 1) K·∫æ HO·∫†CH ƒê·∫¶U NG√ÄY (t·ª´ TK1) -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">üìå K·∫ø ho·∫°ch ƒë·∫ßu ng√†y</h3>
      <span id="planBadge" class="pill">Ch∆∞a t·∫£i</span>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>Ng√†y</label>
        <input type="date" id="ngay" />
      </div>
      <div>
        <label>Ch·ªçn line</label>
        <select id="lineSelect"></select>
      </div>
    </div>

    <div class="planBox" style="margin-top:10px">
      <div class="planMeta" id="planText">‚Äî</div>
      <div class="planMeta" style="text-align:right" id="planMeta">‚Äî</div>
    </div>

    <div id="planWarn" class="danger"></div>
  </div>

  <!-- 2) NH·∫¨P NƒÇNG SU·∫§T -->
<div class="card">
  <h3>‚úçÔ∏è Nh·∫≠p nƒÉng su·∫•t gi·ªù</h3>

  <!-- Khung gi·ªù -->
  <div>
    <label>Khung gi·ªù</label>
    <select id="khung"></select>
  </div>

  <!-- Th·ª±c t·∫ø -->
  <div style="margin-top:10px">
    <label>Th·ª±c t·∫ø (SP)</label>
    <input id="thuc_te" inputmode="numeric" placeholder="vd: 120" />
  </div>

  <!-- Nguy√™n nh√¢n -->
  <div style="margin-top:10px">
    <label>Nguy√™n nh√¢n / ghi ch√∫</label>
    <textarea id="nguyen_nhan"
      placeholder="vd: Thi·∫øu h√†ng, m√°y h∆∞, ƒë·ªïi m√£, thi·∫øu ng∆∞·ªùi..."></textarea>
  </div>

  <!-- N√∫t l∆∞u ƒë·∫∑t D∆Ø·ªöI -->
  <button
    class="btn primary"
    id="btnSave"
    style="
      width:100%;
      margin-top:14px;
      padding:14px 0;
      font-size:15px;
      border-radius:999px;
    "
    onclick="save()"
  >
    üíæ L∆ØU
  </button>

  <div id="warnBox" class="danger"></div>
</div>


  <!-- 3) B·∫¢NG D∆Ø·ªöI C√ôNG: D·ªÆ LI·ªÜU TRONG NG√ÄY -->
  <div class="card">
    <h3>üìä NƒÉng su·∫•t ƒë√£ nh·∫≠p trong ng√†y</h3>
    <div class="hint" id="metaTable">‚Äî</div>
    <div style="margin-top:10px;overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Line</th>
            <th>Khung</th>
            <th>KH/gi·ªù</th>
            <th>Th·ª±c t·∫ø</th>
            <th>HS</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="hint">Ch·∫°m 1 d√≤ng ƒë·ªÉ xem nguy√™n nh√¢n.</div>
  </div>

</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const XUONG = 1;
const HOURS = ["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"];
const HOURS_COUNT = 9;

/* ================== SESSION ================== */
const KEY="NS_SESSION";
function getSess(){ try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null} }
function mustLogin(){
  const s=getSess();
  if(!s || !s.token){ location.href="../login.html"; return null; }
  return s;
}
function logout(){ localStorage.removeItem(KEY); location.href="../login.html"; }

/* ================== UTIL ================== */
function setStatus(t){ document.getElementById("status").innerText=t; }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function nInt(v){
  const n=Number(String(v??"").replaceAll(",","").trim());
  if(!Number.isFinite(n)) return 0;
  return Math.round(n);
}
function nNum(v){
  const n=Number(String(v??"").replaceAll(",","").trim());
  if(!Number.isFinite(n)) return 0;
  return n;
}
function fmt0(n){ return String(Math.round(Number(n)||0)); }
function fmt1(n){ return (Number(n)||0).toFixed(1); }
function fmt2(n){ return (Number(n)||0).toFixed(2); }
function pctClass(hs){
  hs = Number(hs)||0;
  if(hs>=95) return "ok";
  if(hs>=80) return "warn";
  return "bad";
}
function esc(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
async function apiPost(payload){
  const r=await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const text = await r.text();
  try{ return JSON.parse(text); }
  catch{ return { success:false, msg:`API kh√¥ng tr·∫£ JSON (HTTP ${r.status})`, raw:text.slice(0,240) }; }
}

/* ================== STATE ================== */
let S = mustLogin();
let TO = 0;
let planLines = [];
let selectedLine = 1;
let hoursRows = [];

/* ================== INIT ================== */
document.getElementById("ngay").value = todayISO();
document.getElementById("khung").innerHTML = HOURS.map(h=>`<option value="${h}">${h}</option>`).join("");
document.getElementById("lineSelect").innerHTML = `<option value="1">Line 1</option>`;

if(S){
  const roleOk = (S.role === "to");
  const xuongOk = (Number(S.xuong) === XUONG);
  TO = Number(S.to_nhom || 0);

  if(!roleOk || !xuongOk || !TO){
    document.getElementById("who").innerText = `‚õî Kh√¥ng ƒë√∫ng quy·ªÅn: role=${S.role} xuong=${S.xuong} to=${S.to_nhom}`;
    document.getElementById("btnSave").disabled = true;
    setStatus("Kh√¥ng ƒë√∫ng quy·ªÅn / thi·∫øu t·ªï");
  }else{
    document.getElementById("who").innerText = `T√†i kho·∫£n: ${S.username} ‚Ä¢ XN${S.xuong} ‚Ä¢ T·ªï: ${TO}`;
    reload();
  }
}

/* ================== LOAD ================== */
async function reload(){
  S = mustLogin(); if(!S) return;
  const ngay = document.getElementById("ngay").value;

  setStatus("ƒêang t·∫£i...");
  hideWarn();
  hidePlanWarn();

  // 1) load plan lines (t·ª´ TK1)
  await loadPlanLines(ngay);

  // 2) load d·ªØ li·ªáu gi·ªù ƒë√£ nh·∫≠p theo t·ªï
  const resH = await apiPost({
    action:"getHourByTo",
    token:S.token,
    ngay,
    xuong:XUONG,
    to_nhom: TO
  });

  if(!resH.success){
    setStatus("L·ªói t·∫£i gi·ªù: " + (resH.msg||""));
    hoursRows = [];
    renderTable([], ngay);
    applyHourDisableByLine();
    return;
  }

  hoursRows = resH.data || [];
  setStatus(`ƒê√£ t·∫£i ‚Ä¢ ${ngay} ‚Ä¢ ${hoursRows.length} b·∫£n ghi`);
  renderTable(hoursRows, ngay);
  applyHourDisableByLine();
}

async function loadPlanLines(ngay){
  planLines = [];

  const res = await apiPost({
    action:"getTkXuongDay",
    token:S.token,
    ngay,
    xuong:XUONG
  });

  if(res.success){
    const rows = res.rows || [];
    planLines = rows
      .filter(r => Number(r.to_nhom) === Number(TO))
      .map(r => ({...r, line_no: Number(r.line_no||1)}))
      .sort((a,b)=>a.line_no-b.line_no);
  }else{
    // v·∫´n cho nh·∫≠p gi·ªù b√¨nh th∆∞·ªùng, ch·ªâ b√°o l√† kh√¥ng xem ƒë∆∞·ª£c k·∫ø ho·∫°ch
    showPlanWarn(
      "‚õî Kh√¥ng t·∫£i ƒë∆∞·ª£c k·∫ø ho·∫°ch (TK1). N·∫øu Worker ƒëang ch·∫∑n role=to ·ªü action getTkXuongDay th√¨ c·∫ßn m·ªü quy·ªÅn."
    );
  }

  // build line select
  const sel = document.getElementById("lineSelect");
  const lines = planLines.length ? planLines.map(p => Number(p.line_no||1)) : [1];
  const uniqueLines = [...new Set(lines)].sort((a,b)=>a-b);

  sel.innerHTML = uniqueLines.map(ln=>{
    const p = planLines.find(x=>Number(x.line_no)===ln);
    const mh = p?.ma_hang ? ` ‚Äì ${p.ma_hang}` : "";
    return `<option value="${ln}">Line ${ln}${esc(mh)}</option>`;
  }).join("");

  selectedLine = uniqueLines.includes(selectedLine) ? selectedLine : uniqueLines[0];
  sel.value = String(selectedLine);

  renderPlan(ngay);
}

function renderPlan(ngay){
  const badge = document.getElementById("planBadge");
  const text  = document.getElementById("planText");
  const meta  = document.getElementById("planMeta");

  meta.innerHTML = `Ng√†y: <b>${ngay}</b><br/>XN${XUONG} ‚Ä¢ T·ªï <b>${TO}</b>`;

  const p = planLines.find(x=>Number(x.line_no)===Number(selectedLine)) || null;

  if(!p || !p.ma_hang){
    badge.className = "pill bad";
    badge.innerText = "‚ö†Ô∏è Ch∆∞a c√≥ KH";
    text.innerHTML =
      `Line <b>${selectedLine}</b>: <b>ch∆∞a c√≥ k·∫ø ho·∫°ch</b><br/>` +
      `<span class="mono" style="color:#6b7280">B√°o TK nh·∫≠p m√£ h√†ng/ƒë·ªãnh m·ª©c cho line n√†y.</span>`;
    return;
  }

  const dmNgay = nInt(p.dinh_muc_ngay);
  const dmGio  = p.dinh_muc_gio ? nNum(p.dinh_muc_gio) : (dmNgay>0 ? (dmNgay / HOURS_COUNT) : 0);

  badge.className = "pill ok";
  badge.innerText = `‚úÖ Line ${selectedLine}`;

  text.innerHTML =
    `M√£ h√†ng: <b class="mono">${esc(p.ma_hang)}</b><br/>`+
    `ƒêM gi·ªù: <b>${fmt2(dmGio)}</b> ‚Ä¢ SLKH: <b>${fmt0(p.so_luong_ke_hoach||0)}</b>`;
}

/* ================== TABLE RENDER ================== */
function renderTable(rows, ngay){
  document.getElementById("metaTable").innerText = `Ng√†y: ${ngay} ‚Ä¢ XN${XUONG} ‚Ä¢ T·ªï: ${TO}`;

  const tb = document.getElementById("tbody");
  tb.innerHTML = rows.map(r=>{
    const hs = nInt(r.hieu_suat);
    return `
      <tr onclick="alertReason('${esc(r.line_no)}','${esc(r.khung_gio)}','${esc(r.nguyen_nhan||"")}')">
        <td><b>${esc(r.line_no||1)}</b></td>
        <td><b>${esc(r.khung_gio)}</b></td>
        <td>${fmt0(r.ke_hoach_gio)}</td>
        <td>${fmt0(r.thuc_te)}</td>
        <td class="pct ${pctClass(hs)}">${fmt0(hs)}%</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="5" class="left" style="padding:12px;color:#6b7280">Ch∆∞a nh·∫≠p gi·ªù n√†o.</td></tr>`;
}

/* ‚úÖ Kho√° khung gi·ªù ƒë√£ d√πng theo line ƒëang ch·ªçn */
function applyHourDisableByLine(){
  const used = new Set(
    (hoursRows||[])
      .filter(r => Number(r.line_no||1) === Number(selectedLine))
      .map(r => String(r.khung_gio))
  );

  const sel = document.getElementById("khung");
  [...sel.options].forEach(op=>{ op.disabled = used.has(op.value); });

  const firstAvail = [...sel.options].find(op=>!op.disabled);
  if(firstAvail) sel.value = firstAvail.value;
}

/* ================== SAVE ================== */
async function save(){
  S = mustLogin(); if(!S) return;
  if(S.role !== "to" || Number(S.xuong)!==XUONG){ return; }

  const ngay = document.getElementById("ngay").value;
  const khung = document.getElementById("khung").value;
  const thuc_te = nInt(document.getElementById("thuc_te").value);
  const nguyen_nhan = document.getElementById("nguyen_nhan").value.trim();
  const line_no = Number(selectedLine || 1);

  if(!ngay) return showWarn("Vui l√≤ng ch·ªçn ng√†y.");
  if(!khung) return showWarn("Vui l√≤ng ch·ªçn khung gi·ªù.");
  if(thuc_te <= 0) return showWarn("Th·ª±c t·∫ø ph·∫£i > 0.");

  const btn = document.getElementById("btnSave");
  btn.disabled = true;
  btn.innerText = "ƒêang l∆∞u...";

  try{
    const res = await apiPost({
      action:"saveHour",
      token:S.token,
      ngay,
      khung_gio: khung,
      line_no,
      thuc_te,
      nguyen_nhan
    });

    if(!res.success){
      showWarn(res.msg || "L∆∞u th·∫•t b·∫°i");
      setStatus("L∆∞u l·ªói");
      return;
    }

    setStatus(`‚úÖ ƒê√£ l∆∞u ${khung} (line ${line_no})`);
    document.getElementById("thuc_te").value = "";
    document.getElementById("nguyen_nhan").value = "";
    hideWarn();
    await reload();
    document.getElementById("thuc_te").focus();
  }catch(e){
    showWarn("L·ªói k·∫øt n·ªëi: " + (e.message || e));
  }finally{
    btn.disabled = false;
    btn.innerText = "L∆∞u";
  }
}

/* ================== WARN ================== */
function showWarn(t){
  const b=document.getElementById("warnBox");
  b.style.display="block";
  b.innerText = "‚õî " + t;
}
function hideWarn(){
  const b=document.getElementById("warnBox");
  b.style.display="none";
  b.innerText = "";
}
function showPlanWarn(t){
  const b=document.getElementById("planWarn");
  b.style.display="block";
  b.innerText = t;
}
function hidePlanWarn(){
  const b=document.getElementById("planWarn");
  b.style.display="none";
  b.innerText = "";
}

function alertReason(line, khung, reason){
  reason = reason || "(Kh√¥ng c√≥ ghi ch√∫)";
  alert(`Line ${line} ‚Ä¢ Khung ${khung}\n\nNguy√™n nh√¢n:\n${reason}`);
}

/* ================== EVENTS ================== */
document.getElementById("ngay").addEventListener("change", reload);

document.getElementById("lineSelect").addEventListener("change", ()=>{
  selectedLine = Number(document.getElementById("lineSelect").value || 1);
  renderPlan(document.getElementById("ngay").value);
  applyHourDisableByLine();
});

document.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && (e.ctrlKey || e.metaKey)) save();
});
</script>

</body>
</html>
