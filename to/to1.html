<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TO1 ‚Äì Nh·∫≠p nƒÉng su·∫•t gi·ªù (XN1)</title>
<style>
  :root{
    --bg:#f3f4f6;--card:#fff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
    --primary:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .topbar{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg,#0b1b3a,#0e2552);
    color:#fff;padding:12px 14px;box-shadow:0 10px 24px rgba(0,0,0,.18)
  }
  .toprow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .brand b{display:block}
  .brand span{font-size:12px;opacity:.85}
  .status{
    font-size:12px;opacity:.95;padding:6px 10px;background:rgba(255,255,255,.10);
    border:1px dashed rgba(255,255,255,.25);border-radius:12px;max-width:520px
  }
  .btn{border:none;background:var(--primary);color:#fff;padding:8px 10px;border-radius:12px;font-weight:800;cursor:pointer;font-size:12px}
  .btn.ghost{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.20)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .wrap{padding:14px;max-width:1180px;margin:0 auto}

  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .card h3{margin:0 0 10px;font-size:14px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{
    width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;outline:none;
    font-size:14px;background:#fff
  }
  input:focus,select:focus,textarea:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
  textarea{min-height:92px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
  .kpi .val{font-size:18px;font-weight:900;margin-top:2px}
  .kpi .lab{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
  th,td{border:1px solid var(--line);padding:8px;text-align:center;white-space:nowrap}
  th{background:#eef2f7;font-weight:900}
  tbody tr:nth-child(even) td{background:#fafafa}
  .pct{font-weight:900}
  .pct.ok{color:var(--ok)} .pct.warn{color:var(--warn)} .pct.bad{color:var(--bad)}
  .left{text-align:left}
  .hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:8px}
  .dangerBox{
    border:1px solid rgba(220,38,38,.25);background:rgba(220,38,38,.06);
    border-radius:14px;padding:10px;color:#7f1d1d;font-size:13px
  }
  .infoBox{
    border:1px solid rgba(37,99,235,.20);background:rgba(37,99,235,.06);
    border-radius:16px;padding:12px
  }
  .infoGrid{
    display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));
    gap:10px
  }
  .infoItem{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px}
  .infoItem .k{font-size:12px;color:var(--muted)}
  .infoItem .v{font-size:16px;font-weight:900;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tag{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;font-weight:900}
  .tag.ok{background:rgba(22,163,74,.12);color:var(--ok)}
  .tag.warn{background:rgba(245,158,11,.12);color:var(--warn)}
  .tag.bad{background:rgba(220,38,38,.12);color:var(--bad)}
  @media(max-width:1100px){ .infoGrid{grid-template-columns:repeat(3,minmax(120px,1fr));} }
  @media(max-width:920px){ .grid{grid-template-columns:1fr} .infoGrid{grid-template-columns:repeat(2,minmax(120px,1fr));} }
</style>
</head>
<body>

<div class="topbar">
  <div class="toprow">
    <div class="brand">
      <b>üßµ TO1 ‚Äì NH·∫¨P NƒÇNG SU·∫§T GI·ªú (XN1)</b>
      <span id="who">‚Äî</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button class="btn ghost" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      <button class="btn" onclick="reload()">T·∫£i l·∫°i</button>
      <div class="status" id="status">Ch∆∞a t·∫£i</div>
    </div>
  </div>
</div>

<div class="wrap">

  <!-- ===== PLAN SUMMARY (NEW) ===== -->
  <div class="card infoBox">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
      <div>
        <b>üìå K·∫ø ho·∫°ch ƒë·∫ßu ng√†y (TK nh·∫≠p) ‚Äì T·ªï <span id="p_to">‚Äî</span></b>
        <div class="hint" id="p_note">‚Äî</div>
      </div>
      <div id="p_tag" class="tag warn">Ch∆∞a c√≥ KH</div>
    </div>

    <div class="infoGrid" style="margin-top:10px">
      <div class="infoItem">
        <div class="k">M√£ h√†ng</div>
        <div class="v" id="p_ma">‚Äî</div>
      </div>
      <div class="infoItem">
        <div class="k">SL k·∫ø ho·∫°ch</div>
        <div class="v" id="p_sl">0</div>
      </div>
      <div class="infoItem">
        <div class="k">ƒêM ng√†y</div>
        <div class="v" id="p_dmngay">0</div>
      </div>
      <div class="infoItem">
        <div class="k">ƒêM gi·ªù</div>
        <div class="v" id="p_dmgio">0</div>
      </div>
      <div class="infoItem">
        <div class="k">ƒê∆°n gi√°</div>
        <div class="v" id="p_dg">0.00</div>
      </div>
      <div class="infoItem">
        <div class="k">USD/QT (∆∞·ªõc t√≠nh)</div>
        <div class="v" id="p_usdqt">0.00</div>
      </div>
    </div>

    <div class="hint" style="margin-top:10px">
      ‚Ä¢ C√°c th√¥ng tin tr√™n <b>ch·ªâ xem</b>. N·∫øu ‚ÄúCh∆∞a c√≥ KH‚Äù, b√°o TK nh·∫≠p k·∫ø ho·∫°ch tr∆∞·ªõc khi nh·∫≠p gi·ªù.<br/>
      ‚Ä¢ KH/gi·ªù trong nh·∫≠p li·ªáu s·∫Ω t·ª± l·∫•y theo ƒêM gi·ªù (n·∫øu TK nh·∫≠p) ho·∫∑c ƒêM ng√†y/9.
    </div>
  </div>

  <!-- KPI -->
  <div class="kpi" style="margin-top:12px">
    <div class="card">
      <div class="lab">S·ªë gi·ªù ƒë√£ nh·∫≠p</div>
      <div class="val" id="kpiCount">0</div>
    </div>
    <div class="card">
      <div class="lab">T·ªïng SP (th·ª±c t·∫ø)</div>
      <div class="val" id="kpiSum">0</div>
    </div>
    <div class="card">
      <div class="lab">Hi·ªáu su·∫•t TB</div>
      <div class="val" id="kpiHs">0%</div>
    </div>
  </div>

  <div class="grid">
    <!-- FORM -->
    <div class="card">
      <h3>Nh·∫≠p gi·ªù</h3>

      <div class="row3">
        <div>
          <label>Ng√†y</label>
          <input type="date" id="ngay" />
        </div>
        <div>
          <label>Khung gi·ªù</label>
          <select id="khung"></select>
        </div>
        <div>
          <label>Th·ª±c t·∫ø (SP)</label>
          <input id="thuc_te" inputmode="numeric" placeholder="vd: 120" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>KH/gi·ªù (t·ª± l·∫•y)</label>
          <input id="ke_gio" readonly />
        </div>
        <div>
          <label>Hi·ªáu su·∫•t gi·ªù (t·ª± t√≠nh)</label>
          <input id="hs_gio" readonly />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Nguy√™n nh√¢n / ghi ch√∫ (n·∫øu c√≥)</label>
        <textarea id="nguyen_nhan" placeholder="vd: Thi·∫øu h√†ng, m√°y h∆∞, ƒë·ªïi m√£, thi·∫øu ng∆∞·ªùi..."></textarea>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="btnSave" onclick="save()">L∆∞u gi·ªù</button>
        <button class="btn ghost" onclick="clearForm()">X√≥a nh·∫≠p</button>
        <div class="hint">
          ‚Ä¢ T√†i kho·∫£n t·ªï tr∆∞·ªüng ch·ªâ nh·∫≠p <b>ƒë√∫ng t·ªï c·ªßa m√¨nh</b> (t·ª± kh√≥a).<br/>
          ‚Ä¢ N·∫øu ƒë√£ nh·∫≠p gi·ªù ƒë√≥, h·ªá th·ªëng s·∫Ω b√°o ‚Äú‚õî Gi·ªù n√†y ƒë√£ nh·∫≠p‚Äù.
        </div>
      </div>

      <div id="warnBox" style="margin-top:12px;display:none" class="dangerBox"></div>
    </div>

    <!-- LIST -->
    <div class="card">
      <h3>D·ªØ li·ªáu ƒë√£ nh·∫≠p trong ng√†y</h3>
      <div class="hint" id="meta">‚Äî</div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Khung</th>
              <th>KH/gi·ªù</th>
              <th>Th·ª±c t·∫ø</th>
              <th>HS</th>
            </tr>
          </thead>
          <tbody id="mini"></tbody>
        </table>
      </div>

      <div class="hint" style="margin-top:10px">
        Ch·∫°m v√†o 1 d√≤ng b√™n d∆∞·ªõi b·∫£ng chi ti·∫øt ƒë·ªÉ xem nguy√™n nh√¢n.
      </div>
    </div>
  </div>

  <!-- DETAIL TABLE -->
  <div class="card" style="margin-top:12px">
    <h3>Chi ti·∫øt gi·ªù (k√®m nguy√™n nh√¢n)</h3>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Khung gi·ªù</th>
            <th>K·∫ø ho·∫°ch gi·ªù</th>
            <th>Th·ª±c t·∫ø</th>
            <th>Hi·ªáu su·∫•t</th>
            <th class="left">Nguy√™n nh√¢n</th>
            <th>Th·ªùi gian nh·∫≠p</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const XUONG = 1;
const HOURS = ["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"];
const HOURS_COUNT = 9;

/* ================== SESSION ================== */
const KEY="NS_SESSION";
function getSess(){ try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null} }
function mustLogin(){
  const s=getSess();
  if(!s || !s.token){ location.href="../login.html"; return null; }
  return s;
}
function logout(){ localStorage.removeItem(KEY); location.href="../login.html"; }

/* ================== UTIL ================== */
function setStatus(t){ document.getElementById("status").innerText=t; }
function todayISO(){
  const d=new Date();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function nInt(v){
  const n=Number(String(v??"").replaceAll(",","").trim());
  if(!Number.isFinite(n)) return 0;
  return Math.round(n);
}
function nNum(v){
  const n=Number(String(v??"").replaceAll(",","").trim());
  if(!Number.isFinite(n)) return 0;
  return n;
}
function fmt0(n){ return String(Math.round(Number(n)||0)); }
function fmt1(n){ return (Number(n)||0).toFixed(1); }
function fmt2(n){ return (Number(n)||0).toFixed(2); }
function pctClass(hs){
  hs = Number(hs)||0;
  if(hs>=95) return "ok";
  if(hs>=80) return "warn";
  return "bad";
}
async function apiPost(payload){
  const r=await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  return await r.json();
}
function escapeStr(s){
  return String(s??"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ================== STATE ================== */
let S = mustLogin();
let TO = null;

let plan = null;      // plan row of this TO
let keGioAuto = 0;    // ke_hoach_gio auto (from plan)

/* ================== INIT ================== */
document.getElementById("ngay").value = todayISO();
document.getElementById("khung").innerHTML = HOURS.map(h=>`<option value="${h}">${h}</option>`).join("");

if(S){
  const roleOk = (S.role === "to");
  const xuongOk = (Number(S.xuong) === XUONG);
  TO = Number(S.to_nhom || 0);

  if(!roleOk || !xuongOk || !TO){
    document.getElementById("who").innerText = `‚õî Kh√¥ng ƒë√∫ng quy·ªÅn: role=${S.role} xuong=${S.xuong} to=${S.to_nhom}`;
    document.getElementById("btnSave").disabled = true;
    setStatus("Kh√¥ng ƒë√∫ng quy·ªÅn / thi·∫øu t·ªï");
  }else{
    document.getElementById("who").innerText = `T√†i kho·∫£n: ${S.username} ‚Ä¢ X∆∞·ªüng: XN${S.xuong} ‚Ä¢ T·ªï: ${TO}`;
    reload();
  }
}

/* ================== LOAD ================== */
async function reload(){
  S = mustLogin(); if(!S) return;

  const ngay = document.getElementById("ngay").value;
  setStatus("ƒêang t·∫£i d·ªØ li·ªáu ng√†y...");
  document.getElementById("warnBox").style.display="none";
// 1) Load PLAN tr·ª±c ti·∫øp c·ªßa t·ªï (chu·∫©n nghi·ªáp v·ª•)
const planRes = await apiPost({
  action: "getPlanByTo",
  token: S.token,
  ngay
});

plan = (planRes && planRes.success) ? (planRes.data || null) : null;

// render l·∫°i khu v·ª±c hi·ªÉn th·ªã k·∫ø ho·∫°ch
renderPlan(ngay);


  // 2) Load HOURS history
  const res = await apiPost({
    action:"getHourByTo",
    token:S.token,
    ngay,
    xuong:XUONG,
    to_nhom: TO
  });

  if(!res.success){
    setStatus("L·ªói t·∫£i: " + (res.msg||""));
    renderHours([], ngay);
    return;
  }

  const data = res.data || [];
  setStatus(`ƒê√£ t·∫£i ‚Ä¢ ${ngay} ‚Ä¢ ${data.length} gi·ªù`);
  renderHours(data, ngay);

  // recompute ke_gio display & hs display
  updateAutoFields();
}

/* ================== PLAN UI (NEW) ================== */
function renderPlan(ngay){
  document.getElementById("p_to").innerText = TO;

  if(!plan){
    document.getElementById("p_tag").className = "tag bad";
    document.getElementById("p_tag").innerText = "Ch∆∞a c√≥ KH";
    document.getElementById("p_note").innerText = `Ng√†y ${ngay}: Ch∆∞a th·∫•y TK nh·∫≠p k·∫ø ho·∫°ch cho t·ªï n√†y.`;

    setPlanFields({ ma_hang:"‚Äî", so_luong_ke_hoach:0, dinh_muc_ngay:0, dinh_muc_gio:0, don_gia:0, usd_quy_trinh:0 });
    keGioAuto = 0;
    return;
  }

  const ma = String(plan.ma_hang || "").trim();
  const sl = nInt(plan.so_luong_ke_hoach);
  const dmNgay = nInt(plan.dinh_muc_ngay);
  const dg = nNum(plan.don_gia);

  // dm_gio: ∆∞u ti√™n plan.dinh_muc_gio, n·∫øu null th√¨ dmNgay/9
  const dmGio = nNum(plan.dinh_muc_gio) > 0 ? nNum(plan.dinh_muc_gio) : (dmNgay>0 ? (dmNgay/HOURS_COUNT) : 0);
  const usdQt = nNum(plan.usd_quy_trinh) > 0 ? nNum(plan.usd_quy_trinh) : (dmNgay>0 && dg>0 ? dmNgay*dg : 0);

  setPlanFields({
    ma_hang: ma || "‚Äî",
    so_luong_ke_hoach: sl,
    dinh_muc_ngay: dmNgay,
    dinh_muc_gio: dmGio,
    don_gia: dg,
    usd_quy_trinh: usdQt
  });

  // ke_gio auto cho nh·∫≠p gi·ªù: theo nghi·ªáp v·ª• = dinh_muc_gio (l√†m tr√≤n)
  keGioAuto = dmGio > 0 ? Math.round(dmGio) : 0;

  document.getElementById("p_tag").className = "tag ok";
  document.getElementById("p_tag").innerText = "ƒê√£ c√≥ KH";
  document.getElementById("p_note").innerText = `Ng√†y ${ngay}: TK ƒë√£ nh·∫≠p k·∫ø ho·∫°ch. B·∫°n nh·∫≠p gi·ªù theo khung b√™n d∆∞·ªõi.`;
}

function setPlanFields(x){
  document.getElementById("p_ma").innerText = x.ma_hang;
  document.getElementById("p_sl").innerText = fmt0(x.so_luong_ke_hoach);
  document.getElementById("p_dmngay").innerText = fmt0(x.dinh_muc_ngay);
  document.getElementById("p_dmgio").innerText = fmt2(x.dinh_muc_gio);
  document.getElementById("p_dg").innerText = fmt2(x.don_gia);
  document.getElementById("p_usdqt").innerText = fmt2(x.usd_quy_trinh);
}

/* ================== HOURS UI ================== */
function renderHours(data, ngay){
  document.getElementById("meta").innerText = `Ng√†y: ${ngay} ‚Ä¢ X∆∞·ªüng: XN${XUONG} ‚Ä¢ T·ªï: ${TO}`;

  // KPI
  const count = data.length;
  let sumTT=0, sumKH=0;
  data.forEach(r=>{ sumTT += nInt(r.thuc_te); sumKH += nInt(r.ke_hoach_gio); });
  const hsTB = sumKH>0 ? (sumTT/sumKH*100) : 0;

  document.getElementById("kpiCount").innerText = fmt0(count);
  document.getElementById("kpiSum").innerText = fmt0(sumTT);
  document.getElementById("kpiHs").innerText = fmt1(hsTB) + "%";

  // mini
  const mini = document.getElementById("mini");
  mini.innerHTML = (data.length?data:[]).map(r=>{
    const hs = nInt(r.hieu_suat);
    return `
      <tr onclick="alertReason('${escapeStr(r.khung_gio)}','${escapeStr(r.nguyen_nhan)}')">
        <td><b>${escapeStr(r.khung_gio)}</b></td>
        <td>${fmt0(r.ke_hoach_gio)}</td>
        <td>${fmt0(r.thuc_te)}</td>
        <td class="pct ${pctClass(hs)}">${fmt0(hs)}%</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="4" class="left" style="padding-left:10px;color:#6b7280">Ch∆∞a nh·∫≠p gi·ªù n√†o.</td></tr>`;

  // detail
  const tb = document.getElementById("tbody");
  tb.innerHTML = (data.length?data:[]).map(r=>{
    const hs = nInt(r.hieu_suat);
    return `
      <tr>
        <td><b>${escapeStr(r.khung_gio)}</b></td>
        <td>${fmt0(r.ke_hoach_gio)}</td>
        <td>${fmt0(r.thuc_te)}</td>
        <td class="pct ${pctClass(hs)}">${fmt0(hs)}%</td>
        <td class="left" style="white-space:normal;min-width:280px">${escapeStr(r.nguyen_nhan||"")}</td>
        <td>${escapeStr((r.created_at||"").replace("T"," ").slice(0,19))}</td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="6" class="left" style="padding-left:10px;color:#6b7280">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>`;

  // disable gi·ªù ƒë√£ nh·∫≠p
  const used = new Set(data.map(x=>String(x.khung_gio)));
  const sel = document.getElementById("khung");
  [...sel.options].forEach(op=>{ op.disabled = used.has(op.value); });

  // auto ch·ªçn khung ch∆∞a nh·∫≠p ƒë·∫ßu ti√™n
  const firstAvail = [...sel.options].find(op=>!op.disabled);
  if(firstAvail) sel.value = firstAvail.value;
}

/* ================== AUTO FIELDS (NEW) ================== */
function updateAutoFields(){
  // show ke_gio (auto)
  const ke = keGioAuto || 0;
  document.getElementById("ke_gio").value = ke ? fmt0(ke) : "0";

  // compute hs_gio from input thuc_te
  const tt = nInt(document.getElementById("thuc_te").value);
  const hs = ke>0 ? (tt/ke*100) : 0;
  document.getElementById("hs_gio").value = ke>0 ? (fmt1(hs) + "%") : "0%";
}

document.getElementById("thuc_te").addEventListener("input", updateAutoFields);
document.getElementById("khung").addEventListener("change", ()=>{
  clearForm(true);
  updateAutoFields();
});

/* ================== SAVE ================== */
async function save(){
  S = mustLogin(); if(!S) return;
  if(S.role !== "to" || Number(S.xuong)!==XUONG){ return; }

  const ngay = document.getElementById("ngay").value;
  const khung = document.getElementById("khung").value;
  const thuc_te = nInt(document.getElementById("thuc_te").value);
  const nguyen_nhan = document.getElementById("nguyen_nhan").value.trim();

  if(!ngay){ return showWarn("Vui l√≤ng ch·ªçn ng√†y."); }
  if(!khung){ return showWarn("Vui l√≤ng ch·ªçn khung gi·ªù."); }
  if(thuc_te <= 0){ return showWarn("Th·ª±c t·∫ø ph·∫£i > 0."); }

  // N·∫øu ch∆∞a c√≥ k·∫ø ho·∫°ch th√¨ v·∫´n cho nh·∫≠p, nh∆∞ng c·∫£nh b√°o r√µ
  if(!plan){
    // kh√¥ng ch·∫∑n v√¨ th·ª±c t·∫ø c√≥ th·ªÉ TK nh·∫≠p tr·ªÖ, nh∆∞ng n√™n b√°o
    showWarn("Ch∆∞a c√≥ k·∫ø ho·∫°ch ƒë·∫ßu ng√†y (TK ch∆∞a nh·∫≠p). V·∫´n c√≥ th·ªÉ nh·∫≠p gi·ªù, nh∆∞ng KH/gi·ªù s·∫Ω l√† 0 ho·∫∑c t√≠nh t·∫°m.");
  }

  const btn = document.getElementById("btnSave");
  btn.disabled = true;
  btn.innerText = "ƒêang l∆∞u...";

  try{
    const res = await apiPost({
      action:"saveHour",
      token:S.token,
      ngay,
      khung_gio: khung,
      thuc_te,
      nguyen_nhan
    });

    if(!res.success){
      showWarn(res.msg || "L∆∞u th·∫•t b·∫°i");
      setStatus("L∆∞u l·ªói");
      return;
    }

    setStatus(`‚úÖ ƒê√£ l∆∞u ${khung}`);
    clearForm(true);
    await reload();
  }catch(e){
    showWarn("L·ªói k·∫øt n·ªëi: " + (e.message || e));
  }finally{
    btn.disabled = false;
    btn.innerText = "L∆∞u gi·ªù";
  }
}

function clearForm(keepReason=false){
  document.getElementById("thuc_te").value = "";
  if(!keepReason) document.getElementById("nguyen_nhan").value = "";
  // kh√¥ng t·∫Øt warnBox ngay n·∫øu warn ƒëang d√πng ƒë·ªÉ nh·∫Øc "ch∆∞a c√≥ KH"
  updateAutoFields();
  document.getElementById("thuc_te").focus();
}

function showWarn(t){
  const b=document.getElementById("warnBox");
  b.style.display="block";
  b.innerText = "‚ö†Ô∏è " + t;
}

function alertReason(khung, reason){
  reason = reason || "(Kh√¥ng c√≥ ghi ch√∫)";
  alert(`Khung gi·ªù ${khung}\n\nNguy√™n nh√¢n:\n${reason}`);
}

/* reload when date changes */
document.getElementById("ngay").addEventListener("change", reload);

/* Enter ƒë·ªÉ l∆∞u nhanh: Ctrl+Enter */
document.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && (e.ctrlKey || e.metaKey)){
    save();
  }
});
</script>

</body>
</html>
