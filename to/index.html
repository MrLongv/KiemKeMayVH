<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>üßµ Nh·∫≠p nƒÉng su·∫•t t·ªï</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f3f4f6}
header{background:#2563eb;color:#fff;padding:12px;text-align:center;font-weight:600}
.box{background:#fff;margin:12px;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.info{font-size:14px;margin-bottom:10px}
.grid{display:grid;grid-template-columns:100px 1fr 1fr 1fr 2fr;border:1px solid #ddd}
.grid div{border-bottom:1px solid #ddd;border-right:1px solid #ddd;padding:6px;text-align:center}
.head{background:#f1f5f9;font-weight:600}
input,select{width:95%}
.lock{background:#e5e7eb;color:#666}
.bad{color:#dc2626;font-weight:600}
.ok{color:#16a34a;font-weight:600}
.alert{background:#fee2e2;border:2px solid #dc2626;padding:10px;border-radius:10px;margin-top:10px}
button{padding:10px;border:none;border-radius:8px;background:#16a34a;color:#fff;width:100%;cursor:pointer}
</style>
</head>

<body>
<header>üßµ NH·∫¨P NƒÇNG SU·∫§T THEO GI·ªú</header>

<div class="box">
  <div class="info">
    <b>X∆∞·ªüng:</b> <span id="xuong"></span> |
    <b>T·ªï:</b> <span id="to"></span> |
    <b>Ng√†y:</b> <span id="ngay"></span>
  </div>

  <div class="grid" id="grid">
    <div class="head">Gi·ªù</div>
    <div class="head">K·∫ø ho·∫°ch</div>
    <div class="head">Th·ª±c t·∫ø</div>
    <div class="head">HS %</div>
    <div class="head">Nguy√™n nh√¢n</div>
  </div>

  <div id="alertBox" class="alert" style="display:none"></div>
  <button onclick="saveAll()">üíæ L∆ØU D·ªÆ LI·ªÜU</button>
</div>

<script>
const API_URL="https://nang-suat-may.hoalangiongxoai.workers.dev";
const HOURS=["07-08","08-09","09-10","10-11","11-12","12-13","13-14","14-15","15-16","16-17"];

const u=JSON.parse(localStorage.getItem("USER"));
if(!u||!["to_truong","to_pho"].includes(u.role))location.href="../login.html";

xuong.innerText=u.xuong;
to.innerText=u.to;
ngay.innerText=new Date().toISOString().slice(0,10);

const rows=[];
const grid=document.getElementById("grid");

HOURS.forEach(gio=>{
  const r={gio,kh:0,tt:0,hs:0,reason:"",locked:false};

  grid.insertAdjacentHTML("beforeend",`
    <div>${gio}</div>
    <div><input type="number"></div>
    <div><input type="number"></div>
    <div class="hs">0</div>
    <div>
      <select>
        <option value=""></option>
        <option>M√°y h∆∞</option>
        <option>Thi·∫øu ph·ª• li·ªáu</option>
        <option>Thi·∫øu ng∆∞·ªùi</option>
        <option>Ch·ªù k·ªπ thu·∫≠t</option>
        <option>Kh√°c</option>
      </select>
    </div>
  `);

  const cells=grid.querySelectorAll("div");
  r.khInput=cells[cells.length-4].querySelector("input");
  r.ttInput=cells[cells.length-3].querySelector("input");
  r.hsCell=cells[cells.length-2];
  r.reasonSelect=cells[cells.length-1].querySelector("select");

  r.khInput.oninput=()=>calc(r);
  r.ttInput.oninput=()=>calc(r);
  r.reasonSelect.onchange=()=>r.reason=r.reasonSelect.value;

  rows.push(r);
});

function calc(r){
  r.kh=+r.khInput.value;
  r.tt=+r.ttInput.value;
  if(r.kh>0){
    r.hs=Math.round(r.tt/r.kh*100);
    r.hsCell.innerText=r.hs;
    r.hsCell.className=r.hs<80?"bad":"ok";
  }
  checkAlert();
}

function checkAlert(){
  for(let i=1;i<rows.length;i++){
    if(rows[i].hs<80&&rows[i-1].hs<80&&rows[i].hs>0){
      alertBox.style.display="block";
      alertBox.innerHTML=`üö® ${rows[i-1].gio} & ${rows[i].gio} < 80%`;
      return;
    }
  }
  alertBox.style.display="none";
}

function saveAll(){
  rows.forEach(r=>{
    if(r.locked||r.kh<=0) return;
    fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        action:"saveHour",
        xuong:u.xuong,
        to_nhom:u.to,
        ngay:ngay.innerText,
        khung_gio:r.gio,
        ke_hoach_gio:r.kh,
        thuc_te:r.tt,
        nguyen_nhan:r.reason
      })
    });
  });
  alert("‚úî ƒê√£ l∆∞u");
}

loadToday();

function loadToday(){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"getHour",
      xuong:u.xuong,
      to_nhom:u.to,
      ngay:ngay.innerText
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success) return;
    res.data.forEach(d=>{
      const r=rows.find(x=>x.gio===d.khung_gio);
      if(!r) return;
      r.kh=d.ke_hoach_gio;
      r.tt=d.thuc_te;
      r.hs=d.hieu_suat;
      r.reason=d.nguyen_nhan;
      r.locked=true;

      r.khInput.value=r.kh;
      r.ttInput.value=r.tt;
      r.reasonSelect.value=r.reason;
      r.hsCell.innerText=r.hs;
      r.hsCell.className=r.hs<80?"bad":"ok";

      r.khInput.disabled=true;
      r.ttInput.disabled=true;
      r.reasonSelect.disabled=true;
      r.khInput.classList.add("lock");
      r.ttInput.classList.add("lock");
    });
  });
}
</script>
</body>
</html>
