<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üë∑ T·ªï tr∆∞·ªüng ‚Äì Nh·∫≠p nƒÉng su·∫•t</title>

<style>
body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:#f3f4f6;
}
header{
  background:#2563eb;
  color:#fff;
  padding:12px 16px;
}
header b{font-size:18px}
.container{
  padding:16px;
}
.card{
  background:#fff;
  border-radius:10px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
h3{margin-top:0}
label{
  display:block;
  margin-top:10px;
  font-weight:600;
}
input,select,textarea,button{
  width:100%;
  padding:8px;
  margin-top:4px;
  font-size:14px;
}
button{
  margin-top:12px;
  background:#16a34a;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{background:#e5e7eb}
.logout{
  float:right;
  cursor:pointer;
  font-size:14px;
}
</style>
</head>

<body>

<header>
  <b>üë∑ T·ªî TR∆Ø·ªûNG</b>
  <span class="logout" onclick="logout()">‚èª Tho√°t</span><br>
  <span id="info"></span>
</header>

<div class="container">

  <!-- ===== NH·∫¨P GI·ªú ===== -->
  <div class="card">
    <h3>üïí Nh·∫≠p s·∫£n l∆∞·ª£ng theo gi·ªù</h3>

    <label>Ng√†y</label>
    <input type="date" id="ngay">

    <label>Khung gi·ªù</label>
    <select id="khung_gio">
      <option value="07-08">07-08</option>
      <option value="08-09">08-09</option>
      <option value="09-10">09-10</option>
      <option value="10-11">10-11</option>
      <option value="13-14">13-14</option>
      <option value="14-15">14-15</option>
      <option value="15-16">15-16</option>
      <option value="16-17">16-17</option>
    </select>

    <label>K·∫ø ho·∫°ch gi·ªù</label>
    <input type="number" id="ke_hoach_gio">

    <label>Th·ª±c t·∫ø</label>
    <input type="number" id="thuc_te">

    <label>Nguy√™n nh√¢n (n·∫øu c√≥)</label>
    <textarea id="nguyen_nhan"></textarea>

    <button onclick="saveHour()">üíæ L∆∞u gi·ªù</button>

    <div id="msg" style="margin-top:8px;color:#dc2626"></div>
  </div>

  <!-- ===== B·∫¢NG GI·ªú ===== -->
  <div class="card">
    <h3>üìä Gi·ªù ƒë√£ nh·∫≠p trong ng√†y</h3>
    <table>
      <thead>
        <tr>
          <th>Gi·ªù</th>
          <th>K·∫ø ho·∫°ch</th>
          <th>Th·ª±c t·∫ø</th>
          <th>HS (%)</th>
          <th>Nguy√™n nh√¢n</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

</div>

<script>
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const USER = JSON.parse(localStorage.getItem("USER"));

/* ===== CHECK QUY·ªÄN ===== */
if(!USER || USER.role !== "to_truong"){
  location.href = "../login.html";
}

/* ===== INIT ===== */
document.getElementById("info").innerText =
  `X∆∞·ªüng ${USER.xuong} | T·ªï ${USER.to_nhom}`;

const today = new Date().toISOString().slice(0,10);
document.getElementById("ngay").value = today;

loadHour();

/* ===== SAVE HOUR ===== */
function saveHour(){
  const d = {
    action:"saveHour",
    ngay: document.getElementById("ngay").value,
    khung_gio: document.getElementById("khung_gio").value,
    ke_hoach_gio: document.getElementById("ke_hoach_gio").value,
    thuc_te: document.getElementById("thuc_te").value,
    nguyen_nhan: document.getElementById("nguyen_nhan").value,
    xuong: USER.xuong,
    to_nhom: USER.to_nhom
  };

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(d)
  })
  .then(r=>r.json())
  .then(res=>{
    document.getElementById("msg").innerText =
      res.success ? "‚úÖ ƒê√£ l∆∞u" : res.msg;
    if(res.success) loadHour();
  });
}

/* ===== LOAD HOUR ===== */
function loadHour(){
  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"getHour",
      ngay: document.getElementById("ngay").value,
      xuong: USER.xuong,
      to_nhom: USER.to_nhom
    })
  })
  .then(r=>r.json())
  .then(res=>{
    const tb = document.getElementById("tb");
    tb.innerHTML = "";
    (res.data || []).forEach(r=>{
      tb.innerHTML += `
        <tr>
          <td>${r.khung_gio}</td>
          <td>${r.ke_hoach_gio}</td>
          <td>${r.thuc_te}</td>
          <td>${r.hieu_suat}</td>
          <td>${r.nguyen_nhan || ""}</td>
        </tr>`;
    });
  });
}

/* ===== LOGOUT ===== */
function logout(){
  localStorage.clear();
  location.href = "../login.html";
}
</script>

</body>
</html>
