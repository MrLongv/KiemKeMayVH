<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üë∑ T·ªï tr∆∞·ªüng ‚Äì Nh·∫≠p s·∫£n l∆∞·ª£ng gi·ªù</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f3f4f6;
}
header{
  background:#065f46;
  color:#fff;
  padding:12px 20px;
  font-size:18px;
}
.container{
  padding:20px;
}
.info{
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-bottom:15px;
}
.info b{ color:#065f46 }
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
  font-size:14px;
}
th{
  background:#e5e7eb;
}
input,select{
  width:100%;
  border:none;
  outline:none;
  text-align:center;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#2563eb;
  color:#fff;
}
.msg{
  margin-top:10px;
  font-weight:bold;
}
.ok{ color:#16a34a }
.err{ color:#dc2626 }
</style>
</head>

<body>

<header>üë∑ M√ÄN H√åNH T·ªî TR∆Ø·ªûNG</header>

<div class="container">

  <!-- TH√îNG TIN K·∫æ HO·∫†CH -->
  <div class="info" id="planInfo">
    ‚è≥ ƒêang t·∫£i k·∫ø ho·∫°ch...
  </div>

  <!-- NH·∫¨P GI·ªú -->
  <table>
    <thead>
      <tr>
        <th>Khung gi·ªù</th>
        <th>ƒêM gi·ªù</th>
        <th>Th·ª±c t·∫ø</th>
        <th>Hi·ªáu su·∫•t %</th>
        <th>Nguy√™n nh√¢n</th>
        <th>L∆∞u</th>
      </tr>
    </thead>
    <tbody id="tbody">
    </tbody>
  </table>

  <div id="msg" class="msg"></div>

</div>

<script>
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const user = JSON.parse(localStorage.getItem("USER")||"{}");

if(user.role !== "to"){
  alert("Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p");
  location.href="../login.html";
}

const ngay = new Date().toISOString().slice(0,10);
const xuong = user.xuong;
const to_nhom = user.to;

/* ===== LOAD K·∫æ HO·∫†CH ===== */
fetch(API_URL,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({
    action:"getPlan",
    ngay,
    xuong,
    to_nhom
  })
})
.then(r=>r.json())
.then(res=>{
  if(!res.success || !res.data){
    document.getElementById("planInfo").innerHTML =
      "‚ùå Ch∆∞a c√≥ k·∫ø ho·∫°ch ƒë·∫ßu ng√†y";
    return;
  }

  const p = res.data;

  document.getElementById("planInfo").innerHTML = `
    <b>T·ªï:</b> ${p.to_nhom} |
    <b>M√£ h√†ng:</b> ${p.ma_hang} |
    <b>ƒêM ng√†y:</b> ${p.dinh_muc_ngay} |
    <b>ƒêM gi·ªù:</b> ${p.dinh_muc_gio}
  `;

  buildRows(p.dinh_muc_gio);
});

/* ===== T·∫†O C√ÅC KHUNG GI·ªú ===== */
function buildRows(dm_gio){
  const hours = [
    "07:30-08:30","08:30-09:30","09:30-10:30",
    "10:30-11:30","13:00-14:00","14:00-15:00",
    "15:00-16:00","16:00-17:00"
  ];

  const tbody = document.getElementById("tbody");
  tbody.innerHTML="";

  hours.forEach(h=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${h}</td>
      <td>${dm_gio}</td>
      <td><input type="number" min="0"></td>
      <td class="hs">0%</td>
      <td><input></td>
      <td><button onclick="saveHour(this,'${h}',${dm_gio})">L∆∞u</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== T√çNH HS REALTIME ===== */
document.addEventListener("input",e=>{
  if(e.target.type==="number"){
    const tr=e.target.closest("tr");
    const dm=Number(tr.children[1].innerText||0);
    const tt=Number(e.target.value||0);
    const hs=dm>0?Math.round(tt/dm*100):0;
    tr.querySelector(".hs").innerText=hs+"%";
  }
});

/* ===== L∆ØU GI·ªú ===== */
function saveHour(btn,khung_gio,dm){
  const tr=btn.closest("tr");
  const thuc_te=Number(tr.querySelector("input[type=number]").value||0);
  const nguyen_nhan=tr.querySelectorAll("input")[1].value;

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"saveHour",
      ngay,
      xuong,
      to_nhom,
      khung_gio,
      ke_hoach_gio: dm,
      thuc_te,
      nguyen_nhan
    })
  })
  .then(r=>r.json())
  .then(res=>{
    const msg=document.getElementById("msg");
    if(res.success){
      msg.className="msg ok";
      msg.innerText="‚úÖ ƒê√£ l∆∞u "+khung_gio;
      btn.disabled=true;
    }else{
      msg.className="msg err";
      msg.innerText=res.msg||"L·ªói l∆∞u";
    }
  });
}
</script>

</body>
</html>
