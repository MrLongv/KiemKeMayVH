<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>üßµ Nh·∫≠p nƒÉng su·∫•t t·ªï</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f3f4f6;
}
header{
  background:#2563eb;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:600;
}
.box{
  background:#fff;
  margin:12px;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.info{
  font-size:14px;
  margin-bottom:10px;
}
.grid{
  display:grid;
  grid-template-columns: 100px 1fr 1fr 1fr 2fr;
  border:1px solid #ddd;
}
.grid div{
  border-bottom:1px solid #ddd;
  border-right:1px solid #ddd;
  padding:6px;
  font-size:14px;
  text-align:center;
}
.grid .head{
  background:#f1f5f9;
  font-weight:600;
}
input{
  width:90%;
  padding:4px;
}
select{
  width:95%;
}
button{
  padding:10px;
  border:none;
  border-radius:8px;
  background:#16a34a;
  color:#fff;
  width:100%;
  cursor:pointer;
}
.lock{
  background:#e5e7eb;
  color:#666;
}
.bad{color:#dc2626;font-weight:600}
.ok{color:#16a34a;font-weight:600}

.alert{
  background:#fee2e2;
  border:2px solid #dc2626;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}
</style>
</head>

<body>

<header>üßµ NH·∫¨P NƒÇNG SU·∫§T THEO GI·ªú</header>

<div class="box">
  <div class="info">
    <b>X∆∞·ªüng:</b> <span id="xuong"></span> |
    <b>T·ªï:</b> <span id="to"></span> |
    <b>Ng√†y:</b> <span id="ngay"></span>
  </div>

  <div class="grid" id="grid">
    <div class="head">Gi·ªù</div>
    <div class="head">K·∫ø ho·∫°ch</div>
    <div class="head">Th·ª±c t·∫ø</div>
    <div class="head">HS %</div>
    <div class="head">Nguy√™n nh√¢n</div>
  </div>

  <div id="alertBox" class="alert" style="display:none"></div>

  <button onclick="saveAll()">üíæ L∆ØU D·ªÆ LI·ªÜU</button>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const HOURS = [
  "07-08","08-09","09-10","10-11","11-12",
  "12-13","13-14","14-15","15-16","16-17"
];

/* ===== AUTH ===== */
const u = JSON.parse(localStorage.getItem("USER"));
if(!u || !["to_truong","to_pho"].includes(u.role)){
  location.href="../login.html";
}

/* ===== INIT ===== */
xuong.innerText = u.xuong;
to.innerText = u.to;
ngay.innerText = new Date().toISOString().slice(0,10);

const rows = [];

HOURS.forEach(h=>{
  const r = {
    gio:h, kh:0, tt:0, hs:0, reason:"", locked:false
  };
  rows.push(r);
  drawRow(r);
});

function drawRow(r){
  const g = document.getElementById("grid");

  const d1 = document.createElement("div");
  d1.innerText = r.gio;

  const d2 = document.createElement("div");
  const kh = document.createElement("input");
  kh.type="number";
  kh.oninput=()=>{ r.kh=+kh.value; calc(r); };
  d2.appendChild(kh);

  const d3 = document.createElement("div");
  const tt = document.createElement("input");
  tt.type="number";
  tt.oninput=()=>{ r.tt=+tt.value; calc(r); };
  d3.appendChild(tt);

  const d4 = document.createElement("div");
  d4.innerText="0";
  r.hsCell = d4;

  const d5 = document.createElement("div");
  const rs = document.createElement("select");
  ["","M√°y h∆∞","Thi·∫øu ph·ª• li·ªáu","Thi·∫øu ng∆∞·ªùi","Ch·ªù k·ªπ thu·∫≠t","Kh√°c"]
    .forEach(x=>{
      const o=document.createElement("option");
      o.text=x;
      rs.appendChild(o);
    });
  rs.onchange=()=>r.reason=rs.value;
  d5.appendChild(rs);

  g.append(d1,d2,d3,d4,d5);
}

function calc(r){
  if(r.kh>0){
    r.hs = Math.round(r.tt/r.kh*100);
    r.hsCell.innerText = r.hs;
    r.hsCell.className = r.hs<80?"bad":"ok";
  }
  checkAlert();
}

/* ===== ALERT 2 GI·ªú <80% ===== */
function checkAlert(){
  for(let i=1;i<rows.length;i++){
    if(rows[i].hs<80 && rows[i-1].hs<80 && rows[i].hs>0){
      alertBox.style.display="block";
      alertBox.innerHTML = `üö® C·∫¢NH B√ÅO: ${rows[i-1].gio} & ${rows[i].gio} ƒë·ªÅu < 80%`;
      return;
    }
  }
  alertBox.style.display="none";
}

/* ===== SAVE ===== */
function saveAll(){
  const today = ngay.innerText;

  rows.forEach(r=>{
    if(r.kh>0 && r.tt>0){
      fetch(API_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          action:"save",
          user:u.user,
          xuong:u.xuong,
          to:u.to,
          ngay:today,
          khung_gio:r.gio,
          ke_hoach:r.kh,
          thuc_te:r.tt,
          nguyen_nhan:r.reason
        })
      });
    }
  });

  alert("‚úî ƒê√£ g·ª≠i d·ªØ li·ªáu");
}
</script>

</body>
</html>
