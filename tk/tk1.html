<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TK1 ‚Äì Th·ªëng k√™ nƒÉng su·∫•t gi·ªù (XN1) ‚Ä¢ line_no</title>

<!-- ‚úÖ html2canvas: load s·ªõm ƒë·ªÉ b·∫•m n√∫t l√† d√πng ƒë∆∞·ª£c -->
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --bg:#f3f4f6;--card:#fff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
    --head:#eef2f7;--head2:#e5e7eb;--primary:#2563eb;
    --good:#16a34a;--warn:#f59e0b;--bad:#dc2626;--shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0b1b3a,#0e2552);color:#fff;padding:12px 14px;box-shadow:0 10px 24px rgba(0,0,0,.18)}
  .topbar .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .brand b{display:block}
  .brand span{font-size:12px;opacity:.85}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .ctl{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);padding:6px 8px;border-radius:12px}
  .ctl label{font-size:12px;opacity:.9}
  .ctl input,.ctl select{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;padding:6px 8px;border-radius:10px;outline:none;font-size:12px}
  .ctl select option{color:#111}
  .btn{border:none;background:var(--primary);color:#fff;padding:8px 10px;border-radius:12px;font-weight:800;cursor:pointer;font-size:12px}
  .btn.ghost{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.20)}
  .btn.warn{background:#f59e0b}
  .btn.danger{background:#dc2626}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .status{font-size:12px;opacity:.95;padding:6px 10px;background:rgba(255,255,255,.10);border:1px dashed rgba(255,255,255,.25);border-radius:12px;max-width:520px}

  /* ============================
     ‚úÖ CH·ªà ƒê·∫†O GƒêC (TICKER)
  ============================ */
  .gdc-ticker{
    position:sticky;
    top:64px;
    z-index:19;
    height:38px;
    display:none;
    align-items:center;
    overflow:hidden;
    background:#0e2552;
    color:#fff;
    box-shadow:0 8px 18px rgba(0,0,0,.16);
  }
  .gdc-ticker .label{
    flex:0 0 auto;height:100%;
    display:flex;align-items:center;
    padding:0 14px;font-weight:900;font-size:13px;
    background:#0b1b3a;border-right:1px solid rgba(255,255,255,.14);
  }
  .gdc-ticker .track{flex:1;overflow:hidden;white-space:nowrap;position:relative}
  .gdc-ticker .text{
    display:inline-block;padding-left:100%;
    font-weight:800;font-size:14px;line-height:38px;
    animation:gdc-marquee 22s linear infinite;will-change:transform;
  }
  @keyframes gdc-marquee{from{transform:translateX(0)}to{transform:translateX(-100%)}}
  .gdc-ticker .meta{
    flex:0 0 auto;height:100%;
    display:flex;align-items:center;gap:8px;
    padding:0 12px;font-size:12px;opacity:.9;
    border-left:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.08);
  }
  .gdc-ticker .dot{
    width:7px;height:7px;border-radius:999px;background:#22c55e;display:inline-block;
    box-shadow:0 0 0 4px rgba(34,197,94,.14);
  }
  .gdc-ticker .time{opacity:.9;font-variant-numeric:tabular-nums}

  .wrap{padding:14px}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px;margin-bottom:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .card .label{font-size:12px;color:var(--muted)}
  .card .value{font-size:20px;font-weight:900;margin-top:4px}
  .card .sub{font-size:12px;color:var(--muted);margin-top:2px}

  .tableWrap{background:#fff;border:1px solid var(--line);border-radius:16px;overflow:auto;box-shadow:var(--shadow)}
  table{width:max(1900px,100%);border-collapse:collapse;font-size:12.5px}
  th,td{border:1px solid var(--line);padding:6px;text-align:center;white-space:nowrap}
  thead tr:nth-child(1) th{background:var(--head);font-weight:900}
  thead tr:nth-child(2) th{background:var(--head2);font-weight:800}
  thead th{position:sticky;top:0;z-index:5}
  thead tr:nth-child(2) th{top:34px}

  /* sticky cols */
  .sticky1{position:sticky;left:0;z-index:6;background:#fff}
  .sticky2{position:sticky;left:45px;z-index:6;background:#fff}
  .sticky3{position:sticky;left:85px;z-index:6;background:#fff}
  thead .sticky1, thead .sticky2, thead .sticky3{z-index:10;background:var(--head)}
  thead tr:nth-child(2) .sticky1, thead tr:nth-child(2) .sticky2, thead tr:nth-child(2) .sticky3{background:var(--head2)}

  tbody tr:nth-child(even) td{background:#fafafa}
  .calc{font-weight:900}
  .pct{font-weight:900}
  .pct.good{color:var(--good)} .pct.warn{color:var(--warn)} .pct.bad{color:var(--bad)}

  tfoot td{background:#f1f5f9;font-weight:900}
  .small{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.4}

  input.cell{width:100%;border:none;outline:none;background:transparent;text-align:center;font:inherit;padding:6px}
  input.cell:focus{background:#fff7ed;box-shadow:inset 0 0 0 2px rgba(245,158,11,.35)}
  .ro{background:#f1f5f9 !important;color:#111827}

  .saveMini{padding:6px 8px;border-radius:10px;font-size:12px}
  .right{text-align:right}
  .left{text-align:left}

  .tagLine{
    font-size:11px;font-weight:900;
    display:inline-flex;align-items:center;justify-content:center;
    min-width:26px;height:22px;padding:0 8px;border-radius:999px;
    background:#0e2552;color:#fff;
  }
  .btnMini{padding:6px 8px;border-radius:10px;font-size:12px;font-weight:900;border:none;cursor:pointer;background:#111827;color:#fff}
  .btnMini.gray{background:#6b7280}

  /* FIX footer sticky */
  tfoot .sticky1, tfoot .sticky2, tfoot .sticky3{background:#f1f5f9; z-index:8;}

  /* =========================
     üì∏ CAPTURE: FIX M·∫§T N√âT CH·ªÆ
     - khi ch·ª•p: b·ªè sticky + overflow
     - tƒÉng line-height/padding ƒë·ªÉ kh√¥ng c·∫Øt baseline
  ========================= */
  body.capturing .tableWrap{ overflow: visible !important; }
  body.capturing thead th{ position: static !important; top:auto !important; }
  body.capturing .sticky1,
  body.capturing .sticky2,
  body.capturing .sticky3{ position: static !important; left:auto !important; }

  body.capturing #tbl th,
  body.capturing #tbl td{
    line-height: 1.35 !important;
    padding-top: 8px !important;
    padding-bottom: 8px !important;
  }

  .btn.capture{ background:#16a34a; }
</style>
</head>

<body>

<div class="topbar">
  <div class="row">
    <div class="brand">
      <b>üìä TK1 ‚Äì THEO D√ïI NƒÇNG SU·∫§T GI·ªú (XN1) ‚Ä¢ LINE_NO</b>
      <span id="roleHint">TK nh·∫≠p k·∫ø ho·∫°ch theo LINE ‚Ä¢ Gi·ªù do t·ªï tr∆∞·ªüng nh·∫≠p ‚Ä¢ GƒêX ch·ªâ xem</span>
    </div>

    <div class="controls">
      <div class="ctl">
        <label>Ch·∫ø ƒë·ªô</label>
        <select id="mode">
          <option value="day">Ng√†y</option>
          <option value="week">Tu·∫ßn</option>
          <option value="month">Th√°ng</option>
          <option value="quarter">Qu√Ω</option>
          <option value="year">NƒÉm</option>
        </select>
      </div>

      <div class="ctl">
        <label>Ng√†y</label>
        <input type="date" id="date" />
      </div>

      <button class="btn ghost" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      <button class="btn" onclick="reload()">T·∫£i d·ªØ li·ªáu</button>

      <!-- ‚úÖ N√öT CH·ª§P FULL B·∫¢NG -->
      <button class="btn capture" id="btnCapture" onclick="captureTable()">üì∏ Ch·ª•p full b·∫£ng (HD)</button>

      <button class="btn warn" id="btnSaveAll" onclick="saveAll()">L∆∞u t·∫•t c·∫£ KH</button>

      <div class="status" id="status">Ch∆∞a t·∫£i d·ªØ li·ªáu</div>
    </div>
  </div>
</div>

<div class="gdc-ticker" id="gdcTicker">
  <div class="label">üì£ CH·ªà ƒê·∫†O C·ª¶A GI√ÅM ƒê·ªêC C√îNG TY</div>
  <div class="track">
    <div class="text" id="gdcTickerText">‚Äî</div>
  </div>
  <div class="meta" title="T·ª± c·∫≠p nh·∫≠t m·ªói 30 gi√¢y">
    <span class="dot"></span>
    <span id="gdcTickerScope">‚Äî</span>
    <span class="time" id="gdcTickerTime">‚Äî</span>
  </div>
</div>

<div class="wrap">
  <div class="kpi">
    <div class="card">
      <div class="label">T·ªïng USD (∆∞·ªõc t√≠nh)</div>
      <div class="value" id="kpiUsd">0.00</div>
      <div class="sub">USD/TH = T·ªïng SP * ƒê∆°n gi√°</div>
    </div>
    <div class="card">
      <div class="label">T·ªïng SP</div>
      <div class="value" id="kpiSp">0</div>
      <div class="sub">C·ªông s·∫£n l∆∞·ª£ng t·∫•t c·∫£ line</div>
    </div>
    <div class="card">
      <div class="label">Hi·ªáu su·∫•t TB</div>
      <div class="value" id="kpiHs">0%</div>
      <div class="sub">TB theo line (d·ª±a ƒêM ng√†y)</div>
    </div>
    <div class="card">
      <div class="label">USD/gi·ªù cao nh·∫•t</div>
      <div class="value" id="kpiMax">0.00</div>
      <div class="sub">Trong 9 khung gi·ªù</div>
    </div>
  </div>

  <div class="tableWrap">
    <table id="tbl">
      <thead>
        <tr>
          <th class="sticky1" rowspan="2" style="min-width:54px;">T·ªî</th>
          <th class="sticky2" rowspan="2" style="min-width:78px;">LINE</th>
          <th class="sticky3" rowspan="2" style="min-width:130px;">M√É H√ÄNG</th>

          <th rowspan="2" style="min-width:90px;">SL KH</th>
          <th rowspan="2" style="min-width:90px;">ƒêM NG√ÄY</th>
          <th rowspan="2" style="min-width:90px;">ƒêM GI·ªú</th>
          <th rowspan="2" style="min-width:95px;">USD/QT</th>

          <th colspan="9">S·∫¢N L∆Ø·ª¢NG THEO GI·ªú</th>

          <th rowspan="2" style="min-width:90px;">T·ªîNG SP</th>
          <th rowspan="2" style="min-width:110px;">USD/TH</th>
          <th rowspan="2" style="min-width:105px;">HI·ªÜU SU·∫§T</th>

          <th colspan="2">LAO ƒê·ªòNG</th>

          <th rowspan="2" style="min-width:90px;">ƒêG</th>
          <th rowspan="2" style="min-width:90px;">TG/QT</th>
          <th rowspan="2" style="min-width:110px;">USD 80%</th>
          <th rowspan="2" style="min-width:110px;">USD 100%</th>
          <th rowspan="2" style="min-width:140px;">CHUY·ªÇN ƒê·ªîI/NG√ÄY</th>
          <th rowspan="2" style="min-width:220px;">GHI CH√ö</th>
          <th rowspan="2" style="min-width:150px;">THAO T√ÅC</th>
        </tr>
        <tr id="hourHead"></tr>
      </thead>

      <tbody id="tbody"></tbody>

      <tfoot>
        <!-- C·ªòNG USD: t·ªïng USD/QT + t·ªïng USD theo gi·ªù -->
        <tr>
          <td class="sticky1 left" style="padding-left:10px;">C·ªòNG USD</td>
          <td class="sticky2"></td>
          <td class="sticky3"></td>

          <td colspan="3"></td>

          <td id="usdQtSum" class="right">0.00</td>

          <td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td>
          <td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td><td class="usdGio right">0.00</td>

          <td colspan="11"></td>
        </tr>

        <!-- ‚úÖ ƒê√É X√ìA D√íNG ‚Äú∆Ø·ªöC T√çNH USD TRONG NG√ÄY‚Äù (b·ªã d∆∞, kh√¥ng d·ªØ li·ªáu) -->
      </tfoot>
    </table>
  </div>

  <div class="small" id="rangeInfo"></div>
  <div class="small">
    <b>Nghi·ªáp v·ª• line:</b> Khi T·ªï ƒë·ªïi sang m√£ m·ªõi trong ng√†y, TK b·∫•m <b>+</b> ·ªü c·ªôt LINE ƒë·ªÉ th√™m line_no m·ªõi.
  </div>
</div>

<script>
/* ================== CONFIG (TK1 c·ªë ƒë·ªãnh XN1) ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const XUONG = 1;
const TO_LIST = [1,3,5,7,9];
const HOURS = ["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"];
const KEY="NS_SESSION";

/* ================== FORMAT ================== */
const NF_INT   = new Intl.NumberFormat("en-US", { useGrouping:true, minimumFractionDigits:0, maximumFractionDigits:0 });
const NF_MONEY = new Intl.NumberFormat("en-US", { useGrouping:true, minimumFractionDigits:2, maximumFractionDigits:2 });
const NF_DG    = new Intl.NumberFormat("en-US", { useGrouping:false, minimumFractionDigits:0, maximumFractionDigits:2 });

function fmtInt(n){ return NF_INT.format(Math.round(Number(n)||0)); }
function fmtMoney(n){ return NF_MONEY.format(Number(n)||0); }
function fmtDg(n){ return NF_DG.format(Number(n)||0); }
function fmtPct1(n){ return (Number(n)||0).toFixed(1); }

function toNum(v){
  let s = String(v ?? "").trim();
  if(!s) return 0;
  s = s.replace(/\s+/g,"").replaceAll(",","");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

/* ================== SESSION ================== */
function sess(){ try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null} }
function mustLogin(){ const s=sess(); if(!s||!s.token){ location.href="../login.html"; return null;} return s; }
function logout(){ localStorage.removeItem(KEY); location.href="../login.html"; }

/* ================== UTIL ================== */
async function apiPost(payload){
  const r = await fetch(API_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload) });
  return await r.json();
}
function setStatus(t){ document.getElementById("status").innerText = t; }
function todayISO(){
  const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function pctClass(hs){
  if(hs>=95) return "good";
  if(hs>=80) return "warn";
  return "bad";
}

/* ================== STATE ================== */
let S = mustLogin();
let canEditPlan = false;

/* ================== GƒêC TICKER ================== */
let gdcTimer = null;
function fmtTickerTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const mo = String(d.getMonth()+1).padStart(2,"0");
  return `${dd}/${mo} ${hh}:${mm}`;
}
async function loadGdcTicker(){
  if(!S || !S.token) return;
  try{
    const resX = await apiPost({ action:"getDirectorMessage", token:S.token, xuong:XUONG });
    const resAll = await apiPost({ action:"getDirectorMessage", token:S.token, xuong:"ALL" });

    let picked = null;
    if(resX?.success && (resX.message||"").trim()) picked = resX;
    else if(resAll?.success && (resAll.message||"").trim()) picked = resAll;

    const box = document.getElementById("gdcTicker");
    const textEl = document.getElementById("gdcTickerText");
    const scopeEl = document.getElementById("gdcTickerScope");
    const timeEl = document.getElementById("gdcTickerTime");

    if(!picked){ box.style.display="none"; return; }
    const scope = String(picked.scope || "").toUpperCase();
    const msg = String(picked.message || "").trim();
    if(!msg){ box.style.display="none"; return; }

    box.style.display="flex";
    scopeEl.innerText = scope === "ALL" ? "ALL" : `XN${scope}`;
    timeEl.innerText = fmtTickerTime(picked.updated_at) || "‚Äî";

    textEl.style.animation="none"; textEl.offsetHeight;
    textEl.innerText = (scope === "ALL" ? "ALL: " : `XN${scope}: `) + msg;
    textEl.style.animation="gdc-marquee 22s linear infinite";
  }catch(e){
    console.warn("GDC ticker error:", e);
  }
}
function startGdcTicker(){ stopGdcTicker(); loadGdcTicker(); gdcTimer=setInterval(loadGdcTicker,30000); }
function stopGdcTicker(){ if(gdcTimer) clearInterval(gdcTimer); gdcTimer=null; }
window.addEventListener("beforeunload", stopGdcTicker);

/* ================== INIT UI ================== */
document.getElementById("date").value = todayISO();
document.getElementById("hourHead").innerHTML =
  HOURS.map(h=>`<th>${h}</th>`).join("") + `<th>TT</th><th>SƒêC</th>`;

if(S){
  if(S.role === "tk" && Number(S.xuong) === XUONG){
    canEditPlan = true;
    document.getElementById("roleHint").innerText = "‚úÖ TK1: ƒë∆∞·ª£c nh·∫≠p & l∆∞u k·∫ø ho·∫°ch theo LINE (XN1)";
  } else if(S.role === "gdx" && Number(S.xuong) === XUONG){
    canEditPlan = false;
    document.getElementById("roleHint").innerText = "üëÄ GƒêX1: ch·ªâ xem (XN1)";
  } else if(S.role === "gdc"){
    canEditPlan = false;
    document.getElementById("roleHint").innerText = "üëÄ GƒêC: ƒëang xem XN1";
  } else {
    canEditPlan = false;
    document.getElementById("roleHint").innerText = "‚õî Kh√¥ng ƒë√∫ng quy·ªÅn / sai x∆∞·ªüng";
  }
  document.getElementById("btnSaveAll").disabled = !canEditPlan;

  startGdcTicker();
  reload();
}

/* ================== RANGE ================== */
function getRange(mode, dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const yyyy = d.getFullYear();
  const mm = d.getMonth();
  const dd = d.getDate();
  const toISO = (x)=>{
    const m=String(x.getMonth()+1).padStart(2,"0");
    const da=String(x.getDate()).padStart(2,"0");
    return `${x.getFullYear()}-${m}-${da}`;
  };

  if(mode === "day") return { from: dateStr, to: dateStr, label:`Ng√†y ${dateStr}` };
  if(mode === "week"){
    const day = (d.getDay()+6)%7;
    const start = new Date(d); start.setDate(dd - day);
    const end = new Date(start); end.setDate(start.getDate()+6);
    return { from: toISO(start), to: toISO(end), label:`Tu·∫ßn ${toISO(start)} ‚Üí ${toISO(end)}` };
  }
  if(mode === "month"){
    const start = new Date(yyyy, mm, 1);
    const end = new Date(yyyy, mm+1, 0);
    return { from: toISO(start), to: toISO(end), label:`Th√°ng ${yyyy}-${String(mm+1).padStart(2,"0")}` };
  }
  if(mode === "quarter"){
    const q = Math.floor(mm/3);
    const start = new Date(yyyy, q*3, 1);
    const end = new Date(yyyy, q*3+3, 0);
    return { from: toISO(start), to: toISO(end), label:`Qu√Ω ${q+1}/${yyyy}` };
  }
  const start = new Date(yyyy, 0, 1);
  const end = new Date(yyyy, 12, 0);
  return { from: toISO(start), to: toISO(end), label:`NƒÉm ${yyyy}` };
}

/* ================== MAIN LOAD ================== */
async function reload(){
  S = mustLogin(); if(!S) return;

  const allowed = (
    (S.role==="tk" && Number(S.xuong)===XUONG) ||
    (S.role==="gdx" && Number(S.xuong)===XUONG) ||
    (S.role==="gdc")
  );

  if(!allowed){
    setStatus("‚õî B·∫°n kh√¥ng c√≥ quy·ªÅn m·ªü TK1 ho·∫∑c sai x∆∞·ªüng");
    clearAll();
    return;
  }

  const mode = document.getElementById("mode").value;
  const date = document.getElementById("date").value;
  const range = getRange(mode, date);

  document.getElementById("rangeInfo").innerText = `B·ªô l·ªçc: ${range.label} ‚Ä¢ X∆∞·ªüng: XN${XUONG}`;

  if(mode === "day"){
    await loadDayDetail(date);
  } else {
    await loadRangeSummary(range.from, range.to);
  }
}

function clearAll(){
  document.getElementById("tbody").innerHTML = "";
  document.getElementById("usdQtSum").innerText = "0.00";
  document.querySelectorAll(".usdGio").forEach(td=> td.innerText="0.00");
  setKpi(0,0,0,0);
}

function setKpi(usd, sp, hs, max){
  document.getElementById("kpiUsd").innerText = fmtMoney(usd);
  document.getElementById("kpiSp").innerText = fmtInt(sp);
  document.getElementById("kpiHs").innerText = fmtPct1(hs) + "%";
  document.getElementById("kpiMax").innerText = fmtMoney(max);
}

/* ================== DAY DETAIL ================== */
async function loadDayDetail(ngay){
  setStatus("ƒêang t·∫£i b·∫£ng ng√†y...");

  const res = await apiPost({ action:"getTkXuongDay", token:S.token, ngay, xuong:XUONG });
  if(!res.success){
    setStatus("L·ªói: " + (res.msg||""));
    clearAll();
    return;
  }

  const got = Array.isArray(res.rows) ? res.rows : [];
  const rows = [];
  for(const to of TO_LIST){
    const list = got.filter(r => Number(r.to_nhom)===Number(to))
                    .sort((a,b)=>Number(a.line_no||1)-Number(b.line_no||1));
    if(list.length) rows.push(...list.map(x=>normalizeRow(to, x)));
    else rows.push(normalizeRow(to, { to_nhom:to, line_no:1, hours:Array(HOURS.length).fill(0) }));
  }

  renderDayRows(rows);
  calcFooterAndKpi(rows);

  setStatus(`ƒê√£ t·∫£i ‚Ä¢ ${ngay} ‚Ä¢ XN${XUONG} ‚Ä¢ ${canEditPlan ? "TK nh·∫≠p KH" : "Ch·ªâ xem"}`);
}

function normalizeRow(to, r){
  const out = { ...r };
  out.to_nhom = Number(to);
  out.line_no = Number(r.line_no || 1);
  if(!Array.isArray(out.hours)) out.hours = Array(HOURS.length).fill(0);
  if(out.hours.length !== HOURS.length) out.hours = Array(HOURS.length).fill(0);
  return out;
}

function renderDayRows(rows){
  const tb = document.getElementById("tbody");
  tb.innerHTML = rows.map(r=>{
    const hours = r.hours || Array(HOURS.length).fill(0);
    const tongSP = hours.reduce((a,b)=>a+toNum(b),0);

    const dmNgay = toNum(r.dinh_muc_ngay);
    const dg = toNum(r.don_gia);

    const dmGio = (dmNgay ? dmNgay/9 : 0);
    const usdQt = (dmNgay>0 && dg>0) ? (dmNgay*dg) : 0;

    const usdTh = tongSP * dg;
    const hs = dmNgay ? (tongSP/dmNgay*100) : 0;

    const usd100 = dmNgay * dg;
    const usd80 = usd100 * 0.8;

    const ro = canEditPlan ? "" : "ro";

    return `
      <tr data-to="${r.to_nhom}" data-line="${r.line_no}">
        <td class="sticky1"><b>${r.to_nhom}</b></td>

        <td class="sticky2 left" style="padding-left:8px;">
          <span class="tagLine">L${r.line_no}</span>
          ${canEditPlan
            ? `<button class="btnMini gray" style="margin-left:6px" title="Th√™m line" onclick="addLine(${r.to_nhom})">+</button>`
            : `<span style="margin-left:6px;color:#6b7280;font-size:12px">‚Äî</span>`
          }
        </td>

        <td class="sticky3">
          <input class="cell ${ro} ma_hang" ${canEditPlan?"":"readonly"} value="${escapeHtml(r.ma_hang||"")}" />
        </td>

        <td><input class="cell ${ro} so_luong_ke_hoach" ${canEditPlan?"":"readonly"} inputmode="numeric" value="${fmtInt(r.so_luong_ke_hoach||0)}" /></td>
        <td><input class="cell ${ro} dinh_muc_ngay" ${canEditPlan?"":"readonly"} inputmode="numeric" value="${fmtInt(dmNgay)}" /></td>

        <td><input class="cell ro right dinh_muc_gio" readonly value="${fmtMoney(dmGio)}" /></td>
        <td><input class="cell ro right usd_quy_trinh" readonly value="${fmtMoney(usdQt)}" /></td>

        ${hours.map(v=>`<td>${fmtInt(v||0)}</td>`).join("")}

        <td class="calc">${fmtInt(tongSP)}</td>
        <td class="calc right">${fmtMoney(usdTh)}</td>
        <td class="pct ${pctClass(hs)}">${fmtPct1(hs)}%</td>

        <td><input class="cell ${ro} lao_dong_thuc_te" ${canEditPlan?"":"readonly"} inputmode="numeric" value="${fmtInt(r.lao_dong_thuc_te||0)}" /></td>
        <td><input class="cell ${ro} lao_dong_chuyen" ${canEditPlan?"":"readonly"} inputmode="numeric" value="${fmtInt(r.lao_dong_chuyen||0)}" /></td>

        <td><input class="cell ${ro} right don_gia" ${canEditPlan?"":"readonly"} inputmode="decimal" value="${fmtDg(dg)}" /></td>
        <td><input class="cell ${ro} right thoi_gian_giay" ${canEditPlan?"":"readonly"} inputmode="numeric" value="${fmtInt(r.thoi_gian_giay||0)}" /></td>

        <td class="calc right">${fmtMoney(usd80)}</td>
        <td class="calc right">${fmtMoney(usd100)}</td>

        <td><input class="cell ${ro} chuyen_doi_ngay" ${canEditPlan?"":"readonly"} inputmode="numeric" value="${fmtInt(r.chuyen_doi_ngay||0)}" /></td>

        <td class="left" style="padding-left:6px;">
          <input class="cell ${ro} ghi_chu" ${canEditPlan?"":"readonly"} style="text-align:left" value="${escapeHtml(r.ghi_chu||"")}" />
        </td>

        <td>
          ${canEditPlan
            ? `<button class="btn saveMini" onclick="savePlanRow(${r.to_nhom},${r.line_no})">L∆∞u</button>
               ${Number(r.line_no) > 1
                 ? `<button class="btn danger saveMini" style="margin-left:6px" onclick="deleteLine(${r.to_nhom},${r.line_no})">X√≥a</button>`
                 : ``
               }`
            : "‚Äî"
          }
        </td>
      </tr>
    `;
  }).join("");
}

function calcFooterAndKpi(rows){
  let tongUsdNgay=0, tongSpAll=0, hsSum=0, hsCount=0;
  let tongUsdQt=0;
  const usdGio = Array(HOURS.length).fill(0);

  rows.forEach(r=>{
    const hours = r.hours || Array(HOURS.length).fill(0);
    const tongSP = hours.reduce((a,b)=>a+toNum(b),0);
    tongSpAll += tongSP;

    const dmNgay = toNum(r.dinh_muc_ngay);
    const dg = toNum(r.don_gia);

    const usdQt = (dmNgay>0 && dg>0) ? (dmNgay*dg) : 0;
    tongUsdQt += usdQt;

    hours.forEach((v,i)=> usdGio[i] += toNum(v)*dg);

    const usdTh = tongSP*dg;
    tongUsdNgay += usdTh;

    const hs = dmNgay ? (tongSP/dmNgay*100) : 0;
    hsSum += hs; hsCount++;
  });

  document.getElementById("usdQtSum").innerText = fmtMoney(tongUsdQt);
  document.querySelectorAll(".usdGio").forEach((td,i)=> td.innerText = fmtMoney(usdGio[i]||0));

  const maxUsdGio = usdGio.length ? Math.max(...usdGio) : 0;
  const hsTb = hsCount ? (hsSum/hsCount) : 0;
  setKpi(tongUsdNgay, tongSpAll, hsTb, maxUsdGio);
}

/* ================== ADD LINE (UI only) ================== */
function addLine(to){
  if(!canEditPlan) return;

  const trs = [...document.querySelectorAll(`#tbody tr[data-to="${to}"]`)];
  let maxLine = 0;
  for(const tr of trs) maxLine = Math.max(maxLine, Number(tr.dataset.line||1));
  const newLine = maxLine + 1;

  const blank = {
    to_nhom: to, line_no: newLine,
    ma_hang: "", so_luong_ke_hoach: 0, dinh_muc_ngay: 0,
    don_gia: 0, lao_dong_thuc_te: 0, lao_dong_chuyen: 0,
    thoi_gian_giay: 0, chuyen_doi_ngay: 0, ghi_chu: "",
    hours: Array(HOURS.length).fill(0)
  };

  const tbody = document.getElementById("tbody");
  const last = trs[trs.length-1];

  const tmp = document.createElement("tbody");
  tmp.innerHTML = renderRowHtml(blank);
  const newTr = tmp.firstElementChild;

  if(last && last.nextSibling) tbody.insertBefore(newTr, last.nextSibling);
  else tbody.appendChild(newTr);
}

function renderRowHtml(r){
  const hours = r.hours || Array(HOURS.length).fill(0);
  return `
    <tr data-to="${r.to_nhom}" data-line="${r.line_no}">
      <td class="sticky1"><b>${r.to_nhom}</b></td>
      <td class="sticky2 left" style="padding-left:8px;">
        <span class="tagLine">L${r.line_no}</span>
        <button class="btnMini gray" style="margin-left:6px" title="Th√™m line" onclick="addLine(${r.to_nhom})">+</button>
      </td>
      <td class="sticky3"><input class="cell ma_hang" value="" /></td>
      <td><input class="cell so_luong_ke_hoach" inputmode="numeric" value="0" /></td>
      <td><input class="cell dinh_muc_ngay" inputmode="numeric" value="0" /></td>
      <td><input class="cell ro right dinh_muc_gio" readonly value="0.00" /></td>
      <td><input class="cell ro right usd_quy_trinh" readonly value="0.00" /></td>
      ${hours.map(_=>`<td>0</td>`).join("")}
      <td class="calc">0</td>
      <td class="calc right">0.00</td>
      <td class="pct bad">0.0%</td>
      <td><input class="cell lao_dong_thuc_te" inputmode="numeric" value="0" /></td>
      <td><input class="cell lao_dong_chuyen" inputmode="numeric" value="0" /></td>
      <td><input class="cell right don_gia" inputmode="decimal" value="0" /></td>
      <td><input class="cell right thoi_gian_giay" inputmode="numeric" value="0" /></td>
      <td class="calc right">0.00</td>
      <td class="calc right">0.00</td>
      <td><input class="cell chuyen_doi_ngay" inputmode="numeric" value="0" /></td>
      <td class="left" style="padding-left:6px;"><input class="cell ghi_chu" style="text-align:left" value="" /></td>
      <td>
        <button class="btn saveMini" onclick="savePlanRow(${r.to_nhom},${r.line_no})">L∆∞u</button>
        <button class="btn danger saveMini" style="margin-left:6px" onclick="deleteLine(${r.to_nhom},${r.line_no})">X√≥a</button>
      </td>
    </tr>
  `;
}

/* ================== SAVE PLAN ================== */
async function savePlanRow(to_nhom, line_no){
  if(!canEditPlan){ setStatus("B·∫°n kh√¥ng c√≥ quy·ªÅn l∆∞u k·∫ø ho·∫°ch"); return; }

  const ngay = document.getElementById("date").value;
  const tr = document.querySelector(`tr[data-to="${to_nhom}"][data-line="${line_no}"]`);
  if(!tr){ setStatus(`Kh√¥ng t√¨m th·∫•y d√≤ng t·ªï ${to_nhom} line ${line_no}`); return; }

  const payload = {
    action:"savePlan",
    token:S.token,
    ngay, xuong:XUONG, to_nhom:Number(to_nhom), line_no:Number(line_no),

    ma_hang: tr.querySelector(".ma_hang").value.trim(),
    so_luong_ke_hoach: toNum(tr.querySelector(".so_luong_ke_hoach").value),
    dinh_muc_ngay: toNum(tr.querySelector(".dinh_muc_ngay").value),

    lao_dong_thuc_te: toNum(tr.querySelector(".lao_dong_thuc_te").value),
    lao_dong_chuyen: toNum(tr.querySelector(".lao_dong_chuyen").value),

    don_gia: toNum(tr.querySelector(".don_gia").value),
    thoi_gian_giay: Math.round(toNum(tr.querySelector(".thoi_gian_giay").value)),

    chuyen_doi_ngay: toNum(tr.querySelector(".chuyen_doi_ngay").value),
    ghi_chu: tr.querySelector(".ghi_chu").value.trim()
  };

  setStatus(`ƒêang l∆∞u KH t·ªï ${to_nhom} ‚Ä¢ line ${line_no}...`);
  const res = await apiPost(payload);
  if(!res.success){ setStatus("L·ªói l∆∞u: " + (res.msg||"")); return; }

  setStatus(`‚úÖ ƒê√£ l∆∞u KH t·ªï ${to_nhom} ‚Ä¢ line ${line_no}`);
  await reload();
}

async function saveAll(){
  if(!canEditPlan){ setStatus("B·∫°n kh√¥ng c√≥ quy·ªÅn l∆∞u k·∫ø ho·∫°ch"); return; }
  const ngay = document.getElementById("date").value;

  setStatus("ƒêang l∆∞u t·∫•t c·∫£ k·∫ø ho·∫°ch...");
  const trs = [...document.querySelectorAll("#tbody tr")];

  for(const tr of trs){
    const to = Number(tr.dataset.to);
    const line = Number(tr.dataset.line||1);

    const payload = {
      action:"savePlan",
      token:S.token,
      ngay, xuong:XUONG, to_nhom:to, line_no:line,

      ma_hang: tr.querySelector(".ma_hang")?.value?.trim() || "",
      so_luong_ke_hoach: toNum(tr.querySelector(".so_luong_ke_hoach")?.value),
      dinh_muc_ngay: toNum(tr.querySelector(".dinh_muc_ngay")?.value),

      lao_dong_thuc_te: toNum(tr.querySelector(".lao_dong_thuc_te")?.value),
      lao_dong_chuyen: toNum(tr.querySelector(".lao_dong_chuyen")?.value),

      don_gia: toNum(tr.querySelector(".don_gia")?.value),
      thoi_gian_giay: Math.round(toNum(tr.querySelector(".thoi_gian_giay")?.value)),

      chuyen_doi_ngay: toNum(tr.querySelector(".chuyen_doi_ngay")?.value),
      ghi_chu: tr.querySelector(".ghi_chu")?.value?.trim() || ""
    };

    const isAllEmpty = !payload.ma_hang && payload.so_luong_ke_hoach===0 && payload.dinh_muc_ngay===0 && payload.don_gia===0;
    if(isAllEmpty) continue;

    const res = await apiPost(payload);
    if(!res.success){ setStatus(`L·ªói t·∫°i t·ªï ${to} line ${line}: ${res.msg||""}`); return; }
  }

  setStatus("‚úÖ ƒê√£ l∆∞u t·∫•t c·∫£ k·∫ø ho·∫°ch");
  await reload();
}

async function deleteLine(to_nhom, line_no){
  if(!canEditPlan) return;
  if(!confirm(`X√≥a k·∫ø ho·∫°ch T·ªï ${to_nhom} ‚Ä¢ Line ${line_no} ?`)) return;

  const ngay = document.getElementById("date").value;
  setStatus(`ƒêang x√≥a t·ªï ${to_nhom} line ${line_no}...`);

  const res = await apiPost({
    action:"deletePlanLine",
    token:S.token,
    ngay, xuong:XUONG, to_nhom:Number(to_nhom), line_no:Number(line_no)
  });

  if(!res.success){ setStatus("L·ªói x√≥a: " + (res.msg||"")); return; }
  setStatus(`‚úÖ ƒê√£ x√≥a t·ªï ${to_nhom} line ${line_no}`);
  await reload();
}

/* ================== RANGE SUMMARY (KPI only) ================== */
async function loadRangeSummary(from, to){
  setStatus("ƒêang t·∫£i t·ªïng h·ª£p kho·∫£ng...");

  const res = await apiPost({ action:"getDayRangeByXuong", token:S.token, xuong:XUONG, from, to });
  if(!res.success){
    setStatus("L·ªói: " + (res.msg||""));
    clearAll();
    return;
  }

  const data = res.data || [];
  let tongSp=0, tongKe=0;
  data.forEach(r=>{ tongSp += toNum(r.tong_sp); tongKe += toNum(r.dinh_muc_ngay); });

  const hs = tongKe>0 ? (tongSp/tongKe*100) : 0;
  setKpi(0, tongSp, hs, 0);

  document.getElementById("tbody").innerHTML = "";
  document.getElementById("usdQtSum").innerText = "0.00";
  document.querySelectorAll(".usdGio").forEach(td=> td.innerText="0.00");

  setStatus(`ƒê√£ t·∫£i t·ªïng h·ª£p ‚Ä¢ ${from} ‚Üí ${to} ‚Ä¢ XN${XUONG}`);
}

/* ================== EVENTS ================== */
document.getElementById("date").addEventListener("change", reload);
document.getElementById("mode").addEventListener("change", reload);

/* auto-calc dm_gio & usd_qt khi TK s·ª≠a dm_ngay/don_gia */
document.addEventListener("input",(e)=>{
  const t = e.target;
  if(!t) return;
  const tr = t.closest("tr");
  if(!tr) return;

  if(t.classList.contains("dinh_muc_ngay") || t.classList.contains("don_gia")){
    const dmNgay = toNum(tr.querySelector(".dinh_muc_ngay")?.value);
    const dg = toNum(tr.querySelector(".don_gia")?.value);

    const dmGio = dmNgay ? dmNgay/9 : 0;
    const usdQt = (dmNgay>0 && dg>0) ? dmNgay*dg : 0;

    const dmGioEl = tr.querySelector(".dinh_muc_gio");
    const usdQtEl = tr.querySelector(".usd_quy_trinh");
    if(dmGioEl) dmGioEl.value = fmtMoney(dmGio);
    if(usdQtEl) usdQtEl.value = fmtMoney(usdQt);

    const dgEl = tr.querySelector(".don_gia");
    if(dgEl && document.activeElement !== dgEl){
      dgEl.value = fmtDg(dg);
    }
  }
});

/* =========================
   üì∏ CH·ª§P FULL B·∫¢NG (HD) ‚Äî FIX M·∫§T N√âT CH·ªÆ
   - D·ª©t ƒëi·ªÉm: ƒë·ªïi input.cell -> span text trong b·∫£n clone
========================= */
async function captureTable(){
  const btn = document.getElementById("btnCapture");
  const status = document.getElementById("status");
  const table = document.getElementById("tbl");
  const wrap = document.querySelector(".tableWrap");
  if(!table || !wrap) return;

  try{
    btn.disabled = true;
    const oldStatus = status.innerText;
    status.innerText = "üì∏ ƒêang ch·ª•p full b·∫£ng (HD, ch·ªØ kh√¥ng r·ª•ng)...";

    if(typeof window.html2canvas !== "function"){
      status.innerText = "‚ùå html2canvas ch∆∞a t·∫£i (CDN ch·∫≠m ho·∫∑c b·ªã ch·∫∑n).";
      return;
    }

    const oldScrollLeft = wrap.scrollLeft;
    const oldScrollTop  = wrap.scrollTop;

    document.body.classList.add("capturing");
    wrap.scrollLeft = 0;
    wrap.scrollTop  = 0;
    await new Promise(r=>setTimeout(r, 160));

    const w = Math.ceil(table.scrollWidth);
    const h = Math.ceil(table.scrollHeight);

    const canvas = await html2canvas(table, {
      backgroundColor: "#ffffff",
      scale: 4,                 // ‚úÖ scale cao + s·ªë nguy√™n -> ch·ªØ s·∫Øc h∆°n
      width: w,
      height: h,
      windowWidth: w,
      windowHeight: h,
      scrollX: 0,
      scrollY: 0,
      useCORS: true,
      allowTaint: false,
      letterRendering: true,

      onclone: (doc) => {
        doc.body.classList.add("capturing");

        const wrapClone = doc.querySelector(".tableWrap");
        if(wrapClone) wrapClone.style.overflow = "visible";

        // b·ªè sticky trong clone
        doc.querySelectorAll("thead th").forEach(th=>{
          th.style.position = "static";
          th.style.top = "auto";
        });
        doc.querySelectorAll(".sticky1,.sticky2,.sticky3").forEach(td=>{
          td.style.position = "static";
          td.style.left = "auto";
        });

        // ‚úÖ FIX CH√çNH: input.cell -> span text
        const inputs = doc.querySelectorAll("input.cell");
        inputs.forEach(inp=>{
          const span = doc.createElement("span");
          span.textContent = inp.value ?? "";

          const cs = doc.defaultView.getComputedStyle(inp);
          span.style.display = "block";
          span.style.width = "100%";
          span.style.boxSizing = "border-box";
          span.style.font = cs.font;
          span.style.fontSize = cs.fontSize;
          span.style.fontWeight = cs.fontWeight;
          span.style.color = cs.color;
          span.style.textAlign = cs.textAlign;
          span.style.whiteSpace = "nowrap";
          span.style.paddingLeft = cs.paddingLeft;
          span.style.paddingRight = cs.paddingRight;
          span.style.background = cs.backgroundColor;

          span.style.lineHeight = "1.35";
          span.style.paddingTop = "8px";
          span.style.paddingBottom = "8px";

          inp.replaceWith(span);
        });

        // √©p line-height/padding cho cell
        doc.querySelectorAll("#tbl th, #tbl td").forEach(el=>{
          el.style.lineHeight = "1.35";
          el.style.paddingTop = "8px";
          el.style.paddingBottom = "8px";
        });
      }
    });

    const mode = document.getElementById("mode")?.value || "day";
    const date = document.getElementById("date")?.value || "";
    const fileName = `TK1_XN1_${mode}_${date || "capture"}_HD.png`;

    await new Promise((resolve, reject)=>{
      canvas.toBlob((blob)=>{
        if(!blob){ reject(new Error("toBlob failed")); return; }
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        resolve();
      }, "image/png");
    });

    document.body.classList.remove("capturing");
    wrap.scrollLeft = oldScrollLeft;
    wrap.scrollTop  = oldScrollTop;

    status.innerText = "‚úÖ ƒê√£ ch·ª•p ·∫£nh HD: " + fileName;
    setTimeout(()=>{ status.innerText = oldStatus; }, 2500);
  }catch(err){
    console.error(err);
    document.body.classList.remove("capturing");
    status.innerText = "‚ùå Ch·ª•p ·∫£nh th·∫•t b·∫°i (xem console).";
  }finally{
    btn.disabled = false;
  }
}
</script>

</body>
</html>
