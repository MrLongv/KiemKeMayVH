<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TH·ªêNG K√ä XN1</title>

<style>
body{
  font-family: Arial, Helvetica, sans-serif;
  margin:0;
  background:#f2f4f7;
}
h2{
  margin:10px;
}

/* ===== TABLE ===== */
table{
  border-collapse:collapse;
  width:100%;
  background:#fff;
}
th, td{
  border:1px solid #bfc4c9;
  padding:4px;
  font-size:13px;
  text-align:center;
  white-space:nowrap;
}
th{
  background:#e9ecef;
  font-weight:bold;
}

/* ===== INPUT ===== */
input{
  width:100%;
  border:none;
  outline:none;
  text-align:center;
  background:transparent;
}

/* ===== STICKY (C·ªê ƒê·ªäNH NH∆Ø EXCEL) ===== */
.stt   { position:sticky; left:0;   background:#fff; z-index:3 }
.to    { position:sticky; left:40px;background:#fff; z-index:3 }
.ma    { position:sticky; left:90px;background:#fff; z-index:3 }
.ten   { position:sticky; left:170px;background:#fff; z-index:3 }
.dm    { position:sticky; left:340px;background:#fff; z-index:3 }
.kh    { position:sticky; left:420px;background:#fff; z-index:3 }

/* ===== M√ÄU ===== */
.good{ background:#c8f7c5 }
.bad{ background:#f7c5c5 }
.readonly{
  background:#f1f3f5;
  font-weight:bold;
}

/* ===== HEADER C·ªê ƒê·ªäNH ===== */
thead th{
  position:sticky;
  top:0;
  z-index:5;
}
</style>
</head>

<body>

<h2>üìä TH·ªêNG K√ä S·∫¢N XU·∫§T ‚Äì XN1</h2>

<table id="tbl">
<thead>
<tr>
  <th class="stt">STT</th>
  <th class="to">T·ªî</th>
  <th class="ma">M√É H√ÄNG</th>
  <th class="ten">T√äN H√ÄNG</th>
  <th class="dm">ƒêM / GI·ªú</th>
  <th class="kh">KH NG√ÄY</th>

  <th>07-08</th>
  <th>08-09</th>
  <th>09-10</th>
  <th>10-11</th>
  <th>13-14</th>
  <th>14-15</th>
  <th>15-16</th>
  <th>16-17</th>

  <th>T·ªîNG</th>
  <th>HS %</th>
  <th>GHI CH√ö</th>
</tr>
</thead>

<tbody id="body"></tbody>
</table>

<script>
/* ================= C·∫§U H√åNH ================= */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const XUONG = 1;
const NGAY = new Date().toISOString().slice(0,10);
const GIO = ["07-08","08-09","09-10","10-11","13-14","14-15","15-16","16-17"];
const SO_TO = 10;

/* ================= T·∫†O KHUNG B·∫¢NG ================= */
const body = document.getElementById("body");

for(let to=1; to<=SO_TO; to++){
  const tr = document.createElement("tr");
  tr.dataset.to = to;

  tr.innerHTML = `
    <td class="stt">${to}</td>
    <td class="to">T·ªï ${to}</td>
    <td class="ma"><input></td>
    <td class="ten"><input></td>
    <td class="dm"><input class="dm_gio"></td>
    <td class="kh"><input></td>

    ${GIO.map(()=>`<td class="gio">0</td>`).join("")}

    <td class="tong readonly">0</td>
    <td class="hs readonly"></td>
    <td><input></td>
  `;
  body.appendChild(tr);
}

/* ================= LOAD S·∫¢N L∆Ø·ª¢NG THEO GI·ªú ================= */
fetch(API_URL,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({
    action:"getHourByXuong",
    ngay: NGAY,
    xuong: XUONG
  })
})
.then(r=>r.json())
.then(res=>{
  if(!res.success) return;

  res.data.forEach(d=>{
    const row = document.querySelector(`tr[data-to="${d.to_nhom}"]`);
    if(!row) return;

    const idx = GIO.indexOf(d.khung_gio);
    if(idx >= 0){
      row.querySelectorAll(".gio")[idx].innerText = d.thuc_te;
    }

    tinhDong(row);
  });
});

/* ================= T√çNH T·ªîNG & HI·ªÜU SU·∫§T ================= */
function tinhDong(row){
  let tong = 0;
  row.querySelectorAll(".gio").forEach(td=>{
    tong += Number(td.innerText || 0);
  });
  row.querySelector(".tong").innerText = tong;

  const dm = Number(row.querySelector(".dm_gio").value || 0);
  const hsCell = row.querySelector(".hs");

  if(dm > 0){
    const hs = Math.round(tong / dm * 100);
    hsCell.innerText = hs;
    hsCell.className = "hs readonly " + (hs >= 100 ? "good" : "bad");
  }else{
    hsCell.innerText = "";
    hsCell.className = "hs readonly";
  }
}
</script>

</body>
</html>
