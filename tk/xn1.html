<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TH·ªêNG K√ä XN1</title>

<style>
body{font-family:Arial;margin:0;background:#f2f4f7}
h2{margin:10px}
table{border-collapse:collapse;width:100%;background:#fff}
th,td{
  border:1px solid #bfc4c9;
  padding:4px;
  font-size:13px;
  text-align:center;
  white-space:nowrap;
}
th{background:#e9ecef;font-weight:bold}
input{width:100%;border:none;outline:none;text-align:center;background:transparent}
thead th{position:sticky;top:0;z-index:5}
.readonly{background:#f1f3f5;font-weight:bold}
.total-row{background:#dee2e6;font-weight:bold}
.good{background:#c8f7c5}
.bad{background:#f7c5c5}
</style>
</head>

<body>

<h2>üìä TH·ªêNG K√ä S·∫¢N XU·∫§T ‚Äì XN1</h2>

<table id="tbl">
<thead>
<tr>
  <th>T·ªî</th><th>M√É H√ÄNG</th><th>SL</th>
  <th>ƒêM NG√ÄY</th><th>ƒêM GI·ªú</th><th>USD/QT</th>
  <th>7-8</th><th>8-9</th><th>9-10</th><th>10-11</th>
  <th>12-13</th><th>13-14</th><th>14-15</th><th>15-16</th><th>16-17</th>
  <th>C·ªòNG SP</th><th>USD/TH</th><th>HS%</th>
  <th>Lƒê TT</th><th>Lƒê SƒêC</th>
  <th>USD NG√ÄY 100%</th><th>∆Ø·ªöC T√çNH USD NG√ÄY</th>
</tr>
</thead>

<tbody id="body"></tbody>

<tfoot>
<tr class="total-row">
  <td colspan="6">T·ªîNG S·∫¢N L∆Ø·ª¢NG GI·ªú</td>
  <td id="t78">0</td><td id="t89">0</td><td id="t910">0</td><td id="t1011">0</td>
  <td id="t1213">0</td><td id="t1314">0</td><td id="t1415">0</td><td id="t1516">0</td><td id="t1617">0</td>
  <td id="tsp">0</td><td id="tusd">0</td><td></td><td colspan="3"></td>
</tr>

<tr class="total-row">
  <td colspan="21">T·ªîNG USD / TH·ª∞C T·∫æ</td>
  <td id="tusdngay">0</td>
</tr>
</tfoot>
</table>

<script>
const API_URL="URL_WORKER";
const NGAY=new Date().toISOString().slice(0,10);
const GIO=["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"];
const body=document.getElementById("body");

/* ==== T·∫†O 10 T·ªî ==== */
for(let i=1;i<=10;i++){
  const tr=document.createElement("tr");
  tr.dataset.to=i;
  tr.innerHTML=`
    <td>T·ªï ${i}</td>
    <td><input></td><td><input></td>
    <td><input></td><td><input class="dm"></td><td><input class="usdqt"></td>
    ${GIO.map(()=>`<td class="gio">0</td>`).join("")}
    <td class="tong readonly">0</td>
    <td class="usd readonly">0</td>
    <td class="hs readonly"></td>
    <td><input></td><td><input></td>
    <td class="usd100 readonly">0</td>
    <td class="uoc readonly">0</td>
  `;
  body.appendChild(tr);
}

/* ==== LOAD GI·ªú ==== */
fetch(API_URL,{
  method:"POST",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({action:"getHourByXuong",ngay:NGAY,xuong:1})
})
.then(r=>r.json())
.then(res=>{
  res.data.forEach(d=>{
    const row=document.querySelector(`tr[data-to="${d.to_nhom}"]`);
    if(!row)return;
    const idx=GIO.indexOf(d.khung_gio);
    if(idx>=0)row.querySelectorAll(".gio")[idx].innerText=d.thuc_te;
    tinhDong(row);
  });
  tinhTong();
});

function tinhDong(r){
  let tong=0;
  r.querySelectorAll(".gio").forEach(td=>tong+=Number(td.innerText));
  r.querySelector(".tong").innerText=tong;

  const dm=Number(r.querySelector(".dm").value||0);
  const usdqt=Number(r.querySelector(".usdqt").value||0);

  if(dm){
    const hs=Math.round(tong/dm*100);
    r.querySelector(".hs").innerText=hs;
    r.querySelector(".usd").innerText=Math.round(tong*usdqt);
    r.querySelector(".usd100").innerText=Math.round(dm*usdqt);
    r.querySelector(".uoc").innerText=Math.round(tong*usdqt);
  }
}

function tinhTong(){
  let tongSP=0,tongUSD=0;
  GIO.forEach((_,i)=>{
    let s=0;
    document.querySelectorAll(`.gio:nth-child(${i+7})`).forEach(td=>s+=Number(td.innerText));
    document.getElementById("t"+GIO[i].replace("-","")).innerText=s;
  });

  document.querySelectorAll(".tong").forEach(td=>tongSP+=Number(td.innerText));
  document.querySelectorAll(".usd").forEach(td=>tongUSD+=Number(td.innerText));
  document.getElementById("tsp").innerText=tongSP;
  document.getElementById("tusd").innerText=tongUSD;
  document.getElementById("tusdngay").innerText=tongUSD;
}
</script>

</body>
</html>
