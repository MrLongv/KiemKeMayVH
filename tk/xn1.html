<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š Theo dÃµi nÄƒng suáº¥t giá» â€“ XN1</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f3f4f6;
}
header{
  background:#1e40af;
  color:#fff;
  padding:12px 20px;
  font-size:18px;
  font-weight:600;
}
.container{ padding:16px; }

.top-bar{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
}

button{
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.btn-save{ background:#2563eb;color:#fff; }

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid #ccc;
  padding:4px;
  text-align:center;
  font-size:13px;
}
th{ background:#e5e7eb; }
input{
  width:100%;
  border:none;
  outline:none;
  text-align:center;
  font-size:13px;
}
.readonly{ background:#f9fafb; }
.good{ background:#dcfce7; font-weight:600; }
.bad{ background:#fee2e2; color:#b91c1c; font-weight:600; }
</style>
</head>

<body>

<header>ğŸ“Š THEO DÃ•I NÄ‚NG SUáº¤T GIá»œ â€“ XÃ NGHIá»†P 1</header>

<div class="container">

<div class="top-bar">
  ğŸ“… NgÃ y:
  <input type="date" id="ngay">
  <button class="btn-save" onclick="savePlan()">ğŸ’¾ LÆ°u káº¿ hoáº¡ch</button>
</div>

<table>
<thead>
<tr>
  <th rowspan="2">Tá»”</th>
  <th rowspan="2">MÃƒ HÃ€NG</th>
  <th rowspan="2">SL</th>
  <th rowspan="2">ÄM NGÃ€Y</th>
  <th rowspan="2">ÄM GIá»œ</th>
  <th colspan="8">NÄ‚NG SUáº¤T THEO GIá»œ</th>
  <th rowspan="2">Cá»˜NG SP</th>
  <th rowspan="2">HS (%)</th>
</tr>
<tr>
  <th>7-8</th><th>8-9</th><th>9-10</th><th>10-11</th>
  <th>13-14</th><th>14-15</th><th>15-16</th><th>16-17</th>
</tr>
</thead>

<tbody id="tbody"></tbody>
</table>

</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const TO_LIST = [1,3,5,7,9];
const GIO = ["07-08","08-09","09-10","10-11","13-14","14-15","15-16","16-17"];

const user = JSON.parse(localStorage.getItem("USER") || "{}");
if(user.role !== "tk"){
  alert("KhÃ´ng cÃ³ quyá»n truy cáº­p");
  location.href = "../login.html";
}
const xuong = user.xuong || 1;

/* ================== INIT ================== */
document.getElementById("ngay").value =
  new Date().toISOString().slice(0,10);

renderTable();

/* ================== RENDER ================== */
function renderTable(){
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  TO_LIST.forEach(to=>{
    let tr = document.createElement("tr");
    tr.dataset.to = to;

    tr.innerHTML = `
      <td>${to}</td>
      <td><input class="ma_hang"></td>
      <td><input type="number" class="sl"></td>
      <td><input type="number" class="dm_ngay"></td>
      <td><input type="number" class="dm_gio"></td>
    `;

    GIO.forEach(()=> {
      const td = document.createElement("td");
      td.className = "readonly";
      tr.appendChild(td);
    });

    tr.innerHTML += `
      <td class="readonly tong"></td>
      <td class="readonly hs"></td>
    `;

    tb.appendChild(tr);
  });
}

/* ================== SAVE PLAN ================== */
function savePlan(){
  const ngay = document.getElementById("ngay").value;
  const rows = document.querySelectorAll("#tbody tr");
  const data = [];

  rows.forEach(r=>{
    data.push({
      to_nhom: r.dataset.to,
      ma_hang: r.querySelector(".ma_hang").value,
      so_luong: Number(r.querySelector(".sl").value||0),
      dinh_muc_ngay: Number(r.querySelector(".dm_ngay").value||0),
      dinh_muc_gio: Number(r.querySelector(".dm_gio").value||0)
    });
  });

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"savePlan",
      ngay,
      xuong,
      data
    })
  })
  .then(r=>r.json())
  .then(res=>{
    alert(res.success ? "âœ… ÄÃ£ lÆ°u káº¿ hoáº¡ch" : "âŒ Lá»—i lÆ°u");
  })
  .catch(()=>alert("Lá»—i káº¿t ná»‘i server"));
}
  
fetch(API_URL,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({
    action:"getHourByXuong",
    ngay: document.getElementById("ngay").value,
    xuong
  })
})
.then(r=>r.json())
.then(res=>{
  (res.data||[]).forEach(h=>{
    const row = document.querySelector(`tr[data-to="${h.to_nhom}"]`);
    if(!row) return;

    const idx = GIO.indexOf(h.khung_gio);
    if(idx>=0){
      row.children[5+idx].innerText = h.thuc_te;
    }

    // TÃNH Tá»”NG & HS
    let tong = 0;
    GIO.forEach((_,i)=>{
      tong += Number(row.children[5+i].innerText||0);
    });

    const dm = Number(row.querySelector(".dm_gio").value||0);
    row.querySelector(".tong").innerText = tong;

    if(dm>0){
      const hs = Math.round(tong/dm*100);
      const cell = row.querySelector(".hs");
      cell.innerText = hs;
      cell.className = "readonly " + (hs>=100?"good":"bad");
    }
  });
});
</script>

</body>
</html>
