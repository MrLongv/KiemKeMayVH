<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸ“Š Thá»‘ng kÃª xÆ°á»Ÿng</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f3f4f6;
}
header{
  background:#1e40af;
  color:#fff;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
main{
  padding:16px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
  margin-bottom:16px;
}
h3{ margin-top:0; }

input,select,button{
  padding:8px;
  margin:4px 0;
  width:100%;
  font-size:14px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}
.msg{
  margin-top:8px;
  font-weight:600;
}
.success{ color:#16a34a; }
.error{ color:#dc2626; }
</style>
</head>

<body>

<header>
  <div>
    ğŸ“Š <b>THá»NG KÃŠ XÆ¯á»NG</b>
    <span id="xnLabel"></span>
  </div>
  <button onclick="logout()">ÄÄƒng xuáº¥t</button>
</header>

<main>

<div class="card">
  <h3>ğŸ“… Nháº­p káº¿ hoáº¡ch Ä‘áº§u ngÃ y</h3>

  <div class="row">
    <div>
      <label>NgÃ y</label>
      <input type="date" id="ngay">
    </div>

    <div>
      <label>Tá»•</label>
      <select id="to_nhom"></select>
    </div>

    <div>
      <label>MÃ£ hÃ ng</label>
      <input id="ma_hang">
    </div>

    <div>
      <label>Sá»‘ lÆ°á»£ng</label>
      <input type="number" id="so_luong">
    </div>

    <div>
      <label>Äá»‹nh má»©c ngÃ y</label>
      <input type="number" id="dinh_muc_ngay">
    </div>

    <div>
      <label>Äá»‹nh má»©c giá»</label>
      <input type="number" id="dinh_muc_gio">
    </div>

    <div>
      <label>USD</label>
      <input type="number" id="usd">
    </div>

    <div>
      <label>LÄ thá»±c táº¿</label>
      <input type="number" id="lao_dong_thuc_te">
    </div>

    <div>
      <label>LÄ sÆ¡ Ä‘á»“</label>
      <input type="number" id="lao_dong_so_do">
    </div>

    <div>
      <label>ÄÆ¡n giÃ¡</label>
      <input type="number" id="don_gia">
    </div>

    <div>
      <label>Thá»i gian (giÃ¢y)</label>
      <input type="number" id="thoi_gian_giay">
    </div>

    <div>
      <label>USD Ä‘áº¡t/ngÃ y</label>
      <input type="number" id="usd_dat_ngay">
    </div>

    <div>
      <label>Chuyá»ƒn Ä‘á»•i ngÃ y</label>
      <input id="chuyen_doi_ngay">
    </div>
  </div>

  <button onclick="savePlan()">ğŸ’¾ LÆ°u káº¿ hoáº¡ch</button>
  <div id="msg" class="msg"></div>
</div>

</main>

<script>
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const BASE_PATH = "/KiemKeMayVH/";

/* ===== AUTH CHECK ===== */
const USER = JSON.parse(localStorage.getItem("USER"));
if(!USER || USER.role !== "tk"){
  location.href = BASE_PATH + "login.html";
}

const XUONG = USER.xuong;
document.getElementById("xnLabel").innerText = "(XÆ°á»Ÿng " + XUONG + ")";

/* ===== INIT ===== */
document.getElementById("ngay").value =
  new Date().toISOString().slice(0,10);

/* ===== DANH SÃCH Tá»” THEO XÆ¯á»NG ===== */
const TO_BY_XUONG = {
  1:[1,3,5,7,9],
  2:[11,13,15,17],
  3:[19,21,23,25,27]
};

const selTo = document.getElementById("to_nhom");
TO_BY_XUONG[XUONG].forEach(t=>{
  const o = document.createElement("option");
  o.value = t;
  o.textContent = "Tá»• " + t;
  selTo.appendChild(o);
});

/* ===== SAVE PLAN ===== */
function savePlan(){
  const d = {
    action:"savePlan",
    ngay: ngay.value,
    xuong: XUONG,
    to_nhom: to_nhom.value,
    ma_hang: ma_hang.value,
    so_luong: so_luong.value,
    dinh_muc_ngay: dinh_muc_ngay.value,
    dinh_muc_gio: dinh_muc_gio.value,
    usd: usd.value,
    lao_dong_thuc_te: lao_dong_thuc_te.value,
    lao_dong_so_do: lao_dong_so_do.value,
    don_gia: don_gia.value,
    thoi_gian_giay: thoi_gian_giay.value,
    usd_dat_ngay: usd_dat_ngay.value,
    chuyen_doi_ngay: chuyen_doi_ngay.value
  };

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(d)
  })
  .then(r=>r.json())
  .then(res=>{
    const m = document.getElementById("msg");
    if(res.success){
      m.innerText = "âœ… ÄÃ£ lÆ°u káº¿ hoáº¡ch";
      m.className = "msg success";
    }else{
      m.innerText = res.msg || "âŒ Lá»—i lÆ°u";
      m.className = "msg error";
    }
  })
  .catch(()=>{
    const m = document.getElementById("msg");
    m.innerText = "âŒ Lá»—i káº¿t ná»‘i server";
    m.className = "msg error";
  });
}

function logout(){
  localStorage.removeItem("USER");
  location.href = BASE_PATH + "login.html";
}
</script>

</body>
</html>
