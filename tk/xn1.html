<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TH·ªêNG K√ä XN1</title>

<style>
body{
  font-family:Arial, Helvetica, sans-serif;
  margin:0;
  background:#f2f4f7;
}
h2{ margin:10px }

/* ===== TABLE ===== */
table{
  border-collapse:collapse;
  width:100%;
  background:#fff;
}
th,td{
  border:1px solid #bfc4c9;
  padding:4px;
  font-size:13px;
  text-align:center;
  white-space:nowrap;
}
th{
  background:#e9ecef;
  font-weight:bold;
}

/* ===== INPUT ===== */
input{
  width:100%;
  border:none;
  outline:none;
  text-align:center;
  background:transparent;
}

/* ===== STICKY COLUMNS ===== */
.stt{ position:sticky; left:0; background:#fff; z-index:4 }
.to{ position:sticky; left:40px; background:#fff; z-index:4 }
.ma{ position:sticky; left:90px; background:#fff; z-index:4 }
.sl{ position:sticky; left:180px; background:#fff; z-index:4 }
.dmngay{ position:sticky; left:240px; background:#fff; z-index:4 }
.dmgio{ position:sticky; left:320px; background:#fff; z-index:4 }
.usdqt{ position:sticky; left:400px; background:#fff; z-index:4 }

/* ===== HEADER STICKY ===== */
thead th{
  position:sticky;
  top:0;
  z-index:6;
}

/* ===== STATUS ===== */
.readonly{ background:#f1f3f5; font-weight:bold }
.good{ background:#c8f7c5 }
.bad{ background:#f7c5c5 }
</style>
</head>

<body>

<h2>üìä TH·ªêNG K√ä S·∫¢N XU·∫§T ‚Äì XN1</h2>

<table>
<thead>
<tr>
  <th class="stt">STT</th>
  <th class="to">T·ªî</th>
  <th class="ma">M√É H√ÄNG</th>
  <th class="sl">SL</th>
  <th class="dmngay">ƒêM NG√ÄY</th>
  <th class="dmgio">ƒêM GI·ªú</th>
  <th class="usdqt">USD/QT</th>

  <th>7-8</th>
  <th>8-9</th>
  <th>9-10</th>
  <th>10-11</th>
  <th>12-13</th>
  <th>13-14</th>
  <th>14-15</th>
  <th>15-16</th>
  <th>16-17</th>

  <th>C·ªòNG SP</th>
  <th>USD/TH</th>
  <th>HI·ªÜU SU·∫§T %</th>
  <th>Lƒê TT</th>
  <th>Lƒê SƒêC</th>
  <th>ƒêƒêG</th>
  <th>TG/QT</th>
  <th>USD/NG√ÄY 100%</th>
  <th>CHUY·ªÇN ƒê·ªîI / NG√ÄY</th>
</tr>
</thead>

<tbody id="tbody"></tbody>
</table>

<script>
/* ================= C·∫§U H√åNH ================= */
const API_URL = "URL_WORKER_CUA_BAN";
const XUONG = 1;
const NGAY = new Date().toISOString().slice(0,10);
const GIO = ["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"];
const SO_TO = 10;

/* ================= T·∫†O D√íNG C·ªê ƒê·ªäNH THEO T·ªî ================= */
const tbody = document.getElementById("tbody");

for(let to=1; to<=SO_TO; to++){
  const tr = document.createElement("tr");
  tr.dataset.to = to;

  tr.innerHTML = `
    <td class="stt">${to}</td>
    <td class="to">T·ªï ${to}</td>
    <td class="ma"><input></td>
    <td class="sl"><input></td>
    <td class="dmngay"><input></td>
    <td class="dmgio"><input class="dm_gio"></td>
    <td class="usdqt"><input class="usd_qt"></td>

    ${GIO.map(()=>`<td class="gio">0</td>`).join("")}

    <td class="tong readonly">0</td>
    <td class="usdth readonly">0</td>
    <td class="hs readonly"></td>
    <td><input></td>
    <td><input></td>
    <td><input></td>
    <td><input></td>
    <td class="usd100 readonly">0</td>
    <td class="cdngay readonly">0</td>
  `;
  tbody.appendChild(tr);
}

/* ================= LOAD GI·ªú T·ª™ WORKER ================= */
fetch(API_URL,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({
    action:"getHourByXuong",
    ngay: NGAY,
    xuong: XUONG
  })
})
.then(r=>r.json())
.then(res=>{
  if(!res.success) return;

  res.data.forEach(d=>{
    const row = document.querySelector(`tr[data-to="${d.to_nhom}"]`);
    if(!row) return;

    const idx = GIO.indexOf(d.khung_gio);
    if(idx>=0){
      row.querySelectorAll(".gio")[idx].innerText = d.thuc_te;
    }

    tinhDong(row);
  });
});

/* ================= T√çNH TO√ÅN ================= */
function tinhDong(row){
  let tong = 0;
  row.querySelectorAll(".gio").forEach(td=>{
    tong += Number(td.innerText||0);
  });
  row.querySelector(".tong").innerText = tong;

  const dmgio = Number(row.querySelector(".dm_gio").value||0);
  const usdqt = Number(row.querySelector(".usd_qt").value||0);

  if(dmgio>0){
    const hs = Math.round(tong / dmgio * 100);
    const hsCell = row.querySelector(".hs");
    hsCell.innerText = hs;
    hsCell.className = "hs readonly " + (hs>=100?"good":"bad");

    row.querySelector(".usdth").innerText =
      Math.round(tong * usdqt);

    row.querySelector(".usd100").innerText =
      Math.round(dmgio * usdqt);

    row.querySelector(".cdngay").innerText =
      Math.round(tong / dmgio * 100);
  }
}
</script>

</body>
</html>
