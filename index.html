<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { padding: 10px; background:#fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:space-between;}
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
th { background:#eee; }
.highlight-row { background: #ffff99; }
button { padding:4px 8px; margin:2px; cursor:pointer; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:5px; width:90%; max-width:500px; max-height:90%; overflow-y:auto; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.modal-header h2 { margin:0; }
input, textarea { width:100%; padding:4px; margin:2px 0; box-sizing:border-box; }
</style>
</head>
<body>

<header>
  <h1>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</h1>
  <div>
    <button id="btnAdd">Th√™m</button>
  </div>
</header>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>S·ªë th·∫ª</th>
      <th>S·ªë m√°y</th>
      <th>Lo·∫°i m√°y</th>
      <th>V·ªã tr√≠</th>
      <th>Ghi ch√∫</th>
      <th>ƒê√£ KK</th>
      <th>In QR</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Ch·ªânh s·ª≠a m√°y</h2>
      <button id="closeModal">&times;</button>
    </div>
    <input type="hidden" id="editId">
    <label>S·ªë th·∫ª</label><input type="text" id="m_soThe">
    <label>S·ªë m√°y</label><input type="text" id="m_soMay">
    <label>Lo·∫°i m√°y</label><input type="text" id="m_loaiMay">
    <label>V·ªã tr√≠</label><input type="text" id="m_viTri">
    <label>Ghi ch√∫</label><textarea id="m_ghiChu"></textarea>
    <label>ƒê√£ ki·ªÉm k√™ <input type="checkbox" id="m_daKiemKe"></label>
    <label>In QR <input type="checkbox" id="m_chonIn"></label>
    <div style="margin-top:10px; text-align:right;">
      <button id="btnSave">L∆∞u</button>
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev"; // URL Worker
let allData = [];

const modal = document.getElementById('modal');
const m_soThe = document.getElementById('m_soThe');
const m_soMay = document.getElementById('m_soMay');
const m_loaiMay = document.getElementById('m_loaiMay');
const m_viTri = document.getElementById('m_viTri');
const m_ghiChu = document.getElementById('m_ghiChu');
const m_daKiemKe = document.getElementById('m_daKiemKe');
const m_chonIn = document.getElementById('m_chonIn');
const editId = document.getElementById('editId');

// ---- Modal ----
function openEditModal(id=null){
  if(id!==null){
    const row = allData.find(r=>r.id==id);
    if(row){
      editId.value = row.id;
      m_soThe.value = row.soThe||"";
      m_soMay.value = row.soMay||"";
      m_loaiMay.value = row.loaiMay||"";
      m_viTri.value = row.viTri||"";
      m_ghiChu.value = row.ghiChu||"";
      m_daKiemKe.checked = row.daKiemKe==1;
      m_chonIn.checked = row.chonIn==1;
    }
  } else {
    editId.value = "";
    m_soThe.value = m_soMay.value = m_loaiMay.value = m_viTri.value = m_ghiChu.value = "";
    m_daKiemKe.checked = m_chonIn.checked = false;
  }
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }
document.getElementById('closeModal').onclick = closeModal;
window.onclick = e=>{ if(e.target==modal) closeModal(); }

// ---- Load Data ----
async function loadData(){
  try{
    const res = await fetch(WORKER_URL+"/");
    if(!res) throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Worker");
    if(!res.ok) throw new Error("HTTP l·ªói "+res.status);
    const data = await res.json();
    if(!data || !data.success) throw new Error(data?.error||"D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");
    allData = data.data||[];
    renderTable();
  }catch(err){
    alert("L·ªói khi load d·ªØ li·ªáu: "+err);
  }
}

function renderTable(){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  allData.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${r.id}</td>
      <td>${r.soThe||""}</td>
      <td>${r.soMay||""}</td>
      <td>${r.loaiMay||""}</td>
      <td>${r.viTri||""}</td>
      <td>${r.ghiChu||""}</td>
      <td><input type="checkbox" disabled ${r.daKiemKe? "checked":""}></td>
      <td><input type="checkbox" disabled ${r.chonIn? "checked":""}></td>
      <td>
        <button onclick="openEditModal(${r.id})">S·ª≠a</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ---- Add / Edit ----
document.getElementById('btnAdd').onclick = ()=>openEditModal(null);

document.getElementById('btnSave').onclick = async ()=>{
  const payload = {
    id: editId.value? Number(editId.value): undefined,
    soThe: m_soThe.value.trim(),
    soMay: m_soMay.value.trim(),
    loaiMay: m_loaiMay.value.trim(),
    viTri: m_viTri.value.trim(),
    ghiChu: m_ghiChu.value.trim(),
    daKiemKe: m_daKiemKe.checked,
    chonIn: m_chonIn.checked
  };

  let url = WORKER_URL+"/add";
  if(payload.id) url = WORKER_URL+"/update";

  try{
    const res = await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res) throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Worker");
    if(!res.ok) throw new Error("HTTP l·ªói "+res.status);
    const data = await res.json();
    if(!data || !data.success) throw new Error(data?.error||"D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");

    await loadData();
    closeModal();
  }catch(err){
    alert("L·ªói khi l∆∞u: "+err);
  }
}

// ---- Auto load ----
loadData();
</script>
</body>
</html>
