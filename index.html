<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìã Qu·∫£n l√Ω danh s√°ch m√°y</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f9fafc;
      margin: 0; padding: 0;
    }
    h2 {
      text-align: center;
      color: #333;
      margin: 20px 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
    tr:nth-child(even) { background: #f2f2f2; }
    tr:hover { background: #e9f3ff; }

    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-save { background: #28a745; color: white; }
    .btn-edit { background: #007bff; color: white; }
    .btn-close { background: #dc3545; color: white; }
    .btn-sync { background: #17a2b8; color: white; margin: 10px; }

    #modal {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #modalContent {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
    }
    label { display: block; margin-top: 10px; }
    input, textarea {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h2>üìã DANH S√ÅCH M√ÅY</h2>
  <button class="btn-sync" id="btnSync">üíæ L∆∞u to√†n b·ªô l√™n Google Sheet</button>
  <table id="dataTable">
    <thead>
      <tr>
        <th>S·ªë th·∫ª</th>
        <th>S·ªë m√°y</th>
        <th>Lo·∫°i m√°y</th>
        <th>V·ªã tr√≠</th>
        <th>Ghi ch√∫</th>
        <th>Ki·ªÉm k√™</th>
        <th>In m√£ QR</th>
        <th>Ng√†y mua</th>
        <th>N∆°i mua</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <!-- Modal ch·ªânh s·ª≠a -->
  <div id="modal">
    <div id="modalContent">
      <h3>Ch·ªânh s·ª≠a th√¥ng tin</h3>
      <label>S·ªë th·∫ª</label><input id="m_soThe">
      <label>S·ªë m√°y</label><input id="m_soMay">
      <label>Lo·∫°i m√°y</label><input id="m_loaiMay">
      <label>V·ªã tr√≠</label><input id="m_viTri">
      <label>Ghi ch√∫</label><textarea id="m_ghiChu"></textarea>
      <label>Ki·ªÉm k√™</label><input type="checkbox" id="m_daKiemKe">
      <label>In m√£ QR</label><input type="checkbox" id="m_chonIn">
      <label>Ng√†y mua</label><input type="text" id="m_ngayMua" placeholder="dd/mm/yyyy">
      <label>N∆°i mua</label><input id="m_noiMua">
      <div style="margin-top:10px; text-align:right;">
        <button class="btn-save" id="saveBtn">L∆∞u</button>
        <button class="btn-close" id="closeBtn">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzIAZSx0hs6xobKoWYy6XuMgTdKAYeFht4w3H2CQykxHwDvrs58ez-mw0kg86hENCk8/exec"; // ‚ö†Ô∏è D√°n URL web app sau khi tri·ªÉn khai Code.gs

    let allData = [];
    let editIndex = -1;

    function loadData() {
      const url = webAppUrl + "?callback=callbackLoad";
      const script = document.createElement("script");
      script.src = url;
      document.body.appendChild(script);
    }

    function callbackLoad(res) {
      if (!res.success) return alert("L·ªói load d·ªØ li·ªáu: " + res.message);
      allData = res.data;
      renderTable();
    }

    function renderTable() {
      const body = document.getElementById("tableBody");
      body.innerHTML = "";
      allData.forEach((r, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${safe(r.soThe)}</td>
          <td>${safe(r.soMay)}</td>
          <td>${safe(r.loaiMay)}</td>
          <td>${safe(r.viTri)}</td>
          <td>${safe(r.ghiChu)}</td>
          <td><input type='checkbox' ${r.daKiemKe ? "checked" : ""} disabled></td>
          <td><input type='checkbox' ${r.chonIn ? "checked" : ""} disabled></td>
          <td>${safe(r.ngayMua)}</td>
          <td>${safe(r.noiMua)}</td>
          <td><button class="btn-edit" onclick="openEditModal(${i})">S·ª≠a</button></td>
        `;
        body.appendChild(row);
      });
    }

    function openEditModal(index) {
      editIndex = index;
      const r = allData[index];
      document.getElementById("m_soThe").value = r.soThe;
      document.getElementById("m_soMay").value = r.soMay;
      document.getElementById("m_loaiMay").value = r.loaiMay;
      document.getElementById("m_viTri").value = r.viTri;
      document.getElementById("m_ghiChu").value = r.ghiChu;
      document.getElementById("m_daKiemKe").checked = r.daKiemKe;
      document.getElementById("m_chonIn").checked = r.chonIn;
      document.getElementById("m_ngayMua").value = r.ngayMua;
      document.getElementById("m_noiMua").value = r.noiMua;
      document.getElementById("modal").style.display = "flex";
    }

    document.getElementById("closeBtn").onclick = () => {
      document.getElementById("modal").style.display = "none";
    };

    document.getElementById("saveBtn").onclick = () => {
      const r = allData[editIndex];
      r.soThe = document.getElementById("m_soThe").value;
      r.soMay = document.getElementById("m_soMay").value;
      r.loaiMay = document.getElementById("m_loaiMay").value;
      r.viTri = document.getElementById("m_viTri").value;
      r.ghiChu = document.getElementById("m_ghiChu").value;
      r.daKiemKe = document.getElementById("m_daKiemKe").checked;
      r.chonIn = document.getElementById("m_chonIn").checked;
      r.ngayMua = document.getElementById("m_ngayMua").value;
      r.noiMua = document.getElementById("m_noiMua").value;
      renderTable();
      saveOneRow(editIndex);
      document.getElementById("modal").style.display = "none";
    };

    document.getElementById("btnSync").onclick = () => {
      const url = webAppUrl + "?save=1&data=" + encodeURIComponent(JSON.stringify(allData)) + "&callback=callbackSave";
      const script = document.createElement("script");
      script.src = url;
      document.body.appendChild(script);
    };

    function saveOneRow(index) {
      const r = allData[index];
      const url = webAppUrl + "?update=1&row=" + index + "&data=" + encodeURIComponent(JSON.stringify(r)) + "&callback=callbackUpdate";
      const script = document.createElement("script");
      script.src = url;
      document.body.appendChild(script);
    }

    function callbackSave(res) {
      if (res.success) alert("‚úÖ ƒê√£ l∆∞u " + res.written + " d√≤ng v√†o Google Sheet!");
      else alert("‚ùå L·ªói khi l∆∞u: " + res.message);
    }

    function callbackUpdate(res) {
      if (!res.success) alert("‚ùå L·ªói c·∫≠p nh·∫≠t d√≤ng: " + res.message);
    }

    function safe(str) {
      return str ? String(str).replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])) : '';
    }

    loadData();
  </script>
</body>
</html>
