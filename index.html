<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may - Full</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:6px;text-align:center;word-break:break-word;font-size:13px}
th{background:#0b74d1;color:#fff}
tr.highlight{background: #ffeaa7 !important}
/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} .controls input[type="text"]{width:100%} }
</style>
</head>
<body>

<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may â€” Full</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y" />
  <button id="btnImport" class="ghost">ğŸ“‚ Nháº­p Excel</button>
  <button id="btnExport">ğŸ’¾ Xuáº¥t Excel</button>
  <button id="btnAdd">â• ThÃªm</button>
  <button id="btnSync">â˜ï¸ Äá»“ng bá»™ Google Sheet</button>
  <button id="btnRefresh" class="ghost">ğŸ”„ Táº£i láº¡i tá»« Sheet</button>
  <button id="btnPrintQR">ğŸ–¨ï¸ In tem QR</button>
  <label><input type="checkbox" id="filterChecked"/> Chá»‰ hiá»ƒn thá»‹ Ä‘Ã£ kiá»ƒm kÃª</label>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
</div>

<div class="note">Ghi chÃº: Khi GAS tháº¥t báº¡i, web tá»± fallback vá» data.json.</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>Chá»n Ä‘á»ƒ in</th>
        <th>ÄÃ£ kiá»ƒm kÃª</th>
        <th>Sá»‘ tháº»</th>
        <th>Sá»‘ mÃ¡y</th>
        <th>Loáº¡i mÃ¡y</th>
        <th>Vá»‹ trÃ­</th>
        <th>NgÃ y mua</th>
        <th>Ghi chÃº</th>
        <th>HÃ nh Ä‘á»™ng</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a / ThÃªm dÃ²ng</h3>
    <label>Sá»‘ tháº»</label><input id="m_soThe" />
    <label>Sá»‘ mÃ¡y</label><input id="m_soMay" />
    <label>Loáº¡i mÃ¡y</label><input id="m_loaiMay" />
    <label>Vá»‹ trÃ­</label><input id="m_viTri" />
    <label>NgÃ y mua</label><input id="m_ngayMua" type="date"/>
    <label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
    <label><input type="checkbox" id="m_daKiemKe"/> ÄÃ£ kiá»ƒm kÃª</label>
    <div class="actions">
      <button id="cancelBtn" class="ghost">Há»§y</button>
      <button id="saveBtn">Cáº­p nháº­t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxma15HtD6m0MdVDrl8fXtL2jFOLPywF4_OGdVMgniVRhJSEEWLiy96lACDaYrjz08/exec'; // <== Thay URL deploy GAS
const DATA_JSON = 'data.json';
const statusEl = document.getElementById('status');
const tbody = document.querySelector('#dataTable tbody');
let allData = [], editingIndex = null;

function setStatus(text, ok=true){
  statusEl.innerText = 'Tráº¡ng thÃ¡i: '+text;
  statusEl.style.color=ok?'#0b74d1':'#c0392b';
}
function safeText(v){ return (v==null)?'':String(v); }
function safeId(s){ return 'qr_'+String(s).replace(/[^\w\-]/g,'_'); }
function formatDate(d){ if(!d) return ''; if(d instanceof Date) return d.toLocaleDateString('vi-VN'); return d; }
function parseDate(v){ if(!v) return null; const d=new Date(v); return isNaN(d)?null:d; }

async function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  try {
    const res = await fetch(GAS_URL);
    const j = await res.json();
    if(j.success && Array.isArray(j.data)){
      allData = j.data.map(r=>({
        soThe: safeText(r.soThe),
        soMay: safeText(r.soMay),
        loaiMay: safeText(r.loaiMay),
        viTri: safeText(r.viTri),
        ghiChu: safeText(r.ghiChu),
        daKiemKe: !!r.daKiemKe,
        ngayMua: parseDate(r.ngayMua)
      }));
      setStatus('ÄÃ£ táº£i tá»« Google Sheet ('+allData.length+' dÃ²ng)');
      renderTable(); return;
    }
    throw new Error('Dá»¯ liá»‡u GAS khÃ´ng há»£p lá»‡');
  } catch(e){
    console.warn('Load GAS tháº¥t báº¡i:',e);
    try{
      const res2=await fetch(DATA_JSON+'?_='+Date.now());
      const arr=await res2.json();
      allData=arr.map(r=>({
        soThe: safeText(r.soThe),
        soMay: safeText(r.soMay),
        loaiMay: safeText(r.loaiMay),
        viTri: safeText(r.viTri),
        ghiChu: safeText(r.ghiChu),
        daKiemKe: !!r.daKiemKe,
        ngayMua: parseDate(r.ngayMua)
      }));
      setStatus('ÄÃ£ táº£i dá»± phÃ²ng tá»« data.json ('+allData.length+' dÃ²ng)');
      renderTable();
    }catch(e2){ console.error('Load data.json tháº¥t báº¡i:',e2); setStatus('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u',false); allData=[]; renderTable(); }
  }
}

function renderTable(){
  tbody.innerHTML='';
  allData.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.dataset.index=idx;
    const idChkPrint = 'chkPrint_'+idx;
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td><input type="checkbox" class="chkPrint" id="${idChkPrint}"/></td>
      <td><input type="checkbox" class="chkDaKiemKe" ${r.daKiemKe?'checked':''}/></td>
      <td>${escapeHtml(r.soThe)}</td>
      <td>${escapeHtml(r.soMay)}</td>
      <td>${escapeHtml(r.loaiMay)}</td>
      <td>${escapeHtml(r.viTri)}</td>
      <td>${formatDate(r.ngayMua)}</td>
      <td>${escapeHtml(r.ghiChu)}</td>
      <td>
        <button data-act="edit" data-i="${idx}">âœï¸</button>
        <button data-act="del" data-i="${idx}">ğŸ—‘ï¸</button>
        <button data-act="qr" data-i="${idx}">ğŸ”—</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ===== Sá»± kiá»‡n báº£ng ===== */
tbody.addEventListener('click',ev=>{
  const btn=ev.target.closest('button'); if(!btn) return;
  const act=btn.dataset.act; const i=Number(btn.dataset.i);
  if(act==='edit'){ openEditModal(i); }
  else if(act==='del'){ if(confirm('XÃ³a dÃ²ng '+allData[i].soThe+'?')){ allData.splice(i,1); renderTable(); } }
  else if(act==='qr'){ const id=encodeURIComponent(allData[i].soThe); prompt('Link QR:', location.href.split('#')[0].split('?')[0]+'#'+id); }
});
tbody.addEventListener('change',ev=>{
  if(ev.target.classList.contains('chkDaKiemKe')){
    const idx = Number(ev.target.closest('tr').dataset.index);
    allData[idx].daKiemKe = ev.target.checked;
  }
});

/* ===== Modal chá»‰nh sá»­a ===== */
const modal = document.getElementById('editModal');
const m_soThe = document.getElementById('m_soThe');
const m_soMay = document.getElementById('m_soMay');
const m_loaiMay = document.getElementById('m_loaiMay');
const m_viTri = document.getElementById('m_viTri');
const m_ghiChu = document.getElementById('m_ghiChu');
const m_daKiemKe = document.getElementById('m_daKiemKe');
const m_ngayMua = document.getElementById('m_ngayMua');
const cancelBtn=document.getElementById('cancelBtn');
const saveBtn=document.getElementById('saveBtn');

function openEditModal(idx){
  editingIndex=(typeof idx==='number')?idx:null;
  if(editingIndex===null){
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value=''; m_daKiemKe.checked=false; m_ngayMua.value='';
  }else{
    const r=allData[editingIndex];
    m_soThe.value=r.soThe; m_soMay.value=r.soMay; m_loaiMay.value=r.loaiMay; m_viTri.value=r.viTri; m_ghiChu.value=r.ghiChu;
    m_daKiemKe.checked=!!r.daKiemKe;
    m_ngayMua.value=r.ngayMua?r.ngayMua.toISOString().slice(0,10):'';
  }
  modal.style.display='flex'; m_soThe.focus();
}
cancelBtn.onclick=()=>{ modal.style.display='none'; editingIndex=null; };
saveBtn.onclick=()=>{
  const obj={
    soThe:m_soThe.value.trim(), soMay:m_soMay.value.trim(), loaiMay:m_loaiMay.value.trim(),
    viTri:m_viTri.value.trim(), ghiChu:m_ghiChu.value.trim(),
    daKiemKe:m_daKiemKe.checked,
    ngayMua:m_ngayMua.value?new Date(m_ngayMua.value):null
  };
  if(!obj.soThe){ alert('Sá»‘ tháº» khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng'); return; }
  if(editingIndex===null) allData.push(obj); else allData[editingIndex]=obj;
  modal.style.display='none'; editingIndex=null; renderTable();
};

/* ===== NÃºt Ä‘iá»u khiá»ƒn ===== */
document.getElementById('btnAdd').addEventListener('click',()=>openEditModal(null));
document.getElementById('btnExport').addEventListener('click',exportExcel);
document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('btnRefresh').addEventListener('click',loadData);
document.getElementById('filterChecked').addEventListener('change',()=>filterChecked());
document.getElementById('fileInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(sheet);
    allData=arr.map(r=>({
      soThe:safeText(r.soThe||r['Sá»‘ tháº»']||r['MaMay']||r['Ma']),
      soMay:safeText(r.soMay||r['Sá»‘ mÃ¡y']||r['SoMay']||''),
      loaiMay:safeText(r.loaiMay||r['Loáº¡i mÃ¡y']||''),
      viTri:safeText(r.viTri||r['Vá»‹ trÃ­']||''),
      ghiChu:safeText(r.ghiChu||r['Ghi chÃº']||''),
      daKiemKe:!!r.daKiemKe,
      ngayMua:parseDate(r.ngayMua)
    }));
    renderTable();
  };
  reader.readAsArrayBuffer(f);
});

/* ===== Export Excel ===== */
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(allData.map(r=>({
    ...r, ngayMua:r.ngayMua?formatDate(r.ngayMua):''
  })));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'DanhSachMay');
  XLSX.writeFile(wb,'DanhSachMay.xlsx');
}

/* ===== Äá»“ng bá»™ GAS ===== */
async function syncToSheet(){
  setStatus('Äang Ä‘á»“ng bá»™ Google Sheet...');
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(allData)});
    const txt=await res.text();
    let parsed=null; try{ parsed=txt?JSON.parse(txt):null; }catch(e){ parsed=null; }
    if(!res.ok){ setStatus('Tháº¥t báº¡i HTTP '+res.status,false); alert('Lá»—i: '+txt); return; }
    if(parsed && parsed.success){ setStatus('ÄÃ£ Ä‘á»“ng bá»™'); alert('Äá»“ng bá»™ thÃ nh cÃ´ng'); setTimeout(()=>loadData(),500); }
    else{ setStatus('Server tráº£ vá»'); alert('Server: '+txt); }
  }catch(err){ console.error(err); setStatus('Lá»—i káº¿t ná»‘i',false); alert('KhÃ´ng thá»ƒ káº¿t ná»‘i: '+err.message); }
}
document.getElementById('btnSync').addEventListener('click',syncToSheet);

/* ===== Filter checkbox ===== */
function filterChecked(){
  const only= document.getElementById('filterChecked').checked;
  Array.from(tbody.children).forEach(tr=>{
    const idx=Number(tr.dataset.index);
    if(only && !allData[idx].daKiemKe) tr.style.display='none';
    else tr.style.display='';
  });
}

/* ===== Highlight QR ===== */
function getQRfromUrl(){ const u=new URL(window.location.href); let c=u.searchParams.get('q'); if(!c)c=decodeURIComponent((window.location.hash||'').replace(/^#/,'')||null); return c?String(c):null; }
function attemptHighlight(code){
  if(!code) return; let tries=0;
  const i=setInterval(()=>{
    const idx=allData.findIndex(d=>d.soThe===code||d.soMay===code);
    if(idx>=0){
      const rows=document.querySelectorAll('#dataTable tbody tr');
      rows.forEach(r=>r.classList.remove('highlight'));
      const target=rows[idx]; if(target){target.classList.add('highlight'); target.scrollIntoView({behavior:'smooth',block:'center'});}
      clearInterval(i);
    }else if(++tries>12) clearInterval(i);
  },250);
}

/* ===== Print QR Tem ===== */
document.getElementById('btnPrintQR').addEventListener('click',printSelected);
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function printSelected(){
  const sel=Array.from(tbody.querySelectorAll('.chkPrint')).map((chk,i)=>chk.checked?allData[i]:null).filter(Boolean);
  if(sel.length===0){ alert('Chá»n Ã­t nháº¥t 1 dÃ²ng Ä‘á»ƒ in'); return; }
  const w=window.open('','_blank');
  w.document.write('<html><head><title>In tem QR</title><style>body{font-family:sans-serif} .tem{border:1px solid #000;padding:8px;margin:4px;display:inline-block;width:45%;height:120px;text-align:center;}</style></head><body>');
  sel.forEach(r=>{
    const id = safeId(r.soThe);
    w.document.write('<div class="tem">');
    w.document.write('<div>Sá»‘ tháº»: '+escapeHtml(r.soThe)+'</div>');
    w.document.write('<div>Sá»‘ mÃ¡y: '+escapeHtml(r.soMay)+'</div>');
    w.document.write(`<div id="${id}"></div>`);
    w.document.write('</div>');
  });
  w.document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><script>');
  sel.forEach(r=>{
    const id = safeId(r.soThe);
    const qrText = JSON.stringify(r.soThe);
    w.document.write(`new QRCode(document.getElementById('${id}'), { text: ${qrText}, width:64, height:64 });`);
  });
  w.document.write('</script></body></html>');
  w.document.close();
}

/* ===== Search ===== */
document.getElementById('searchBox').addEventListener('input',e=>{
  const v=e.target.value.toLowerCase();
  Array.from(tbody.children).forEach(tr=>{
    const idx=Number(tr.dataset.index);
    const r=allData[idx];
    if(r.soThe.toLowerCase().includes(v)||r.soMay.toLowerCase().includes(v)) tr.style.display='';
    else tr.style.display='none';
  });
});

loadData();
attemptHighlight(getQRfromUrl());
</script>
</body>
</html>
