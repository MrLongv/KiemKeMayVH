<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header, .controls, .note, .table-wrap{display:flex;flex-direction:column;gap:10px;padding:10px}
.table-wrap table{border-collapse:collapse;width:100%}
.table-wrap th, .table-wrap td{border:1px solid #ccc;padding:5px;font-size:14px}
.table-wrap th{background:#eee}
.modal-open{overflow:hidden;position:fixed;width:100%}
.highlight-row{background:yellow}
</style>
</head>
<body>

<header>
  <h2>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</h2>
</header>

<div class="controls">
  <input type="text" id="searchBox" placeholder="T√¨m ki·∫øm...">
  <select id="filterBox">
    <option value="">T·∫•t c·∫£</option>
    <option value="daKiemKe">ƒê√£ ki·ªÉm k√™</option>
    <option value="chuaKiemKe">Ch∆∞a ki·ªÉm k√™</option>
    <option value="daIn">ƒê√£ in</option>
    <option value="chuaIn">Ch∆∞a in</option>
  </select>
  <button id="btnAdd">Th√™m m√°y</button>
  <button id="btnSync">ƒê·ªìng b·ªô</button>
  <button id="btnRefresh">L√†m m·ªõi</button>
</div>

<div class="note">
  <span id="status">Tr·∫°ng th√°i: ...</span>
  <span id="searchInfo"></span>
</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th><th>S·ªë th·∫ª</th><th>S·ªë m√°y</th><th>Lo·∫°i m√°y</th>
        <th>V·ªã tr√≠</th><th>Ghi ch√∫</th><th>H√†nh ƒë·ªông</th>
        <th>ƒê√£ KK</th><th>In QR</th><th>Ng√†y mua</th><th>N∆°i mua</th>
        <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>S·ª≠a ch·ªØa</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal Edit -->
<div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;padding:15px;border-radius:8px;width:350px;max-height:90%;overflow:auto">
    <h3>Ch·ªânh s·ª≠a / Th√™m m√°y</h3>
    <input id="m_soThe" placeholder="S·ªë th·∫ª" style="width:100%;margin:5px 0">
    <input id="m_soMay" placeholder="S·ªë m√°y" style="width:100%;margin:5px 0">
    <input id="m_loaiMay" placeholder="Lo·∫°i m√°y" style="width:100%;margin:5px 0">
    <input id="m_viTri" placeholder="V·ªã tr√≠" style="width:100%;margin:5px 0">
    <input id="m_ghiChu" placeholder="Ghi ch√∫" style="width:100%;margin:5px 0">
    <input id="m_ngayMua" type="date" style="width:100%;margin:5px 0">
    <input id="m_noiMua" placeholder="N∆°i mua" style="width:100%;margin:5px 0">
    <label><input type="checkbox" id="m_daKiemKe"> ƒê√£ ki·ªÉm k√™</label>
    <label><input type="checkbox" id="m_chonIn"> In QR</label>
    <div>
      <label><input type="checkbox" id="m_bdQ1"> Q1</label>
      <input type="date" id="m_bdQ1_ngay">
    </div>
    <div>
      <label><input type="checkbox" id="m_bdQ2"> Q2</label>
      <input type="date" id="m_bdQ2_ngay">
    </div>
    <div>
      <label><input type="checkbox" id="m_bdQ3"> Q3</label>
      <input type="date" id="m_bdQ3_ngay">
    </div>
    <div>
      <label><input type="checkbox" id="m_bdQ4"> Q4</label>
      <input type="date" id="m_bdQ4_ngay">
    </div>
    <textarea id="m_suaChua" rows="3" placeholder="S·ª≠a ch·ªØa..." style="width:100%;margin:5px 0"></textarea>
    <div style="display:flex;justify-content:flex-end;gap:5px;margin-top:5px">
      <button id="cancelBtn">H·ªßy</button>
      <button id="saveBtn">C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const CF_ENDPOINT = 'https://snowy-surf-e985.hoalangiongxoai.workers.dev/';
let allData=[], editingIndex=null;

const statusEl=document.getElementById('status'), tbody=document.querySelector('#dataTable tbody');
const filterBox=document.getElementById('filterBox'), searchBox=document.getElementById('searchBox');
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe'), m_soMay=document.getElementById('m_soMay'),
      m_loaiMay=document.getElementById('m_loaiMay'), m_viTri=document.getElementById('m_viTri'),
      m_ghiChu=document.getElementById('m_ghiChu'), m_daKiemKe=document.getElementById('m_daKiemKe'),
      m_chonIn=document.getElementById('m_chonIn'), m_ngayMua=document.getElementById('m_ngayMua'),
      m_noiMua=document.getElementById('m_noiMua'),
      m_bdQ1=document.getElementById('m_bdQ1'), m_bdQ2=document.getElementById('m_bdQ2'),
      m_bdQ3=document.getElementById('m_bdQ3'), m_bdQ4=document.getElementById('m_bdQ4'),
      m_bdQ1_ngay=document.getElementById('m_bdQ1_ngay'), m_bdQ2_ngay=document.getElementById('m_bdQ2_ngay'),
      m_bdQ3_ngay=document.getElementById('m_bdQ3_ngay'), m_bdQ4_ngay=document.getElementById('m_bdQ4_ngay'),
      m_suaChua=document.getElementById('m_suaChua');

function setStatus(txt,ok=true){statusEl.innerText='Tr·∫°ng th√°i: '+txt;statusEl.style.color=ok?'#0b74d1':'#c0392b';}
function safeText(v){return v==null?'':String(v);}
function formatDateDDMMYYYY(d){if(!d)return"";let dt=new Date(d);if(isNaN(dt))return String(d);return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`}

// ==== RENDER B·∫¢NG ====
function renderTable(){
  tbody.innerHTML='';
  const filter = filterBox.value;
  const search = (searchBox.value||'').toLowerCase();
  let countVisible=0;
  allData.forEach((r,idx)=>{
    let show=true;
    if(filter==='daKiemKe' && !r.daKiemKe) show=false;
    if(filter==='chuaKiemKe' && r.daKiemKe) show=false;
    if(filter==='daIn' && !r.chonIn) show=false;
    if(filter==='chuaIn' && r.chonIn) show=false;
    if(search){
      const haystack=[r.soThe,r.soMay,r.loaiMay,r.viTri,r.ghiChu,r.noiMua,r.ngayMua,r.suaChua].map(x=>(x||'').toLowerCase()).join(' ');
      if(!haystack.includes(search)) show=false;
    }
    if(show){
      countVisible++;
      const tr=document.createElement('tr'); tr.dataset.index=idx;
      tr.innerHTML=`
        <td>${idx+1}</td>
        <td class="col-so-the">${safeText(r.soThe)}</td>
        <td>${safeText(r.soMay)}</td>
        <td>${safeText(r.loaiMay)}</td>
        <td>${safeText(r.viTri)}</td>
        <td>${safeText(r.ghiChu)}</td>
        <td>
          <button data-act="edit" data-i="${idx}">‚úèÔ∏è</button>
          <button data-act="qr" data-i="${idx}">üîó</button>
        </td>
        <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
        <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
        <td>${r.ngayMua||''}</td>
        <td>${r.noiMua||''}</td>
        <td><input type="checkbox" class="bdQ1" ${r.bdQ1?'checked':''}></td>
        <td><input type="checkbox" class="bdQ2" ${r.bdQ2?'checked':''}></td>
        <td><input type="checkbox" class="bdQ3" ${r.bdQ3?'checked':''}></td>
        <td><input type="checkbox" class="bdQ4" ${r.bdQ4?'checked':''}></td>
        <td>${safeText(r.suaChua)}</td>
      `;
      tbody.appendChild(tr);
    }
  });
  const searchInfo=document.getElementById('searchInfo'); if(searchInfo) searchInfo.textContent=`T√¨m th·∫•y ${countVisible} d√≤ng`;
}

// ==== LOAD DATA T·ª™ CF ====
async function loadData(){
  setStatus('ƒêang t·∫£i d·ªØ li·ªáu...');
  try{
    const res=await fetch(CF_ENDPOINT+'?action=get');
    const json=await res.json();
    if(Array.isArray(json)){
      allData=json.map(r=>({
        soThe:r.soThe||'', soMay:r.soMay||'', loaiMay:r.loaiMay||'', viTri:r.viTri||'', ghiChu:r.ghiChu||'',
        daKiemKe:!!r.daKiemKe, chonIn:!!r.chonIn, ngayMua:r.ngayMua||'', noiMua:r.noiMua||'',
        bdQ1:!!r.bdQ1, bdQ2:!!r.bdQ2, bdQ3:!!r.bdQ3, bdQ4:!!r.bdQ4,
        bdNgayQ1:r.bdNgayQ1||'', bdNgayQ2:r.bdNgayQ2||'', bdNgayQ3:r.bdNgayQ3||'', bdNgayQ4:r.bdNgayQ4||'',
        suaChua:r.suaChua||''
      }));
      renderTable(); setStatus('ƒê√£ t·∫£i '+allData.length+' d√≤ng');
    } else setStatus('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',false);
  }catch(e){setStatus('L·ªói t·∫£i d·ªØ li·ªáu',false);}
}

// ==== L∆ØU / C·∫¨P NH·∫¨T ROW L√äN CF ====
async function autoSyncRow(i){
  if(i==null||!allData[i]) return;
  const row=allData[i];
  try{
    const res=await fetch(CF_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'update',index:i,data:row})
    });
    const json=await res.json();
    if(json.success) setStatus('‚úÖ ƒê√£ l∆∞u d√≤ng '+(i+1));
    else setStatus('‚ùå L·ªói l∆∞u d√≤ng '+(i+1),false);
  }catch(e){setStatus('‚ùå L·ªói l∆∞u d√≤ng '+(i+1),false);}
}

// ==== EVENTS ====
filterBox.addEventListener('change',renderTable);
searchBox.addEventListener('input',renderTable);

tbody.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const act=btn.dataset.act, i=Number(btn.dataset.i);
  if(act==='edit') openEditModal(i);
  if(act==='qr'){const code=encodeURIComponent(allData[i].soThe||'');prompt('Link QR (copy & in tem):',location.href.split('#')[0]+'#'+code);}
});

tbody.addEventListener('change',e=>{
  const tr=e.target.closest('tr'); if(!tr) return; const idx=Number(tr.dataset.index);
  if(e.target.classList.contains('daKiemKe')){allData[idx].daKiemKe=e.target.checked;autoSyncRow(idx);}
  if(e.target.classList.contains('chonIn')){allData[idx].chonIn=e.target.checked;autoSyncRow(idx);}
  if(e.target.classList.contains('bdQ1')){allData[idx].bdQ1=e.target.checked;autoSyncRow(idx);}
  if(e.target.classList.contains('bdQ2')){allData[idx].bdQ2=e.target.checked;autoSyncRow(idx);}
  if(e.target.classList.contains('bdQ3')){allData[idx].bdQ3=e.target.checked;autoSyncRow(idx);}
  if(e.target.classList.contains('bdQ4')){allData[idx].bdQ4=e.target.checked;autoSyncRow(idx);}
  renderTable();
});

// ==== MODAL ====
let lastScrollY=0;
function openEditModal(idx){
  lastScrollY=window.scrollY;
  editingIndex=idx;
  const r=allData[idx]||{};
  m_soThe.value=r.soThe||'';
  m_soMay.value=r.soMay||'';
  m_loaiMay.value=r.loaiMay||'';
  m_viTri.value=r.viTri||'';
  m_ghiChu.value=r.ghiChu||'';
  m_daKiemKe.checked=!!r.daKiemKe;
  m_chonIn.checked=!!r.chonIn;
  m_ngayMua.value=r.ngayMua||'';
  m_noiMua.value=r.noiMua||'';
  m_bdQ1.checked=!!r.bdQ1; m_bdQ2.checked=!!r.bdQ2; m_bdQ3.checked=!!r.bdQ3; m_bdQ4.checked=!!r.bdQ4;
  m_bdQ1_ngay.value=r.bdNgayQ1||''; m_bdQ2_ngay.value=r.bdNgayQ2||''; m_bdQ3_ngay.value=r.bdNgayQ3||''; m_bdQ4_ngay.value=r.bdNgayQ4||'';
  m_suaChua.value=r.suaChua||'';
  modal.style.display='flex'; document.body.classList.add('modal-open'); document.body.style.top=`-${window.scrollY}px`;
  m_soThe.focus();
}
function closeModal(){modal.style.display='none';editingIndex=null;document.body.classList.remove('modal-open');document.body.style.top='';window.scrollTo(0,lastScrollY);}
document.getElementById('cancelBtn').onclick=closeModal;

document.getElementById('saveBtn').onclick=()=>{
  const hasData=m_soThe.value.trim()||m_soMay.value.trim();
  if(!hasData){alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ th√™m!');return;}
  if(editingIndex==null){
    const newRow={
      soThe:m_soThe.value,soMay:m_soMay.value,loaiMay:m_loaiMay.value,viTri:m_viTri.value,ghiChu:m_ghiChu.value,
      daKiemKe:m_daKiemKe.checked,chonIn:m_chonIn.checked,ngayMua:m_ngayMua.value,noiMua:m_noiMua.value,
      bdQ1:m_bdQ1.checked,bdQ2:m_bdQ2.checked,bdQ3:m_bdQ3.checked,bdQ4:m_bdQ4.checked,
      bdNgayQ1:m_bdQ1_ngay.value,bdNgayQ2:m_bdQ2_ngay.value,bdNgayQ3:m_bdQ3_ngay.value,bdNgayQ4:m_bdQ4_ngay.value,
      suaChua:m_suaChua.value
    };
    allData.push(newRow); autoSyncRow(allData.length-1);
  }else{
    const r=allData[editingIndex];
    r.soThe=m_soThe.value; r.soMay=m_soMay.value; r.loaiMay=m_loaiMay.value; r.viTri=m_viTri.value; r.ghiChu=m_ghiChu.value;
    r.daKiemKe=m_daKiemKe.checked; r.chonIn=m_chonIn.checked; r.ngayMua=m_ngayMua.value; r.noiMua=m_noiMua.value;
    r.bdQ1=m_bdQ1.checked; r.bdQ2=m_bdQ2.checked; r.bdQ3=m_bdQ3.checked; r.bdQ4=m_bdQ4.checked;
    r.bdNgayQ1=m_bdQ1_ngay.value; r.bdNgayQ2=m_bdQ2_ngay.value; r.bdNgayQ3=m_bdQ3_ngay.value; r.bdNgayQ4=m_bdQ4_ngay.value;
    r.suaChua=m_suaChua.value;
    autoSyncRow(editingIndex);
  }
  renderTable(); closeModal();
};

// ==== INIT ====
loadData();
</script>
</body>
</html>
