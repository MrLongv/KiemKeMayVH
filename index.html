<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üìã Ki·ªÉm k√™ VH</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f4f4; }
h1 { text-align:center; }
table { border-collapse: collapse; width: 100%; background:#fff; }
th, td { border: 1px solid #ccc; padding: 6px; text-align:center; font-size:14px; }
th { background:#eee; }
button { padding:4px 8px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; width:400px; border-radius:5px; position:relative; }
.modal-content input, .modal-content textarea { width:100%; margin-bottom:8px; padding:4px; }
.close { position:absolute; top:5px; right:10px; cursor:pointer; font-size:18px; }
</style>
</head>
<body>
<h1>Ki·ªÉm k√™ VH</h1>
<button id="btnAdd">Th√™m m·ªõi</button>
<button id="btnRefresh">T·∫£i l·∫°i</button>
<button id="btnPrintQR">In QR</button>
<button id="btnPrintLyLich">In L√Ω L·ªãch</button>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>S·ªë th·∫ª</th>
      <th>S·ªë m√°y</th>
      <th>Lo·∫°i m√°y</th>
      <th>V·ªã tr√≠</th>
      <th>Ghi ch√∫</th>
      <th><label><input type="checkbox" id="checkAllKK">ƒê√£ KK</label></th>
      <th><label><input type="checkbox" id="checkAllQR">In QR</label></th>
      <th>Ng√†y mua</th>
      <th>N∆°i mua</th>
      <th><label><input type="checkbox" id="checkAllQ1">Q1</label></th>
      <th><label><input type="checkbox" id="checkAllQ2">Q2</label></th>
      <th><label><input type="checkbox" id="checkAllQ3">Q3</label></th>
      <th><label><input type="checkbox" id="checkAllQ4">Q4</label></th>
      <th>S·ª≠a ch·ªØa</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" id="modalClose">&times;</span>
    <h3>Th√¥ng tin m√°y</h3>
    <input type="hidden" id="m_id">
    <input placeholder="S·ªë th·∫ª" id="m_soThe">
    <input placeholder="S·ªë m√°y" id="m_soMay">
    <input placeholder="Lo·∫°i m√°y" id="m_loaiMay">
    <input placeholder="V·ªã tr√≠" id="m_viTri">
    <textarea placeholder="Ghi ch√∫" id="m_ghiChu"></textarea>
    <label><input type="checkbox" id="m_daKiemKe"> ƒê√£ ki·ªÉm k√™</label><br>
    <label><input type="checkbox" id="m_chonIn"> In QR</label><br>
    <input type="date" id="m_ngayMua" placeholder="Ng√†y mua">
    <input placeholder="N∆°i mua" id="m_noiMua">
    <input placeholder="B·∫£o d∆∞·ª°ng Q1" id="m_bdNgayQ1">
    <input placeholder="B·∫£o d∆∞·ª°ng Q2" id="m_bdNgayQ2">
    <input placeholder="B·∫£o d∆∞·ª°ng Q3" id="m_bdNgayQ3">
    <input placeholder="B·∫£o d∆∞·ª°ng Q4" id="m_bdNgayQ4">
    <input placeholder="S·ª≠a ch·ªØa" id="m_suaChua">
    <button id="modalSave">L∆∞u</button>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev"; // Thay b·∫±ng URL Worker b·∫°n
let allData = [];

// --- Modal ---
const modal = document.getElementById('modal');
const m_id = document.getElementById('m_id');
const m_soThe = document.getElementById('m_soThe');
const m_soMay = document.getElementById('m_soMay');
const m_loaiMay = document.getElementById('m_loaiMay');
const m_viTri = document.getElementById('m_viTri');
const m_ghiChu = document.getElementById('m_ghiChu');
const m_daKiemKe = document.getElementById('m_daKiemKe');
const m_chonIn = document.getElementById('m_chonIn');
const m_ngayMua = document.getElementById('m_ngayMua');
const m_noiMua = document.getElementById('m_noiMua');
const m_bdNgayQ1 = document.getElementById('m_bdNgayQ1');
const m_bdNgayQ2 = document.getElementById('m_bdNgayQ2');
const m_bdNgayQ3 = document.getElementById('m_bdNgayQ3');
const m_bdNgayQ4 = document.getElementById('m_bdNgayQ4');
const m_suaChua = document.getElementById('m_suaChua');
const modalClose = document.getElementById('modalClose');
const modalSave = document.getElementById('modalSave');

modalClose.onclick = ()=> modal.style.display='none';
window.onclick = e=>{if(e.target===modal) modal.style.display='none';};

function openModal(row){
  modal.style.display='flex';
  if(row){
    m_id.value=row.id;
    m_soThe.value=row.soThe||'';
    m_soMay.value=row.soMay||'';
    m_loaiMay.value=row.loaiMay||'';
    m_viTri.value=row.viTri||'';
    m_ghiChu.value=row.ghiChu||'';
    m_daKiemKe.checked=row.daKiemKe||false;
    m_chonIn.checked=row.chonIn||false;
    m_ngayMua.value=row.ngayMua||'';
    m_noiMua.value=row.noiMua||'';
    m_bdNgayQ1.value=row.bdNgayQ1||'';
    m_bdNgayQ2.value=row.bdNgayQ2||'';
    m_bdNgayQ3.value=row.bdNgayQ3||'';
    m_bdNgayQ4.value=row.bdNgayQ4||'';
    m_suaChua.value=row.suaChua||'';
  } else {
    m_id.value='';
    m_soThe.value='';
    m_soMay.value='';
    m_loaiMay.value='';
    m_viTri.value='';
    m_ghiChu.value='';
    m_daKiemKe.checked=false;
    m_chonIn.checked=false;
    m_ngayMua.value='';
    m_noiMua.value='';
    m_bdNgayQ1.value='';
    m_bdNgayQ2.value='';
    m_bdNgayQ3.value='';
    m_bdNgayQ4.value='';
    m_suaChua.value='';
  }
}

// --- Load data ---
async function loadData(){
  try{
    const res = await fetch(WORKER_URL);
    const data = await res.json();
    if(data.success){
      allData = data.data;
      renderTable();
    } else alert("L·ªói khi load d·ªØ li·ªáu: "+data.error);
  }catch(e){console.error(e); alert("L·ªói khi load d·ªØ li·ªáu")};
}

// --- Render table ---
function renderTable(){
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML='';
  allData.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.index=idx;
    tr.innerHTML=`
      <td>${r.id}</td>
      <td>${r.soThe||''}</td>
      <td>${r.soMay||''}</td>
      <td>${r.loaiMay||''}</td>
      <td>${r.viTri||''}</td>
      <td>${r.ghiChu||''}</td>
      <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
      <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
      <td>${r.ngayMua||''}</td>
      <td>${r.noiMua||''}</td>
      <td><input type="checkbox" class="bdQ1" ${r.bdQ1?'checked':''}></td>
      <td><input type="checkbox" class="bdQ2" ${r.bdQ2?'checked':''}></td>
      <td><input type="checkbox" class="bdQ3" ${r.bdQ3?'checked':''}></td>
      <td><input type="checkbox" class="bdQ4" ${r.bdQ4?'checked':''}></td>
      <td>${r.suaChua||''}</td>
      <td><button onclick="openModal(allData[${idx}])">S·ª≠a</button></td>
    `;
    tbody.appendChild(tr);

    ['daKiemKe','chonIn','bdQ1','bdQ2','bdQ3','bdQ4'].forEach(cls=>{
      tr.querySelector('.'+cls).addEventListener('change', async function(){
        allData[idx][cls]=this.checked;
        await saveRow(allData[idx]);
      });
    });
  });
}

// --- Save row ---
// --- Save row ---
async function saveRow(row){
  try{
    let url = row.id ? WORKER_URL+"/update" : WORKER_URL+"/add";
    let payload = {...row};
    // Convert checkbox boolean th√†nh 1/0 n·∫øu c·∫ßn
    ['daKiemKe','chonIn','bdQ1','bdQ2','bdQ3','bdQ4'].forEach(k=>{
      payload[k] = payload[k]?1:0;
    });
    const res = await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.success) { alert("L·ªói khi l∆∞u: "+data.error); return; }

    if(!row.id){
      // Th√™m m·ªõi: g√°n id tr·∫£ v·ªÅ t·ª´ D1
      row.id = data.insertedId;
      allData.push(row);
    } else {
      // S·ª≠a: c·∫≠p nh·∫≠t allData
      const idx = allData.findIndex(r=>r.id==row.id);
      if(idx>=0) allData[idx] = {...row};
    }
    renderTable();
  }catch(e){console.error(e); alert("Error: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Worker");}
}

// --- Modal Save ---
modalSave.onclick = async()=>{
  const row = {
    id:m_id.value||null,
    soThe:m_soThe.value,
    soMay:m_soMay.value,
    loaiMay:m_loaiMay.value,
    viTri:m_viTri.value,
    ghiChu:m_ghiChu.value,
    daKiemKe:m_daKiemKe.checked,
    chonIn:m_chonIn.checked,
    ngayMua:m_ngayMua.value,
    noiMua:m_noiMua.value,
    bdQ1:m_bdNgayQ1.value?true:false,
    bdNgayQ1:m_bdNgayQ1.value,
    bdQ2:m_bdNgayQ2.value?true:false,
    bdNgayQ2:m_bdNgayQ2.value,
    bdQ3:m_bdNgayQ3.value?true:false,
    bdNgayQ3:m_bdNgayQ3.value,
    bdQ4:m_bdNgayQ4.value?true:false,
    bdNgayQ4:m_bdNgayQ4.value,
    suaChua:m_suaChua.value
  };
  await saveRow(row);
  modal.style.display='none';
}

// --- Modal Save ---
modalSave.onclick = async()=>{
  const row = {
    id:m_id.value||null,
    soThe:m_soThe.value,
    soMay:m_soMay.value,
    loaiMay:m_loaiMay.value,
    viTri:m_viTri.value,
    ghiChu:m_ghiChu.value,
    daKiemKe:m_daKiemKe.checked,
    chonIn:m_chonIn.checked,
    ngayMua:m_ngayMua.value,
    noiMua:m_noiMua.value,
    bdQ1:m_bdNgayQ1.value?true:false,
    bdNgayQ1:m_bdNgayQ1.value,
    bdQ2:m_bdNgayQ2.value?true:false,
    bdNgayQ2:m_bdNgayQ2.value,
    bdQ3:m_bdNgayQ3.value?true:false,
    bdNgayQ3:m_bdNgayQ3.value,
    bdQ4:m_bdNgayQ4.value?true:false,
    bdNgayQ4:m_bdNgayQ4.value,
    suaChua:m_suaChua.value
  };
  await saveRow(row);
  modal.style.display='none';
}

// --- Add new ---
document.getElementById('btnAdd').onclick=()=>openModal(null);
document.getElementById('btnRefresh').onclick=loadData;

// --- Check all header ---
['KK','QR','Q1','Q2','Q3','Q4'].forEach(id=>{
  document.getElementById('checkAll'+id).addEventListener('change',function(){
    document.querySelectorAll('.'+(id==='KK'?'daKiemKe':id==='QR'?'chonIn':'bd'+id)).forEach(cb=>cb.checked=this.checked);
  });
});

// --- Init ---
loadData();
</script>
</body>
</html>
