<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã Ki·ªÉm k√™ m√°y may - QR + Camera Scan</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f3f6f9; }
h2 { background:#2e86de; color:#fff; padding:12px 20px; margin:0; }
.container { padding:20px; }
button { padding:6px 12px; border:none; background:#2e86de; color:white; border-radius:4px; cursor:pointer; margin-right:5px; }
button:hover { background:#1b4f9c; }
input, select { padding:5px; border:1px solid #ccc; border-radius:4px; }
#msg { margin-top:10px; }
#tableContainer { height:600px; overflow-y:auto; border:1px solid #ccc; background:white; }
table { width:100%; border-collapse: collapse; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#e9ecef; }
.actions button { margin-right:4px; }
.qr-cell { width:70px; height:70px; }
.highlight { background:#ffeaa7 !important; }

/* Popup ch·ªânh s·ª≠a */
.modal { display:none; position: fixed; z-index:999; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.4);}
.modal-content { background:#fff; border-radius:8px; padding:16px; width:400px; margin:8% auto; box-shadow:0 6px 20px rgba(0,0,0,0.2);}
.modal-content label{display:block;margin-top:8px;font-weight:600;}
.modal-content input, .modal-content textarea{width:100%;padding:6px;margin-top:4px;}
.modal-buttons{text-align:right;margin-top:12px;}

/* Camera QR */
#qrScanner { width:100%; max-width:400px; margin-top:10px; }
</style>
</head>
<body>

<h2>üìã Qu·∫£n l√Ω Ki·ªÉm k√™ M√°y May</h2>
<div class="container">

  <div style="margin-bottom:10px;">
    <button onclick="syncData()">üîÑ ƒê·ªìng b·ªô t·ª´ Google Sheet</button>
    <button onclick="saveToGoogleSheet()">üíæ L∆∞u l√™n Google Sheet</button>
    <button onclick="addRow()">‚ûï Th√™m d√≤ng</button>
    <button onclick="exportExcel()">‚¨áÔ∏è Xu·∫•t Excel</button>
    <button onclick="document.getElementById('importInput').click()">‚¨ÜÔ∏è Nh·∫≠p Excel</button>
    <input type="file" id="importInput" accept=".xlsx" onchange="importExcel(event)">
  </div>

  <div style="margin-bottom:10px;">
    <label>Qu√©t / Nh·∫≠p QR ho·∫∑c s·ªë th·∫ª: </label>
    <input type="text" id="qrInput" placeholder="Nh·∫≠p s·ªë th·∫ª ho·∫∑c qu√©t QR..." onkeydown="if(event.key==='Enter') highlightQR()">
  </div>

  <div>
    <label>T√¨m ki·∫øm: </label>
    <input type="text" id="searchBox" oninput="updateFiltered()" placeholder="Nh·∫≠p s·ªë th·∫ª, s·ªë m√°y ho·∫∑c v·ªã tr√≠...">
  </div>

  <div id="msg"></div>

  <div id="qrScanner"></div>

  <div id="tableContainer">
    <table id="dataTable">
      <thead>
        <tr>
          <th>QR</th>
          <th>S·ªë th·∫ª</th>
          <th>S·ªë m√°y</th>
          <th>Lo·∫°i m√°y</th>
          <th>V·ªã tr√≠</th>
          <th>Ghi ch√∫</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<!-- Popup ch·ªânh s·ª≠a -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin d√≤ng</h3>
    <label>S·ªë th·∫ª:</label><input id="editSoThe">
    <label>S·ªë m√°y:</label><input id="editSoMay">
    <label>Lo·∫°i m√°y:</label><input id="editLoaiMay">
    <label>V·ªã tr√≠:</label><input id="editViTri">
    <label>Ghi ch√∫:</label><textarea id="editGhiChu" rows="3"></textarea>
    <div class="modal-buttons">
      <button onclick="closeModal()">H·ªßy</button>
      <button onclick="saveEdit()">C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyV36oZEfMdC7Hc2EOqVL5r2A6qMPWvo5sU3qUdDhxbQ1hMPzwSYgdGnXPioOeZeWVs/exec';
const GITHUB_BASE = 'https://mrlongv.github.io/KiemKeMayVH/';

let data = [];
let filteredData = [];
let editingIndex = null;
const tbody = document.querySelector('#dataTable tbody');

// ---------- ƒê·ªìng b·ªô t·ª´ Google Sheet ----------
async function syncData() {
  const msg = document.getElementById('msg');
  msg.textContent = '‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...';
  try {
    const res = await fetch(GAS_URL);
    const text = await res.text();
    let j = JSON.parse(text);
    if(j.success && Array.isArray(j.data)){
      data = j.data;
      updateFiltered();
      msg.textContent = '‚úÖ ƒê·ªìng b·ªô th√†nh c√¥ng (' + j.data.length + ' d√≤ng)';
      checkURLQR();
    } else throw new Error(j.message || 'Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá');
  } catch(err){
    msg.textContent = '‚ùå L·ªói: ' + err.message;
  }
}

// ---------- L∆∞u d·ªØ li·ªáu l√™n Google Sheet ----------
async function saveToGoogleSheet() {
  const msg = document.getElementById('msg');
  msg.textContent = '‚è≥ ƒêang l∆∞u d·ªØ li·ªáu l√™n Google Sheet...';
  try {
    const formData = new URLSearchParams();
    formData.append('data', JSON.stringify(data));

    const res = await fetch(GAS_URL, { method:'POST', body: formData });
    const text = await res.text();
    let j = JSON.parse(text);
    if(j.success){
      msg.textContent = '‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng ' + j.written + ' d√≤ng!';
    } else throw new Error(j.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
  } catch(err){
    msg.textContent = '‚ùå L·ªói khi l∆∞u: ' + err.message;
  }
}

// ---------- Render b·∫£ng ----------
function renderTable() {
  tbody.innerHTML = '';
  filteredData.forEach((row, i)=>{
    const tr = document.createElement('tr');
    tr.className = row.highlight ? 'highlight' : '';
    tr.innerHTML = `
      <td class="qr-cell" id="qr-${i}"></td>
      <td>${row.soThe}</td>
      <td>${row.soMay}</td>
      <td>${row.loaiMay}</td>
      <td>${row.viTri}</td>
      <td>${row.ghiChu}</td>
      <td class="actions">
        <button onclick="editRow(${i})">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
        <button onclick="deleteRow(${i})">üóëÔ∏è X√≥a</button>
      </td>
    `;
    tbody.appendChild(tr);

    const qrText = GITHUB_BASE + '?id=' + encodeURIComponent(row.soThe);
    new QRCode(document.getElementById('qr-'+i), { text: qrText, width:60, height:60 });
  });
}

// ---------- Filter d·ªØ li·ªáu ----------
function updateFiltered() {
  const keyword = document.getElementById('searchBox').value.toLowerCase();
  filteredData = data.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(keyword)));
  renderTable();
}

// ---------- Highlight theo QR / S·ªë th·∫ª ----------
function highlightQR(val=null){
  val = val || document.getElementById('qrInput').value.trim().toLowerCase();
  filteredData.forEach(r=> r.highlight = false);
  const idx = filteredData.findIndex(r => r.soThe.toLowerCase() === val);
  if(idx !== -1){
    filteredData[idx].highlight = true;
    document.querySelectorAll('#dataTable tbody tr')[idx].scrollIntoView({behavior:'smooth', block:'center'});
    renderTable();
  }
  document.getElementById('qrInput').value = '';
}

// ---------- Ki·ªÉm tra URL khi qu√©t QR tr·ª±c ti·∫øp ----------
function checkURLQR(){
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if(id) highlightQR(id);
}

// ---------- Ch·ªânh s·ª≠a d√≤ng ----------
function editRow(index){
  editingIndex = index;
  const row = filteredData[index];
  document.getElementById('editSoThe').value = row.soThe;
  document.getElementById('editSoMay').value = row.soMay;
  document.getElementById('editLoaiMay').value = row.loaiMay;
  document.getElementById('editViTri').value = row.viTri;
  document.getElementById('editGhiChu').value = row.ghiChu;
  document.getElementById('editModal').style.display = 'block';
}
function saveEdit(){
  if(editingIndex === null) return;
  const row = filteredData[editingIndex];
  row.soThe = document.getElementById('editSoThe').value;
  row.soMay = document.getElementById('editSoMay').value;
  row.loaiMay = document.getElementById('editLoaiMay').value;
  row.viTri = document.getElementById('editViTri').value;
  row.ghiChu = document.getElementById('editGhiChu').value;

  const originalIndex = data.indexOf(row);
  if(originalIndex !== -1) data[originalIndex] = row;

  editingIndex = null;
  document.getElementById('editModal').style.display = 'none';
  renderTable();
}
function closeModal(){ editingIndex = null; document.getElementById('editModal').style.display='none'; }

// ---------- Th√™m / X√≥a d√≤ng ----------
function addRow(){
  const newRow = {soThe:'',soMay:'',loaiMay:'',viTri:'',ghiChu:''};
  data.push(newRow);
  updateFiltered();
}
function deleteRow(index){
  if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng n√†y?')){
    const row = filteredData[index];
    const originalIndex = data.indexOf(row);
    if(originalIndex !== -1) data.splice(originalIndex,1);
    updateFiltered();
  }
}

// ---------- Xu·∫•t / Nh·∫≠p Excel ----------
function exportExcel(){
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DanhSachMay");
  XLSX.writeFile(wb, "DanhSachMay.xlsx");
}
function importExcel(evt){
  const file = evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    const wb = XLSX.read(e.target.result,{type:'binary'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    data = XLSX.utils.sheet_to_json(ws);
    updateFiltered();
  };
  reader.readAsBinaryString(file);
}

// ---------- Camera QR Scan ----------
function startCameraScan(){
  const qrScanner = new Html5Qrcode("qrScanner");
  qrScanner.start(
    { facingMode: "environment" },
    { fps:10, qrbox:250 },
    qrCodeMessage => { highlightQR(qrCodeMessage); }
  ).catch(err=> console.log(err));
}

// ---------- Khi m·ªü trang ----------
window.addEventListener('load', ()=>{
  syncData();
  startCameraScan();
});
</script>

</body>
</html>
