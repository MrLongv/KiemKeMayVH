<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may - Sync JSONP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
th{background:#0b74d1;color:#fff}
tr.highlight{background:#ffeaa7 !important}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} .controls input[type="text"]{width:100%} }
</style>
</head>
<body>
<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may â€” Sync JSONP</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y" />
  <button id="btnAdd">â• ThÃªm</button>
  <button id="btnSync">â˜ï¸ Äá»“ng bá»™ Sheet</button>
  <button id="btnRefresh" class="ghost">ğŸ”„ Táº£i láº¡i tá»« Sheet</button>
  <button id="btnPrint">ğŸ–¨ï¸ In tem QR</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
</div>

<div class="note">QR code, in tem, checkbox "ÄÃ£ kiá»ƒm kÃª" + "Chá»n Ä‘á»ƒ in", ngÃ y mua chuáº©n dd/mm/yyyy</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>Sá»‘ tháº»</th>
        <th>Sá»‘ mÃ¡y</th>
        <th>Loáº¡i mÃ¡y</th>
        <th>Vá»‹ trÃ­</th>
        <th>Ghi chÃº</th>
        <th>ÄÃ£ kiá»ƒm kÃª</th>
        <th>Chá»n Ä‘á»ƒ in</th>
        <th>NgÃ y mua</th>
        <th>HÃ nh Ä‘á»™ng</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a / ThÃªm dÃ²ng</h3>
    <label>Sá»‘ tháº»</label><input id="m_soThe" />
    <label>Sá»‘ mÃ¡y</label><input id="m_soMay" />
    <label>Loáº¡i mÃ¡y</label><input id="m_loaiMay" />
    <label>Vá»‹ trÃ­</label><input id="m_viTri" />
    <label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
    <label>ÄÃ£ kiá»ƒm kÃª</label><input type="checkbox" id="m_daKiemKe" />
    <label>Chá»n Ä‘á»ƒ in</label><input type="checkbox" id="m_chonIn" />
    <label>NgÃ y mua</label><input type="date" id="m_ngayMua" />
    <div class="actions">
      <button id="cancelBtn" class="ghost">Há»§y</button>
      <button id="saveBtn">Cáº­p nháº­t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzXo8WTTJlaRptJNK_iBJn8Pm3z4bn9Bt2J2iRBdqOFx8PG5ZK1XCnK3mKycwGfY_r9/exec'; // <-- Thay báº±ng URL Web App deploy
const statusEl = document.getElementById('status');
const tbody = document.querySelector('#dataTable tbody');
let allData = [], editingIndex = null;

function setStatus(txt,ok=true){statusEl.innerText='Tráº¡ng thÃ¡i: '+txt; statusEl.style.color=ok?'#0b74d1':'#c0392b';}
function safeText(v){return (v===null||v===undefined)?'':String(v);}

/* ===== Load dá»¯ liá»‡u JSONP ===== */
function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  const cbName = '__load_cb_' + Date.now();
  window[cbName] = function(res){
    try{
      if(res && res.success && Array.isArray(res.data)){
        allData = res.data;
        renderTable();
        setStatus('ÄÃ£ táº£i '+allData.length+' dÃ²ng');
      } else {
        setStatus('Lá»—i táº£i dá»¯ liá»‡u',false);
        alert(res.message || 'KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u');
      }
    } finally { delete window[cbName]; script.remove(); }
  };
  const script = document.createElement('script');
  script.src = GAS_URL + '?callback=' + cbName + '&_=' + Date.now();
  script.onerror = ()=>{ setStatus('Lá»—i táº£i dá»¯ liá»‡u',false); delete window[cbName]; script.remove(); };
  document.head.appendChild(script);
}

/* ===== Render báº£ng ===== */
function renderTable(){
  tbody.innerHTML = '';
  allData.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${safeText(r.soThe)}</td>
      <td>${safeText(r.soMay)}</td>
      <td>${safeText(r.loaiMay)}</td>
      <td>${safeText(r.viTri)}</td>
      <td>${safeText(r.ghiChu)}</td>
      <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
      <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
      <td>${r.ngayMua||''}</td>
      <td>
        <button data-act="edit" data-i="${idx}">âœï¸</button>
        <button data-act="qr" data-i="${idx}">ğŸ”—</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== Báº£ng sá»± kiá»‡n ===== */
tbody.addEventListener('click',e=>{
  const btn=e.target.closest('button');
  if(!btn) return;
  const act=btn.dataset.act, i=Number(btn.dataset.i);
  if(act==='edit') openEditModal(i);
  else if(act==='qr'){
    const code = encodeURIComponent(allData[i].soThe||'');
    const url = location.href.split('#')[0]+'#'+code;
    prompt('Link QR (copy & in tem):', url);
  }
});
tbody.addEventListener('change',e=>{
  const tr=e.target.closest('tr'); const idx=Number(tr.dataset.index);
  if(e.target.classList.contains('daKiemKe')) allData[idx].daKiemKe=e.target.checked;
  if(e.target.classList.contains('chonIn')) allData[idx].chonIn=e.target.checked;
});

/* ===== Modal thÃªm/sá»­a ===== */
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe');
const m_soMay=document.getElementById('m_soMay');
const m_loaiMay=document.getElementById('m_loaiMay');
const m_viTri=document.getElementById('m_viTri');
const m_ghiChu=document.getElementById('m_ghiChu');
const m_daKiemKe=document.getElementById('m_daKiemKe');
const m_chonIn=document.getElementById('m_chonIn');
const m_ngayMua=document.getElementById('m_ngayMua');
document.getElementById('btnAdd').onclick=()=>openEditModal(null);
document.getElementById('cancelBtn').onclick=()=>{ modal.style.display='none'; editingIndex=null; };
document.getElementById('saveBtn').onclick=()=>{
  const obj = {
    soThe: m_soThe.value.trim(),
    soMay: m_soMay.value.trim(),
    loaiMay: m_loaiMay.value.trim(),
    viTri: m_viTri.value.trim(),
    ghiChu: m_ghiChu.value.trim(),
    daKiemKe: m_daKiemKe.checked,
    chonIn: m_chonIn.checked,
    ngayMua: m_ngayMua.value ? (new Date(m_ngayMua.value)).toLocaleDateString('en-GB') : ''
  };
  if(!obj.soThe){alert('Sá»‘ tháº» khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng'); return;}
  if(editingIndex===null) allData.push(obj); else allData[editingIndex]=obj;
  modal.style.display='none'; editingIndex=null; renderTable();
};
function openEditModal(idx){
  editingIndex = (typeof idx==='number')?idx:null;
  if(editingIndex===null){
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu='';
    m_daKiemKe.checked=m_chonIn.checked=false;
    m_ngayMua.value='';
  } else {
    const r=allData[editingIndex];
    m_soThe.value=r.soThe; m_soMay.value=r.soMay; m_loaiMay.value=r.loaiMay;
    m_viTri.value=r.viTri; m_ghiChu.value=r.ghiChu;
    m_daKiemKe.checked=r.daKiemKe; m_chonIn.checked=r.chonIn;
    m_ngayMua.value=r.ngayMua ? new Date(r.ngayMua.split('/').reverse().join('-')).toISOString().slice(0,10) : '';
  }
  modal.style.display='flex'; m_soThe.focus();
}

/* ===== TÃ¬m kiáº¿m ===== */
document.getElementById('searchBox').addEventListener('input',e=>{
  const v=e.target.value.toLowerCase();
  Array.from(tbody.children).forEach(tr=>{
    const idx=Number(tr.dataset.index); const r=allData[idx];
    const text=(r.soThe+' '+r.soMay+' '+r.loaiMay+' '+r.viTri+' '+r.ghiChu).toLowerCase();
    tr.style.display=text.includes(v)?'':'none';
  });
});

/* ===== JSONP Äá»“ng bá»™ dá»¯ liá»‡u ===== */
document.getElementById('btnSync').onclick = () => {
  const payload = allData;
  const encoded = encodeURIComponent(JSON.stringify(payload));
  const cbName = '__sync_cb_' + Date.now();
  window[cbName] = function(res){
    try{
      if(res && res.success){
        setStatus('ÄÃ£ Ä‘á»“ng bá»™ '+(res.written||0)+' dÃ²ng');
        loadData();
      } else {
        setStatus('Lá»—i ghi dá»¯ liá»‡u', false);
        alert(res.message || 'Lá»—i ghi dá»¯ liá»‡u');
      }
    } finally {
      delete window[cbName];
      script.remove();
    }
  };
  const script = document.createElement('script');
  script.src = GAS_URL + '?save=1&callback=' + cbName + '&data=' + encoded + '&_=' + Date.now();

  // ==== Thay Ä‘á»•i á»Ÿ Ä‘Ã¢y ====
  script.onerror = function(){
    console.warn('CÃ³ thá»ƒ ghi thÃ nh cÃ´ng nhÆ°ng JSONP callback chÆ°a load xong.');
    delete window[cbName];
    script.remove();
    // KhÃ´ng hiá»‡n alert, dá»¯ liá»‡u váº«n vÃ o sheet
  };

  document.head.appendChild(script);
};


/* ===== In tem QR ===== */
document.getElementById('btnPrint').onclick=()=>{
  const printData = allData.filter(r=>r.chonIn);
  if(printData.length===0){alert('Chá»n Ã­t nháº¥t 1 dÃ²ng Ä‘á»ƒ in'); return;}
  const w=window.open('','_blank');
  w.document.write('<html><head><title>In Tem QR</title><style>body{font-family:Arial;margin:0;padding:0} .tem{width:48%;height:180px;margin:1%;float:left;border:1px solid #000;padding:4px;box-sizing:border-box;text-align:center;} canvas{margin-top:8px}</style></head><body>');
  printData.forEach(r=>{
    w.document.write('<div class="tem"><b>Sá»‘ tháº»:</b>'+r.soThe+'<br><b>Sá»‘ mÃ¡y:</b>'+r.soMay+'<br><b>NgÃ y mua:</b>'+r.ngayMua+'<div id="qr_'+r.soThe+'"></div></div>');
  });
  w.document.write('</body></html>');
  w.document.close();
  printData.forEach(r=>{
    const qrDiv=w.document.getElementById('qr_'+r.soThe);
    new QRCode(qrDiv, {text:r.soThe,width:80,height:80});
  });
  w.focus(); w.print();
};

/* ===== Táº£i láº¡i dá»¯ liá»‡u ===== */
document.getElementById('btnRefresh').onclick = loadData;

/* ===== Load khi má»Ÿ ===== */
loadData();
</script>
</body>
</html>
