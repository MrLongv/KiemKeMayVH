<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üìã Ki·ªÉm k√™ m√°y may</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:6px;text-align:center;word-break:break-word;font-size:13px}
th{background:#0b74d1;color:#fff}
tr.highlight{background: #ffeaa7 !important}
/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} .controls input[type="text"]{width:100%} }
</style>
</head>
<body>

<header>üìã Ki·ªÉm k√™ m√°y may ‚Äî Full Features</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="üîç T√¨m theo s·ªë th·∫ª / s·ªë m√°y" />
  <button id="btnImport" class="ghost">üìÇ Nh·∫≠p Excel</button>
  <button id="btnExport">üíæ Xu·∫•t Excel</button>
  <button id="btnAdd">‚ûï Th√™m</button>
  <button id="btnSync">‚òÅÔ∏è ƒê·ªìng b·ªô Google Sheet</button>
  <button id="btnRefresh" class="ghost">üîÑ T·∫£i l·∫°i t·ª´ Sheet</button>
  <button id="btnPrintQR">üñ®Ô∏è In tem QR code</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tr·∫°ng th√°i: offline</span>
  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
</div>

<div class="note">Ghi ch√∫: Ch·ªâ in c√°c d√≤ng checkbox ch·ªçn. QR code v√† ng√†y mua hi·ªÉn th·ªã tr√™n tem.</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>Ch·ªçn</th>
        <th>STT</th>
        <th>S·ªë th·∫ª</th>
        <th>S·ªë m√°y</th>
        <th>Lo·∫°i m√°y</th>
        <th>V·ªã tr√≠</th>
        <th>Ng√†y mua</th>
        <th>ƒê√£ ki·ªÉm k√™</th>
        <th>Ghi ch√∫</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">‚úèÔ∏è Ch·ªânh s·ª≠a / Th√™m d√≤ng</h3>
    <label>S·ªë th·∫ª</label><input id="m_soThe" />
    <label>S·ªë m√°y</label><input id="m_soMay" />
    <label>Lo·∫°i m√°y</label><input id="m_loaiMay" />
    <label>V·ªã tr√≠</label><input id="m_viTri" />
    <label>Ng√†y mua</label><input id="m_ngayMua" type="date"/>
    <label>ƒê√£ ki·ªÉm k√™</label><input id="m_daKiemKe" type="checkbox"/>
    <label>Ghi ch√∫</label><textarea id="m_ghiChu" rows="3"></textarea>
    <div class="actions">
      <button id="cancelBtn" class="ghost">H·ªßy</button>
      <button id="saveBtn">C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxHxIuxKWZk_ddirCCes0nf-fbbnex0q3kTSZWiRdbpP7JDzDpMZlslWo-FWM0CPKGH/exec';
const DATA_JSON = 'data.json';
const statusEl = document.getElementById('status');
const tbody = document.querySelector('#dataTable tbody');
let allData = [];
let editingIndex = null;

function setStatus(text, ok=true){ statusEl.innerText = 'Tr·∫°ng th√°i: '+text; statusEl.style.color=ok?'#0b74d1':'#c0392b'; }
function safeText(v){ return (v===null||v===undefined)?'':String(v); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function loadData(){
  setStatus('ƒêang t·∫£i d·ªØ li·ªáu...');
  try {
    const res = await fetch(GAS_URL);
    if(!res.ok) throw new Error('GAS l·ªói '+res.status);
    const j = await res.json();
    if(j && j.success && Array.isArray(j.data)){
      allData = j.data.map(r=>({
        soThe:safeText(r.soThe), soMay:safeText(r.soMay),
        loaiMay:safeText(r.loaiMay), viTri:safeText(r.viTri),
        ngayMua:r.ngayMua||'', daKiemKe:!!r.daKiemKe,
        ghiChu:safeText(r.ghiChu)
      }));
      setStatus('ƒê√£ t·∫£i t·ª´ Google Sheet ('+allData.length+' d√≤ng)');
      renderTable(); return;
    } else throw new Error('GAS tr·∫£ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
  } catch(err){
    console.warn('Load GAS th·∫•t b·∫°i',err);
    try{
      const res2 = await fetch(DATA_JSON+'?_='+Date.now());
      const arr = await res2.json();
      allData = arr.map(r=>({
        soThe:safeText(r.soThe), soMay:safeText(r.soMay),
        loaiMay:safeText(r.loaiMay), viTri:safeText(r.viTri),
        ngayMua:r.ngayMua||'', daKiemKe:!!r.daKiemKe,
        ghiChu:safeText(r.ghiChu)
      }));
      setStatus('ƒê√£ t·∫£i d·ª± ph√≤ng t·ª´ data.json ('+allData.length+' d√≤ng)');
      renderTable();
    }catch(e2){ setStatus('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu',false); allData=[]; renderTable(); }
  }
}

function renderTable(){
  tbody.innerHTML='';
  allData.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.index=idx;
    tr.innerHTML = `
      <td><input type="checkbox" class="chkPrint"></td>
      <td>${idx+1}</td>
      <td>${escapeHtml(r.soThe)}</td>
      <td>${escapeHtml(r.soMay)}</td>
      <td>${escapeHtml(r.loaiMay)}</td>
      <td>${escapeHtml(r.viTri)}</td>
      <td>${r.ngayMua}</td>
      <td><input type="checkbox" class="chkDakiemke" ${r.daKiemKe?'checked':''}></td>
      <td>${escapeHtml(r.ghiChu)}</td>
      <td>
        <button data-act="edit" data-i="${idx}">‚úèÔ∏è</button>
        <button data-act="del" data-i="${idx}">üóëÔ∏è</button>
        <button data-act="qr" data-i="${idx}">üîó</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ======= S·ª± ki·ªán trong b·∫£ng ======= */
tbody.addEventListener('click',(ev)=>{
  const btn=ev.target.closest('button');
  if(btn){
    const act=btn.dataset.act, i=Number(btn.dataset.i);
    if(act==='edit') openEditModal(i);
    else if(act==='del'){ if(confirm('X√≥a '+allData[i].soThe+'?')){ allData.splice(i,1); renderTable(); } }
    else if(act==='qr'){ const url=location.href.split('#')[0]+'#'+encodeURIComponent(allData[i].soThe); prompt('Link QR:',url); }
  } else if(ev.target.classList.contains('chkDakiemke')){
    const idx = Number(ev.target.closest('tr').dataset.index);
    allData[idx].daKiemKe = ev.target.checked;
  }
});

/* ======= Modal ======= */
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe');
const m_soMay=document.getElementById('m_soMay');
const m_loaiMay=document.getElementById('m_loaiMay');
const m_viTri=document.getElementById('m_viTri');
const m_ngayMua=document.getElementById('m_ngayMua');
const m_daKiemKe=document.getElementById('m_daKiemKe');
const m_ghiChu=document.getElementById('m_ghiChu');
const cancelBtn=document.getElementById('cancelBtn');
const saveBtn=document.getElementById('saveBtn');

function openEditModal(index){
  editingIndex=(typeof index==='number')?index:null;
  if(editingIndex===null){
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ngayMua.value=m_ghiChu.value=''; m_daKiemKe.checked=false;
  }else{
    const r=allData[editingIndex];
    m_soThe.value=r.soThe; m_soMay.value=r.soMay; m_loaiMay.value=r.loaiMay; m_viTri.value=r.viTri;
    m_ngayMua.value=r.ngayMua; m_daKiemKe.checked=r.daKiemKe; m_ghiChu.value=r.ghiChu;
  }
  modal.style.display='flex'; m_soThe.focus();
}

cancelBtn.onclick=()=>{ modal.style.display='none'; editingIndex=null; };
saveBtn.onclick=()=>{
  const obj={
    soThe:m_soThe.value.trim(), soMay:m_soMay.value.trim(),
    loaiMay:m_loaiMay.value.trim(), viTri:m_viTri.value.trim(),
    ngayMua:m_ngayMua.value, daKiemKe:m_daKiemKe.checked,
    ghiChu:m_ghiChu.value.trim()
  };
  if(!obj.soThe){ alert('S·ªë th·∫ª kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng'); return; }
  if(editingIndex===null) allData.push(obj); else allData[editingIndex]=obj;
  modal.style.display='none'; editingIndex=null; renderTable();
};

/* ======= N√∫t ƒëi·ªÅu khi·ªÉn ======= */
document.getElementById('btnAdd').addEventListener('click',()=>openEditModal(null));
document.getElementById('btnExport').addEventListener('click',exportExcel);
document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('btnRefresh').addEventListener('click',loadData);
document.getElementById('fileInput').addEventListener('change',(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=(ev)=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    allData=sheet.map(r=>({
      soThe:r.soThe||r['S·ªë th·∫ª']||'',
      soMay:r.soMay||r['S·ªë m√°y']||'',
      loaiMay:r.loaiMay||r['Lo·∫°i m√°y']||'',
      viTri:r.viTri||r['V·ªã tr√≠']||'',
      ngayMua:r.ngayMua||'',
      daKiemKe:!!r.daKiemKe,
      ghiChu:r.ghiChu||r['Ghi ch√∫']||''
    }));
    renderTable();
  };
  reader.readAsArrayBuffer(f);
});

function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(allData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'DanhSachMay');
  XLSX.writeFile(wb,'DanhSachMay.xlsx');
}

async function syncToSheet(){
  setStatus('ƒêang ƒë·ªìng b·ªô...');
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(allData)});
    const txt=await res.text();
    let parsed=null; try{ parsed=txt?JSON.parse(txt):null }catch(e){parsed=null;}
    if(!res.ok){ setStatus('HTTP l·ªói',false); alert('L·ªói '+txt); return; }
    if(parsed && parsed.success){ setStatus('ƒê√£ ƒë·ªìng b·ªô'); alert('ƒê·ªìng b·ªô th√†nh c√¥ng'); setTimeout(()=>loadData(),700); }
    else{ setStatus('Server tr·∫£ v·ªÅ',true); alert('Server: '+txt); }
  }catch(err){ setStatus('L·ªói k·∫øt n·ªëi',false); alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi: '+err.message); }
}

document.getElementById('btnSync').addEventListener('click',syncToSheet);

/* ======= Search nhanh ======= */
document.getElementById('searchBox').addEventListener('input',(e)=>{
  const q=e.target.value.trim().toLowerCase();
  tbody.querySelectorAll('tr').forEach(r=>{
    const idx=Number(r.dataset.index);
    const d=allData[idx];
    r.style.display=(d.soThe.toLowerCase().includes(q) || d.soMay.toLowerCase().includes(q))?'':'none';
  });
});

/* ======= In tem QR code ======= */
document.getElementById('btnPrintQR').addEventListener('click',()=>{
  const selectedRows = Array.from(tbody.querySelectorAll('tr')).filter(r=>r.querySelector('.chkPrint').checked);
  if(selectedRows.length===0){ alert('Ch∆∞a ch·ªçn d√≤ng ƒë·ªÉ in'); return; }

  const win=window.open('','_blank','width=800,height=600');
  win.document.write('<html><head><title>In tem QR</title>');
  win.document.write('<style>body{font-family:Arial;margin:5mm} .page{page-break-after:always;display:flex;flex-wrap:wrap;align-content:flex-start} .tem{width:95mm;height:55mm;margin:5px;border:1px solid #000;padding:4px;text-align:center;font-size:12px}</style>');
  win.document.write('</head><body><div class="page">');

  let count=0;
  selectedRows.forEach(r=>{
    const idx=Number(r.dataset.index); const d=allData[idx];
    win.document.write('<div class="tem">');
    win.document.write('<div><b>'+escapeHtml(d.soThe)+'</b></div>');
    win.document.write('<div>S·ªë m√°y: '+escapeHtml(d.soMay)+'</div>');
    win.document.write('<div>Lo·∫°i: '+escapeHtml(d.loaiMay)+'</div>');
    win.document.write('<div>V·ªã tr√≠: '+escapeHtml(d.viTri)+'</div>');
    win.document.write('<div>Ng√†y mua: '+escapeHtml(d.ngayMua)+'</div>');
    win.document.write('<div id="qr'+idx+'"></div>');
    win.document.write('</div>');
    count++;
    if(count%6===0) win.document.write('</div><div class="page">');
  });

  win.document.write('</div></body></html>');
  win.document.close();

  win.onload=()=>{
    selectedRows.forEach(r=>{
      const idx=Number(r.dataset.index); const d=allData[idx];
      const container=win.document.getElementById('qr'+idx);
      if(container) new QRCode(container,{text:d.soThe+'|'+d.soMay,width:80,height:80});
    });
    win.focus(); win.print();
  };
});

/* ======= Init ======= */
loadData();
</script>

</body>
</html>
