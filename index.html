<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kiểm kê VH</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:10px; background:#f4f6f8; }
h1 { text-align:center; }
button { margin:2px; padding:4px 8px; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; width:400px; border-radius:5px; position:relative; }
.close { position:absolute; top:10px; right:10px; cursor:pointer; font-weight:bold; }
input[type="text"], input[type="number"], input[type="date"] { width:100%; margin-bottom:6px; }
</style>
</head>
<body>
<h1>Kiểm kê VH</h1>
<div>
  <label>Năm: 
    <select id="selectYear"></select>
  </label>
  <button id="btnAdd">Thêm</button>
</div>
<table id="dataTable">
<thead>
<tr>
  <th>ID</th><th>Số thẻ</th><th>Số máy</th><th>Loại máy</th><th>Vị trí</th><th>Ghi chú</th>
  <th>Đã KK</th><th>In QR</th>
  <th>Ngày mua</th><th>Nơi mua</th>
  <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th>
  <th>Sửa chữa</th><th>Hành động</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" id="modalClose">&times;</span>
    <h3 id="modalTitle">Chỉnh sửa máy</h3>
    <input type="hidden" id="modalId">
    <label>Số thẻ: <input type="text" id="mSoThe"></label>
    <label>Số máy: <input type="text" id="mSoMay"></label>
    <label>Loại máy: <input type="text" id="mLoaiMay"></label>
    <label>Vị trí: <input type="text" id="mViTri"></label>
    <label>Ghi chú: <input type="text" id="mGhiChu"></label>
    <label>Đã KK: <input type="checkbox" id="mDaKiemKe"></label>
    <label>In QR: <input type="checkbox" id="mChonIn"></label>
    <label>Ngày mua: <input type="date" id="mNgayMua"></label>
    <label>Nơi mua: <input type="text" id="mNoiMua"></label>
    <label>Q1: <input type="checkbox" id="mBdQ1"><input type="text" id="mBdNgayQ1" placeholder="Ngày"></label>
    <label>Q2: <input type="checkbox" id="mBdQ2"><input type="text" id="mBdNgayQ2" placeholder="Ngày"></label>
    <label>Q3: <input type="checkbox" id="mBdQ3"><input type="text" id="mBdNgayQ3" placeholder="Ngày"></label>
    <label>Q4: <input type="checkbox" id="mBdQ4"><input type="text" id="mBdNgayQ4" placeholder="Ngày"></label>
    <label>Sửa chữa: <input type="text" id="mSuaChua"></label>
    <button id="modalSave">Lưu</button>
  </div>
</div>

<script>
const WORKER_URL = 'https://snowy-surf-e985.hoalangiongxoai.workers.dev';
let allData = [];
let currentYear = new Date().getFullYear();

const modal = document.getElementById('modal');
const modalClose = document.getElementById('modalClose');
const modalSave = document.getElementById('modalSave');

const mId = document.getElementById('modalId');
const mSoThe = document.getElementById('mSoThe');
const mSoMay = document.getElementById('mSoMay');
const mLoaiMay = document.getElementById('mLoaiMay');
const mViTri = document.getElementById('mViTri');
const mGhiChu = document.getElementById('mGhiChu');
const mDaKiemKe = document.getElementById('mDaKiemKe');
const mChonIn = document.getElementById('mChonIn');
const mNgayMua = document.getElementById('mNgayMua');
const mNoiMua = document.getElementById('mNoiMua');
const mBdQ1 = document.getElementById('mBdQ1');
const mBdNgayQ1 = document.getElementById('mBdNgayQ1');
const mBdQ2 = document.getElementById('mBdQ2');
const mBdNgayQ2 = document.getElementById('mBdNgayQ2');
const mBdQ3 = document.getElementById('mBdQ3');
const mBdNgayQ3 = document.getElementById('mBdNgayQ3');
const mBdQ4 = document.getElementById('mBdQ4');
const mBdNgayQ4 = document.getElementById('mBdNgayQ4');
const mSuaChua = document.getElementById('mSuaChua');

const selectYear = document.getElementById('selectYear');

// ==== NĂM ====
function initYearDropdown() {
  const startYear = 2024;
  const endYear = new Date().getFullYear() + 5;
  for(let y=startYear;y<=endYear;y++){
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if(y===currentYear) opt.selected = true;
    selectYear.appendChild(opt);
  }
  selectYear.addEventListener('change',()=>{ currentYear=Number(selectYear.value); loadData(); });
}

// ==== MODAL ====
function openModal(row=null){
  modal.style.display='flex';
  if(row){
    mId.value=row.id||'';
    mSoThe.value=row.soThe||'';
    mSoMay.value=row.soMay||'';
    mLoaiMay.value=row.loaiMay||'';
    mViTri.value=row.viTri||'';
    mGhiChu.value=row.ghiChu||'';
    mDaKiemKe.checked=row.daKiemKe==1;
    mChonIn.checked=row.chonIn==1;
    mNgayMua.value=row.ngayMua||'';
    mNoiMua.value=row.noiMua||'';
    mBdQ1.checked=row.bdQ1==1; mBdNgayQ1.value=row.bdNgayQ1||'';
    mBdQ2.checked=row.bdQ2==1; mBdNgayQ2.value=row.bdNgayQ2||'';
    mBdQ3.checked=row.bdQ3==1; mBdNgayQ3.value=row.bdQ3||'';
    mBdQ4.checked=row.bdQ4==1; mBdNgayQ4.value=row.bdQ4||'';
    mSuaChua.value=row.suaChua||'';
  } else {
    mId.value=''; mSoThe.value=''; mSoMay.value=''; mLoaiMay.value='';
    mViTri.value=''; mGhiChu.value=''; mDaKiemKe.checked=false; mChonIn.checked=false;
    mNgayMua.value=''; mNoiMua.value='';
    mBdQ1.checked=false; mBdNgayQ1.value='';
    mBdQ2.checked=false; mBdNgayQ2.value='';
    mBdQ3.checked=false; mBdNgayQ3.value='';
    mBdQ4.checked=false; mBdNgayQ4.value='';
    mSuaChua.value='';
  }
}
modalClose.onclick=()=>modal.style.display='none';

// ==== LOAD DỮ LIỆU ====
async function loadData(){
  try{
    const res = await fetch(`${WORKER_URL}?nam=${currentYear}`);
    const data = await res.json();
    if(!data.success) throw new Error(data.error||'Không xác định');
    allData = data.data||[];
    renderTable();
  }catch(e){
    alert('Lỗi khi load dữ liệu: '+e);
    console.error(e);
  }
}

function renderTable(){
  const tbody=document.querySelector('#dataTable tbody');
  tbody.innerHTML='';
  allData.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${row.id}</td>
      <td>${row.soThe||''}</td>
      <td>${row.soMay||''}</td>
      <td>${row.loaiMay||''}</td>
      <td>${row.viTri||''}</td>
      <td>${row.ghiChu||''}</td>
      <td><input type="checkbox" class="cbDaKiemKe" ${row.daKiemKe==1?'checked':''}></td>
      <td><input type="checkbox" class="cbChonIn" ${row.chonIn==1?'checked':''}></td>
      <td>${row.ngayMua||''}</td>
      <td>${row.noiMua||''}</td>
      <td><input type="checkbox" class="cbBdQ1" ${row.bdQ1==1?'checked':''}></td>
      <td><input type="checkbox" class="cbBdQ2" ${row.bdQ2==1?'checked':''}></td>
      <td><input type="checkbox" class="cbBdQ3" ${row.bdQ3==1?'checked':''}></td>
      <td><input type="checkbox" class="cbBdQ4" ${row.bdQ4==1?'checked':''}></td>
      <td>${row.suaChua||''}</td>
      <td><button class="btnEdit">Sửa</button></td>
    `;
    tbody.appendChild(tr);

    // Checkbox thay đổi trực tiếp
    tr.querySelector('.cbDaKiemKe').addEventListener('change',()=>updateRowCheckbox(row.id,'daKiemKe',tr.querySelector('.cbDaKiemKe').checked));
    tr.querySelector('.cbChonIn').addEventListener('change',()=>updateRowCheckbox(row.id,'chonIn',tr.querySelector('.cbChonIn').checked));
    tr.querySelector('.cbBdQ1').addEventListener('change',()=>updateRowCheckbox(row.id,'bdQ1',tr.querySelector('.cbBdQ1').checked));
    tr.querySelector('.cbBdQ2').addEventListener('change',()=>updateRowCheckbox(row.id,'bdQ2',tr.querySelector('.cbBdQ2').checked));
    tr.querySelector('.cbBdQ3').addEventListener('change',()=>updateRowCheckbox(row.id,'bdQ3',tr.querySelector('.cbBdQ3').checked));
    tr.querySelector('.cbBdQ4').addEventListener('change',()=>updateRowCheckbox(row.id,'bdQ4',tr.querySelector('.cbBdQ4').checked));

    tr.querySelector('.btnEdit').addEventListener('click',()=>openModal(row));
  });
}

// ==== UPDATE CHECKBOX TRỰC TIẾP ====
async function updateRowCheckbox(id,field,value){
  try{
    const row = allData.find(r=>r.id==id);
    if(!row) return;
    row[field] = value?1:0;
    const body={...row, nam:currentYear};
    const res = await fetch(`${WORKER_URL}/update`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const data = await res.json();
    if(!data.success) throw new Error(data.error||'Không nhận được phản hồi từ Worker');
    loadData();
  }catch(e){ console.error(e); alert('Lỗi khi cập nhật: '+e); }
}

// ==== SAVE MODAL ====
modalSave.onclick=async()=>{
  try{
    const body = {
      id: mId.value||null,
      soThe:mSoThe.value, soMay:mSoMay.value, loaiMay:mLoaiMay.value, viTri:mViTri.value,
      ghiChu:mGhiChu.value,
      daKiemKe:mDaKiemKe.checked?1:0,
      chonIn:mChonIn.checked?1:0,
      bdQ1:mBdQ1.checked?1:0, bdNgayQ1:mBdNgayQ1.value,
      bdQ2:mBdQ2.checked?1:0, bdNgayQ2:mBdNgayQ2.value,
      bdQ3:mBdQ3.checked?1:0, bdNgayQ3:mBdNgayQ3.value,
      bdQ4:mBdQ4.checked?1:0, bdNgayQ4:mBdNgayQ4.value,
      ngayMua:mNgayMua.value,
      noiMua:mNoiMua.value,
      suaChua:mSuaChua.value,
      nam:currentYear
    };
    const url = body.id?`${WORKER_URL}/update`:`${WORKER_URL}/add`;
    const res = await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const data = await res.json();
    if(!data.success) throw new Error(data.error||'Không nhận được phản hồi từ Worker');
    modal.style.display='none';
    loadData();
  }catch(e){ console.error(e); alert('Lỗi khi lưu: '+e); }
}

// ==== ADD ====
document.getElementById('btnAdd').onclick=()=>openModal(null);

// ==== INIT ====
initYearDropdown();
loadData();
</script>
</body>
</html>
