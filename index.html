<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng (Cloudflare D1)</title>
<style>
    body { font-family: Arial; margin: 20px; background: #f4f4f4; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ccc; }
    th { background: #eee; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; }
    .modal {
        position: fixed; inset: 0; display: none;
        background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
        background: white; padding: 20px; width: 400px;
        border-radius: 8px; max-height: 90vh; overflow-y: auto;
    }
    .row { margin-bottom: 8px; }
    label { font-weight: bold; }
    input[type=text], input[type=date] { width: 100%; padding: 6px; }
</style>
</head>
<body>

<h2>üìã Qu·∫£n l√Ω Ki·ªÉm k√™ M√°y ‚Äî Cloudflare D1</h2>

<button onclick="openModal()">‚ûï Th√™m</button>

<table>
<thead>
<tr>
    <th>ID</th>
    <th>S·ªë th·∫ª</th>
    <th>S·ªë m√°y</th>
    <th>Lo·∫°i m√°y</th>
    <th>V·ªã tr√≠</th>
    <th>ƒê√£ ki·ªÉm k√™</th>
    <th>H√†nh ƒë·ªông</th>
</tr>
</thead>
<tbody id="data-body"></tbody>
</table>

<!-- MODAL -->
<div class="modal" id="modal">
<div class="modal-content">
    <h3 id="modal-title">Th√™m m·ªõi</h3>

    <input type="hidden" id="m-id">

    <div class="row"><label>S·ªë th·∫ª</label><input id="m-soThe"></div>
    <div class="row"><label>S·ªë m√°y</label><input id="m-soMay"></div>
    <div class="row"><label>Lo·∫°i m√°y</label><input id="m-loaiMay"></div>
    <div class="row"><label>V·ªã tr√≠</label><input id="m-viTri"></div>
    <div class="row"><label>Ghi ch√∫</label><input id="m-ghiChu"></div>

    <div class="row"><label><input type="checkbox" id="m-daKiemKe"> ƒê√£ ki·ªÉm k√™</label></div>
    <div class="row"><label><input type="checkbox" id="m-chonIn"> Ch·ªçn in</label></div>

    <hr>
    <h4>Th√¥ng tin b·∫£o d∆∞·ª°ng</h4>

    Q1: <input type="checkbox" id="m-bdQ1"> Ng√†y: <input type="date" id="m-bdNgayQ1"><br><br>
    Q2: <input type="checkbox" id="m-bdQ2"> Ng√†y: <input type="date" id="m-bdNgayQ2"><br><br>
    Q3: <input type="checkbox" id="m-bdQ3"> Ng√†y: <input type="date" id="m-bdNgayQ3"><br><br>
    Q4: <input type="checkbox" id="m-bdQ4"> Ng√†y: <input type="date" id="m-bdNgayQ4"><br><br>

    <hr>
    <h4>Th√¥ng tin mua / s·ª≠a ch·ªØa</h4>

    Ng√†y mua: <input type="date" id="m-ngayMua"><br><br>
    N∆°i mua: <input id="m-noiMua"><br><br>
    S·ª≠a ch·ªØa: <input id="m-suaChua"><br><br>

    <button onclick="save()">üíæ L∆∞u</button>
    <button onclick="closeModal()">‚ùå ƒê√≥ng</button>
</div>
</div>

<script>
const API_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev";

function openModal(item = null) {
    document.getElementById("modal").style.display = "flex";

    if (item) {
        document.getElementById("modal-title").innerText = "Ch·ªânh s·ª≠a";
        document.getElementById("m-id").value = item.id;
        document.getElementById("m-soThe").value = item.soThe;
        document.getElementById("m-soMay").value = item.soMay;
        document.getElementById("m-loaiMay").value = item.loaiMay;
        document.getElementById("m-viTri").value = item.viTri;
        document.getElementById("m-ghiChu").value = item.ghiChu;

        document.getElementById("m-daKiemKe").checked = item.daKiemKe == 1;
        document.getElementById("m-chonIn").checked = item.chonIn == 1;

        document.getElementById("m-bdQ1").checked = item.bdQ1 == 1;
        document.getElementById("m-bdNgayQ1").value = item.bdNgayQ1 || "";

        document.getElementById("m-bdQ2").checked = item.bdQ2 == 1;
        document.getElementById("m-bdNgayQ2").value = item.bdNgayQ2 || "";

        document.getElementById("m-bdQ3").checked = item.bdQ3 == 1;
        document.getElementById("m-bdNgayQ3").value = item.bdNgayQ3 || "";

        document.getElementById("m-bdQ4").checked = item.bdQ4 == 1;
        document.getElementById("m-bdNgayQ4").value = item.bdNgayQ4 || "";

        document.getElementById("m-ngayMua").value = item.ngayMua || "";
        document.getElementById("m-noiMua").value = item.noiMua || "";
        document.getElementById("m-suaChua").value = item.suaChua || "";
    } else {
        document.getElementById("modal-title").innerText = "Th√™m m·ªõi";
        document.querySelectorAll("#modal input").forEach(i => { 
            if (i.type === "checkbox") i.checked = false;
            else i.value = "";
        });
    }
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
}

async function loadData() {
    const res = await fetch(API_URL);
    const js = await res.json();

    if (!js.success) {
        alert("L·ªói load: " + js.error);
        return;
    }

    const tbody = document.getElementById("data-body");
    tbody.innerHTML = "";

    js.data.forEach(row => {
        tbody.innerHTML += `
            <tr>
                <td>${row.id}</td>
                <td>${row.soThe}</td>
                <td>${row.soMay}</td>
                <td>${row.loaiMay}</td>
                <td>${row.viTri}</td>
                <td>${row.daKiemKe ? "‚úî" : ""}</td>
                <td><button onclick='openModal(${JSON.stringify(row)})'>S·ª≠a</button></td>
            </tr>
        `;
    });
}

async function save() {
    const id = document.getElementById("m-id").value;

    const payload = {
        id: id ? Number(id) : undefined,
        soThe: m-soThe.value,
        soMay: m-soMay.value,
        loaiMay: m-loaiMay.value,
        viTri: m-viTri.value,
        ghiChu: m-ghiChu.value,

        daKiemKe: m-daKiemKe.checked,
        chonIn: m-chonIn.checked,

        bdQ1: m-bdQ1.checked,
        bdNgayQ1: m-bdNgayQ1.value,

        bdQ2: m-bdQ2.checked,
        bdNgayQ2: m-bdNgayQ2.value,

        bdQ3: m-bdQ3.checked,
        bdNgayQ3: m-bdNgayQ3.value,

        bdQ4: m-bdQ4.checked,
        bdNgayQ4: m-bdNgayQ4.value,

        ngayMua: m-ngayMua.value,
        noiMua: m-noiMua.value,
        suaChua: m-suaChua.value
    };

    const url = id ? API_URL + "/update" : API_URL + "/add";

    const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const js = await res.json();

    if (!js.success) {
        alert("L·ªói l∆∞u: " + js.error);
        return;
    }

    closeModal();
    loadData();
}

loadData();
</script>
</body>
</html>
