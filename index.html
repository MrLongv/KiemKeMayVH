<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>üìã Ki·ªÉm k√™ m√°y may - Online Sync</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  body { font-family: Arial; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #333; padding: 6px; text-align: center; }
  th { background: #eee; }
  .highlight { background: yellow; }
  #qrInput { width: 250px; margin-bottom: 10px; font-size: 16px; }
  button { margin: 3px; padding: 5px 10px; cursor: pointer; }
  .qr { width: 60px; height: 60px; margin: auto; }
</style>
</head>
<body>

<h2>üìã Danh s√°ch m√°y may (Sync v·ªõi Google Sheet)</h2>
<div>
  <input type="text" id="qrInput" placeholder="üîç Qu√©t QR ho·∫∑c nh·∫≠p S·ªë th·∫ª" autofocus>
  <button id="uploadBtn">‚òÅÔ∏è ƒê·ªìng b·ªô l√™n Google Sheet</button>
  <button id="downloadBtn">üíæ Xu·∫•t Excel</button>
</div>

<table id="machineTable">
  <thead>
    <tr>
      <th>STT</th>
      <th>M√£ QR</th>
      <th>S·ªë th·∫ª</th>
      <th>S·ªë m√°y</th>
      <th>Lo·∫°i m√°y</th>
      <th>V·ªã tr√≠</th>
      <th>Ghi ch√∫</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyV36oZEfMdC7Hc2EOqVL5r2A6qMPWvo5sU3qUdDhxbQ1hMPzwSYgdGnXPioOeZeWVs/exec'; // thay link th·∫≠t
const GITHUB_BASE = 'https://mrlongv.github.io/KiemKeMayVH/';
const tableBody = document.querySelector('#machineTable tbody');
const qrInput = document.getElementById('qrInput');

// -------- Th√™m h√†ng --------
function addRow(soThe, soMay, loaiMay, viTri, ghiChu){
  const row = document.createElement('tr');
  row.dataset.id = soThe;
  row.innerHTML = `
    <td></td>
    <td class="qr"></td>
    <td>${soThe}</td>
    <td>${soMay}</td>
    <td>${loaiMay}</td>
    <td>${viTri}</td>
    <td>${ghiChu}</td>
  `;
  tableBody.appendChild(row);
}
function updateSTT(){ tableBody.querySelectorAll('tr').forEach((r,i)=> r.children[0].innerText = i+1); }
function generateQRs(){
  tableBody.querySelectorAll('tr').forEach(row=>{
    const id = row.dataset.id;
    const qrCell = row.querySelector('.qr');
    qrCell.innerHTML = '';
    const url = GITHUB_BASE + '?id=' + encodeURIComponent(id);
    new QRCode(qrCell, { text: url, width:60, height:60 });
  });
}
function highlightRow(val){
  document.querySelectorAll('.highlight').forEach(e=> e.classList.remove('highlight'));
  const row = tableBody.querySelector(`tr[data-id="${val}"]`);
  if(row){ row.classList.add('highlight'); row.scrollIntoView({behavior:'smooth', block:'center'}); }
  else alert('Kh√¥ng t√¨m th·∫•y: ' + val);
}

async function loadFromSheet(){
  try {
    const res = await fetch(GAS_URL);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    console.log('Raw response:', text);
    const data = JSON.parse(text);
    tableBody.innerHTML = '';
    data.forEach(d => addRow(d.soThe, d.soMay, d.loaiMay, d.viTri, d.ghiChu));
    updateSTT(); generateQRs();

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if(id) setTimeout(()=>highlightRow(id), 600);
  } catch(err){
    alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi GAS: ' + err.message);
  }
}


// -------- G·ª≠i d·ªØ li·ªáu ng∆∞·ª£c l√™n Sheet --------
async function uploadToSheet(){
  const arr = [];
  tableBody.querySelectorAll('tr').forEach(r=>{
    const t = r.querySelectorAll('td');
    arr.push({
      soThe: t[2].innerText,
      soMay: t[3].innerText,
      loaiMay: t[4].innerText,
      viTri: t[5].innerText,
      ghiChu: t[6].innerText
    });
  });
  const formData = new URLSearchParams();
  formData.append('data', JSON.stringify(arr));
  const res = await fetch(GAS_URL, { method:'POST', body:formData });
  const j = await res.json();
  if(j.success) alert('‚úÖ ƒê·ªìng b·ªô th√†nh c√¥ng ' + j.written + ' d√≤ng');
  else alert('‚ùå L·ªói: ' + j.message);
}

// -------- S·ª± ki·ªán --------
document.getElementById('uploadBtn').onclick = uploadToSheet;
qrInput.addEventListener('change', ()=>{ const v=qrInput.value.trim(); if(v) highlightRow(v); qrInput.value=''; });

// -------- Khi m·ªü trang --------
window.addEventListener('load', loadFromSheet);
</script>

</body>
</html>
