<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may - Sync</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f6f8}
  header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
  .controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
  .controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  .controls button.ghost{background:#eee;color:#333}
  .note{padding:8px 12px;color:#666;font-size:13px}
  .table-wrap{padding:12px;overflow:auto}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
  th{background:#0b74d1;color:#fff}
  tr.highlight{background: #ffeaa7 !important}
  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
  .modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
  .modal label{display:block;margin-top:8px;font-weight:600}
  .modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  @media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} .controls input[type="text"]{width:100%} }
</style>
</head>
<body>

<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may â€” Load tá»« data.json + Sync Google Sheet</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y" />
  <button id="btnImport" class="ghost">ğŸ“‚ Nháº­p Excel</button>
  <button id="btnExport">ğŸ’¾ Xuáº¥t Excel</button>
  <button id="btnAdd">â• ThÃªm</button>
  <button id="btnSync">â˜ï¸ Äá»“ng bá»™ Google Sheet</button>
  <button id="btnRefresh" class="ghost">ğŸ”„ Táº£i láº¡i tá»« Sheet</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
</div>

<div class="note">Ghi chÃº: Ä‘áº·t <code>data.json</code> cÃ¹ng thÆ° má»¥c vá»›i file nÃ y. Khi GAS tháº¥t báº¡i, web tá»± fallback vá» data.json. QR bÃªn ngoÃ i cÃ³ thá»ƒ má»Ÿ Ä‘Æ°á»ng dáº«n dáº¡ng <code>?q=VH-0020</code> hoáº·c <code>#VH-0020</code>.</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>Sá»‘ tháº»</th>
        <th>Sá»‘ mÃ¡y</th>
        <th>Loáº¡i mÃ¡y</th>
        <th>Vá»‹ trÃ­</th>
        <th>Ghi chÃº</th>
        <th>HÃ nh Ä‘á»™ng</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a / ThÃªm dÃ²ng</h3>
    <label>Sá»‘ tháº»</label><input id="m_soThe" />
    <label>Sá»‘ mÃ¡y</label><input id="m_soMay" />
    <label>Loáº¡i mÃ¡y</label><input id="m_loaiMay" />
    <label>Vá»‹ trÃ­</label><input id="m_viTri" />
    <label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
    <div class="actions">
      <button id="cancelBtn" class="ghost">Há»§y</button>
      <button id="saveBtn">Cáº­p nháº­t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* ========== Cáº¤U HÃŒNH ========== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyV36oZEfMdC7Hc2EOqVL5r2A6qMPWvo5sU3qUdDhxbQ1hMPzwSYgdGnXPioOeZeWVs/exec';
const DATA_JSON = 'data.json';

/* ========== TRáº NG THÃI & Dá»® LIá»†U ========== */
const statusEl = document.getElementById('status');
const tbody = document.querySelector('#dataTable tbody');
let allData = []; // máº£ng cÃ¡c object {soThe, soMay, loaiMay, viTri, ghiChu}
let editingIndex = null;

/* ========== HÃ€M Há»– TRá»¢ ========== */
function setStatus(text, ok=true){
  statusEl.innerText = 'Tráº¡ng thÃ¡i: ' + text;
  statusEl.style.color = ok ? '#0b74d1' : '#c0392b';
}

function safeText(v){ return (v===null||v===undefined)?'':String(v); }

/* ======= Load tá»« GAS, náº¿u fail thÃ¬ fallback data.json ======= */
async function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  // try GAS
  try {
    const res = await fetch(GAS_URL);
    if (!res.ok) throw new Error('GAS tráº£ lá»—i tráº¡ng thÃ¡i ' + res.status);
    const j = await res.json();
    if (j && j.success && Array.isArray(j.data)){
      allData = j.data.map(r => ({
        soThe: safeText(r.soThe),
        soMay: safeText(r.soMay),
        loaiMay: safeText(r.loaiMay),
        viTri: safeText(r.viTri),
        ghiChu: safeText(r.ghiChu)
      }));
      setStatus('ÄÃ£ táº£i tá»« Google Sheet (' + allData.length + ' dÃ²ng)');
      renderTable();
      return;
    } else {
      throw new Error('GAS tráº£ dá»¯ liá»‡u khÃ´ng há»£p lá»‡');
    }
  } catch (err) {
    console.warn('Load GAS tháº¥t báº¡i:', err);
    // fallback data.json
    try {
      const res2 = await fetch(DATA_JSON + '?_=' + Date.now());
      if (!res2.ok) throw new Error('KhÃ´ng táº£i Ä‘Æ°á»£c data.json: ' + res2.status);
      const arr = await res2.json();
      if (!Array.isArray(arr)) throw new Error('data.json khÃ´ng pháº£i máº£ng');
      allData = arr.map(r => ({
        soThe: safeText(r.soThe),
        soMay: safeText(r.soMay),
        loaiMay: safeText(r.loaiMay),
        viTri: safeText(r.viTri),
        ghiChu: safeText(r.ghiChu)
      }));
      setStatus('ÄÃ£ táº£i dá»± phÃ²ng tá»« data.json (' + allData.length + ' dÃ²ng)');
      renderTable();
      return;
    } catch (err2) {
      console.error('Load data.json tháº¥t báº¡i:', err2);
      setStatus('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u', false);
      // clear table
      allData = [];
      renderTable();
    }
  }
}

/* ======= Render báº£ng ======= */
function renderTable(){
  tbody.innerHTML = '';
  allData.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    tr.dataset.id = r.soThe || '';
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${escapeHtml(r.soThe)}</td>
      <td>${escapeHtml(r.soMay)}</td>
      <td>${escapeHtml(r.loaiMay)}</td>
      <td>${escapeHtml(r.viTri)}</td>
      <td>${escapeHtml(r.ghiChu)}</td>
      <td>
        <button data-act="edit" data-i="${idx}">âœï¸</button>
        <button data-act="del" data-i="${idx}">ğŸ—‘ï¸</button>
        <button data-act="qr" data-i="${idx}">ğŸ”—</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* escape html minimal */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ======= Sá»± kiá»‡n nÃºt trong báº£ng (edit / delete / show qr) ======= */
tbody.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  const act = btn.dataset.act;
  const i = Number(btn.dataset.i);
  if (act === 'edit') {
    openEditModal(i);
  } else if (act === 'del') {
    if (confirm('XÃ³a dÃ²ng ' + (allData[i].soThe || '') + '?')) {
      allData.splice(i,1);
      renderTable();
    }
  } else if (act === 'qr') {
    // má»Ÿ link chá»©a hash Ä‘á»ƒ cÃ³ thá»ƒ quÃ©t báº±ng app QR ngoÃ i
    const id = encodeURIComponent(allData[i].soThe || '');
    const url = (location.href.split('#')[0].split('?')[0]) + '#'+id;
    prompt('Link QR (copy & in tem):', url);
  }
});

/* ======= Modal chá»‰nh sá»­a ======= */
const modal = document.getElementById('editModal');
const m_soThe = document.getElementById('m_soThe');
const m_soMay = document.getElementById('m_soMay');
const m_loaiMay = document.getElementById('m_loaiMay');
const m_viTri = document.getElementById('m_viTri');
const m_ghiChu = document.getElementById('m_ghiChu');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');

function openEditModal(index){
  editingIndex = (typeof index === 'number') ? index : null;
  if (editingIndex === null){
    // thÃªm má»›i
    m_soThe.value = m_soMay.value = m_loaiMay.value = m_viTri.value = m_ghiChu.value = '';
  } else {
    const r = allData[editingIndex];
    m_soThe.value = r.soThe || '';
    m_soMay.value = r.soMay || '';
    m_loaiMay.value = r.loaiMay || '';
    m_viTri.value = r.viTri || '';
    m_ghiChu.value = r.ghiChu || '';
  }
  modal.style.display = 'flex';
  m_soThe.focus();
}

cancelBtn.onclick = ()=> { modal.style.display = 'none'; editingIndex = null; };

saveBtn.onclick = ()=>{
  const obj = {
    soThe: m_soThe.value.trim(),
    soMay: m_soMay.value.trim(),
    loaiMay: m_loaiMay.value.trim(),
    viTri: m_viTri.value.trim(),
    ghiChu: m_ghiChu.value.trim()
  };
  if (!obj.soThe) { alert('Sá»‘ tháº» khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng'); return; }
  if (editingIndex === null) {
    allData.push(obj);
  } else {
    allData[editingIndex] = obj;
  }
  modal.style.display = 'none';
  editingIndex = null;
  renderTable();
};

/* ======= NÃºt Ä‘iá»u khiá»ƒn bÃªn trÃªn ======= */
document.getElementById('btnAdd').addEventListener('click', ()=> openEditModal(null));
document.getElementById('btnExport').addEventListener('click', exportExcel);
document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
document.getElementById('btnRefresh').addEventListener('click', loadData);

document.getElementById('fileInput').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const arr = XLSX.utils.sheet_to_json(sheet);
    // normalize to keys used
    allData = arr.map(r => ({
      soThe: safeText(r.soThe || r['Sá»‘ tháº»'] || r['MaMay'] || r['Ma'] || ''),
      soMay: safeText(r.soMay || r['Sá»‘ mÃ¡y'] || r['SoMay'] || ''),
      loaiMay: safeText(r.loaiMay || r['Loáº¡i mÃ¡y'] || ''),
      viTri: safeText(r.viTri || r['Vá»‹ trÃ­'] || ''),
      ghiChu: safeText(r.ghiChu || r['Ghi chÃº'] || '')
    }));
    renderTable();
  };
  reader.readAsArrayBuffer(f);
});

/* ======= Xuáº¥t Excel ======= */
function exportExcel(){
  const ws = XLSX.utils.json_to_sheet(allData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'DanhSachMay');
  XLSX.writeFile(wb, 'DanhSachMay.xlsx');
}

/* ======= Äá»“ng bá»™ lÃªn GAS (POST) ======= */
async function syncToSheet(){
  setStatus('Äang Ä‘á»“ng bá»™ lÃªn Google Sheet...');
  try {
    const res = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(allData)
    });
    // kiá»ƒm tra response an toÃ n
    const txt = await (async ()=>{
      try {
        return await res.text();
      } catch(e){ return null; }
    })();
    let parsed = null;
    try { parsed = txt ? JSON.parse(txt) : null; } catch(e){ parsed = null; }
    if (!res.ok) {
      setStatus('Äá»“ng bá»™ tháº¥t báº¡i (HTTP ' + res.status + ')', false);
      alert('Lá»—i khi Ä‘á»“ng bá»™. Server tráº£: ' + (txt || ('HTTP ' + res.status)));
      return;
    }
    // náº¿u server tráº£ JSON success
    if (parsed && parsed.success){
      setStatus('ÄÃ£ Ä‘á»“ng bá»™ ' + (parsed.written || '') + ' dÃ²ng');
      alert('Äá»“ng bá»™ thÃ nh cÃ´ng!');
      // táº£i láº¡i tá»« GAS Ä‘á»ƒ Ä‘á»“ng bá»™ 2 chiá»u (báº£o Ä‘áº£m tráº­t tá»±)
      setTimeout(()=>loadData(), 700);
    } else {
      setStatus('ÄÃ£ nháº­n pháº£n há»“i tá»« server', true);
      alert('Server tráº£ vá»: ' + (txt || JSON.stringify(parsed)));
    }
  } catch (err){
    console.error('sync error', err);
    setStatus('Lá»—i káº¿t ná»‘i khi Ä‘á»“ng bá»™', false);
    alert('KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i GAS: ' + err.message);
  }
}

/* ======= TÃ¬m (filter nhanh) ======= */
document.getElementById('searchBox').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  const rows = document.querySelectorAll('#dataTable tbody tr');
  rows.forEach(r=>{
    const idx = Number(r.dataset.index);
    const d = allData[idx];
    const text = (d.soThe + ' ' + d.soMay + ' ' + d.loaiMay + ' ' + d.viTri + ' ' + d.ghiChu).toLowerCase();
    r.style.display = text.includes(q) ? '' : 'none';
  });
});

/* ======= Highlight + scroll khi má»Ÿ link QR (support ?q= or #id) ======= */
function getQRfromUrl(){
  const u = new URL(window.location.href);
  let code = u.searchParams.get('q');
  if (!code) {
    code = decodeURIComponent((window.location.hash || '').replace(/^#/, '')) || null;
  }
  return code ? String(code) : null;
}
function attemptHighlight(code){
  if(!code) return;
  // thá»­ tÃ¬m nhiá»u láº§n, phÃ²ng khi dá»¯ liá»‡u cÃ²n Ä‘ang render
  let tries = 0;
  const i = setInterval(()=>{
    const idx = allData.findIndex(d => d.soThe === code || d.soMay === code);
    if (idx >= 0) {
      // show, highlight and scroll
      const rows = document.querySelectorAll('#dataTable tbody tr');
      rows.forEach(r => r.classList.remove('highlight'));
      const target = rows[idx];
      if (target) {
        target.classList.add('highlight');
        target.scrollIntoView({behavior:'smooth', block:'center'});
      }
      clearInterval(i);
    } else if (++tries > 12) {
      // tried ~12 times (12*250ms = 3s)
      clearInterval(i);
      console.warn('KhÃ´ng tÃ¬m tháº¥y mÃ£ trong dá»¯ liá»‡u:', code);
    }
  }, 250);
}

/* ======= Khá»Ÿi Ä‘á»™ng ======= */
window.addEventListener('load', async ()=>{
  await loadData();
  // náº¿u url cÃ³ q or hash, highlight (thá»­ nhiá»u láº§n trong function)
  const code = getQRfromUrl();
  if (code) attemptHighlight(code);
});

/* ======= Expose sync button ======= */
document.getElementById('btnSync').addEventListener('click', syncToSheet);

</script>
</body>
</html>
