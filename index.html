<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
th{background:#0b74d1;color:#fff}
tr.highlight{background: #ffeaa7 !important}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} .controls input[type="text"]{width:100%} }
</style>
</head>
<body>
<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may</header>

<div class="controls">
<input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y" />
<button id="btnImport" class="ghost">ğŸ“‚ Nháº­p Excel</button>
<button id="btnExport">ğŸ’¾ Xuáº¥t Excel</button>
<button id="btnAdd">â• ThÃªm</button>
<button id="btnSync">â˜ï¸ Äá»“ng bá»™ Sheet</button>
<button id="btnRefresh" class="ghost">ğŸ”„ Táº£i tá»« Sheet</button>
<button id="btnPrint">ğŸ–¨ In tem QR</button>
<input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
<span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
</div>

<div class="note">QR code, in tem, checkbox "ÄÃ£ kiá»ƒm kÃª" + "Chá»n Ä‘á»ƒ in", ngÃ y mua chuáº©n dd/MM/yyyy.</div>

<div class="table-wrap">
<table id="dataTable">
<thead>
<tr>
<th>STT</th><th>Sá»‘ tháº»</th><th>Sá»‘ mÃ¡y</th><th>Loáº¡i mÃ¡y</th>
<th>Vá»‹ trÃ­</th><th>Ghi chÃº</th>
<th>ÄÃ£ kiá»ƒm kÃª</th><th>Chá»n Ä‘á»ƒ in</th><th>NgÃ y mua</th><th>HÃ nh Ä‘á»™ng</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
<div class="card">
<h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a / ThÃªm dÃ²ng</h3>
<label>Sá»‘ tháº»</label><input id="m_soThe" />
<label>Sá»‘ mÃ¡y</label><input id="m_soMay" />
<label>Loáº¡i mÃ¡y</label><input id="m_loaiMay" />
<label>Vá»‹ trÃ­</label><input id="m_viTri" />
<label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
<label>ÄÃ£ kiá»ƒm kÃª</label><input type="checkbox" id="m_daKiemKe" />
<label>NgÃ y mua</label><input type="date" id="m_ngayMua" />
<div class="actions">
<button id="cancelBtn" class="ghost">Há»§y</button>
<button id="saveBtn">Cáº­p nháº­t</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyXOeIiH9MoP44Q1MKKSISnK9ZU-okas-9wv0dRVZba_UNaBPx43iYneE-M8zlK2k4Z/exec';
const tbody = document.querySelector('#dataTable tbody');
const statusEl = document.getElementById('status');
let allData = [], editingIndex = null;

function setStatus(txt,ok=true){ statusEl.innerText='Tráº¡ng thÃ¡i: '+txt; statusEl.style.color = ok?'#0b74d1':'#c0392b'; }
function safeText(v){ return (v==null?'':v); }

async function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  try{
    const res = await fetch(GAS_URL);
    const j = await res.json();
    if(j.success && Array.isArray(j.data)){
      allData = j.data.map(r=>({
        soThe:safeText(r.soThe),
        soMay:safeText(r.soMay),
        loaiMay:safeText(r.loaiMay),
        viTri:safeText(r.viTri),
        ghiChu:safeText(r.ghiChu),
        daKiemKe:!!r.daKiemKe,
        chonIn:!!r.chonIn,
        ngayMua:safeText(r.ngayMua)
      }));
      setStatus('ÄÃ£ táº£i tá»« Sheet ('+allData.length+' dÃ²ng)');
      renderTable();
      return;
    }
    throw new Error('Dá»¯ liá»‡u khÃ´ng há»£p lá»‡');
  }catch(err){
    console.error(err);
    setStatus('KhÃ´ng táº£i Ä‘Æ°á»£c Sheet',false);
    allData=[];
    renderTable();
  }
}

function renderTable(){
  tbody.innerHTML='';
  allData.forEach((r,idx)=>{
    const tr=document.createElement('tr'); tr.dataset.index=idx;
    tr.innerHTML=`
<td>${idx+1}</td>
<td>${r.soThe}</td>
<td>${r.soMay}</td>
<td>${r.loaiMay}</td>
<td>${r.viTri}</td>
<td>${r.ghiChu}</td>
<td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
<td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
<td><input type="date" class="ngayMua" value="${r.ngayMua?formatDateInput(r.ngayMua):''}"></td>
<td>
<button data-act="edit" data-i="${idx}">âœï¸</button>
<button data-act="qr" data-i="${idx}">ğŸ”—</button>
</td>
    `;
    tbody.appendChild(tr);
  });
  attachRowEvents();
}

function formatDateInput(str){ // dd/MM/yyyy -> yyyy-MM-dd
  const parts=str.split('/'); if(parts.length!==3) return ''; return `${parts[2]}-${parts[1]}-${parts[0]}`;
}

function attachRowEvents(){
  tbody.querySelectorAll('input.daKiemKe').forEach((cb,i)=>cb.onchange=e=>allData[i].daKiemKe=cb.checked);
  tbody.querySelectorAll('input.chonIn').forEach((cb,i)=>cb.onchange=e=>allData[i].chonIn=cb.checked);
  tbody.querySelectorAll('input.ngayMua').forEach((cb,i)=>cb.onchange=e=>{
    const v=cb.value; allData[i].ngayMua=v?v.split('-').reverse().join('/'):'';
  });
  tbody.querySelectorAll('button').forEach(btn=>{
    const act=btn.dataset.act; const i=Number(btn.dataset.i);
    if(act==='edit') openEditModal(i);
    else if(act==='qr'){
      const code=encodeURIComponent(allData[i].soThe||'');
      const url=location.origin+location.pathname+'#'+code;
      prompt('Link QR:',url);
    }
  });
}

/* ===== Modal chá»‰nh sá»­a ===== */
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe');
const m_soMay=document.getElementById('m_soMay');
const m_loaiMay=document.getElementById('m_loaiMay');
const m_viTri=document.getElementById('m_viTri');
const m_ghiChu=document.getElementById('m_ghiChu');
const m_daKiemKe=document.getElementById('m_daKiemKe');
const m_ngayMua=document.getElementById('m_ngayMua');
const cancelBtn=document.getElementById('cancelBtn');
const saveBtn=document.getElementById('saveBtn');

function openEditModal(i){
  editingIndex=typeof i==='number'?i:null;
  if(editingIndex===null){
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value='';
    m_daKiemKe.checked=false; m_ngayMua.value='';
  }else{
    const r=allData[i];
    m_soThe.value=r.soThe; m_soMay.value=r.soMay; m_loaiMay.value=r.loaiMay; m_viTri.value=r.viTri;
    m_ghiChu.value=r.ghiChu; m_daKiemKe.checked=r.daKiemKe;
    m_ngayMua.value=formatDateInput(r.ngayMua);
  }
  modal.style.display='flex'; m_soThe.focus();
}
cancelBtn.onclick=()=>{ modal.style.display='none'; editingIndex=null; };
saveBtn.onclick=()=>{
  const obj={
    soThe:m_soThe.value.trim(),
    soMay:m_soMay.value.trim(),
    loaiMay:m_loaiMay.value.trim(),
    viTri:m_viTri.value.trim(),
    ghiChu:m_ghiChu.value.trim(),
    daKiemKe:m_daKiemKe.checked,
    chonIn:false,
    ngayMua:m_ngayMua.value?m_ngayMua.value.split('-').reverse().join('/'):''
  };
  if(!obj.soThe){ alert('Sá»‘ tháº» khÃ´ng Ä‘Æ°á»£c trá»‘ng'); return; }
  if(editingIndex===null) allData.push(obj); else allData[editingIndex]=obj;
  modal.style.display='none'; editingIndex=null;
  renderTable();
};

/* ===== NÃºt Ä‘iá»u khiá»ƒn ===== */
document.getElementById('btnAdd').onclick=()=>openEditModal(null);
document.getElementById('btnRefresh').onclick=loadData;
document.getElementById('btnExport').onclick=()=>{
  const ws=XLSX.utils.json_to_sheet(allData);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'DanhSachMay');
  XLSX.writeFile(wb,'DanhSachMay.xlsx');
};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(sheet);
    allData=arr.map(r=>({
      soThe:safeText(r.soThe||r['Sá»‘ tháº»']||''),
      soMay:safeText(r.soMay||r['Sá»‘ mÃ¡y']||''),
      loaiMay:safeText(r.loaiMay||r['Loáº¡i mÃ¡y']||''),
      viTri:safeText(r.viTri||r['Vá»‹ trÃ­']||''),
      ghiChu:safeText(r.ghiChu||r['Ghi chÃº']||''),
      daKiemKe:!!r.daKiemKe,
      chonIn:false,
      ngayMua:safeText(r.ngayMua||'')
    }));
    renderTable();
  };
  reader.readAsArrayBuffer(f);
};

/* ===== Äá»“ng bá»™ lÃªn Sheet ===== */
async function syncToSheet(){
  setStatus('Äang Ä‘á»“ng bá»™ lÃªn Sheet...');
  try{
    const res=await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(allData)
    });
    const txt=await res.text();
    const parsed=JSON.parse(txt);
    if(parsed.success){
      setStatus('ÄÃ£ Ä‘á»“ng bá»™ '+allData.length+' dÃ²ng');
      alert('Äá»“ng bá»™ thÃ nh cÃ´ng!');
      setTimeout(()=>loadData(),700);
    }else{
      setStatus('Server tráº£ lá»—i',false);
      alert('Server: '+txt);
    }
  }catch(err){
    console.error(err);
    setStatus('KhÃ´ng thá»ƒ káº¿t ná»‘i',false);
    alert('Lá»—i: '+err.message);
  }
}
document.getElementById('btnSync').onclick=syncToSheet;

/* ===== Search nhanh ===== */
document.getElementById('searchBox').oninput=e=>{
  const v=e.target.value.toLowerCase();
  Array.from(tbody.children).forEach(tr=>{
    const idx=Number(tr.dataset.index); const r=allData[idx];
    tr.style.display=(r.soThe.toLowerCase().includes(v)||r.soMay.toLowerCase().includes(v))?'':'none';
  });
};

/* ===== QR + In tem ===== */
document.getElementById('btnPrint').onclick=()=>{
  const printData=allData.filter(r=>r.chonIn);
  if(printData.length===0){ alert('Chá»n Ã­t nháº¥t 1 dÃ²ng Ä‘á»ƒ in'); return; }
  const w=window.open('','_blank');
  w.document.write('<html><head><title>In tem QR</title></head><body style="font-family:Arial">');
  printData.forEach(r=>{
    const qr=r.soThe; const ngay=r.ngayMua||''; const loai=r.loaiMay||''; const vt=r.viTri||'';
    w.document.write('<div style="width:180px;height:180px;border:1px solid #000;margin:6px;display:inline-block;text-align:center;padding:4px;">');
    w.document.write('<div style="font-weight:bold">'+r.soThe+'</div>');
    w.document.write('<div>Loáº¡i:'+loai+'</div><div>Vá»‹ trÃ­:'+vt+'</div><div>NgÃ y:'+ngay+'</div>');
    w.document.write('<div id="qrcode'+qr+'"></div></div>');
  });
  w.document.write('</body></html>'); w.document.close();
  w.onload=()=>{
    printData.forEach(r=>{
      new QRCode(w.document.getElementById('qrcode'+r.soThe),{text:r.soThe,width:80,height:80});
    });
    w.print();
  };
};

/* ===== Load láº§n Ä‘áº§u ===== */
loadData();
</script>
</body>
</html>
