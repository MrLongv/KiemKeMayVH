<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kiểm kê máy Việt Hồng</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5;}
h1 { text-align:center; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:left; }
th { background:#eee; }
button { padding:5px 10px; margin:2px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
         background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:4px; width:90%; max-width:500px; }
.modal-header { font-weight:bold; margin-bottom:10px; }
.modal input, .modal textarea { width:100%; margin-bottom:6px; padding:4px; }
.modal label { font-weight:bold; font-size:14px; }
</style>
</head>
<body>
<h1>Kiểm kê máy Việt Hồng</h1>
<div>
<button id="btnAdd">Thêm mới</button>
<button id="btnRefresh">Tải lại</button>
</div>
<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Số thẻ</th>
      <th>Số máy</th>
      <th>Loại máy</th>
      <th>Vị trí</th>
      <th>Ghi chú</th>
      <th>Đã KK</th>
      <th>In QR</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">Chỉnh sửa / Thêm mới</div>
    <input type="hidden" id="modalId">
    <label>Số thẻ</label>
    <input type="text" id="modalSoThe">
    <label>Số máy</label>
    <input type="text" id="modalSoMay">
    <label>Loại máy</label>
    <input type="text" id="modalLoaiMay">
    <label>Vị trí</label>
    <input type="text" id="modalViTri">
    <label>Ghi chú</label>
    <textarea id="modalGhiChu"></textarea>
    <label><input type="checkbox" id="modalDaKiemKe"> Đã kiểm kê</label>
    <label><input type="checkbox" id="modalChonIn"> In QR</label>
    <div style="margin-top:10px; text-align:right;">
      <button id="modalSave">Lưu</button>
      <button id="modalCancel">Hủy</button>
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev";
let allData = [];

const modal = document.getElementById("editModal");
const m_id = document.getElementById("modalId");
const m_soThe = document.getElementById("modalSoThe");
const m_soMay = document.getElementById("modalSoMay");
const m_loaiMay = document.getElementById("modalLoaiMay");
const m_viTri = document.getElementById("modalViTri");
const m_ghiChu = document.getElementById("modalGhiChu");
const m_daKiemKe = document.getElementById("modalDaKiemKe");
const m_chonIn = document.getElementById("modalChonIn");

function renderTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  allData.forEach((row) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${row.soThe || ""}</td>
      <td>${row.soMay || ""}</td>
      <td>${row.loaiMay || ""}</td>
      <td>${row.viTri || ""}</td>
      <td>${row.ghiChu || ""}</td>
      <td><input type="checkbox" disabled ${row.daKiemKe ? "checked" : ""}></td>
      <td><input type="checkbox" disabled ${row.chonIn ? "checked" : ""}></td>
      <td>
        <button onclick="openEditModal(${row.id})">Sửa</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadData() {
  try {
    const res = await fetch(WORKER_URL);
    if (!res.ok) throw new Error(res.statusText);
    const data = await res.json();
    if (data.success) {
      allData = data.data || [];
      renderTable();
    } else {
      alert("Lỗi khi load dữ liệu: " + (data.error || "Không xác định"));
    }
  } catch (err) {
    alert("Lỗi khi load dữ liệu: " + err);
  }
}

function openEditModal(id) {
  modal.style.display = "flex";
  if (id == null) {
    // Thêm mới
    m_id.value = "";
    m_soThe.value = "";
    m_soMay.value = "";
    m_loaiMay.value = "";
    m_viTri.value = "";
    m_ghiChu.value = "";
    m_daKiemKe.checked = false;
    m_chonIn.checked = false;
  } else {
    // Sửa
    const row = allData.find(r => r.id == id);
    if (!row) return alert("Không tìm thấy dữ liệu");
    m_id.value = row.id;
    m_soThe.value = row.soThe || "";
    m_soMay.value = row.soMay || "";
    m_loaiMay.value = row.loaiMay || "";
    m_viTri.value = row.viTri || "";
    m_ghiChu.value = row.ghiChu || "";
    m_daKiemKe.checked = row.daKiemKe ? true : false;
    m_chonIn.checked = row.chonIn ? true : false;
  }
}

function closeModal() {
  modal.style.display = "none";
}

// Lưu dữ liệu
document.getElementById("modalSave").addEventListener("click", async () => {
  const payload = {
    soThe: m_soThe.value || "",
    soMay: m_soMay.value || "",
    loaiMay: m_loaiMay.value || "",
    viTri: m_viTri.value || "",
    ghiChu: m_ghiChu.value || "",
    daKiemKe: m_daKiemKe.checked,
    chonIn: m_chonIn.checked
  };

  try {
    let url = WORKER_URL + "/add";
    if (m_id.value) {
      payload.id = Number(m_id.value);
      url = WORKER_URL + "/update";
    }

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(res.statusText);
    const data = await res.json();
    if (data.success) {
      await loadData();
      closeModal();
    } else {
      alert("Lỗi khi lưu: " + (data.error || "Không xác định"));
    }
  } catch (err) {
    alert("Lỗi khi lưu: " + err);
  }
});

document.getElementById("modalCancel").addEventListener("click", closeModal);
document.getElementById("btnAdd").addEventListener("click", () => openEditModal(null));
document.getElementById("btnRefresh").addEventListener("click", loadData);

document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
