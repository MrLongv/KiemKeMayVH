<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y Viá»‡t Há»“ng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{display:flex;justify-content:center;align-items:center;background:#0b74d1;color:#fff;padding:16px 0;font-size:24px;font-weight:bold;letter-spacing:1px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls select{padding:6px 8px;border:1px solid #ccc;border-radius:4px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{display:block;width:100%;overflow-x:auto;overflow-y:auto;box-sizing:border-box}
table{min-width:1200px;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap;vertical-align:top}
th{background:#0b74d1;color:#fff}
tr.highlight{background:#ffeaa7 !important}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:9999;display:flex;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%;max-height:80vh;overflow-y:auto;-webkit-overflow-scrolling:touch;box-sizing:border-box}
body.modal-open{position:fixed;width:100%;overflow:hidden;height:100%;top:0}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:920px){.table-wrap{overflow:auto}}
@media(max-width:640px){.controls{flex-direction:column;align-items:stretch}.controls input[type="text"],.controls select{width:100%}}
.highlight-row{background:yellow !important;transition:background 0.2s}
.small-checkbox{transform:scale(1);margin:0}

/* ===== Cá»˜T GHI CHÃš & Sá»¬A CHá»®A 2 DÃ’NG ===== */
.col-ghi-chu, .col-sua-chua {
    white-space: normal;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Hiá»ƒn thá»‹ tá»‘i Ä‘a 2 dÃ²ng */
    -webkit-box-orient: vertical;
    text-overflow: ellipsis;
    word-wrap: break-word;
    text-align: left;
    padding-left: 8px;
    max-width: 200px; /* Ä‘iá»u chá»‰nh theo Ã½ */
}
</style>
</head>
<body>
<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y Viá»‡t Há»“ng</header>
<div class="controls">
  <input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y" />
  <select id="filterBox">
    <option value="all">ğŸ“‹ Hiá»‡n táº¥t cáº£</option>
    <option value="daKiemKe">âœ… ÄÃ£ kiá»ƒm kÃª</option>
    <option value="chuaKiemKe">â¬œ ChÆ°a kiá»ƒm kÃª</option>
    <option value="daIn">ğŸ–¨ï¸ ÄÃ£ chá»n in</option>
    <option value="chuaIn">ğŸ“„ ChÆ°a chá»n in</option>
  </select>
  <button id="btnAdd">â• ThÃªm</button>
  <button id="btnSync">â˜ï¸ Äá»“ng bá»™ lÃªn Sheet</button>
  <button id="btnRefresh" class="ghost">ğŸ”„ Táº£i láº¡i tá»« Sheet</button>
  <button id="btnPrint">ğŸ–¨ï¸ In tem QR</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
</div>

<div class="note">TÃ¬m sá»‘ tháº» chá»‰ nháº­p sá»‘, Checkbox ÄÃ£ KK tá»± lÆ°u, ngÃ y mua chuáº©n dd/mm/yyyy. Báº£o dÆ°á»¡ng = 4 quÃ½ (checkbox). Sá»­a chá»¯a = text, editable trong modal vÃ  auto-sync.</div>

<div class="table-wrap">
<table id="dataTable">
<thead>
<tr>
  <th rowspan="2">STT</th>
  <th rowspan="2">Sá»‘ tháº»</th>
  <th rowspan="2">Sá»‘ mÃ¡y</th>
  <th rowspan="2">Loáº¡i mÃ¡y</th>
  <th rowspan="2">Vá»‹ trÃ­</th>
  <th rowspan="2">Ghi chÃº</th>
  <th rowspan="2">HÃ nh Ä‘á»™ng</th>
  <th rowspan="2" style="text-align:center;">ÄÃ£ KK<br><input type="checkbox" id="checkAllKK"></th>
  <th rowspan="2" style="text-align:center;">In QR<br><input type="checkbox" id="checkAllQR"></th>
  <th rowspan="2">NgÃ y mua</th>
  <th rowspan="2">NÆ¡i mua</th>
  <th colspan="4">Báº£o dÆ°á»¡ng</th>
  <th rowspan="2">Sá»­a chá»¯a</th>
</tr>
<tr>
  <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="editModal" class="modal">
<div class="card">
<h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a </h3>
<label>Sá»‘ tháº»</label><input id="m_soThe" />
<label>Sá»‘ mÃ¡y</label><input id="m_soMay" />
<label>Loáº¡i mÃ¡y</label><input id="m_loaiMay" />
<label>Vá»‹ trÃ­</label><input id="m_viTri" />
<label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
<label>ÄÃ£ kiá»ƒm kÃª</label><input type="checkbox" id="m_daKiemKe" />
<label>Chá»n Ä‘á»ƒ in</label><input type="checkbox" id="m_chonIn" />
<label>NgÃ y mua</label><input id="m_ngayMua" type="text" placeholder="dd/MM/yyyy" />
<label>NÆ¡i mua</label><input id="m_noiMua" />
<label style="margin-top:10px;font-weight:700">Báº£o dÆ°á»¡ng (Ä‘Ã¡nh dáº¥u quÃ½ Ä‘Ã£ báº£o dÆ°á»¡ng)</label>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
  <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="m_bdQ1" /> Q1</label>
  <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="m_bdQ2" /> Q2</label>
  <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="m_bdQ3" /> Q3</label>
  <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="m_bdQ4" /> Q4</label>
</div>
<label style="margin-top:10px">Sá»­a chá»¯a</label>
<textarea id="m_suaChua" rows="3" placeholder="Ghi ná»™i dung sá»­a chá»¯a (vd: thay motor, thay dÃ¢y...)"></textarea>
<div class="actions">
<button id="cancelBtn" class="ghost">Há»§y</button>
<button id="saveBtn">Cáº­p nháº­t</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// ==== BIáº¾N ==== //
const GAS_URL='https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'; // Ä‘á»•i theo script cá»§a báº¡n
const statusEl=document.getElementById('status'), tbody=document.querySelector('#dataTable tbody');
const filterBox=document.getElementById('filterBox'), searchBox=document.getElementById('searchBox');
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe'), m_soMay=document.getElementById('m_soMay'),
      m_loaiMay=document.getElementById('m_loaiMay'), m_viTri=document.getElementById('m_viTri'),
      m_ghiChu=document.getElementById('m_ghiChu'), m_daKiemKe=document.getElementById('m_daKiemKe'),
      m_chonIn=document.getElementById('m_chonIn'), m_ngayMua=document.getElementById('m_ngayMua'),
      m_noiMua=document.getElementById('m_noiMua'),
      m_bdQ1=document.getElementById('m_bdQ1'), m_bdQ2=document.getElementById('m_bdQ2'),
      m_bdQ3=document.getElementById('m_bdQ3'), m_bdQ4=document.getElementById('m_bdQ4'),
      m_suaChua=document.getElementById('m_suaChua');
let allData=[], editingIndex=null;

function setStatus(txt,ok=true){statusEl.innerText='Tráº¡ng thÃ¡i: '+txt;statusEl.style.color=ok?'#0b74d1':'#c0392b';}
function safeText(v){return v==null?'':String(v);}
function formatDateDDMMYYYY(d){if (!d && d!==0) return ""; if(typeof d==='string' && d.includes('/')) return d; if(typeof d==='string'){const m=d.match(/^(\d{4})-(\d{2})-(\d{2})/);if(m) return `${m[3]}/${m[2]}/${m[1]}`;} let date=(d instanceof Date)?d:new Date(d); if(isNaN(date)) return String(d); const day=String(date.getDate()).padStart(2,'0'); const month=String(date.getMonth()+1).padStart(2,'0'); const year=date.getFullYear(); return `${day}/${month}/${year}`;}

// ==== RENDER TABLE ==== //
function renderTable(){
  const filter=filterBox.value, search=(searchBox.value||'').toLowerCase();
  tbody.innerHTML='';
  allData.forEach((r,idx)=>{
    let show=true;
    if(filter==='daKiemKe'&&!r.daKiemKe) show=false;
    if(filter==='chuaKiemKe'&&r.daKiemKe) show=false;
    if(filter==='daIn'&&!r.chonIn) show=false;
    if(filter==='chuaIn'&&r.chonIn) show=false;
    if(search){
      const haystack=[r.soThe,r.soMay,r.loaiMay,r.viTri,r.ghiChu,r.noiMua,r.ngayMua,r.suaChua,r.bdQ1,r.bdQ2,r.bdQ3,r.bdQ4]
      .map(x=>(x||'').toString().toLowerCase()).join(' ');
      if(!haystack.includes(search)) show=false;
    }
    if(show){
      const tr=document.createElement('tr');tr.dataset.index=idx;
      tr.innerHTML=`
        <td>${idx+1}</td>
        <td class="col-so-the">${safeText(r.soThe)}</td>
        <td>${safeText(r.soMay)}</td>
        <td>${safeText(r.loaiMay)}</td>
        <td>${safeText(r.viTri)}</td>
        <td class="col-ghi-chu">${safeText(r.ghiChu)}</td>
        <td>
          <button data-act="edit" data-i="${idx}">âœï¸</button>
          <button data-act="qr" data-i="${idx}">ğŸ”—</button>
        </td>
        <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
        <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
        <td>${r.ngayMua?formatDateDDMMYYYY(r.ngayMua):''}</td>
        <td>${safeText(r.noiMua)}</td>
        <td><input type="checkbox" class="bdQ bdQ1" ${r.bdQ1?'checked':''}></td>
        <td><input type="checkbox" class="bdQ bdQ2" ${r.bdQ2?'checked':''}></td>
        <td><input type="checkbox" class="bdQ bdQ3" ${r.bdQ3?'checked':''}></td>
        <td><input type="checkbox" class="bdQ bdQ4" ${r.bdQ4?'checked':''}></td>
        <td class="col-sua-chua">${safeText(r.suaChua)}</td>
      `;
      tbody.appendChild(tr);
    }
  });
}

// ==== LOAD DATA JSONP ====
function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  const cb='__load_cb_'+Date.now();
  window[cb]=function(res){
    try{
      if(res && res.success && Array.isArray(res.data)){
        allData=res.data.map(r=>{
          return{
            soThe:r.soThe||r.SoThe||r['Sá»‘ tháº»']||'',
            soMay:r.soMay||r.SoMay||r['Sá»‘ mÃ¡y']||'',
            loaiMay:r.loaiMay||r.LoaiMay||r['Loáº¡i mÃ¡y']||'',
            viTri:r.viTri||r.ViTri||r['Vá»‹ trÃ­']||'',
            ghiChu:r.ghiChu||r.GhiChu||r['Ghi chÃº']||'',
            daKiemKe:!!(r.daKiemKe || r.daKiemKe===true || r['ÄÃ£ KK'] || r['daKiemKe']=='TRUE' || r['daKiemKe']=='true'),
            chonIn:!!(r.chonIn || r.chonIn===true || r['chonIn']=='TRUE' || r['chonIn']=='true'),
            ngayMua:r.ngayMua||r.NgayMua||r['NgÃ y mua']||'',
            noiMua:r.noiMua||r.NoiMua||r['NÆ¡i mua']||'',
            bdQ1:!!(r.bdQ1||r['Báº£o dÆ°á»¡ng Q1']),
            bdQ2:!!(r.bdQ2||r['Báº£o dÆ°á»¡ng Q2']),
            bdQ3:!!(r.bdQ3||r['Báº£o dÆ°á»¡ng Q3']),
            bdQ4:!!(r.bdQ4||r['Báº£o dÆ°á»¡ng Q4']),
            suaChua:r.suaChua||r.SuaChua||r['Sá»­a chá»¯a']||''
          };
        });
        allData.forEach(r=>{if(r&&r.ngayMua) r.ngayMua=formatDateDDMMYYYY(r.ngayMua)});
        renderTable();setStatus('ÄÃ£ táº£i '+allData.length+' dÃ²ng');highlightFromHash();
      } else setStatus('Lá»—i táº£i dá»¯ liá»‡u',false);
    } finally{delete window[cb]; script.remove();}
  };
  const script=document.createElement('script');
  script.src=GAS_URL+'?callback='+cb+'&_='+Date.now();
  script.onerror=()=>{setStatus('Lá»—i táº£i dá»¯ liá»‡u',false);delete window[cb];script.remove();};
  document.head.appendChild(script);
}

// ==== AUTO SYNC ROW ====
function autoSyncRow(i){
  if(i==null||!allData[i]) return;
  const row=allData[i];
  const cb='__sync_cb_'+Date.now();
  window[cb]=function(res){console.log('Sync row',i,res);delete window[cb];script.remove();}
  const script=document.createElement('script');
  script.src=GAS_URL+'?callback='+cb+'&action=update&index='+i+'&data='+encodeURIComponent(JSON.stringify(row))+'&_='+Date.now();
  document.head.appendChild(script);
}

// ==== MODAL EDIT ====
tbody.addEventListener('click',e=>{
  const btn=e.target.closest('button[data-act]');
  if(!btn) return;
  const i=parseInt(btn.dataset.i);
  if(btn.dataset.act==='edit'){
    editingIndex=i;
    const r=allData[i];
    m_soThe.value=r.soThe; m_soMay.value=r.soMay; m_loaiMay.value=r.loaiMay;
    m_viTri.value=r.viTri; m_ghiChu.value=r.ghiChu; m_daKiemKe.checked=r.daKiemKe;
    m_chonIn.checked=r.chonIn; m_ngayMua.value=r.ngayMua; m_noiMua.value=r.noiMua;
    m_bdQ1.checked=r.bdQ1; m_bdQ2.checked=r.bdQ2; m_bdQ3.checked=r.bdQ3; m_bdQ4.checked=r.bdQ4;
    m_suaChua.value=r.suaChua;
    modal.style.display='flex';document.body.classList.add('modal-open');
  }
});

// ==== MODAL BUTTONS ====
document.getElementById('cancelBtn').onclick=()=>{modal.style.display='none';document.body.classList.remove('modal-open');editingIndex=null;}
document.getElementById('saveBtn').onclick=()=>{
  if(editingIndex==null) return;
  const r=allData[editingIndex];
  r.soThe=m_soThe.value;r.soMay=m_soMay.value;r.loaiMay=m_loaiMay.value;r.viTri=m_viTri.value;
  r.ghiChu=m_ghiChu.value;r.daKiemKe=m_daKiemKe.checked;r.chonIn=m_chonIn.checked;
  r.ngayMua=m_ngayMua.value;r.noiMua=m_noiMua.value;
  r.bdQ1=m_bdQ1.checked;r.bdQ2=m_bdQ2.checked;r.bdQ3=m_bdQ3.checked;r.bdQ4=m_bdQ4.checked;
  r.suaChua=m_suaChua.value;
  renderTable();autoSyncRow(editingIndex);
  modal.style.display='none';document.body.classList.remove('modal-open');editingIndex=null;
}

// ==== CHECKBOX ÄÃƒ KK + IN QR AUTO SYNC ====
tbody.addEventListener('change',e=>{
  const tr=e.target.closest('tr');
  if(!tr) return;
  const i=parseInt(tr.dataset.index);
  const r=allData[i];
  if(e.target.classList.contains('daKiemKe')){r.daKiemKe=e.target.checked; autoSyncRow(i);}
  if(e.target.classList.contains('chonIn')){r.chonIn=e.target.checked; autoSyncRow(i);}
  if(e.target.classList.contains('bdQ')){
    r.bdQ1=tr.querySelector('.bdQ1').checked;
    r.bdQ2=tr.querySelector('.bdQ2').checked;
    r.bdQ3=tr.querySelector('.bdQ3').checked;
    r.bdQ4=tr.querySelector('.bdQ4').checked;
    autoSyncRow(i);
  }
});

// ==== SEARCH + FILTER ====
searchBox.addEventListener('input',renderTable);
filterBox.addEventListener('change',renderTable);

// ==== CHECK ALL ====
document.getElementById('checkAllKK').addEventListener('change',e=>{
  const val=e.target.checked; allData.forEach((r,i)=>{r.daKiemKe=val;autoSyncRow(i);});renderTable();
});
document.getElementById('checkAllQR').addEventListener('change',e=>{
  const val=e.target.checked; allData.forEach((r,i)=>{r.chonIn=val;autoSyncRow(i);});renderTable();
});

// ==== IN QR ====
document.getElementById('btnPrint').onclick=()=>{
  const printData=allData.filter(r=>r.chonIn);
  if(printData.length===0){alert('Chá»n Ã­t nháº¥t 1 dÃ²ng Ä‘á»ƒ in');return;}
  const w=window.open('','_blank');
  w.document.write('<html><head><title>In Tem QR</title></head><body>');
  printData.forEach(r=>{
    w.document.write('<div style="display:inline-block;margin:8px;text-align:center;width:120px;">');
    w.document.write('<div id="qr_'+r.soThe+'"></div>');
    w.document.write('<div style="margin-top:4px">'+r.soThe+'</div>');
    w.document.write('</div>');
  });
  w.document.write('</body></html>');
  w.document.close();
  printData.forEach(r=>{new QRCode(w.document.getElementById('qr_'+r.soThe),{text:r.soThe,width:100,height:100});});
}

// ==== HIGHLIGHT FROM HASH ====
function highlightFromHash(){
  const hash=window.location.hash.slice(1);
  if(!hash) return;
  tbody.querySelectorAll('tr').forEach(tr=>tr.classList.remove('highlight'));
  tbody.querySelectorAll('tr').forEach(tr=>{
    const val=tr.querySelector('.col-so-the').innerText;
    if(val===hash) tr.classList.add('highlight');
  });
}
window.addEventListener('hashchange',highlightFromHash);
</script>
</body>
</html>
