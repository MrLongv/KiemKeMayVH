<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìã Ki·ªÉm k√™ m√°y may - Sync</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* (style gi·ªëng nh∆∞ b·∫°n g·ª≠i, gi·ªØ nguy√™n) */
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
th{background:#0b74d1;color:#fff}
tr.highlight{background:#ffeaa7 !important}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} .controls input[type="text"]{width:100%} }
</style>
</head>
<body>
<header>üìã Ki·ªÉm k√™ m√°y may ‚Äî Sync Google Sheet</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="üîç T√¨m theo s·ªë th·∫ª / s·ªë m√°y" />
  <button id="btnImport" class="ghost">üìÇ Nh·∫≠p Excel</button>
  <button id="btnExport">üíæ Xu·∫•t Excel</button>
  <button id="btnAdd">‚ûï Th√™m</button>
  <button id="btnSync">‚òÅÔ∏è ƒê·ªìng b·ªô Sheet</button>
  <button id="btnRefresh" class="ghost">üîÑ T·∫£i l·∫°i t·ª´ Sheet</button>
  <button id="btnPrint">üñ®Ô∏è In tem QR</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tr·∫°ng th√°i: offline</span>
  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
</div>

<div class="note">QR code, in tem, checkbox "ƒê√£ ki·ªÉm k√™" + "Ch·ªçn ƒë·ªÉ in", ng√†y mua chu·∫©n dd/mm/yyyy</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>S·ªë th·∫ª</th>
        <th>S·ªë m√°y</th>
        <th>Lo·∫°i m√°y</th>
        <th>V·ªã tr√≠</th>
        <th>Ghi ch√∫</th>
        <th>ƒê√£ ki·ªÉm k√™</th>
        <th>Ch·ªçn ƒë·ªÉ in</th>
        <th>Ng√†y mua</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal ch·ªânh s·ª≠a -->
<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">‚úèÔ∏è Ch·ªânh s·ª≠a / Th√™m d√≤ng</h3>
    <label>S·ªë th·∫ª</label><input id="m_soThe" />
    <label>S·ªë m√°y</label><input id="m_soMay" />
    <label>Lo·∫°i m√°y</label><input id="m_loaiMay" />
    <label>V·ªã tr√≠</label><input id="m_viTri" />
    <label>Ghi ch√∫</label><textarea id="m_ghiChu" rows="3"></textarea>
    <label>ƒê√£ ki·ªÉm k√™</label><input type="checkbox" id="m_daKiemKe" />
    <label>Ch·ªçn ƒë·ªÉ in</label><input type="checkbox" id="m_chonIn" />
    <label>Ng√†y mua</label><input type="date" id="m_ngayMua" />
    <div class="actions">
      <button id="cancelBtn" class="ghost">H·ªßy</button>
      <button id="saveBtn">C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
/* ======= C·∫•u h√¨nh ======= */
// Thay b·∫±ng URL Web App (deployment) c·ªßa b·∫°n (k·∫øt th√∫c b·∫±ng /exec)
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyoBtTtZC-Qn6jtaHRLKGBexuuDkuxcZt5sOQu8MUCoKSHe_bKW6auWSomkBjLuvfS0/exec';
const statusEl = document.getElementById('status');
const tbody = document.querySelector('#dataTable tbody');
let allData = [], editingIndex=null;

/* ======= Utils ======= */
function setStatus(txt,ok=true){statusEl.innerText='Tr·∫°ng th√°i: '+txt; statusEl.style.color=ok?'#0b74d1':'#c0392b';}
function safeText(v){return (v===null||v===undefined)?'':String(v);}
function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

/* ======= Load d·ªØ li·ªáu (th·ª≠ fetch r·ªìi fallback JSONP) ======= */
async function loadData(){
  setStatus('ƒêang t·∫£i d·ªØ li·ªáu...');
  // Th·ª≠ fetch b√¨nh th∆∞·ªùng (n·∫øu deploy ƒë√∫ng v√† CORS ok)
  try{
    const res = await fetch(GAS_URL, {cache:'no-store'});
    // n·∫øu status kh√¥ng ph·∫£i 200 th√¨ throw ƒë·ªÉ th·ª≠ JSONP
    if(!res || !res.ok) throw new Error('HTTP '+(res?res.status:'no response'));
    const j = await res.json();
    if(j && j.success && Array.isArray(j.data)){
      allData = j.data.map(r=>({
        soThe:safeText(r.soThe),
        soMay:safeText(r.soMay),
        loaiMay:safeText(r.loaiMay),
        viTri:safeText(r.viTri),
        ghiChu:safeText(r.ghiChu),
        daKiemKe:!!r.daKiemKe,
        chonIn:!!r.chonIn,
        ngayMua:r.ngayMua
      }));
      setStatus('ƒê√£ t·∫£i t·ª´ Sheet ('+allData.length+' d√≤ng)');
      renderTable();
      return;
    } else {
      throw new Error(j && j.message ? j.message : 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
    }
  }catch(err){
    console.warn('Fetch JSON th·∫•t b·∫°i, th·ª≠ JSONP...', err.message);
    // Fallback: JSONP (ƒë·ªÉ tr√°nh CORS n·∫øu trang c·ªßa b·∫°n host ·ªü n∆°i kh√°c)
    return loadDataJsonp();
  }
}

function loadDataJsonp(){
  return new Promise((resolve, reject)=>{
    const cbName = '__gs_cb_' + Date.now();
    window[cbName] = function(response){
      try {
        if(response && response.success && Array.isArray(response.data)){
          allData = response.data.map(r=>({
            soThe:safeText(r.soThe),
            soMay:safeText(r.soMay),
            loaiMay:safeText(r.loaiMay),
            viTri:safeText(r.viTri),
            ghiChu:safeText(r.ghiChu),
            daKiemKe:!!r.daKiemKe,
            chonIn:!!r.chonIn,
            ngayMua:r.ngayMua
          }));
          setStatus('ƒê√£ t·∫£i t·ª´ Sheet (JSONP) ('+allData.length+' d√≤ng)');
          renderTable();
          resolve();
        } else {
          setStatus('L·ªói t·∫£i d·ªØ li·ªáu', false);
          reject(new Error(response && response.message ? response.message : 'JSONP tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá'));
        }
      } finally {
        // cleanup
        delete window[cbName];
        script.remove();
      }
    };
    const script = document.createElement('script');
    script.src = GAS_URL + '?callback=' + cbName + '&_=' + Date.now();
    script.onerror = function(e){
      setStatus('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu (JSONP)', false);
      delete window[cbName];
      script.remove();
      reject(new Error('JSONP load error'));
    };
    document.head.appendChild(script);
  });
}

/* ======= Render b·∫£ng ======= */
function renderTable(){
  tbody.innerHTML='';
  allData.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.dataset.index=idx;
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${escapeHtml(r.soThe)}</td>
      <td>${escapeHtml(r.soMay)}</td>
      <td>${escapeHtml(r.loaiMay)}</td>
      <td>${escapeHtml(r.viTri)}</td>
      <td>${escapeHtml(r.ghiChu)}</td>
      <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
      <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
      <td>${r.ngayMua||''}</td>
      <td>
        <button data-act="edit" data-i="${idx}">‚úèÔ∏è</button>
        <button data-act="qr" data-i="${idx}">üîó</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ======= Event trong b·∫£ng ======= */
tbody.addEventListener('click',e=>{
  const btn=e.target.closest('button');
  if(!btn) return;
  const act=btn.dataset.act, i=Number(btn.dataset.i);
  if(act==='edit') openEditModal(i);
  else if(act==='qr'){
    const code=encodeURIComponent(allData[i].soThe||'');
    const url=location.href.split('#')[0]+'#'+code;
    prompt('Link QR (copy & in tem):',url);
  }
});
tbody.addEventListener('change',e=>{
  const tr=e.target.closest('tr');
  const idx=Number(tr.dataset.index);
  if(e.target.classList.contains('daKiemKe')) allData[idx].daKiemKe=e.target.checked;
  if(e.target.classList.contains('chonIn')) allData[idx].chonIn=e.target.checked;
});

/* ======= Modal ======= */
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe');
const m_soMay=document.getElementById('m_soMay');
const m_loaiMay=document.getElementById('m_loaiMay');
const m_viTri=document.getElementById('m_viTri');
const m_ghiChu=document.getElementById('m_ghiChu');
const m_daKiemKe=document.getElementById('m_daKiemKe');
const m_chonIn=document.getElementById('m_chonIn');
const m_ngayMua=document.getElementById('m_ngayMua');
document.getElementById('btnAdd').onclick=()=>openEditModal(null);
document.getElementById('cancelBtn').onclick=()=>{modal.style.display='none';editingIndex=null;}
document.getElementById('saveBtn').onclick=()=>{
  const obj={
    soThe:m_soThe.value.trim(),
    soMay:m_soMay.value.trim(),
    loaiMay:m_loaiMay.value.trim(),
    viTri:m_viTri.value.trim(),
    ghiChu:m_ghiChu.value.trim(),
    daKiemKe:m_daKiemKe.checked,
    chonIn:m_chonIn.checked,
    ngayMua:m_ngayMua.value ? (new Date(m_ngayMua.value)).toLocaleDateString('en-GB') : ''
  };
  if(!obj.soThe){alert('S·ªë th·∫ª kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng'); return;}
  if(editingIndex===null) allData.push(obj); else allData[editingIndex]=obj;
  modal.style.display='none'; editingIndex=null; renderTable();
};
function openEditModal(idx){
  editingIndex=(typeof idx==='number')?idx:null;
  if(editingIndex===null){
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu='';
    m_daKiemKe.checked=m_chonIn.checked=false;
    m_ngayMua.value='';
  }else{
    const r=allData[editingIndex];
    m_soThe.value=r.soThe; m_soMay.value=r.soMay; m_loaiMay.value=r.loaiMay;
    m_viTri.value=r.viTri; m_ghiChu.value=r.ghiChu;
    m_daKiemKe.checked=r.daKiemKe; m_chonIn.checked=r.chonIn;
    m_ngayMua.value=r.ngayMua ? new Date(r.ngayMua.split('/').reverse().join('-')).toISOString().slice(0,10) : '';
  }
  modal.style.display='flex'; m_soThe.focus();
}

/* ======= Search ======= */
document.getElementById('searchBox').addEventListener('input',e=>{
  const v=e.target.value.toLowerCase();
  Array.from(tbody.children).forEach(tr=>{
    const idx=Number(tr.dataset.index); const r=allData[idx];
    const text=(r.soThe+' '+r.soMay+' '+r.loaiMay+' '+r.viTri+' '+r.ghiChu).toLowerCase();
    tr.style.display=text.includes(v)?'':'none';
  });
});

/* ======= Import / Export Excel ======= */
document.getElementById('btnImport').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    allData=sheet.map(r=>({
      soThe:safeText(r.soThe||r['S·ªë th·∫ª']),
      soMay:safeText(r.soMay||r['S·ªë m√°y']),
      loaiMay:safeText(r.loaiMay||r['Lo·∫°i m√°y']),
      viTri:safeText(r.viTri||r['V·ªã tr√≠']),
      ghiChu:safeText(r.ghiChu||r['Ghi ch√∫']),
      daKiemKe:!!r.daKiemKe,
      chonIn:!!r.chonIn,
      ngayMua:r.ngayMua||''
    }));
    renderTable();
  };
  reader.readAsArrayBuffer(f);
});
document.getElementById('btnExport').onclick=()=>{
  const ws=XLSX.utils.json_to_sheet(allData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'DanhSachMay');
  XLSX.writeFile(wb,'DanhSachMay.xlsx');
};

/* ======= ƒê·ªìng b·ªô Google Sheet =======
   S·ª≠ d·ª•ng JSONP "save=1&data=encodeURIComponent(JSON.stringify(...))"
   v√¨ POST t·ª´ trang kh√°c c√≥ th·ªÉ b·ªã CORS.
*/
document.getElementById('btnSync').onclick=async()=>{
  if(!confirm('B·∫°n mu·ªën ƒë·ªìng b·ªô to√†n b·ªô d·ªØ li·ªáu hi·ªán c√≥ l√™n Google Sheet? (ghi ƒë√® d·ªØ li·ªáu tr√™n sheet)')) return;
  setStatus('ƒêang ƒë·ªìng b·ªô...');
  try{
    const payload = allData;
    const encoded = encodeURIComponent(JSON.stringify(payload));
    // t·∫°o callback
    const cbName = '__gs_save_cb_' + Date.now();
    window[cbName] = function(response){
      try{
        if(response && response.success){
          setStatus('ƒê√£ ƒë·ªìng b·ªô '+(response.written||0)+' d√≤ng');
          alert('ƒê·ªìng b·ªô th√†nh c√¥ng!');
          // t·∫£i l·∫°i d·ªØ li·ªáu th·ª±c t·∫ø t·ª´ sheet
          loadData();
        } else {
          setStatus('L·ªói server', false);
          alert('L·ªói server: ' + (response && response.message ? response.message : 'Kh√¥ng x√°c ƒë·ªãnh'));
        }
      } finally {
        delete window[cbName];
        script.remove();
      }
    };
    const script = document.createElement('script');
    // d√πng JSONP save (GAS x·ª≠ l√Ω param save=1 & data=...)
    script.src = GAS_URL + '?save=1&callback=' + cbName + '&data=' + encoded + '&_=' + Date.now();
    script.onerror = function(){
      delete window[cbName];
      script.remove();
      setStatus('L·ªói k·∫øt n·ªëi khi ghi', false);
      alert('L·ªói k·∫øt n·ªëi khi ghi (JSONP). H√£y ki·ªÉm tra l·∫°i URL web app v√† quy·ªÅn truy c·∫≠p (Anyone).');
    };
    document.head.appendChild(script);
  }catch(err){
    console.error(err);
    setStatus('L·ªói n·ªôi b·ªô', false);
    alert('L·ªói n·ªôi b·ªô: ' + err.message);
  }
};

/* ======= T·∫£i l·∫°i t·ª´ Sheet ======= */
document.getElementById('btnRefresh').onclick=loadData;

/* ======= QR + In tem (ch·ªçn in) ======= */
document.getElementById('btnPrint').onclick=()=>{
  const printData=allData.filter(r=>r.chonIn);
  if(printData.length===0){alert('Ch·ªçn √≠t nh·∫•t 1 d√≤ng ƒë·ªÉ in'); return;}
  const w=window.open('','_blank');
  w.document.write('<html><head><title>In Tem QR</title><style>body{font-family:Arial;margin:0;padding:0} .tem{width:48%;height:180px;margin:1%;float:left;border:1px solid #000;padding:4px;box-sizing:border-box;text-align:center;} canvas{margin-top:8px}</style></head><body>');
  printData.forEach(r=>{
    const safe = (r.soThe || ('item'+Math.random().toString(36).slice(2,8)));
    w.document.write('<div class="tem"><b>S·ªë th·∫ª:</b>'+escapeHtml(r.soThe)+'<br><b>S·ªë m√°y:</b>'+escapeHtml(r.soMay)+'<br><b>Ng√†y mua:</b>'+escapeHtml(r.ngayMua||'')+'<div id="qr_'+safe+'"></div></div>');
  });
  w.document.write('</body></html>');
  w.document.close();
  // t·∫°o QR sau khi n·ªôi dung s·∫µn
  w.onload = function(){
    printData.forEach(r=>{
      const safe = (r.soThe || ('item'+Math.random().toString(36).slice(2,8)));
      const qrDiv = w.document.getElementById('qr_'+safe);
      if(qrDiv) new QRCode(qrDiv, {text: r.soThe || '', width:80, height:80});
    });
    w.focus(); w.print();
  };
};

/* ======= Load khi m·ªü ======= */
loadData();
</script>
</body>
</html>
