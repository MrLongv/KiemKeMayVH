<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: Arial,sans-serif; margin:0; background:#f4f6f8; }
header { padding:10px; background:#0073e6; color:#fff; text-align:center; font-size:20px; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }
.highlight-row { background: #ffff99; }
button { padding:5px 10px; margin:2px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:5px; width:300px; position:relative; }
.modal-content h3 { margin-top:0; }
.modal-content input, .modal-content textarea { width:100%; margin-bottom:10px; padding:5px; }
.close { position:absolute; top:5px; right:10px; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<header>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</header>

<div style="padding:10px;">
  <button id="btnAdd">Th√™m m·ªõi</button>
  <button id="btnRefresh">T·∫£i l·∫°i</button>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>#</th>
      <th>S·ªë th·∫ª</th>
      <th>S·ªë m√°y</th>
      <th>Lo·∫°i m√°y</th>
      <th>V·ªã tr√≠</th>
      <th>ƒê√£ KK</th>
      <th>In QR</th>
      <th>Q1</th>
      <th>Q2</th>
      <th>Q3</th>
      <th>Q4</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3>Ch·ªânh s·ª≠a / Th√™m m√°y</h3>
    <input type="hidden" id="rowId">
    <input placeholder="S·ªë th·∫ª" id="m_soThe">
    <input placeholder="S·ªë m√°y" id="m_soMay">
    <input placeholder="Lo·∫°i m√°y" id="m_loaiMay">
    <input placeholder="V·ªã tr√≠" id="m_viTri">
    <textarea placeholder="Ghi ch√∫" id="m_ghiChu"></textarea>
    <div>
      <label><input type="checkbox" id="m_daKiemKe"> ƒê√£ ki·ªÉm k√™</label>
      <label><input type="checkbox" id="m_chonIn"> In QR</label>
    </div>
    <div>
      <label><input type="checkbox" id="m_bdQ1"> Q1</label>
      <input type="text" id="m_bdNgayQ1" placeholder="Ng√†y Q1" style="width:100px;">
      <label><input type="checkbox" id="m_bdQ2"> Q2</label>
      <input type="text" id="m_bdNgayQ2" placeholder="Ng√†y Q2" style="width:100px;">
      <label><input type="checkbox" id="m_bdQ3"> Q3</label>
      <input type="text" id="m_bdNgayQ3" placeholder="Ng√†y Q3" style="width:100px;">
      <label><input type="checkbox" id="m_bdQ4"> Q4</label>
      <input type="text" id="m_bdNgayQ4" placeholder="Ng√†y Q4" style="width:100px;">
    </div>
    <input placeholder="Ng√†y mua" id="m_ngayMua">
    <input placeholder="N∆°i mua" id="m_noiMua">
    <input placeholder="S·ª≠a ch·ªØa" id="m_suaChua">
    <button id="btnSave">L∆∞u</button>
  </div>
</div>

<script>
const WORKER_URL = 'https://snowy-surf-e985.hoalangiongxoai.workers.dev'; // thay b·∫±ng Worker URL c·ªßa b·∫°n
let allData = [];

// ==== Modal ====
const modal = document.getElementById('editModal');
const closeModalBtn = document.getElementById('closeModal');
closeModalBtn.onclick = ()=> modal.style.display='none';
window.onclick = e => { if(e.target===modal) modal.style.display='none'; }

function openEditModal(row) {
  modal.style.display = 'flex';
  document.getElementById('rowId').value = row?.id || '';
  document.getElementById('m_soThe').value = row?.soThe || '';
  document.getElementById('m_soMay').value = row?.soMay || '';
  document.getElementById('m_loaiMay').value = row?.loaiMay || '';
  document.getElementById('m_viTri').value = row?.viTri || '';
  document.getElementById('m_ghiChu').value = row?.ghiChu || '';
  document.getElementById('m_daKiemKe').checked = row?.daKiemKe ? true:false;
  document.getElementById('m_chonIn').checked = row?.chonIn ? true:false;
  document.getElementById('m_bdQ1').checked = row?.bdQ1 ? true:false;
  document.getElementById('m_bdNgayQ1').value = row?.bdNgayQ1 || '';
  document.getElementById('m_bdQ2').checked = row?.bdQ2 ? true:false;
  document.getElementById('m_bdNgayQ2').value = row?.bdNgayQ2 || '';
  document.getElementById('m_bdQ3').checked = row?.bdQ3 ? true:false;
  document.getElementById('m_bdNgayQ3').value = row?.bdNgayQ3 || '';
  document.getElementById('m_bdQ4').checked = row?.bdQ4 ? true:false;
  document.getElementById('m_bdNgayQ4').value = row?.bdNgayQ4 || '';
  document.getElementById('m_ngayMua').value = row?.ngayMua || '';
  document.getElementById('m_noiMua').value = row?.noiMua || '';
  document.getElementById('m_suaChua').value = row?.suaChua || '';
}

// ==== Load Data ====
async function loadData() {
  try {
    const res = await fetch(WORKER_URL + '/');
    const data = await res.json();
    if(data.success){
      allData = data.data;
      renderTable();
    } else {
      alert('L·ªói worker: '+data.error);
    }
  } catch(err) {
    console.error(err);
  }
}

// ==== Render Table ====
function renderTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = '';
  allData.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${r.soThe||''}</td>
      <td>${r.soMay||''}</td>
      <td>${r.loaiMay||''}</td>
      <td>${r.viTri||''}</td>
      <td><input type="checkbox" class="daKiemKe" data-idx="${idx}" ${r.daKiemKe?'checked':''}></td>
      <td><input type="checkbox" class="chonIn" data-idx="${idx}" ${r.chonIn?'checked':''}></td>
      <td><input type="checkbox" class="bdQ1" data-idx="${idx}" ${r.bdQ1?'checked':''}></td>
      <td><input type="checkbox" class="bdQ2" data-idx="${idx}" ${r.bdQ2?'checked':''}></td>
      <td><input type="checkbox" class="bdQ3" data-idx="${idx}" ${r.bdQ3?'checked':''}></td>
      <td><input type="checkbox" class="bdQ4" data-idx="${idx}" ${r.bdQ4?'checked':''}></td>
      <td><button class="editBtn" data-idx="${idx}">S·ª≠a</button></td>
    `;
    tbody.appendChild(tr);
  });

  // th√™m event s·ª≠a
  document.querySelectorAll(".editBtn").forEach(btn=>{
    btn.onclick = e=>{
      const idx = e.target.dataset.idx;
      openEditModal(allData[idx]);
    }
  });
}

// ==== Save Row ====
document.getElementById('btnSave').onclick = async ()=>{
  const rowData = {
    id: document.getElementById('rowId').value || undefined,
    soThe: document.getElementById('m_soThe').value.trim(),
    soMay: document.getElementById('m_soMay').value.trim(),
    loaiMay: document.getElementById('m_loaiMay').value.trim(),
    viTri: document.getElementById('m_viTri').value.trim(),
    ghiChu: document.getElementById('m_ghiChu').value.trim(),
    daKiemKe: document.getElementById('m_daKiemKe').checked,
    chonIn: document.getElementById('m_chonIn').checked,
    bdQ1: document.getElementById('m_bdQ1').checked,
    bdNgayQ1: document.getElementById('m_bdNgayQ1').value.trim(),
    bdQ2: document.getElementById('m_bdQ2').checked,
    bdNgayQ2: document.getElementById('m_bdNgayQ2').value.trim(),
    bdQ3: document.getElementById('m_bdQ3').checked,
    bdNgayQ3: document.getElementById('m_bdNgayQ3').value.trim(),
    bdQ4: document.getElementById('m_bdQ4').checked,
    bdNgayQ4: document.getElementById('m_bdNgayQ4').value.trim(),
    ngayMua: document.getElementById('m_ngayMua').value.trim(),
    noiMua: document.getElementById('m_noiMua').value.trim(),
    suaChua: document.getElementById('m_suaChua').value.trim()
  };

  try {
    const url = rowData.id ? WORKER_URL + '/update' : WORKER_URL + '/add';
    const response = await fetch(url, {
      method: 'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(rowData)
    });
    const data = await response.json();
    if(data.success){
      modal.style.display='none';
      loadData();
    } else {
      alert('L·ªói worker: '+data.error);
    }
  } catch(err){
    console.error(err);
    alert('L·ªói JS: '+err);
  }
};

// ==== Button Th√™m & Refresh ====
document.getElementById('btnAdd').onclick = ()=> openEditModal(null);
document.getElementById('btnRefresh').onclick = loadData;

// ==== Checkbox t·ª± ƒë·ªông c·∫≠p nh·∫≠t ====
document.addEventListener('change', async e=>{
  if(e.target.classList.contains('daKiemKe') || e.target.classList.contains('chonIn') ||
     e.target.classList.contains('bdQ1') || e.target.classList.contains('bdQ2') ||
     e.target.classList.contains('bdQ3') || e.target.classList.contains('bdQ4')){
    const idx = e.target.dataset.idx;
    const row = allData[idx];
    row[e.target.classList[0]] = e.target.checked;

    try {
      const response = await fetch(WORKER_URL+'/update',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(row)
      });
      const data = await response.json();
      if(!data.success) console.error('Update error:',data.error);
    } catch(err){
      console.error(err);
    }
  }
});

loadData();
</script>
</body>
</html>
