<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header {
  display: flex;             /* d√πng flexbox */
  justify-content: center;   /* canh gi·ªØa theo ngang */
  align-items: center;       /* canh gi·ªØa theo d·ªçc */
  background: #0b74d1;       /* n·ªÅn xanh */
  color: #fff;               /* ch·ªØ tr·∫Øng */
  padding: 16px 0;           /* tr√™n-d∆∞·ªõi */
  font-size: 24px;           /* ch·ªØ to h∆°n */
  font-weight: bold;         /* ch·ªØ ƒë·∫≠m */
  letter-spacing: 1px;       /* kho·∫£ng c√°ch ch·ªØ */
}

.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls select{padding:6px 8px;border:1px solid #ccc;border-radius:4px;}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap}
th{background:#0b74d1;color:#fff}
tr.highlight{background:#ffeaa7 !important}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){.controls{flex-direction:column;align-items:stretch}.controls input[type="text"],.controls select{width:100%}}
</style>
</head>
<body>
<header>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="üîç T√¨m theo s·ªë th·∫ª / s·ªë m√°y" />
  <select id="filterBox">
    <option value="all">üìã Hi·ªán t·∫•t c·∫£</option>
    <option value="daKiemKe">‚úÖ ƒê√£ ki·ªÉm k√™</option>
    <option value="chuaKiemKe">‚¨ú Ch∆∞a ki·ªÉm k√™</option>
    <option value="daIn">üñ®Ô∏è ƒê√£ ch·ªçn in</option>
    <option value="chuaIn">üìÑ Ch∆∞a ch·ªçn in</option>
  </select>
  <button id="btnAdd">‚ûï Th√™m</button>
  <button id="btnSync">‚òÅÔ∏è ƒê·ªìng b·ªô l√™n Sheet</button>
  <button id="btnRefresh" class="ghost">üîÑ T·∫£i l·∫°i t·ª´ Sheet</button>
  <button id="btnPrint">üñ®Ô∏è In tem QR</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tr·∫°ng th√°i: offline</span>
</div>

<div class="note">T√¨m s·ªë th·∫ª ch·ªâ nh·∫≠p s·ªë kh√¥ng nh·∫≠p VH- ,Checkbox ƒê√£ KK t·ª± l∆∞u, ng√†y mua chu·∫©n dd/mm/yyyy</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
  <tr>
    <th>STT</th>
    <th>S·ªë th·∫ª</th>
    <th>S·ªë m√°y</th>
    <th>Lo·∫°i m√°y</th>
    <th>V·ªã tr√≠</th>
    <th>Ghi ch√∫</th>
    <th>H√†nh ƒë·ªông</th>

    <th>
      ƒê√£ KK<br>
      <input type="checkbox" id="checkAllKiemKe">
    </th>

    <th>
      In QR<br>
      <input type="checkbox" id="checkAllIn">
    </th>

    <th>Ng√†y mua</th>
    <th>N∆°i mua</th>
  </tr>
</thead>

    <tbody></tbody>
  </table>
</div>

<!-- Modal th√™m / ch·ªânh s·ª≠a -->
<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">‚úèÔ∏è Ch·ªânh s·ª≠a </h3>
    <label>S·ªë th·∫ª</label><input id="m_soThe" />
    <label>S·ªë m√°y</label><input id="m_soMay" />
    <label>Lo·∫°i m√°y</label><input id="m_loaiMay" />
    <label>V·ªã tr√≠</label><input id="m_viTri" />
    <label>Ghi ch√∫</label><textarea id="m_ghiChu" rows="3"></textarea>
    <label>ƒê√£ ki·ªÉm k√™</label><input type="checkbox" id="m_daKiemKe" />
    <label>Ch·ªçn ƒë·ªÉ in</label><input type="checkbox" id="m_chonIn" />
    <label>Ng√†y mua</label>
    <input id="m_ngayMua" type="text" placeholder="dd/MM/yyyy" />
    <label>N∆°i mua</label><input id="m_noiMua" /> 
    <div class="actions">
      <button id="cancelBtn" class="ghost">H·ªßy</button>
      <button id="saveBtn">C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbw4uF_svcJwo2ki83RoZ0chTcY3IndTSZidOL-oZ3rM4GSEfEH4IT-Oey7z-UFgWmsB/exec';

const statusEl=document.getElementById('status'), tbody=document.querySelector('#dataTable tbody');
const filterBox=document.getElementById('filterBox'), searchBox=document.getElementById('searchBox');
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe'), m_soMay=document.getElementById('m_soMay'),
      m_loaiMay=document.getElementById('m_loaiMay'), m_viTri=document.getElementById('m_viTri'),
      m_ghiChu=document.getElementById('m_ghiChu'), m_daKiemKe=document.getElementById('m_daKiemKe'),
      m_chonIn=document.getElementById('m_chonIn'), m_ngayMua=document.getElementById('m_ngayMua'),
      m_noiMua=document.getElementById('m_noiMua');
      

let allData=[], editingIndex=null;

function setStatus(txt,ok=true){statusEl.innerText='Tr·∫°ng th√°i: '+txt;statusEl.style.color=ok?'#0b74d1':'#c0392b';}
function safeText(v){return v==null?'':String(v);}

// ==== PH·∫¶N M·∫¨T KH·∫®U ====
const PASSWORD = '12345'; // m·∫≠t kh·∫©u
const mainUI = [document.querySelector('header'), document.querySelector('.controls'), document.querySelector('.note'), document.querySelector('.table-wrap')];
const pwdModal = document.createElement('div');
pwdModal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999';
pwdModal.innerHTML = `
  <div style="background:#fff;padding:20px;border-radius:8px;width:300px;text-align:center">
    <h3>üîí Nh·∫≠p m·∫≠t kh·∫©u</h3>
    <input id="pwdInput" type="password" style="width:80%;padding:6px;margin-top:10px" />
    <div style="margin-top:12px">
      <button id="pwdBtn" style="padding:6px 12px;background:#0b74d1;color:#fff;border:none;border-radius:4px;cursor:pointer">ƒêƒÉng nh·∫≠p</button>
    </div>
  </div>`;
document.body.appendChild(pwdModal);
mainUI.forEach(el=>el.style.display='none');

const pwdInput = document.getElementById('pwdInput');
const pwdBtn = document.getElementById('pwdBtn');
pwdInput.focus();

pwdBtn.onclick = () => {
  if(pwdInput.value===PASSWORD){
    localStorage.setItem('loginTime', Date.now());
    pwdModal.style.display='none';
    mainUI.forEach(el=>el.style.display='flex');
    highlightFromHash();
    loadData();
  } else { alert('M·∫≠t kh·∫©u sai!'); pwdInput.value=''; pwdInput.focus(); }
};

// Ki·ªÉm tra phi√™n ƒëƒÉng nh·∫≠p 1 gi·ªù
const loginTime = localStorage.getItem('loginTime');
if(loginTime && Date.now() - loginTime < 3600*1000){
  pwdModal.style.display='none';
  mainUI.forEach(el=>el.style.display='flex');
  loadData();
}

// ==== H·∫æT PH·∫¶N M·∫¨T KH·∫®U ====
function formatDateDDMMYYYY(d){
  if (!d) return "";
  if (d.includes("/")) return d; // ƒë√£ ƒë√∫ng dd/MM/yyyy => gi·ªØ nguy√™n
  const date = new Date(d);
  if (isNaN(date)) return d;
  const day = String(date.getDate()).padStart(2,'0');
  const month = String(date.getMonth()+1).padStart(2,'0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// Render b·∫£ng v·ªõi filter + search
function renderTable(){
  const filter = filterBox.value;
  const search = searchBox.value.toLowerCase();
  tbody.innerHTML = '';

  allData.forEach((r, idx) => {
    let show = true;

    // Filter
    if(filter === 'daKiemKe' && !r.daKiemKe) show = false;
    if(filter === 'chuaKiemKe' && r.daKiemKe) show = false;
    if(filter === 'daIn' && !r.chonIn) show = false;
    if(filter === 'chuaIn' && r.chonIn) show = false;

    // Search
    if(search && !(r.soThe + r.soMay + r.loaiMay + r.viTri + r.ghiChu).toLowerCase().includes(search))
      show = false;

    if(show){
      const tr = document.createElement('tr');
      tr.dataset.index = idx;

      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${safeText(r.soThe)}</td>
        <td>${safeText(r.soMay)}</td>
        <td>${safeText(r.loaiMay)}</td>
        <td>${safeText(r.viTri)}</td>
        <td>${safeText(r.ghiChu)}</td>
        <td>
          <button data-act="edit" data-i="${idx}">‚úèÔ∏è</button>
          <button data-act="qr" data-i="${idx}">üîó</button>
        </td>
        <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
        <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
        <td>${r.ngayMua ? formatDateDDMMYYYY(r.ngayMua) : ''}</td>
        <td>${safeText(r.noiMua)}</td>
      `;

      tbody.appendChild(tr);
    }
  });
}
// ===== CHECK ALL ‚Äì ƒê√£ ki·ªÉm k√™ =====
document.getElementById("checkAllKiemKe")?.addEventListener("change", function () {
  const checked = this.checked;
  allData.forEach(r => r.daKiemKe = checked);
  renderTable();
});

// ===== CHECK ALL ‚Äì In QR =====
document.getElementById("checkAllIn")?.addEventListener("change", function () {
  const checked = this.checked;
  allData.forEach(r => r.chonIn = checked);
  renderTable();
});

// Load d·ªØ li·ªáu JSONP
function loadData(){
  setStatus('ƒêang t·∫£i d·ªØ li·ªáu...');
  const cb='__load_cb_'+Date.now();
  window[cb]=function(res){
    try{
      if(res && res.success && Array.isArray(res.data)){
        allData=res.data; 
        renderTable(); 
        setStatus('ƒê√£ t·∫£i '+allData.length+' d√≤ng'); 
        // ‚ú® G·ªçi highlight ngay sau khi b·∫£ng ƒë√£ render xong
        highlightFromHash();
      }
      else setStatus('L·ªói t·∫£i d·ªØ li·ªáu',false);
    } finally {
      delete window[cb];
      script.remove();
    }
  };
  const script=document.createElement('script');
  script.src=GAS_URL+'?callback='+cb+'&_='+Date.now();
  script.onerror=()=>{setStatus('L·ªói t·∫£i d·ªØ li·ªáu',false); delete window[cb]; script.remove();};
  document.head.appendChild(script);
}
// Auto l∆∞u 1 d√≤ng
function autoSyncRow(i){
  if(i==null||!allData[i]) return;
  const row=allData[i], encoded=encodeURIComponent(JSON.stringify(row));
  const cb='__auto_cb_'+Date.now();
  window[cb]=function(res){
    try{
      if(res&&res.success) setStatus('‚úÖ ƒê√£ l∆∞u d√≤ng '+(i+1));
      else setStatus('‚ùå L·ªói l∆∞u d√≤ng '+(i+1),false);
    } finally { delete window[cb]; script.remove(); }
  };
  const script=document.createElement('script');
  script.src=GAS_URL+'?update=1&row='+(i+1)+'&data='+encoded+'&callback='+cb+'&_='+Date.now();
  script.onerror=()=>{ console.warn('‚ö†Ô∏è AutoSync l·ªói m·∫°ng'); delete window[cb]; script.remove(); };
  document.head.appendChild(script);
}
// Events
filterBox.addEventListener('change',renderTable);
searchBox.addEventListener('input',renderTable);

tbody.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const act=btn.dataset.act,i=Number(btn.dataset.i);
  if(act==='edit'){openEditModal(i);}
  if(act==='qr'){const code=encodeURIComponent(allData[i].soThe||'');const url=location.href.split('#')[0]+'#'+code;prompt('Link QR (copy & in tem):',url);}
});

tbody.addEventListener('change', e=>{
  const tr = e.target.closest('tr'); if(!tr) return;
  const idx = Number(tr.dataset.index);
  if(e.target.classList.contains('daKiemKe')){
    allData[idx].daKiemKe = e.target.checked; 
    autoSyncRow(idx);
  }
  if(e.target.classList.contains('chonIn')){
    allData[idx].chonIn = e.target.checked;
    autoSyncRow(idx);  // üëà th√™m d√≤ng n√†y ƒë·ªÉ t·ª± l∆∞u
  }
  renderTable();
});

// Modal Th√™m / s·ª≠a
document.getElementById('btnAdd').onclick=()=>{
  editingIndex=null;
  m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value='';
  m_daKiemKe.checked=m_chonIn.checked=false;
  m_ngayMua.value='';
  modal.style.display='flex'; m_soThe.focus();
};
document.getElementById('cancelBtn').onclick=()=>{modal.style.display='none'; editingIndex=null;};
document.getElementById("saveBtn").onclick = () => {

  let ngayText = m_ngayMua.value.trim();
  let ngayMuaFormatted = "";

  // Ng∆∞·ªùi d√πng c√≥ nh·∫≠p ‚Üí ki·ªÉm tra dd/MM/yyyy
  if (ngayText !== "") {
    const parts = ngayText.split("/");
    if (parts.length !== 3) {
      alert("Ng√†y mua kh√¥ng h·ª£p l·ªá (dd/MM/yyyy)");
      m_ngayMua.focus();
      return;
    }
    let [dd, mm, yyyy] = parts;

    // Validate s·ªë
    if (isNaN(dd) || isNaN(mm) || isNaN(yyyy)) {
      alert("Ng√†y mua ph·∫£i l√† s·ªë (dd/MM/yyyy)");
      return;
    }

    // Chu·∫©n h√≥a 2 ch·ªØ s·ªë ng√†y/th√°ng
    dd = dd.padStart(2, "0");
    mm = mm.padStart(2, "0");

    ngayMuaFormatted = `${dd}/${mm}/${yyyy}`;
  }
  else if (editingIndex !== null) {
    // Kh√¥ng nh·∫≠p g√¨ ‚Üí gi·ªØ nguy√™n ng√†y c≈©
    ngayMuaFormatted = allData[editingIndex].ngayMua || "";
  }

  const obj = {
    soThe:   m_soThe.value.trim(),
    soMay:   m_soMay.value.trim(),
    loaiMay: m_loaiMay.value.trim(),
    viTri:   m_viTri.value.trim(),
    ghiChu:  m_ghiChu.value.trim(),
    daKiemKe: m_daKiemKe.checked,
    chonIn:   m_chonIn.checked,
    ngayMua:  ngayMuaFormatted,   // <-- L∆ØU TEXT
    noiMua:   m_noiMua.value.trim()
  };

  if (!obj.soThe) {
    alert("S·ªë th·∫ª kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
    return;
  }

  // Ghi data v√†o m·∫£ng + autosync
  if (editingIndex === null) {
    allData.push(obj);
    autoSyncRow(allData.length - 1);
  } else {
    allData[editingIndex] = obj;
    autoSyncRow(editingIndex);
  }

  modal.style.display = "none";
  editingIndex = null;
  renderTable();
  highlightFromHash();
};

// M·ªü modal ƒë·ªÉ th√™m / ch·ªânh s·ª≠a
function openEditModal(index) {
  editingIndex = index;
  const r = allData[index];

  m_soThe.value   = r.soThe || "";
  m_soMay.value   = r.soMay || "";
  m_loaiMay.value = r.loaiMay || "";
  m_viTri.value   = r.viTri || "";
  m_ghiChu.value  = r.ghiChu || "";
  m_daKiemKe.checked = !!r.daKiemKe;
  m_chonIn.checked   = !!r.chonIn;
  m_noiMua.value  = r.noiMua || "";

  // ‚≠ê‚≠ê GI·ªÆ ƒê√öNG TEXT dd/MM/yyyy ‚Äì KH√îNG BAO GI·ªú new Date()
  m_ngayMua.value = r.ngayMua && r.ngayMua.includes("/")
      ? r.ngayMua
      : ""; // n·∫øu sheet c√≥ format l·∫° th√¨ hi·ªÉn th·ªã tr·ªëng

  modal.style.display = "flex";
  m_soThe.focus();
}

// ƒê·ªìng b·ªô th·ªß c√¥ng
document.getElementById('btnSync').onclick=()=>{
  const payload=allData, encoded=encodeURIComponent(JSON.stringify(payload));
  const cb='__sync_cb_'+Date.now();
  window[cb]=function(res){try{if(res&&res.success){setStatus('ƒê√£ ƒë·ªìng b·ªô '+(res.written||0)+' d√≤ng'); loadData();}else setStatus('L·ªói ghi d·ªØ li·ªáu',false);}finally{delete window[cb];script.remove();}};
  const script=document.createElement('script');
  script.src=GAS_URL+'?save=1&callback='+cb+'&data='+encoded+'&_='+Date.now();
  script.onerror=()=>{console.warn('C√≥ th·ªÉ ghi th√†nh c√¥ng nh∆∞ng JSONP callback ch∆∞a load');delete window[cb];script.remove();};
  document.head.appendChild(script);
};
  
document.getElementById('btnPrint').onclick = () => {
  const printData = allData.filter(r => r.chonIn);
  if (printData.length === 0) {
    alert('Ch·ªçn √≠t nh·∫•t 1 d√≤ng ƒë·ªÉ in');
    return;
  }

  const w = window.open('', '_blank');
  w.document.write('<html><head><title>In Tem QR</title>');
  w.document.write('<style>');
  w.document.write(`
    @page {
      size: A4 portrait;
      margin: 4mm;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(5, 1fr); /* 5 c·ªôt */
      grid-template-rows: repeat(6, auto); /* 6 h√†ng */
      gap: 2mm;
      justify-items: center;
      align-items: center;
    }
    .tem {
      width: 34mm;
      height: 40mm;
      border: 1px solid #000;
      border-radius: 2px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1mm;          /* üëà S√°t h∆°n: ch·ªâ ~4pt */
      box-sizing: border-box;
      text-align: center;
      page-break-inside: avoid;
    }
    .tem .top {
      font-weight: bold;
      font-size: 13px;
      margin: 0.2mm 0 0.2mm 0; /* c√°ch tr√™n 0.5mm, d∆∞·ªõi 0.2mm */
    }
    .tem .qr {
      margin: 0;
      padding: 0;
      line-height: 0;
    }
    .tem .bottom {
      font-weight: bold;
      font-size: 12px;
     margin: 1mm 0 0.2mm 0; /* c√°ch tr√™n 0.5mm, d∆∞·ªõi 0.2mm */
    }
    canvas {
      display: block;
      margin: 0;
      width: 82px !important;  /* ‚úÖ to r√µ n√©t */
      height: 75px !important;
    }
  `);
  w.document.write('</style></head><body>');

  printData.forEach(r => {
    const code = encodeURIComponent(r.soThe || '');
    const soThe = r.soThe || '';
    const soMay = r.soMay || '';
    w.document.write(`
      <div class="tem">
        <div class="top">VH-${soThe}</div>
        <div class="qr" id="qr_${code}"></div>
        <div class="bottom">SM: ${soMay}</div>
      </div>
    `);
  });

  w.document.write('</body></html>');
  w.document.close();

  w.onload = () => {
    printData.forEach(r => {
      const code = encodeURIComponent(r.soThe || '');
      const qrDiv = w.document.getElementById('qr_' + code);
      if (qrDiv) {
        new QRCode(qrDiv, {
          text: location.href.split('#')[0] + '#' + code,
          width: 90,
          height: 90
        });
      }
    });
    setTimeout(() => {
      w.focus();
      w.print();
    }, 600);
  };
};

// Highlight + scroll khi qu√©t QR (s·ªë th·∫ª l√† ch·ªØ/s·ªë k·∫øt h·ª£p)
function highlightFromHash() {
  const hash = decodeURIComponent(location.hash.slice(1)).trim().toLowerCase();
  Array.from(tbody.children).forEach(tr => {
    const idx = Number(tr.dataset.index);
    const r = allData[idx];
    const soThe = r.soThe ? String(r.soThe).trim().toLowerCase() : '';
    if (soThe && soThe === hash) {
      tr.classList.add('highlight');
      tr.scrollIntoView({behavior:'smooth', block:'center'});
    } else {
      tr.classList.remove('highlight');
    }
  });
}
window.addEventListener('hashchange',highlightFromHash);
document.getElementById('btnRefresh').onclick=loadData;

</script>
</body>
</html>
