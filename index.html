<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kiểm kê máy VH</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f8; }
header { padding: 10px; background: #333; color: #fff; text-align: center; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #eee; }
button { padding: 5px 10px; margin: 2px; }
.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; width:400px; max-height:90%; overflow:auto; border-radius:5px; }
.modal-content input, .modal-content textarea { width:100%; margin-bottom:5px; padding:5px; }
.highlight-row { background: #ffff99; }
</style>
</head>
<body>

<header>
  <h2>Kiểm kê máy Việt Hồng</h2>
  <button id="btnAdd">Thêm mới</button>
</header>

<table id="dataTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Số thẻ</th>
      <th>Số máy</th>
      <th>Loại máy</th>
      <th>Vị trí</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Thêm / Sửa</h3>
    <input type="text" id="m_soThe" placeholder="Số thẻ">
    <input type="text" id="m_soMay" placeholder="Số máy">
    <input type="text" id="m_loaiMay" placeholder="Loại máy">
    <input type="text" id="m_viTri" placeholder="Vị trí">
    <textarea id="m_ghiChu" placeholder="Ghi chú"></textarea>
    <label><input type="checkbox" id="m_daKiemKe"> Đã kiểm kê</label><br>
    <label><input type="checkbox" id="m_chonIn"> In QR</label><br>
    <input type="text" id="m_ngayMua" placeholder="Ngày mua">
    <input type="text" id="m_noiMua" placeholder="Nơi mua">
    <input type="text" id="m_suaChua" placeholder="Sửa chữa">
    <div style="margin-top:10px;">
      <button id="btnSave">Lưu</button>
      <button onclick="modal.style.display='none'">Hủy</button>
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev"; // đổi thành URL Worker của bạn
let allData = [];
let editingIndex = null;
const modal = document.getElementById('modal');

async function loadData() {
  try {
    const response = await fetch(WORKER_URL + '/');
    if (!response) throw new Error('Không nhận được phản hồi từ Worker');
    const data = await response.json();
    if (data.success) {
      allData = data.data || [];
      renderTable();
    } else {
      alert('Lỗi Worker: ' + data.error);
    }
  } catch (err) {
    console.error(err);
    alert('Lỗi khi load dữ liệu: ' + err.message);
  }
}

function renderTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  allData.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${r.soThe || ''}</td>
      <td>${r.soMay || ''}</td>
      <td>${r.loaiMay || ''}</td>
      <td>${r.viTri || ''}</td>
      <td>
        <button class="editBtn">Sửa</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.editBtn').forEach((btn, idx) => {
    btn.onclick = () => openEditModal(idx);
  });
}

function openEditModal(idx) {
  editingIndex = idx !== null ? idx : null;
  const r = idx !== null ? allData[idx] : {};
  document.getElementById('m_soThe').value = r.soThe || '';
  document.getElementById('m_soMay').value = r.soMay || '';
  document.getElementById('m_loaiMay').value = r.loaiMay || '';
  document.getElementById('m_viTri').value = r.viTri || '';
  document.getElementById('m_ghiChu').value = r.ghiChu || '';
  document.getElementById('m_daKiemKe').checked = r.daKiemKe ? true : false;
  document.getElementById('m_chonIn').checked = r.chonIn ? true : false;
  document.getElementById('m_ngayMua').value = r.ngayMua || '';
  document.getElementById('m_noiMua').value = r.noiMua || '';
  document.getElementById('m_suaChua').value = r.suaChua || '';
  modal.style.display = 'flex';
}

document.getElementById('btnAdd').onclick = () => openEditModal(null);

document.getElementById('btnSave').onclick = async () => {
  const rowData = {
    id: editingIndex !== null ? allData[editingIndex].id : null,
    soThe: document.getElementById('m_soThe').value.trim(),
    soMay: document.getElementById('m_soMay').value.trim(),
    loaiMay: document.getElementById('m_loaiMay').value.trim(),
    viTri: document.getElementById('m_viTri').value.trim(),
    ghiChu: document.getElementById('m_ghiChu').value.trim(),
    daKiemKe: document.getElementById('m_daKiemKe').checked,
    chonIn: document.getElementById('m_chonIn').checked,
    ngayMua: document.getElementById('m_ngayMua').value.trim(),
    noiMua: document.getElementById('m_noiMua').value.trim(),
    suaChua: document.getElementById('m_suaChua').value.trim()
  };

  const url = rowData.id ? WORKER_URL + '/update' : WORKER_URL + '/add';

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(rowData)
    });

    if (!response) throw new Error('Không nhận được phản hồi từ Worker');

    let data;
    try {
      data = await response.json();
    } catch (err) {
      const text = await response.text().catch(() => '');
      throw new Error('Worker trả về không phải JSON: ' + text);
    }

    if (data.success) {
      modal.style.display = 'none';
      loadData();
    } else {
      alert('Lỗi worker: ' + data.error);
    }

  } catch (err) {
    console.error(err);
    alert('Lỗi JS: ' + err.message);
  }
};

// Load dữ liệu lúc mở trang
loadData();
</script>
</body>
</html>
