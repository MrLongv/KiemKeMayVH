<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã Ki·ªÉm k√™ m√°y may - Online Sync</title>

<!-- Th∆∞ vi·ªán Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Th∆∞ vi·ªán QR code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Th∆∞ vi·ªán qu√©t QR tr·ª±c ti·∫øp -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial; margin:20px; }
h2 { margin-bottom: 10px; }
table { border-collapse: collapse; width: 100%; margin-top:10px; table-layout: fixed; }
th, td { border: 1px solid #333; padding:6px; text-align:center; word-wrap: break-word; }
th { background:#eee; }
.highlight { background-color: yellow !important; }
.topbar { display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-bottom:10px; }
button { margin:3px; padding:5px 10px; cursor:pointer; }
.qr { width:60px; height:60px; margin:auto; }
.status { margin-left:10px; font-size:14px; color:#555; }
.note { color:#666; font-size:13px; }
.modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.4); }
.modal-content { background:#fff; border-radius:8px; padding:16px; width:420px; margin:8% auto; box-shadow:0 6px 20px rgba(0,0,0,0.2); }
.modal-content label{display:block;margin-top:8px;font-weight:600;}
.modal-content input, .modal-content textarea{width:100%;padding:6px;margin-top:4px;}
.modal-buttons{text-align:right;margin-top:12px;}
#qrScanner { width:250px; margin-top:10px; }
</style>
</head>
<body>

<h2>üìã Danh s√°ch m√°y may (Sync v·ªõi Google Sheet)</h2>

<div class="topbar">
  <button id="addBtn">‚ûï Th√™m</button>
  <button id="uploadBtn">‚òÅÔ∏è ƒê·ªìng b·ªô l√™n Google Sheet</button>
  <button id="downloadBtn">üíæ Xu·∫•t Excel</button>
  <button id="importBtn">üìÇ Nh·∫≠p Excel</button>
  <button id="refreshBtn">üîÑ L√†m m·ªõi Sheet</button>
  <span class="status" id="syncStatus">Tr·∫°ng th√°i: offline</span>
</div>

<div id="qrScanner"></div>
<p class="note">Ghi ch√∫: B·∫°n c·∫ßn deploy Apps Script v√† thay URL v√†o bi·∫øn <code>GAS_URL</code> trong code.</p>

<table id="machineTable">
  <thead>
    <tr>
      <th>STT</th>
      <th>M√£ QR</th>
      <th>S·ªë th·∫ª</th>
      <th>S·ªë m√°y</th>
      <th>Lo·∫°i m√°y</th>
      <th>V·ªã tr√≠</th>
      <th>Ghi ch√∫</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<input type="file" id="importFile" accept=".xlsx,.xls" style="display:none">

<!-- Popup ch·ªânh s·ª≠a -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin m√°y</h3>
    <label>S·ªë th·∫ª:</label><input id="editSoThe">
    <label>S·ªë m√°y:</label><input id="editSoMay">
    <label>Lo·∫°i m√°y:</label><input id="editLoaiMay">
    <label>V·ªã tr√≠:</label><input id="editViTri">
    <label>Ghi ch√∫:</label><textarea id="editGhiChu" rows="3"></textarea>
    <div class="modal-buttons">
      <button id="cancelEdit">H·ªßy</button>
      <button id="saveEdit">C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyV36oZEfMdC7Hc2EOqVL5r2A6qMPWvo5sU3qUdDhxbQ1hMPzwSYgdGnXPioOeZeWVs/exec';
const GITHUB_BASE = 'https://mrlongv.github.io/KiemKeMayVH/';

const tableBody = document.querySelector('#machineTable tbody');
const syncStatus = document.getElementById('syncStatus');
const uploadBtn = document.getElementById('uploadBtn');
const downloadBtn = document.getElementById('downloadBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const refreshBtn = document.getElementById('refreshBtn');

const modal = document.getElementById('editModal');
let editingRow = null;

// ---------- Local storage ----------
function saveLocal(){
  const arr = [];
  tableBody.querySelectorAll('tr').forEach(row => {
    const t = row.querySelectorAll('td');
    arr.push({
      soThe: t[2].innerText,
      soMay: t[3].innerText,
      loaiMay: t[4].innerText,
      viTri: t[5].innerText,
      ghiChu: t[6].innerText
    });
  });
  localStorage.setItem('dsMayMay', JSON.stringify(arr));
}
function loadLocal(){
  const data = JSON.parse(localStorage.getItem('dsMayMay') || '[]');
  if(data.length) {
    tableBody.innerHTML = '';
    data.forEach(d => addRow(d.soThe, d.soMay, d.loaiMay, d.viTri, d.ghiChu));
    updateSTT(); generateQRs();
  }
}

// ---------- Th√™m / s·ª≠a / x√≥a ----------
function addRow(soThe, soMay, loaiMay, viTri, ghiChu){
  const row = document.createElement('tr');
  row.dataset.id = soThe || '';
  row.innerHTML = `
    <td></td>
    <td class="qr"></td>
    <td>${soThe || ''}</td>
    <td>${soMay || ''}</td>
    <td>${loaiMay || ''}</td>
    <td>${viTri || ''}</td>
    <td>${ghiChu || ''}</td>
    <td>
      <button class="editBtn">‚úèÔ∏è</button>
      <button class="deleteBtn">üóëÔ∏è</button>
    </td>
  `;
  tableBody.appendChild(row);
}
document.getElementById('addBtn').onclick = ()=>{
  const soThe = prompt('S·ªë th·∫ª:'); if(!soThe) return;
  const soMay = prompt('S·ªë m√°y:'); const loai = prompt('Lo·∫°i m√°y:'); const viTri = prompt('V·ªã tr√≠:'); const ghi = prompt('Ghi ch√∫:');
  addRow(soThe, soMay, loai, viTri, ghi); updateSTT(); generateQRs(); saveLocal();
};
tableBody.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const row = btn.closest('tr');
  if(btn.classList.contains('deleteBtn')){
    if(confirm('Xo√° m√°y ' + row.dataset.id + '?')){ row.remove(); updateSTT(); saveLocal(); }
  }
  if(btn.classList.contains('editBtn')){
    editingRow = row;
    const tds = row.querySelectorAll('td');
    document.getElementById('editSoThe').value = tds[2].innerText;
    document.getElementById('editSoMay').value = tds[3].innerText;
    document.getElementById('editLoaiMay').value = tds[4].innerText;
    document.getElementById('editViTri').value = tds[5].innerText;
    document.getElementById('editGhiChu').value = tds[6].innerText;
    modal.style.display = 'block';
  }
});
document.getElementById('cancelEdit').onclick = ()=> modal.style.display = 'none';
document.getElementById('saveEdit').onclick = ()=>{
  if(!editingRow) return;
  const tds = editingRow.querySelectorAll('td');
  const soThe = document.getElementById('editSoThe').value.trim();
  if(!soThe){ alert('S·ªë th·∫ª kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng'); return; }
  editingRow.dataset.id = soThe;
  tds[2].innerText = soThe;
  tds[3].innerText = document.getElementById('editSoMay').value;
  tds[4].innerText = document.getElementById('editLoaiMay').value;
  tds[5].innerText = document.getElementById('editViTri').value;
  tds[6].innerText = document.getElementById('editGhiChu').value;
  generateQRs(); saveLocal(); modal.style.display = 'none';
};

// ---------- STT & QR ----------
function updateSTT(){ tableBody.querySelectorAll('tr').forEach((r,i)=> r.children[0].innerText = i+1); }
function generateQRs(){
  tableBody.querySelectorAll('tr').forEach(row => {
    const id = row.dataset.id || row.children[2].innerText;
    row.dataset.id = id;
    const qrCell = row.querySelector('.qr'); qrCell.innerHTML = '';
    const url = GITHUB_BASE + '#'+encodeURIComponent(id); // d√πng hash
    new QRCode(qrCell, { text: url, width:60, height:60 });
  });
}

// ---------- Highlight ----------
function highlightRow(val){
  document.querySelectorAll('.highlight').forEach(e=> e.classList.remove('highlight'));
  const row = tableBody.querySelector('tr[data-id="'+val+'"]');
  if(row){
    row.classList.add('highlight');
    row.scrollIntoView({behavior:'smooth', block:'center'});
  } else alert('Kh√¥ng t√¨m th·∫•y: '+val);
}

// ---------- Import / Export ----------
downloadBtn.onclick = ()=>{
  const data = [['STT','S·ªë th·∫ª','S·ªë m√°y','Lo·∫°i m√°y','V·ªã tr√≠','Ghi ch√∫']];
  tableBody.querySelectorAll('tr').forEach(r=>{
    const t = r.querySelectorAll('td');
    data.push([t[0].innerText, t[2].innerText, t[3].innerText, t[4].innerText, t[5].innerText, t[6].innerText]);
  });
  const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'DanhSachMay');
  XLSX.writeFile(wb, 'DanhSachMay.xlsx');
};
importBtn.onclick = ()=> importFile.click();
importFile.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = (ev)=>{
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
    tableBody.innerHTML = '';
    rows.slice(1).forEach(rw => { if(rw[1]) addRow(rw[1], rw[2]||'', rw[3]||'', rw[4]||'', rw[5]||''); });
    updateSTT(); generateQRs(); saveLocal();
    alert('ƒê√£ nh·∫≠p xong');
  };
  r.readAsArrayBuffer(f);
});

// ---------- ƒê·ªìng b·ªô Google Sheet ----------
uploadBtn.onclick = async () => {
  const arr = [];
  tableBody.querySelectorAll('tr').forEach(r => {
    const t = r.querySelectorAll('td');
    arr.push({ soThe: t[2].innerText, soMay: t[3].innerText, loaiMay: t[4].innerText, viTri: t[5].innerText, ghiChu: t[6].innerText });
  });
  try{
    syncStatus.innerText = 'ƒêang g·ª≠i l√™n Google Sheet...';
    const formData = new URLSearchParams();
    formData.append('data', JSON.stringify(arr));
    const res = await fetch(GAS_URL, { method:'POST', body:formData });
    const text = await res.text();
    const j = JSON.parse(text);
    if(j && j.success){ syncStatus.innerText='‚úÖ ƒê√£ ƒë·ªìng b·ªô'; alert('ƒê√£ ƒë·ªìng b·ªô '+j.written+' d√≤ng'); }
    else{ syncStatus.innerText='‚ùå L·ªói'; alert('L·ªói: '+(j && j.message)); }
  }catch(err){ syncStatus.innerText='‚ùå L·ªói k·∫øt n·ªëi'; alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi GAS: '+err); }
};

// ---------- Load t·ª´ Sheet ----------
async function loadFromSheet(){
  try{
    const res = await fetch(GAS_URL);
    const j = await res.json();
    if(j.success){
      tableBody.innerHTML = '';
      j.data.forEach(d => addRow(d.soThe,d.soMay,d.loaiMay,d.viTri,d.ghiChu));
      updateSTT(); generateQRs(); saveLocal();
      syncStatus.innerText='‚úÖ ƒê√£ load d·ªØ li·ªáu Sheet';
    }else syncStatus.innerText='‚ùå L·ªói load Sheet';
  }catch(err){ syncStatus.innerText='‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Sheet'; }
}
refreshBtn.onclick = loadFromSheet;

// ---------- Qu√©t QR tr·ª±c ti·∫øp tr√™n web ----------
function startQrScanner(){
  const qrScannerDiv = document.getElementById('qrScanner');
  const qrScanner = new Html5Qrcode("qrScanner");
  Html5Qrcode.getCameras().then(cameras => {
    if(cameras.length){
      qrScanner.start(
        cameras[0].id,
        { fps: 10, qrbox: 250 },
        qrMessage => {
          const id = decodeURIComponent(qrMessage.split('#')[1]||qrMessage);
          highlightRow(id);
        }
      );
    }
  }).catch(err => console.log('QR scanner error',err));
}

// ---------- Khi m·ªü trang ----------
window.addEventListener('load', ()=>{
  loadLocal(); updateSTT(); generateQRs();
  startQrScanner();
});
</script>

</body>
</html>
