<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body { font-family: Arial,sans-serif; margin:0; background:#f4f6f8; }
header { padding:10px 20px; background:#fff; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
header h1 { margin:0; font-size:20px; }
button { padding:5px 10px; margin:0 2px; cursor:pointer; }
table { border-collapse: collapse; width:100%; margin-top:10px; background:#fff; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; font-size:13px; }
th { background:#eee; }
.highlight-row { background:#fffae6 !important; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:15px; width:350px; border-radius:5px; max-height:90%; overflow-y:auto; position:relative; }
.modal-content h2 { margin-top:0; }
.modal-content label { display:block; margin:5px 0 2px; font-weight:bold; }
.modal-content input, .modal-content textarea { width:100%; padding:4px; margin-bottom:5px; }
.modal-close { position:absolute; top:5px; right:10px; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</h1>
  <div>
    <button id="btnAdd">Th√™m m·ªõi</button>
    <button id="btnRefresh">Load l·∫°i</button>
    <button id="btnPrint">In QR</button>
    <button id="btnPrintLyLich">In L√Ω L·ªãch</button>
    <input type="text" id="soThePrint" placeholder="S·ªë th·∫ª / all" style="width:80px">
  </div>
</header>

<div style="padding:10px;">
  <table id="dataTable">
    <thead>
      <tr>
        <th>#</th>
        <th>S·ªë th·∫ª</th>
        <th>S·ªë m√°y</th>
        <th>Lo·∫°i m√°y</th>
        <th>V·ªã tr√≠</th>
        <th>Ghi ch√∫</th>
        <th>ƒê√£ KK <input type="checkbox" id="checkAllKK"></th>
        <th>In QR <input type="checkbox" id="checkAllQR"></th>
        <th>Q1 <input type="checkbox" id="checkAllQ1"></th>
        <th>Q2 <input type="checkbox" id="checkAllQ2"></th>
        <th>Q3 <input type="checkbox" id="checkAllQ3"></th>
        <th>Q4 <input type="checkbox" id="checkAllQ4"></th>
        <th>S·ª≠a</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="modal-close" id="modalClose">&times;</span>
    <h2>Ch·ªânh s·ª≠a / Th√™m m√°y</h2>
    <label>S·ªë th·∫ª</label><input id="m_soThe">
    <label>S·ªë m√°y</label><input id="m_soMay">
    <label>Lo·∫°i m√°y</label><input id="m_loaiMay">
    <label>V·ªã tr√≠</label><input id="m_viTri">
    <label>Ghi ch√∫</label><textarea id="m_ghiChu"></textarea>
    <label>ƒê√£ ki·ªÉm k√™</label><input type="checkbox" id="m_daKiemKe">
    <label>In QR</label><input type="checkbox" id="m_chonIn">
    <label>B·∫£o d∆∞·ª°ng Q1</label><input type="checkbox" id="m_bdQ1"><input type="date" id="m_bdNgayQ1">
    <label>B·∫£o d∆∞·ª°ng Q2</label><input type="checkbox" id="m_bdQ2"><input type="date" id="m_bdNgayQ2">
    <label>B·∫£o d∆∞·ª°ng Q3</label><input type="checkbox" id="m_bdQ3"><input type="date" id="m_bdNgayQ3">
    <label>B·∫£o d∆∞·ª°ng Q4</label><input type="checkbox" id="m_bdQ4"><input type="date" id="m_bdNgayQ4">
    <label>S·ª≠a ch·ªØa</label><input id="m_suaChua">
    <div style="margin-top:10px; text-align:right;">
      <button id="modalSave">L∆∞u</button>
      <button id="modalCancel">H·ªßy</button>
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev/";
let allData = [], editingIndex = null;

// Fetch d·ªØ li·ªáu t·ª´ Worker
async function loadData() {
  try {
    const res = await fetch(WORKER_URL);
    allData = await res.json();
    renderTable();
    highlightFromHash();
  } catch(err) {
    alert("L·ªói load d·ªØ li·ªáu: "+err);
  }
}

// Render table
function renderTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  allData.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.index = idx;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td class="col-so-the">${r.soThe||''}</td>
      <td>${r.soMay||''}</td>
      <td>${r.loaiMay||''}</td>
      <td>${r.viTri||''}</td>
      <td>${r.ghiChu||''}</td>
      <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
      <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
      <td><input type="checkbox" class="bdQ1" ${r.bdQ1?'checked':''}></td>
      <td><input type="checkbox" class="bdQ2" ${r.bdQ2?'checked':''}></td>
      <td><input type="checkbox" class="bdQ3" ${r.bdQ3?'checked':''}></td>
      <td><input type="checkbox" class="bdQ4" ${r.bdQ4?'checked':''}></td>
      <td><button class="editBtn">S·ª≠a</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Checkbox change
  document.querySelectorAll(".daKiemKe").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].daKiemKe = cb.checked;
    };
  });
  document.querySelectorAll(".chonIn").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].chonIn = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ1").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ1 = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ2").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ2 = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ3").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ3 = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ4").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ4 = cb.checked;
    };
  });

  // Edit button
  document.querySelectorAll(".editBtn").forEach(btn=>{
    btn.onclick = ()=>{
      editingIndex = Number(btn.closest("tr").dataset.index);
      openEditModal(editingIndex);
    };
  });
}

// Modal
const modal = document.getElementById("editModal");
const modalClose = document.getElementById("modalClose");
const modalCancel = document.getElementById("modalCancel");
const modalSave = document.getElementById("modalSave");
const m_soThe = document.getElementById("m_soThe");
const m_soMay = document.getElementById("m_soMay");
const m_loaiMay = document.getElementById("m_loaiMay");
const m_viTri = document.getElementById("m_viTri");
const m_ghiChu = document.getElementById("m_ghiChu");
const m_daKiemKe = document.getElementById("m_daKiemKe");
const m_chonIn = document.getElementById("m_chonIn");
const m_bdQ1 = document.getElementById("m_bdQ1");
const m_bdQ2 = document.getElementById("m_bdQ2");
const m_bdQ3 = document.getElementById("m_bdQ3");
const m_bdQ4 = document.getElementById("m_bdQ4");
const m_bdNgayQ1 = document.getElementById("m_bdNgayQ1");
const m_bdNgayQ2 = document.getElementById("m_bdNgayQ2");
const m_bdNgayQ3 = document.getElementById("m_bdNgayQ3");
const m_bdNgayQ4 = document.getElementById("m_bdNgayQ4");
const m_suaChua = document.getElementById("m_suaChua");

function openEditModal(idx){
  modal.style.display="flex";
  if(idx!==null){
    const r = allData[idx];
    m_soThe.value=r.soThe||'';
    m_soMay.value=r.soMay||'';
    m_loaiMay.value=r.loaiMay||'';
    m_viTri.value=r.viTri||'';
    m_ghiChu.value=r.ghiChu||'';
    m_daKiemKe.checked=r.daKiemKe||false;
    m_chonIn.checked=r.chonIn||false;
    m_bdQ1.checked=r.bdQ1||false;
    m_bdQ2.checked=r.bdQ2||false;
    m_bdQ3.checked=r.bdQ3||false;
    m_bdQ4.checked=r.bdQ4||false;
    m_bdNgayQ1.value=r.bdNgayQ1||'';
    m_bdNgayQ2.value=r.bdNgayQ2||'';
    m_bdNgayQ3.value=r.bdNgayQ3||'';
    m_bdNgayQ4.value=r.bdNgayQ4||'';
    m_suaChua.value=r.suaChua||'';
  } else {
    m_soThe.value=""; m_soMay.value=""; m_loaiMay.value=""; m_viTri.value=""; m_ghiChu.value="";
    m_daKiemKe.checked=false; m_chonIn.checked=false;
    m_bdQ1.checked=false; m_bdQ2.checked=false; m_bdQ3.checked=false; m_bdQ4.checked=false;
    m_bdNgayQ1.value=""; m_bdNgayQ2.value=""; m_bdNgayQ3.value=""; m_bdNgayQ4.value="";
    m_suaChua.value="";
  }
}

modalClose.onclick = modalCancel.onclick = ()=>{ modal.style.display="none"; }

modalSave.onclick = ()=>{
  const obj = {
    soThe: m_soThe.value.trim(),
    soMay: m_soMay.value.trim(),
    loaiMay: m_loaiMay.value.trim(),
    viTri: m_viTri.value.trim(),
    ghiChu: m_ghiChu.value.trim(),
    daKiemKe: m_daKiemKe.checked,
    chonIn: m_chonIn.checked,
    bdQ1: m_bdQ1.checked,
    bdQ2: m_bdQ2.checked,
    bdQ3: m_bdQ3.checked,
    bdQ4: m_bdQ4.checked,
    bdNgayQ1: m_bdNgayQ1.value,
    bdNgayQ2: m_bdNgayQ2.value,
    bdNgayQ3: m_bdNgayQ3.value,
    bdNgayQ4: m_bdNgayQ4.value,
    suaChua: m_suaChua.value
  };
  if(editingIndex!==null) allData[editingIndex] = obj;
  else allData.push(obj);
  renderTable();
  modal.style.display="none";
};

// Check/uncheck t·∫•t c·∫£
document.getElementById("checkAllKK").onchange = function(){
  document.querySelectorAll(".daKiemKe").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQR").onchange = function(){
  document.querySelectorAll(".chonIn").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ1").onchange = function(){
  document.querySelectorAll(".bdQ1").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ2").onchange = function(){
  document.querySelectorAll(".bdQ2").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ3").onchange = function(){
  document.querySelectorAll(".bdQ3").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ4").onchange = function(){
  document.querySelectorAll(".bdQ4").forEach(cb=>cb.checked=this.checked);
};

// Scroll & highlight t·ª´ hash
let hashScrollDone=false;
function highlightFromHash(retry=40){
  const code=location.hash.slice(1);
  if(!code) return;
  const rows=document.querySelectorAll("#dataTable tbody tr");
  let found=false;
  rows.forEach(row=>{
    const soTheCell=row.querySelector(".col-so-the");
    if(!soTheCell) return;
    if(soTheCell.textContent.trim()===code){
      row.classList.add("highlight-row");
      if(!hashScrollDone){ row.scrollIntoView({behavior:"smooth", block:"center"}); hashScrollDone=true; }
      found=true;
    }
  });
  if(!found && retry>0) setTimeout(()=>highlightFromHash(retry-1),150);
}
window.addEventListener("hashchange",()=>{ hashScrollDone=false; setTimeout(()=>highlightFromHash(),100); });

<!-- IN QR -->
<button id="btnPrint">In QR</button>
<script>
document.getElementById('btnPrint').onclick = () => {
  const printData = allData.filter(r => r.chonIn);
  if (printData.length === 0) { alert('Ch·ªçn √≠t nh·∫•t 1 d√≤ng ƒë·ªÉ in'); return; }

  const w = window.open('', '_blank');
  w.document.write('<html><head><title>In Tem QR</title>');
  w.document.write('<style>');
  w.document.write(`
    @page { size: A4 portrait; margin: 4.3mm; }
    body { font-family: Arial,sans-serif; margin:0; padding:0;
           display:grid; grid-template-columns:repeat(5,1fr);
           grid-auto-rows:auto; gap:2mm; justify-items:center; align-items:center; }
    .tem { width:32mm; height:34mm; border:0.1px solid #000; border-radius:0.2px;
           display:flex; flex-direction:column; justify-content:center; align-items:center;
           padding:0.1mm; box-sizing:border-box; text-align:center; page-break-inside:avoid; }
    .tem .top { font-weight:bold; font-size:12px; margin:0.2mm 0; }
    .tem .qr { margin:0; padding:0; line-height:0; }
    .tem .bottom { font-weight:bold; font-size:12px; margin:0.2mm 0 0.1mm 0; }
    canvas { display:block; margin:0; width:76px !important; height:76px !important; }
  `);
  w.document.write('</style></head><body>');

  printData.forEach(r => {
    const code = encodeURIComponent(r.soThe || '');
    const soThe = r.soThe || '';
    const soMay = r.soMay || '';
    w.document.write(`
      <div class="tem">
        <div class="top">VH-${soThe}</div>
        <div class="qr" id="qr_${code}"></div>
        <div class="bottom">SM: ${soMay}</div>
      </div>
    `);
  });

  w.document.write('</body></html>');
  w.document.close();

  w.onload = () => {
    printData.forEach(r => {
      const code = encodeURIComponent(r.soThe || '');
      const qrDiv = w.document.getElementById('qr_' + code);
      if (qrDiv) {
        new QRCode(qrDiv, {
          text: location.href.split('#')[0] + '#' + code,
          width: 90,
          height: 90
        });
      }
    });
    setTimeout(() => { w.focus(); w.print(); }, 500);
  };
};
</script>

<!-- IN L√ù L·ªäCH -->
<button id="btnPrintLyLich">In L√Ω L·ªãch</button>
<input type="text" id="soThePrint" placeholder="Nh·∫≠p s·ªë th·∫ª ho·∫∑c 'all'">

<script>
document.getElementById('btnPrintLyLich').onclick = () => {
  const input = document.getElementById('soThePrint').value.trim();
  if (!input) { alert("Nh·∫≠p s·ªë th·∫ª ho·∫∑c g√µ 'all' ƒë·ªÉ in to√†n b·ªô!"); return; }

  let listSoThe = [];
  if (input.toLowerCase() === "all") {
    listSoThe = allData.map(r => r.soThe);
  } else {
    listSoThe = input.split(',').map(s => s.trim()).filter(s => s);
  }

  if (listSoThe.length === 0) { alert("Kh√¥ng c√≥ s·ªë th·∫ª h·ª£p l·ªá."); return; }

  const baseURL = location.href.split('#')[0];
  const w = window.open('', '_blank');
  w.document.write('<html><head><title>In L√Ω L·ªãch</title>');

  w.document.write(`
    <style>
      body {font-family: Arial; margin: 20px; color:#333;}
      .header-logo div { font-size: 20px; font-weight: bold; line-height: 1.2; }
      h2 { text-align:center; font-size:22px; border-bottom:2px solid #333; padding-bottom:8px; margin-bottom:10px;}
      table { border-collapse: collapse; width:100%; margin-top:10px; }
      th, td { border:1px solid #ccc; padding:8px; }
      th { background:#eee; width:30%; }
      .page-break { page-break-after: always; }
      .sign-box { margin-top:10px; text-align:right; font-size:16px; line-height:1.5; }
      .sign1 { margin-right:30px; }
      .sign2 { margin-right:60px; }
    </style>
  `);
  w.document.write('</head><body>');

  listSoThe.forEach((soThe, idx) => {
    const row = allData.find(r => r.soThe == soThe);
    if (!row) {
      w.document.write(`<h3 style="color:red">‚ö† Kh√¥ng t√¨m th·∫•y s·ªë th·∫ª: ${soThe}</h3><div class="page-break"></div>`);
      return;
    }

    // QR
    const qrText = `${baseURL}#${encodeURIComponent(soThe)}`;
    const tempDiv = document.createElement("div");
    new QRCode(tempDiv, { text: qrText, width: 100, height: 100 });
    const qrImg = tempDiv.querySelector("img")?.src || tempDiv.querySelector("canvas")?.toDataURL();

    // HEADER
    w.document.write(`
      <div class="header-logo">
        <div style="margin-left:0px;">C√îNG TY TNHH MAY XK</div>
        <div style="margin-left:55px;">VI·ªÜT H·ªíNG</div>
      </div>
      <div style="position: relative; margin-bottom: 40px;">
        <div style="position: absolute; left:60px; top:0;">
          <img src="${qrImg}" style="width:100px;height:100px;">
        </div>
        <div style="text-align:center; font-size:20px; font-weight:bold; padding-top:60px;">
          L√ù L·ªäCH M√ÅY VH-${soThe}
        </div>
      </div>
    `);

    // B·∫¢NG
    const fields = [
      ['S·ªë th·∫ª', row.soThe],
      ['S·ªë m√°y', row.soMay],
      ['Lo·∫°i m√°y', row.loaiMay],
      ['V·ªã tr√≠', row.viTri],
      ['Ghi ch√∫', row.ghiChu],
      ['ƒê√£ ki·ªÉm k√™', row.daKiemKe ? '‚úÖ' : '‚ùå'],
      ['In QR', row.chonIn ? '‚úÖ' : '‚ùå'],
      ['Ng√†y mua', row.ngayMua],
      ['N∆°i mua', row.noiMua],
      ['B·∫£o d∆∞·ª°ng Q1', row.bdQ1 ? '‚úÖ ' + row.bdNgayQ1 : ''],
      ['B·∫£o d∆∞·ª°ng Q2', row.bdQ2 ? '‚úÖ ' + row.bdNgayQ2 : ''],
      ['B·∫£o d∆∞·ª°ng Q3', row.bdQ3 ? '‚úÖ ' + row.bdNgayQ3 : ''],
      ['B·∫£o d∆∞·ª°ng Q4', row.bdQ4 ? '‚úÖ ' + row.bdNgayQ4 : ''],
      ['S·ª≠a ch·ªØa', row.suaChua]
    ];

    w.document.write('<table>');
    fields.forEach(f => w.document.write(`<tr><th>${f[0]}</th><td>${f[1]}</td></tr>`));
    w.document.write('</table>');

    // K√ù T√äN
    w.document.write(`
      <div class="sign-box">
        <div class="sign1" style="margin-right:1px;">Vƒ©nh Long, ng√†y ..... th√°ng ..... nƒÉm .....</div>
        <div class="sign2" style="margin-right:105px;">Ng∆∞·ªùi l·∫≠p</div>
      </div>
    `);

    if(idx < listSoThe.length-1) w.document.write('<div class="page-break"></div>');
  });

  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  w.print();
};
</script>

// Add m·ªõi
document.getElementById('btnAdd').onclick=()=>openEditModal(null);
document.getElementById('btnRefresh').onclick=loadData;

// Load l·∫ßn ƒë·∫ßu
loadData();
</script>
</body>
</html>
