<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Kiểm kê VH</title>
<style>
body{font-family:Arial,sans-serif;margin:20px;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #ccc;padding:5px;text-align:left;}
th{background:#eee;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);}
.modal-content{background:#fff;padding:20px;margin:50px auto;width:400px;position:relative;}
.close{position:absolute;top:5px;right:10px;cursor:pointer;}
button{padding:5px 10px;margin:2px;}
</style>
</head>
<body>

<h2>Kiểm kê VH</h2>
<button id="btnAdd">Thêm</button>
<table id="dataTable">
<thead>
<tr>
<th>ID</th><th>Số thẻ</th><th>Số máy</th><th>Hành động</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" id="modalClose">&times;</span>
    <h3>Chỉnh sửa / Thêm</h3>
    <input id="mId" type="hidden">
    <div>Số thẻ: <input id="mSoThe"></div>
    <div>Số máy: <input id="mSoMay"></div>
    <div>Loại máy: <input id="mLoaiMay"></div>
    <div>Vị trí: <input id="mViTri"></div>
    <div>Ghi chú: <input id="mGhiChu"></div>
    <div><button id="btnSave">Lưu</button></div>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev";

const modal = document.getElementById("modal");
const mId = document.getElementById("mId");
const mSoThe = document.getElementById("mSoThe");
const mSoMay = document.getElementById("mSoMay");
const mLoaiMay = document.getElementById("mLoaiMay");
const mViTri = document.getElementById("mViTri");
const mGhiChu = document.getElementById("mGhiChu");

function openModal(row) {
  modal.style.display = "block";
  if(row){
    mId.value = row.id;
    mSoThe.value = row.soThe||"";
    mSoMay.value = row.soMay||"";
    mLoaiMay.value = row.loaiMay||"";
    mViTri.value = row.viTri||"";
    mGhiChu.value = row.ghiChu||"";
  } else {
    mId.value="";
    mSoThe.value="";
    mSoMay.value="";
    mLoaiMay.value="";
    mViTri.value="";
    mGhiChu.value="";
  }
}

document.getElementById("modalClose").onclick = ()=> modal.style.display="none";
document.getElementById("btnAdd").onclick = ()=> openModal(null);

async function loadData(){
  try{
    const res = await fetch(WORKER_URL);
    const json = await res.json();
    if(json.success){
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML="";
      json.data.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.id}</td><td>${r.soThe||""}</td><td>${r.soMay||""}</td>
        <td>
          <button class="editBtn">Sửa</button>
        </td>`;
        tr.querySelector(".editBtn").onclick=()=> openModal(r);
        tbody.appendChild(tr);
      });
    } else alert("Lỗi load: "+json.error);
  }catch(err){
    alert("Lỗi khi load dữ liệu: "+err);
  }
}

document.getElementById("btnSave").onclick = async ()=>{
  const id = mId.value;
  const payload = {
    id: id||0,
    soThe:mSoThe.value,
    soMay:mSoMay.value,
    loaiMay:mLoaiMay.value,
    viTri:mViTri.value,
    ghiChu:mGhiChu.value
  };
  try{
    let res;
    if(id) res = await fetch(WORKER_URL+"/update",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    else res = await fetch(WORKER_URL+"/add",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const json = await res.json();
    if(json.success){
      modal.style.display="none";
      loadData();
    } else {
      alert("Lỗi lưu: "+json.error);
    }
  }catch(err){
    alert("Lỗi khi lưu: "+err);
  }
}

loadData();
</script>
</body>
</html>
