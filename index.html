<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y Viá»‡t Há»“ng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header {
  display: flex; justify-content: center; align-items: center;
  background: #0b74d1; color: #fff; padding: 16px 0;
  font-size: 24px; font-weight: bold; letter-spacing: 1px;
}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls select{padding:6px 8px;border:1px solid #ccc;border-radius:4px;}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap}
th{background:#0b74d1;color:#fff}
tr.highlight{background:#ffeaa7 !important}

/* Modal + card */
.modal {
  display: none;
  position: fixed;
  top: 10%; left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.4);
  z-index: 999;
  align-items: flex-start;
  justify-content: center;
  padding: 10px 0;
}
.modal .card {
  background: #fff;
  padding: 16px;
  border-radius: 8px;
  width: 360px;
  max-width: 95%;
  max-height: 90vh;
  overflow-y: auto;
}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* Responsive mobile */
@media(max-width:640px){
  .controls{flex-direction:column;align-items:stretch}
  .controls input[type="text"],.controls select{width:100%}
  .table-wrap{overflow-x:auto;}
  table th:nth-child(4), table td:nth-child(4),
  table th:nth-child(5), table td:nth-child(5){display:none;}
}
</style>
</head>
<body>
<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y Viá»‡t Há»“ng</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y" />
  <select id="filterBox">
    <option value="all">ğŸ“‹ Hiá»‡n táº¥t cáº£</option>
    <option value="daKiemKe">âœ… ÄÃ£ kiá»ƒm kÃª</option>
    <option value="chuaKiemKe">â¬œ ChÆ°a kiá»ƒm kÃª</option>
    <option value="daIn">ğŸ–¨ï¸ ÄÃ£ chá»n in</option>
    <option value="chuaIn">ğŸ“„ ChÆ°a chá»n in</option>
  </select>
  <button id="btnAdd">â• ThÃªm</button>
  <button id="btnSync">â˜ï¸ Äá»“ng bá»™ lÃªn Sheet</button>
  <button id="btnRefresh" class="ghost">ğŸ”„ Táº£i láº¡i tá»« Sheet</button>
  <button id="btnPrint">ğŸ–¨ï¸ In tem QR</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
</div>

<div class="note">TÃ¬m sá»‘ tháº» chá»‰ nháº­p sá»‘ khÃ´ng nháº­p VH- ,Checkbox ÄÃ£ KK tá»± lÆ°u, ngÃ y mua nháº­p dd/mm/yyyy</div>

<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>Sá»‘ tháº»</th>
        <th>Sá»‘ mÃ¡y</th>
        <th>Loáº¡i mÃ¡y</th>
        <th>Vá»‹ trÃ­</th>
        <th>Ghi chÃº</th>
        <th>HÃ nh Ä‘á»™ng</th>
        <th>ÄÃ£ KK<br><input type="checkbox" id="checkAllKiemKe"></th>
        <th>In QR<br><input type="checkbox" id="checkAllIn"></th>
        <th>NgÃ y mua</th>
        <th>NÆ¡i mua</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal add/edit -->
<div id="editModal" class="modal">
  <div class="card">
    <h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a</h3>
    <label>Sá»‘ tháº»</label><input id="m_soThe" />
    <label>Sá»‘ mÃ¡y</label><input id="m_soMay" />
    <label>Loáº¡i mÃ¡y</label><input id="m_loaiMay" />
    <label>Vá»‹ trÃ­</label><input id="m_viTri" />
    <label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
    <label>ÄÃ£ kiá»ƒm kÃª</label><input type="checkbox" id="m_daKiemKe" />
    <label>Chá»n Ä‘á»ƒ in</label><input type="checkbox" id="m_chonIn" />
    <label>NgÃ y mua</label><input id="m_ngayMua" type="text" placeholder="dd/MM/yyyy" />
    <label>NÆ¡i mua</label><input id="m_noiMua" /> 
    <div class="actions">
      <button id="cancelBtn" class="ghost">Há»§y</button>
      <button id="saveBtn">Cáº­p nháº­t</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbxu8JCK5WIXWvCEA7mWged_gtXkvxI7dw4K7yVpqOMfopqSVLx22QjEfLrmY3_YAQ3O/exec';

const statusEl=document.getElementById('status'), tbody=document.querySelector('#dataTable tbody');
const filterBox=document.getElementById('filterBox'), searchBox=document.getElementById('searchBox');
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe'), m_soMay=document.getElementById('m_soMay'),
      m_loaiMay=document.getElementById('m_loaiMay'), m_viTri=document.getElementById('m_viTri'),
      m_ghiChu=document.getElementById('m_ghiChu'), m_daKiemKe=document.getElementById('m_daKiemKe'),
      m_chonIn=document.getElementById('m_chonIn'), m_ngayMua=document.getElementById('m_ngayMua'),
      m_noiMua=document.getElementById('m_noiMua');

let allData=[], editingIndex=null;

function setStatus(txt,ok=true){statusEl.innerText='Tráº¡ng thÃ¡i: '+txt;statusEl.style.color=ok?'#0b74d1':'#c0392b';}
function safeText(v){return v==null?'':String(v);}

// ===== Helpers =====
function formatDateDDMMYYYY(d){
  if (!d) return "";
  if (d.includes("/")) return d;
  const date = new Date(d);
  if (isNaN(date)) return d;
  const day = String(date.getDate()).padStart(2,'0');
  const month = String(date.getMonth()+1).padStart(2,'0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

// Render table
function renderTable(){
  const filter = filterBox.value;
  const search = searchBox.value.toLowerCase();
  tbody.innerHTML = '';

  allData.forEach((r, idx) => {
    let show = true;
    if(filter==='daKiemKe'&&!r.daKiemKe) show=false;
    if(filter==='chuaKiemKe'&&r.daKiemKe) show=false;
    if(filter==='daIn'&&!r.chonIn) show=false;
    if(filter==='chuaIn'&&r.chonIn) show=false;
    if(search && !(r.soThe+r.soMay+r.loaiMay+r.viTri+r.ghiChu).toLowerCase().includes(search)) show=false;

    if(show){
      const tr=document.createElement('tr');
      tr.dataset.index=idx;
      tr.innerHTML=`
        <td>${idx+1}</td>
        <td>${safeText(r.soThe)}</td>
        <td>${safeText(r.soMay)}</td>
        <td>${safeText(r.loaiMay)}</td>
        <td>${safeText(r.viTri)}</td>
        <td>${safeText(r.ghiChu)}</td>
        <td>
          <button data-act="edit" data-i="${idx}">âœï¸</button>
          <button data-act="qr" data-i="${idx}">ğŸ”—</button>
        </td>
        <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
        <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
        <td>${r.ngayMua ? formatDateDDMMYYYY(r.ngayMua) : ''}</td>
        <td>${safeText(r.noiMua)}</td>
      `;
      tbody.appendChild(tr);
    }
  });
}

// Scroll + Highlight
function scrollToRow(idx){
  const tr=tbody.children[idx];
  if(!tr) return;
  const container=document.querySelector('.table-wrap');
  const trTop=tr.offsetTop;
  const trHeight=tr.offsetHeight;
  const containerHeight=container.clientHeight;
  container.scrollTo({top:trTop-containerHeight/2+trHeight/2, behavior:'smooth'});
}

function highlightFromHash(){
  const hash=decodeURIComponent(location.hash.slice(1)).trim().toLowerCase();
  Array.from(tbody.children).forEach(tr=>{
    const idx=Number(tr.dataset.index);
    const r=allData[idx];
    const soThe=r.soThe?String(r.soThe).trim().toLowerCase():'';
    if(soThe && soThe===hash){tr.classList.add('highlight'); scrollToRow(idx);}
    else tr.classList.remove('highlight');
  });
}
window.addEventListener('hashchange',highlightFromHash);

// Load JSONP
function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  const cb='__load_cb_'+Date.now();
  window[cb]=function(res){
    try{
      if(res && res.success && Array.isArray(res.data)){
        allData=res.data; 
        renderTable(); 
        setStatus('ÄÃ£ táº£i '+allData.length+' dÃ²ng'); 
        highlightFromHash();
      }else setStatus('Lá»—i táº£i dá»¯ liá»‡u',false);
    }finally{delete window[cb]; script.remove();}
  };
  const script=document.createElement('script');
  script.src=GAS_URL+'?callback='+cb+'&_='+Date.now();
  script.onerror=()=>{setStatus('Lá»—i táº£i dá»¯ liá»‡u',false); delete window[cb]; script.remove();};
  document.head.appendChild(script);
}

// In QR code Ä‘Ãºng link quÃ©t Ä‘iá»‡n thoáº¡i má»Ÿ
document.getElementById('btnPrint').onclick=()=>{
  const qrData = allData.filter(r=>r.chonIn).map(r=>r.soThe);
  if(!qrData.length){alert('ChÆ°a chá»n dÃ²ng in'); return;}
  const baseUrl=location.href.split('#')[0];
  let w=window.open('','_blank');
  w.document.write('<html><head><title>QR Code In</title><style>body{font-family:Arial;} .qrItem{display:inline-block;margin:10px;text-align:center;}</style></head><body>');
  qrData.forEach(code=>{
    const url=baseUrl+'#'+encodeURIComponent(code);
    w.document.write('<div class="qrItem"><div id="qr'+code+'"></div><div>'+code+'</div></div>');
  });
  w.document.write('</body></html>');
  w.document.close();
  qrData.forEach(code=>{
    const url=baseUrl+'#'+encodeURIComponent(code);
    new QRCode(w.document.getElementById('qr'+code), {text:url,width:120,height:120});
  });
};

// Event table
filterBox.addEventListener('change',renderTable);
searchBox.addEventListener('input',renderTable);
tbody.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const act=btn.dataset.act,i=Number(btn.dataset.i);
  if(act==='edit'){openEditModal(i);}
  if(act==='qr'){const url=location.href.split('#')[0]+'#'+encodeURIComponent(allData[i].soThe||''); prompt('Link QR (copy & in tem):',url);}
});
tbody.addEventListener('change', e=>{
  const tr = e.target.closest('tr'); if(!tr) return;
  const idx = Number(tr.dataset.index);
  if(e.target.classList.contains('daKiemKe')){ allData[idx].daKiemKe = e.target.checked; autoSyncRow(idx);}
  if(e.target.classList.contains('chonIn')){ allData[idx].chonIn = e.target.checked; autoSyncRow(idx);}
  renderTable();
});

// Modal add/edit
document.getElementById('btnAdd').onclick=()=>{
  editingIndex=null;
  m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value='';
  m_daKiemKe.checked=m_chonIn.checked=false; m_ngayMua.value=''; m_noiMua.value='';
  openEditModal(null);
};
document.getElementById('cancelBtn').onclick=()=>{modal.style.display='none'; editingIndex=null;};
document.getElementById('saveBtn').onclick = () => {
  let ngayMuaFormatted='';
  const inputVal=m_ngayMua.value.trim();
  if(inputVal){
    const parts=inputVal.split('/');
    if(parts.length===3){
      let dd=parts[0].padStart(2,'0'); let mm=parts[1].padStart(2,'0'); let yyyy=parts[2];
      if(isNaN(dd)||isNaN(mm)||isNaN(yyyy)){alert("NgÃ y mua khÃ´ng há»£p lá»‡ (dd/MM/yyyy)"); return m_ngayMua.focus();}
      ngayMuaFormatted=`${dd}/${mm}/${yyyy}`;
    }
  }
  const obj={soThe:m_soThe.value.trim(), soMay:m_soMay.value.trim(), loaiMay:m_loaiMay.value.trim(),
             viTri:m_viTri.value.trim(), ghiChu:m_ghiChu.value.trim(), daKiemKe:m_daKiemKe.checked,
             chonIn:m_chonIn.checked, ngayMua:ngayMuaFormatted, noiMua:m_noiMua.value.trim()};
  if(editingIndex===null){ allData.push(obj); editingIndex=allData.length-1; }
  else allData[editingIndex]=obj;
  renderTable();
  modal.style.display='none';
  autoSyncRow(editingIndex);
  editingIndex=null;
};

function openEditModal(idx){
  if(idx!==null){
    const r=allData[idx];
    m_soThe.value=r.soThe||''; m_soMay.value=r.soMay||''; m_loaiMay.value=r.loaiMay||''; m_viTri.value=r.viTri||'';
    m_ghiChu.value=r.ghiChu||''; m_daKiemKe.checked=r.daKiemKe||false; m_chonIn.checked=r.chonIn||false;
    m_ngayMua.value=r.ngayMua||''; m_noiMua.value=r.noiMua||''; editingIndex=idx;
  } else {
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value='';
    m_daKiemKe.checked=m_chonIn.checked=false; m_ngayMua.value=''; m_noiMua.value=''; editingIndex=null;
  }
  modal.style.display='flex';
}
modal.addEventListener('click', e=>{if(e.target===modal) modal.style.display='none';});

// Check all
document.getElementById("checkAllKiemKe")?.addEventListener("change",function(){
  const checked=this.checked;
  allData.forEach(r=>r.daKiemKe=checked); renderTable();
});
document.getElementById("checkAllIn")?.addEventListener("change",function(){
  const checked=this.checked;
  allData.forEach(r=>r.chonIn=checked); renderTable();
});

// AutoSync 1 dÃ²ng
function autoSyncRow(i){
  if(i==null||!allData[i]) return;
  const row=allData[i], encoded=encodeURIComponent(JSON.stringify(row));
  const cb='__auto_cb_'+Date.now();
  window[cb]=function(res){try{if(res&&res.success) setStatus('âœ… ÄÃ£ lÆ°u dÃ²ng '+(i+1)); else setStatus('âŒ Lá»—i lÆ°u dÃ²ng '+(i+1),false);}finally{delete window[cb]; script.remove();}};
  const script=document.createElement('script');
  script.src=GAS_URL+'?update=1&row='+(i+1)+'&data='+encoded+'&callback='+cb+'&_='+Date.now();
  script.onerror=()=>{console.warn('âš ï¸ AutoSync lá»—i máº¡ng'); delete window[cb]; script.remove(); };
  document.head.appendChild(script);
}

// Reload dá»¯ liá»‡u
document.getElementById('btnRefresh').onclick=loadData;
document.getElementById('btnSync').onclick=()=>{
  allData.forEach((r,i)=>autoSyncRow(i));
  setStatus('âœ… ÄÃ£ Ä‘á»“ng bá»™ toÃ n bá»™ dá»¯ liá»‡u');
};

// Load ban Ä‘áº§u
loadData();
</script>
</body>
</html>
