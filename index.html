<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n l√Ω Ki·ªÉm k√™ ‚Äì Cloudflare D1</title>
<style>
    body { font-family: Arial; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
    th { background: #eee; }
    button { padding: 6px 10px; }
    #modal { 
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center;
    }
    #modal-content {
        background: white; padding: 20px; width: 400px; border-radius: 5px;
    }
</style>
</head>
<body>

<h2>üìã Qu·∫£n l√Ω Ki·ªÉm k√™ M√°y</h2>
<button onclick="openModal()">+ Th√™m m·ªõi</button>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>S·ªë th·∫ª</th>
            <th>S·ªë m√°y</th>
            <th>Lo·∫°i m√°y</th>
            <th>V·ªã tr√≠</th>
            <th>Ghi ch√∫</th>
            <th>‚úî</th>
            <th>üìÑ</th>
            <th>S·ª≠a</th>
        </tr>
    </thead>
    <tbody id="data-body"></tbody>
</table>

<!-- MODAL -->
<div id="modal">
    <div id="modal-content">
        <h3 id="modal-title">Th√™m</h3>

        <input type="hidden" id="m-id">

        <label>S·ªë th·∫ª</label><br>
        <input id="m-soThe" style="width:100%"><br><br>

        <label>S·ªë m√°y</label><br>
        <input id="m-soMay" style="width:100%"><br><br>

        <label>Lo·∫°i m√°y</label><br>
        <input id="m-loaiMay" style="width:100%"><br><br>

        <label>V·ªã tr√≠</label><br>
        <input id="m-viTri" style="width:100%"><br><br>

        <label>Ghi ch√∫</label><br>
        <input id="m-ghiChu" style="width:100%"><br><br>

        <label><input type="checkbox" id="m-daKiemKe"> ƒê√£ ki·ªÉm k√™</label><br>
        <label><input type="checkbox" id="m-chonIn"> Ch·ªçn in l√Ω l·ªãch</label><br><br>

        <button onclick="save()">üíæ L∆∞u</button>
        <button onclick="closeModal()">ƒê√≥ng</button>
    </div>
</div>

<script>
const API_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev";  // <<< s·ª≠a URL t·∫°i ƒë√¢y

// ======================= LOAD DATA ==========================
async function loadData() {
    const res = await fetch(API_URL + "/", { method: "GET" });
    const js = await res.json();

    const tbody = document.getElementById("data-body");
    tbody.innerHTML = "";

    js.data.forEach(row => {
        tbody.innerHTML += `
        <tr>
            <td>${row.id}</td>
            <td>${row.soThe || ""}</td>
            <td>${row.soMay || ""}</td>
            <td>${row.loaiMay || ""}</td>
            <td>${row.viTri || ""}</td>
            <td>${row.ghiChu || ""}</td>
            <td>${row.daKiemKe ? "‚úî" : ""}</td>
            <td>${row.chonIn ? "üìÑ" : ""}</td>
            <td><button onclick="edit(${row.id})">S·ª≠a</button></td>
        </tr>`;
    });
}
loadData();

// ======================= MODAL CONTROL ==========================
function openModal(editing = false) {
    document.getElementById("modal").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
}

// ======================= EDIT ==========================
function edit(id) {
    fetch(API_URL + "/", { method: "GET" })
    .then(res => res.json())
    .then(js => {
        const r = js.data.find(x => x.id === id);
        if (!r) return;

        document.getElementById("m-id").value = r.id;
        document.getElementById("m-soThe").value = r.soThe || "";
        document.getElementById("m-soMay").value = r.soMay || "";
        document.getElementById("m-loaiMay").value = r.loaiMay || "";
        document.getElementById("m-viTri").value = r.viTri || "";
        document.getElementById("m-ghiChu").value = r.ghiChu || "";
        document.getElementById("m-daKiemKe").checked = !!r.daKiemKe;
        document.getElementById("m-chonIn").checked = !!r.chonIn;

        document.getElementById("modal-title").innerText = "S·ª≠a d·ªØ li·ªáu";
        openModal();
    });
}

// ======================= SAVE (ADD / UPDATE) ==========================
async function save() {
    const id = document.getElementById("m-id").value;

    // üöÄ G·ª≠i ƒë·ªß 18 field ƒë√∫ng worker.js
    const payload = {
        id: id ? Number(id) : undefined,
        soThe: document.getElementById("m-soThe").value || "",
        soMay: document.getElementById("m-soMay").value || "",
        loaiMay: document.getElementById("m-loaiMay").value || "",
        viTri: document.getElementById("m-viTri").value || "",
        ghiChu: document.getElementById("m-ghiChu").value || "",
        daKiemKe: document.getElementById("m-daKiemKe").checked,
        chonIn: document.getElementById("m-chonIn").checked,

        // C√°c tr∆∞·ªùng b·ªï sung b·∫Øt bu·ªôc ph·∫£i g·ª≠i ƒë√∫ng Worker.js
        bdQ1: false,
        bdNgayQ1: "",
        bdQ2: false,
        bdNgayQ2: "",
        bdQ3: false,
        bdNgayQ3: "",
        bdQ4: false,
        bdNgayQ4: "",

        ngayMua: "",
        noiMua: "",
        suaChua: ""
    };

    let url = API_URL + "/add";
    if (id) url = API_URL + "/update";

    const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const js = await res.json();
    if (js.success) {
        closeModal();
        loadData();
    } else {
        alert("L·ªói khi l∆∞u: " + js.error);
    }
}

</script>

</body>
</html>
