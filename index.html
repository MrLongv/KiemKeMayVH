<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type=text]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
th{background:#0b74d1;color:#fff}
tr.highlight{background: #ffeaa7 !important}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){ .controls{flex-direction:column;align-items:stretch} .controls input[type=text]{width:100%} }
</style>
</head>
<body>

<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may â€” QR + In tem + NgÃ y mua + Checkbox</header>

<div class="controls">
<input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y">
<button id="btnImport" class="ghost">ğŸ“‚ Nháº­p Excel</button>
<button id="btnExport">ğŸ’¾ Xuáº¥t Excel</button>
<button id="btnAdd">â• ThÃªm</button>
<button id="btnSync">â˜ï¸ Äá»“ng bá»™ Sheet</button>
<button id="btnRefresh" class="ghost">ğŸ”„ Táº£i láº¡i tá»« Sheet</button>
<button id="btnPrint">ğŸ–¨ï¸ In tem QR</button>
<span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
<input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none">
</div>

<div class="table-wrap">
<table id="dataTable">
<thead>
<tr>
<th>STT</th>
<th>Sá»‘ tháº»</th>
<th>Sá»‘ mÃ¡y</th>
<th>Loáº¡i mÃ¡y</th>
<th>Vá»‹ trÃ­</th>
<th>Ghi chÃº</th>
<th>ÄÃ£ kiá»ƒm kÃª</th>
<th>Chá»n Ä‘á»ƒ in</th>
<th>NgÃ y mua</th>
<th>HÃ nh Ä‘á»™ng</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
<div class="card">
<h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a / ThÃªm dÃ²ng</h3>
<label>Sá»‘ tháº»</label><input id="m_soThe">
<label>Sá»‘ mÃ¡y</label><input id="m_soMay">
<label>Loáº¡i mÃ¡y</label><input id="m_loaiMay">
<label>Vá»‹ trÃ­</label><input id="m_viTri">
<label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
<label>ÄÃ£ kiá»ƒm kÃª <input type="checkbox" id="m_daKiemKe"></label>
<label>Chá»n Ä‘á»ƒ in <input type="checkbox" id="m_chonIn"></label>
<label>NgÃ y mua</label><input type="date" id="m_ngayMua">
<div class="actions">
<button id="cancelBtn" class="ghost">Há»§y</button>
<button id="saveBtn">Cáº­p nháº­t</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzHjpqatFwhz9QFgFr4COI_dpadQhifZedOlqZDLuMtKG7Dj1aFOAjv9mO2q-pCH5DC/exec'; // <== Thay báº±ng URL deploy Web App
const DATA_JSON = 'data.json';

const statusEl = document.getElementById('status');
const tbody = document.querySelector('#dataTable tbody');
let allData=[],editingIndex=null;

function setStatus(text,ok=true){statusEl.innerText='Tráº¡ng thÃ¡i: '+text;statusEl.style.color=ok?'#0b74d1':'#c0392b';}
function safeText(v){return(v===null||v===undefined)?'':String(v);}
function dateToInput(v){return v?new Date(v).toISOString().substr(0,10):'';}
function inputToDate(v){return v?v:' ';}

async function loadData(){
setStatus('Äang táº£i dá»¯ liá»‡u...');
try{
const res=await fetch(GAS_URL);
if(!res.ok)throw new Error('GAS tráº£ lá»—i tráº¡ng thÃ¡i '+res.status);
const j=await res.json();
if(j&&j.success&&Array.isArray(j.data)){
allData=j.data.map(r=>({
soThe:safeText(r.soThe),
soMay:safeText(r.soMay),
loaiMay:safeText(r.loaiMay),
viTri:safeText(r.viTri),
ghiChu:safeText(r.ghiChu),
daKiemKe:!!r.daKiemKe,
chonIn:!!r.chonIn,
ngayMua:safeText(r.ngayMua)
}));
setStatus('ÄÃ£ táº£i tá»« Sheet ('+allData.length+' dÃ²ng)');
renderTable();
return;
}else{throw new Error('GAS tráº£ dá»¯ liá»‡u khÃ´ng há»£p lá»‡');}
}catch(err){console.warn('Load GAS tháº¥t báº¡i:',err);setStatus('Lá»—i táº£i dá»¯ liá»‡u',false);}
}

function renderTable(){
tbody.innerHTML='';
allData.forEach((r,idx)=>{
const tr=document.createElement('tr');
tr.dataset.index=idx;
tr.innerHTML=`<td>${idx+1}</td>
<td>${r.soThe}</td>
<td>${r.soMay}</td>
<td>${r.loaiMay}</td>
<td>${r.viTri}</td>
<td>${r.ghiChu}</td>
<td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
<td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
<td><input type="date" class="ngayMua" value="${dateToInput(r.ngayMua)}"></td>
<td><button data-act="edit" data-i="${idx}">âœï¸</button><button data-act="del" data-i="${idx}">ğŸ—‘ï¸</button><button data-act="qr" data-i="${idx}">ğŸ”—</button></td>`;
tbody.appendChild(tr);
});
}

// Event Table Buttons
tbody.addEventListener('click',ev=>{
const btn=ev.target.closest('button');if(!btn)return;
const act=btn.dataset.act;const i=Number(btn.dataset.i);
if(act==='edit')openEditModal(i);
else if(act==='del'){if(confirm('XÃ³a dÃ²ng '+allData[i].soThe+' ?')){allData.splice(i,1);renderTable();}}
else if(act==='qr'){const id=encodeURIComponent(allData[i].soThe);prompt('Link QR:',location.href.split('#')[0]+'#'+id);}
});

// Update checkbox & date on table change
tbody.addEventListener('change',ev=>{
const tr=ev.target.closest('tr');if(!tr)return;
const idx=Number(tr.dataset.index);
if(ev.target.classList.contains('daKiemKe'))allData[idx].daKiemKe=ev.target.checked;
else if(ev.target.classList.contains('chonIn'))allData[idx].chonIn=ev.target.checked;
else if(ev.target.classList.contains('ngayMua'))allData[idx].ngayMua=ev.target.value;
});

// Modal
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe');
const m_soMay=document.getElementById('m_soMay');
const m_loaiMay=document.getElementById('m_loaiMay');
const m_viTri=document.getElementById('m_viTri');
const m_ghiChu=document.getElementById('m_ghiChu');
const m_daKiemKe=document.getElementById('m_daKiemKe');
const m_chonIn=document.getElementById('m_chonIn');
const m_ngayMua=document.getElementById('m_ngayMua');
const cancelBtn=document.getElementById('cancelBtn');
const saveBtn=document.getElementById('saveBtn');

function openEditModal(index){
editingIndex=(typeof index==='number')?index:null;
if(editingIndex===null){m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value='';m_daKiemKe.checked=false;m_chonIn.checked=false;m_ngayMua.value='';}
else{
const r=allData[editingIndex];
m_soThe.value=r.soThe;m_soMay.value=r.soMay;m_loaiMay.value=r.loaiMay;m_viTri.value=r.viTri;m_ghiChu.value=r.ghiChu;m_daKiemKe.checked=r.daKiemKe;m_chonIn.checked=r.chonIn;m_ngayMua.value=dateToInput(r.ngayMua);
}
modal.style.display='flex';m_soThe.focus();
}
cancelBtn.onclick=()=>{modal.style.display='none';editingIndex=null;};
saveBtn.onclick=()=>{
const obj={
soThe:m_soThe.value.trim(),
soMay:m_soMay.value.trim(),
loaiMay:m_loaiMay.value.trim(),
viTri:m_viTri.value.trim(),
ghiChu:m_ghiChu.value.trim(),
daKiemKe:m_daKiemKe.checked,
chonIn:m_chonIn.checked,
ngayMua:m_ngayMua.value
};
if(!obj.soThe){alert('Sá»‘ tháº» khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');return;}
if(editingIndex===null)allData.push(obj);else allData[editingIndex]=obj;
modal.style.display='none';editingIndex=null;renderTable();
};

// Buttons
document.getElementById('btnAdd').addEventListener('click',()=>openEditModal(null));
document.getElementById('btnExport').addEventListener('click',exportExcel);
document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('btnRefresh').addEventListener('click',loadData);
document.getElementById('fileInput').addEventListener('change',e=>{
const f=e.target.files[0];if(!f)return;
const reader=new FileReader();
reader.onload=ev=>{
const data=new Uint8Array(ev.target.result);
const wb=XLSX.read(data,{type:'array'});
const sheet=wb.Sheets[wb.SheetNames[0]];
const arr=XLSX.utils.sheet_to_json(sheet);
allData=arr.map(r=>({
soThe:safeText(r.soThe||r['Sá»‘ tháº»']),
soMay:safeText(r.soMay||r['Sá»‘ mÃ¡y']),
loaiMay:safeText(r.loaiMay||r['Loáº¡i mÃ¡y']),
viTri:safeText(r.viTri||r['Vá»‹ trÃ­']),
ghiChu:safeText(r.ghiChu||r['Ghi chÃº']),
daKiemKe:!!r.daKiemKe,
chonIn:!!r.chonIn,
ngayMua:r.ngayMua||''
}));
renderTable();
};
reader.readAsArrayBuffer(f);
});

// Export Excel
function exportExcel(){
const ws=XLSX.utils.json_to_sheet(allData);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,'DanhSachMay');
XLSX.writeFile(wb,'DanhSachMay.xlsx');
}

// Sync to GAS
async function syncToSheet(){
setStatus('Äang Ä‘á»“ng bá»™ lÃªn Google Sheet...');
try{
const res=await fetch(GAS_URL,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify(allData)
});
const txt=await res.text();
let parsed=null;
try{parsed=txt?JSON.parse(txt):null}catch(e){parsed=null;}
if(!res.ok){setStatus('Äá»“ng bá»™ tháº¥t báº¡i (HTTP '+res.status+')',false);alert('Lá»—i khi Ä‘á»“ng bá»™. Server tráº£: '+txt);return;}
if(parsed&&parsed.success){setStatus('ÄÃ£ Ä‘á»“ng bá»™');alert('Äá»“ng bá»™ thÃ nh cÃ´ng!');setTimeout(()=>loadData(),700);}
else{setStatus('Server tráº£ vá» lá»—i',false);alert('Server tráº£ vá»: '+txt);}
}catch(err){console.error('sync error',err);setStatus('Lá»—i káº¿t ná»‘i',false);alert('KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i GAS: '+err.message);}
}
document.getElementById('btnSync').addEventListener('click',syncToSheet);

// Search
document.getElementById('searchBox').addEventListener('input',e=>{
const v=e.target.value.toLowerCase();
Array.from(tbody.children).forEach(tr=>{
const idx=Number(tr.dataset.index);const r=allData[idx];
tr.style.display=(r.soThe.toLowerCase().includes(v)||r.soMay.toLowerCase().includes(v))?'':'none';
});

// Print QR selected
document.getElementById('btnPrint').addEventListener('click',()=>{
const selected=allData.filter(r=>r.chonIn);
if(!selected.length){alert('ChÆ°a chá»n dÃ²ng nÃ o Ä‘á»ƒ in');return;}
const w=window.open('','_blank');
w.document.write('<html><head><title>In Tem QR</title></head><body>');
selected.forEach(r=>{
const div=`<div style="display:inline-block;width:180px;height:180px;margin:10px;text-align:center;border:1px solid #ccc;padding:6px">
<div id="qrcode-${r.soThe}"></div>
<p style="margin:4px 0;font-size:12px">${r.soThe}</p>
</div>`;
w.document.write(div);
});
w.document.write('</body></html>');
w.document.close();
selected.forEach(r=>{
new QRCode(w.document.getElementById('qrcode-'+r.soThe),{text:r.soThe,width:100,height:100});
});
});

// Initial load
loadData();
</script>

</body>
</html>
