<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may - Full Sync</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b74d1;color:#fff;padding:12px 16px;font-size:18px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:#fff;border-bottom:1px solid #e2e8f0}
.controls input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:220px}
.controls button{background:#0b74d1;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.controls button.ghost{background:#eee;color:#333}
.note{padding:8px 12px;color:#666;font-size:13px}
.table-wrap{padding:12px;overflow:auto}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:center;word-break:break-word}
th{background:#0b74d1;color:#fff}
tr.highlight{background: #ffeaa7 !important}
/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:999;align-items:center;justify-content:center}
.modal .card{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:95%}
.modal label{display:block;margin-top:8px;font-weight:600}
.modal input,.modal textarea{width:100%;padding:6px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:640px){.controls{flex-direction:column;align-items:stretch}.controls input[type="text"]{width:100%}}
</style>
</head>
<body>

<header>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may â€” Full Sync</header>

<div class="controls">
  <input id="searchBox" type="text" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» / sá»‘ mÃ¡y" />
  <button id="btnImport" class="ghost">ğŸ“‚ Nháº­p Excel</button>
  <button id="btnExport">ğŸ’¾ Xuáº¥t Excel</button>
  <button id="btnAdd">â• ThÃªm</button>
  <button id="btnSync">â˜ï¸ Äá»“ng bá»™ Sheet</button>
  <button id="btnRefresh" class="ghost">ğŸ”„ Táº£i tá»« Sheet</button>
  <button id="btnPrint">ğŸ–¨ï¸ In tem QR</button>
  <span id="status" style="margin-left:8px;color:#333;font-size:14px">Tráº¡ng thÃ¡i: offline</span>
  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />
</div>

<div class="note">
Ghi chÃº: checkbox "ÄÃ£ kiá»ƒm kÃª" vÃ  "Chá»n Ä‘á»ƒ in" sá»­ dá»¥ng trá»±c tiáº¿p trÃªn báº£ng. QR code há»— trá»£ in tem trá»±c tiáº¿p.
</div>

<div class="table-wrap">
<table id="dataTable">
<thead>
<tr>
<th>STT</th>
<th>Chá»n Ä‘á»ƒ in</th>
<th>ÄÃ£ kiá»ƒm kÃª</th>
<th>Sá»‘ tháº»</th>
<th>Sá»‘ mÃ¡y</th>
<th>Loáº¡i mÃ¡y</th>
<th>Vá»‹ trÃ­</th>
<th>NgÃ y mua</th>
<th>Ghi chÃº</th>
<th>HÃ nh Ä‘á»™ng</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
<div class="card">
<h3 style="margin:0 0 6px 0">âœï¸ Chá»‰nh sá»­a / ThÃªm dÃ²ng</h3>
<label>Sá»‘ tháº»</label><input id="m_soThe" />
<label>Sá»‘ mÃ¡y</label><input id="m_soMay" />
<label>Loáº¡i mÃ¡y</label><input id="m_loaiMay" />
<label>Vá»‹ trÃ­</label><input id="m_viTri" />
<label>NgÃ y mua</label><input id="m_ngayMua" type="date" />
<label>Ghi chÃº</label><textarea id="m_ghiChu" rows="3"></textarea>
<div class="actions">
  <button id="cancelBtn" class="ghost">Há»§y</button>
  <button id="saveBtn">Cáº­p nháº­t</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwRisn2nsNS-AZ1n-RCS0WRy-2dfbr5Ss8nzhbEsHXargw2xggvQbMZTUmvpUNRi4T0/exec'; // <== Thay URL Web App Ä‘Ã£ deploy
const statusEl = document.getElementById('status');
const tbody = document.querySelector('#dataTable tbody');
let allData=[], editingIndex=null;

// format date dd/mm/yyyy
function formatDate(d){ if(!d) return ''; const dt=new Date(d); return dt.getDate().toString().padStart(2,'0')+'/'+(dt.getMonth()+1).toString().padStart(2,'0')+'/'+dt.getFullYear(); }
function parseDateInput(d){ if(!d) return ''; return d; }

function setStatus(text,ok=true){statusEl.innerText='Tráº¡ng thÃ¡i: '+text; statusEl.style.color=ok?'#0b74d1':'#c0392b';}

async function loadData(){
  setStatus('Äang táº£i dá»¯ liá»‡u...');
  try {
    const res=await fetch(GAS_URL);
    if(!res.ok) throw new Error('GAS tráº£ lá»—i '+res.status);
    const j=await res.json();
    if(j && j.success && Array.isArray(j.data)){
      allData=j.data.map(r=>({soThe:r.soThe||'',soMay:r.soMay||'',loaiMay:r.loaiMay||'',viTri:r.viTri||'',ngayMua:formatDate(r.ngayMua),daKiemKe:r.daKiemKe||false,checked:false,ghiChu:r.ghiChu||''}));
      setStatus('ÄÃ£ táº£i tá»« Sheet ('+allData.length+' dÃ²ng)');
      renderTable(); return;
    } else throw new Error('Dá»¯ liá»‡u GAS khÃ´ng há»£p lá»‡');
  } catch(err){ console.error('Load GAS lá»—i',err); setStatus('KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u',false); allData=[]; renderTable();}
}

function renderTable(){
  tbody.innerHTML='';
  allData.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.dataset.index=idx;
    tr.innerHTML=`<td>${idx+1}</td>
<td><input type="checkbox" data-act="checkprint" ${r.checked?'checked':''}></td>
<td><input type="checkbox" data-act="daKiemKe" ${r.daKiemKe?'checked':''}></td>
<td>${r.soThe}</td>
<td>${r.soMay}</td>
<td>${r.loaiMay}</td>
<td>${r.viTri}</td>
<td>${r.ngayMua}</td>
<td>${r.ghiChu}</td>
<td>
  <button data-act="edit" data-i="${idx}">âœï¸</button>
  <button data-act="del" data-i="${idx}">ğŸ—‘ï¸</button>
  <button data-act="qr" data-i="${idx}">ğŸ”—</button>
</td>`;
    tbody.appendChild(tr);
  });
}

// Event table buttons
tbody.addEventListener('click',ev=>{
  const btn=ev.target.closest('button');
  const idx=Number(btn?.dataset.i);
  const act=btn?.dataset.act;
  if(!act) return;

  if(act==='edit') openEditModal(idx);
  else if(act==='del'){if(confirm('XÃ³a dÃ²ng '+allData[idx].soThe+'?')){allData.splice(idx,1);renderTable();}}
  else if(act==='qr'){const id=encodeURIComponent(allData[idx].soThe);prompt('Link QR:',location.href.split('#')[0]+'#'+id);}
});

// Checkbox update
tbody.addEventListener('change',ev=>{
  const cb=ev.target;
  const tr=cb.closest('tr');
  const idx=Number(tr.dataset.index);
  if(cb.dataset.act==='daKiemKe'){allData[idx].daKiemKe=cb.checked;}
  else if(cb.dataset.act==='checkprint'){allData[idx].checked=cb.checked;}
});

// Modal
const modal=document.getElementById('editModal');
const m_soThe=document.getElementById('m_soThe');
const m_soMay=document.getElementById('m_soMay');
const m_loaiMay=document.getElementById('m_loaiMay');
const m_viTri=document.getElementById('m_viTri');
const m_ngayMua=document.getElementById('m_ngayMua');
const m_ghiChu=document.getElementById('m_ghiChu');
const cancelBtn=document.getElementById('cancelBtn');
const saveBtn=document.getElementById('saveBtn');

function openEditModal(index){
  editingIndex=(typeof index==='number')?index:null;
  if(editingIndex===null){m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ngayMua.value=m_ghiChu.value='';}
  else{const r=allData[editingIndex];m_soThe.value=r.soThe;m_soMay.value=r.soMay;m_loaiMay.value=r.loaiMay;m_viTri.value=r.viTri;m_ngayMua.value=parseDateInput(r.ngayMua);m_ghiChu.value=r.ghiChu;}
  modal.style.display='flex';
  m_soThe.focus();
}
cancelBtn.onclick=()=>{modal.style.display='none';editingIndex=null;}
saveBtn.onclick=()=>{
  const obj={soThe:m_soThe.value.trim(),soMay:m_soMay.value.trim(),loaiMay:m_loaiMay.value.trim(),viTri:m_viTri.value.trim(),ngayMua:m_ngayMua.value,daKiemKe:false,checked:false,ghiChu:m_ghiChu.value.trim()};
  if(!obj.soThe){alert('Sá»‘ tháº» khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');return;}
  if(editingIndex===null){allData.push(obj);}else{allData[editingIndex]=obj;}
  modal.style.display='none';editingIndex=null;renderTable();
}

// Buttons
document.getElementById('btnAdd').addEventListener('click',()=>openEditModal(null));
document.getElementById('btnRefresh').addEventListener('click',loadData);
document.getElementById('btnExport').addEventListener('click',()=>{const ws=XLSX.utils.json_to_sheet(allData);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'DanhSachMay');XLSX.writeFile(wb,'DanhSachMay.xlsx');});
document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    allData=sheet.map(r=>({soThe:r.soThe||r['Sá»‘ tháº»']||'',soMay:r.soMay||r['Sá»‘ mÃ¡y']||'',loaiMay:r.loaiMay||r['Loáº¡i mÃ¡y']||'',viTri:r.viTri||r['Vá»‹ trÃ­']||'',ngayMua:formatDate(r.ngayMua||r['NgÃ y mua']),daKiemKe:false,checked:false,ghiChu:r.ghiChu||r['Ghi chÃº']||''}));
    renderTable();
  };
  reader.readAsArrayBuffer(f);
});

// Sync
async function syncToSheet(){
  setStatus('Äang Ä‘á»“ng bá»™...');
  try{
    const res=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(allData)});
    if(!res) throw new Error('Server khÃ´ng pháº£n há»“i');
    const txt=await res.text();
    let parsed; try{parsed=txt?JSON.parse(txt):null;}catch(e){parsed=null;}
    if(parsed && parsed.success){setStatus('ÄÃ£ Ä‘á»“ng bá»™ '+(parsed.written||allData.length)+' dÃ²ng');alert('Äá»“ng bá»™ thÃ nh cÃ´ng!');setTimeout(()=>loadData(),500);}
    else{setStatus('Server tráº£ lá»—i',false);alert('Server tráº£: '+txt);}
  }catch(err){console.error('sync error',err);setStatus('Lá»—i káº¿t ná»‘i',false);alert('KhÃ´ng thá»ƒ káº¿t ná»‘i: '+err.message);}
}
document.getElementById('btnSync').addEventListener('click',syncToSheet);

// Print QR tem
document.getElementById('btnPrint').addEventListener('click',()=>{
  const printData=allData.filter(r=>r.checked);
  if(printData.length===0){alert('Chá»n Ã­t nháº¥t 1 dÃ²ng Ä‘á»ƒ in');return;}
  const w=window.open('','_blank');
  w.document.write('<html><head><title>In tem QR</title></head><body>');
  w.document.write('<h3>In tem QR</h3>');
  printData.forEach(r=>{
    const div=document.createElement('div');div.style.border='1px solid #000';div.style.display='inline-block';div.style.padding='10px';div.style.margin='5px';div.style.width='180px';div.innerHTML=`<strong>${r.soThe}</strong><br>${r.soMay}<br>${r.loaiMay}<br>${r.viTri}<br>${r.ngayMua}<div id="qrcode"></div>`;
    w.document.body.appendChild(div);
    new QRCode(div.querySelector('#qrcode'),{text:r.soThe,width:100,height:100});
  });
  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  w.print();
});
loadData();
</script>
</body>
</html>
