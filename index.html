<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìã Ki·ªÉm k√™ VH</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8}
header{padding:10px 20px;background:#fff;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
button{padding:6px 12px;margin:2px;font-size:14px;cursor:pointer}
table{border-collapse:collapse;width:100%;margin-top:10px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#eee}
.highlight-row{background:#ffff99 !important}
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
.modal{background:#fff;padding:20px;border-radius:8px;width:400px;max-width:95%}
.modal input, .modal textarea{width:100%;margin:4px 0;padding:4px;font-size:14px}
.close-modal{position:absolute;right:10px;top:10px;cursor:pointer;font-weight:bold}
.checkbox-group{display:flex;gap:5px;justify-content:center}
</style>
</head>
<body>
<header>
  <div>üìã Ki·ªÉm k√™ VH</div>
  <div>
    <button id="btnAdd">Th√™m</button>
    <button id="btnPrint">In QR</button>
    <button id="btnPrintLyLich">In L√Ω L·ªãch</button>
  </div>
</header>

<div style="padding:10px;">
  <label><input type="checkbox" id="checkAllKK"> ƒê√£ KK</label>
  <label><input type="checkbox" id="checkAllQR"> In QR</label>
  <label><input type="checkbox" id="checkAllQ1"> Q1</label>
  <label><input type="checkbox" id="checkAllQ2"> Q2</label>
  <label><input type="checkbox" id="checkAllQ3"> Q3</label>
  <label><input type="checkbox" id="checkAllQ4"> Q4</label>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th><th>S·ªë th·∫ª</th><th>S·ªë m√°y</th><th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="close-modal" id="closeModal">√ó</div>
    <h3>Th√™m / S·ª≠a</h3>
    <input type="hidden" id="modalId">
    <input placeholder="S·ªë th·∫ª" id="m_soThe">
    <input placeholder="S·ªë m√°y" id="m_soMay">
    <input placeholder="Lo·∫°i m√°y" id="m_loaiMay">
    <input placeholder="V·ªã tr√≠" id="m_viTri">
    <textarea placeholder="Ghi ch√∫" id="m_ghiChu"></textarea>
    <label><input type="checkbox" id="m_daKiemKe"> ƒê√£ ki·ªÉm k√™</label>
    <label><input type="checkbox" id="m_chonIn"> In QR</label>
    <div class="checkbox-group">
      <label><input type="checkbox" id="m_bdQ1"> Q1</label>
      <label><input type="checkbox" id="m_bdQ2"> Q2</label>
      <label><input type="checkbox" id="m_bdQ3"> Q3</label>
      <label><input type="checkbox" id="m_bdQ4"> Q4</label>
    </div>
    <input placeholder="Ng√†y mua" id="m_ngayMua">
    <input placeholder="N∆°i mua" id="m_noiMua">
    <input placeholder="S·ª≠a ch·ªØa" id="m_suaChua">
    <button id="btnSave">L∆∞u</button>
  </div>
</div>

<script>
const WORKER_URL = 'https://snowy-surf-e985.hoalangiongxoai.workers.dev';
let allData = [];

const modalBg = document.getElementById('modalBg');
const modalId = document.getElementById('modalId');
const m_soThe = document.getElementById('m_soThe');
const m_soMay = document.getElementById('m_soMay');
const m_loaiMay = document.getElementById('m_loaiMay');
const m_viTri = document.getElementById('m_viTri');
const m_ghiChu = document.getElementById('m_ghiChu');
const m_daKiemKe = document.getElementById('m_daKiemKe');
const m_chonIn = document.getElementById('m_chonIn');
const m_bdQ1 = document.getElementById('m_bdQ1');
const m_bdQ2 = document.getElementById('m_bdQ2');
const m_bdQ3 = document.getElementById('m_bdQ3');
const m_bdQ4 = document.getElementById('m_bdQ4');
const m_ngayMua = document.getElementById('m_ngayMua');
const m_noiMua = document.getElementById('m_noiMua');
const m_suaChua = document.getElementById('m_suaChua');

document.getElementById('btnAdd').onclick = () => openModal();
document.getElementById('closeModal').onclick = () => closeModal();

function openModal(data=null){
  modalBg.style.display='flex';
  if(data){
    modalId.value = data.id||'';
    m_soThe.value = data.soThe||'';
    m_soMay.value = data.soMay||'';
    m_loaiMay.value = data.loaiMay||'';
    m_viTri.value = data.viTri||'';
    m_ghiChu.value = data.ghiChu||'';
    m_daKiemKe.checked = data.daKiemKe?true:false;
    m_chonIn.checked = data.chonIn?true:false;
    m_bdQ1.checked = data.bdQ1?true:false;
    m_bdQ2.checked = data.bdQ2?true:false;
    m_bdQ3.checked = data.bdQ3?true:false;
    m_bdQ4.checked = data.bdQ4?true:false;
    m_ngayMua.value = data.ngayMua||'';
    m_noiMua.value = data.noiMua||'';
    m_suaChua.value = data.suaChua||'';
  } else {
    modalId.value='';
    m_soThe.value=''; m_soMay.value=''; m_loaiMay.value=''; m_viTri.value='';
    m_ghiChu.value=''; m_daKiemKe.checked=false; m_chonIn.checked=false;
    m_bdQ1.checked=false; m_bdQ2.checked=false; m_bdQ3.checked=false; m_bdQ4.checked=false;
    m_ngayMua.value=''; m_noiMua.value=''; m_suaChua.value='';
  }
}

function closeModal(){ modalBg.style.display='none'; }

async function loadData(){
  try{
    const res = await fetch(WORKER_URL);
    const data = await res.json();
    if(data.success){
      allData = data.data;
      renderTable();
    }else{
      alert('L·ªói khi load d·ªØ li·ªáu: '+data.error);
    }
  }catch(err){ console.error(err); alert('L·ªói khi load d·ªØ li·ªáu'); }
}

function renderTable(){
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML='';
  allData.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.soThe||''}</td>
      <td>${r.soMay||''}</td>
      <td>
        <button onclick="openModal(allData[${idx}])">S·ª≠a</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById('btnSave').onclick = async ()=>{
  try{
    const id = modalId.value;
    const payload = {
      id:id||undefined,
      soThe:m_soThe.value,
      soMay:m_soMay.value,
      loaiMay:m_loaiMay.value,
      viTri:m_viTri.value,
      ghiChu:m_ghiChu.value,
      daKiemKe:m_daKiemKe.checked,
      chonIn:m_chonIn.checked,
      bdQ1:m_bdQ1.checked,
      bdQ2:m_bdQ2.checked,
      bdQ3:m_bdQ3.checked,
      bdQ4:m_bdQ4.checked,
      ngayMua:m_ngayMua.value,
      noiMua:m_noiMua.value,
      suaChua:m_suaChua.value
    };
    let url = WORKER_URL+'/add';
    if(id) url = WORKER_URL+'/update';
    const res = await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      alert('L∆∞u th√†nh c√¥ng');
      closeModal();
      loadData();
    }else{
      alert('L·ªói khi l∆∞u: '+data.error);
    }
  }catch(err){ console.error(err); alert('L·ªói khi l∆∞u: '+err); }
}

// Check/Uncheck to√†n b·ªô
['KK','QR','Q1','Q2','Q3','Q4'].forEach(code=>{
  const el = document.getElementById('checkAll'+code);
  if(el) el.addEventListener('change', function(){
    const cls = {'KK':'daKiemKe','QR':'chonIn','Q1':'bdQ1','Q2':'bdQ2','Q3':'bdQ3','Q4':'bdQ4'}[code];
    document.querySelectorAll(`.${cls}`).forEach(cb=>{
      const idx = Number(cb.closest('tr').dataset.index);
      allData[idx][cls] = this.checked;
      updateRow(allData[idx]);
    });
  });
});

async function updateRow(row){
  try{
    const res = await fetch(WORKER_URL+'/update',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(row)
    });
    const data = await res.json();
    if(!data.success) console.error('Update l·ªói:',data.error);
  }catch(err){ console.error(err); }
}

// --- In QR ---
document.getElementById('btnPrint').onclick = ()=>{
  const printData = allData.filter(r=>r.chonIn);
  if(printData.length===0){ alert('Ch·ªçn √≠t nh·∫•t 1 d√≤ng ƒë·ªÉ in'); return; }
  const w = window.open('','_blank');
  w.document.write('<html><head><title>In Tem QR</title>');
  w.document.write('<style>@page{size:A4;margin:5mm;}body{display:grid;grid-template-columns:repeat(5,1fr);gap:2mm;justify-items:center;align-items:center;font-family:Arial;}'+
  '.tem{width:32mm;height:34mm;border:0.1px solid #000;border-radius:0.2px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:0.1mm;text-align:center;page-break-inside:avoid;}'+
  '.tem .top{font-weight:bold;font-size:12px;margin:0.2mm 0;}.tem .qr{margin:0;padding:0;line-height:0;}.tem .bottom{font-weight:bold;font-size:12px;margin:0.2mm 0 0.1mm 0;}canvas{display:block;margin:0;width:76px !important;height:76px !important;}</style></head><body>');
  printData.forEach(r=>{
    const code = encodeURIComponent(r.soThe||'');
    const soThe = r.soThe||''; const soMay = r.soMay||'';
    w.document.write(`<div class="tem"><div class="top">VH-${soThe}</div><div class="qr" id="qr_${code}"></div><div class="bottom">SM: ${soMay}</div></div>`);
  });
  w.document.write('</body></html>');
  w.document.close();
  w.onload = ()=>{
    printData.forEach(r=>{
      const code = encodeURIComponent(r.soThe||'');
      const qrDiv = w.document.getElementById('qr_'+code);
      if(qrDiv){
        new QRCode(qrDiv,{text:location.href.split('#')[0]+'#'+code,width:90,height:90});
      }
    });
    setTimeout(()=>{w.focus();w.print();},500);
  };
};

// --- In L√Ω l·ªãch ---
document.getElementById('btnPrintLyLich').onclick = ()=>{
  const input = prompt("Nh·∫≠p s·ªë th·∫ª ho·∫∑c g√µ 'all' ƒë·ªÉ in to√†n b·ªô").trim();
  if(!input) return;
  let listSoThe = [];
  if(input.toLowerCase()==='all') listSoThe = allData.map(r=>r.soThe);
  else listSoThe = input.split(',').map(s=>s.trim()).filter(s=>s);
  const w = window.open('','_blank');
  const baseURL = location.href.split('#')[0];
  w.document.write('<html><head><title>In L√Ω L·ªãch</title><style>body{font-family:Arial;margin:20px;color:#333;}'+
  '.header-logo div{font-size:20px;font-weight:bold;line-height:1.2;}h2{text-align:center;font-size:22px;border-bottom:2px solid #333;padding-bottom:8px;margin-bottom:10px;}'+
  'table{border-collapse:collapse;width:100%;margin-top:10px;}th,td{border:1px solid #ccc;padding:8px;}th{background:#eee;width:30%;}.page-break{page-break-after:always;}'+
  '.sign-box{margin-top:10px;text-align:right;font-size:16px;line-height:1.5;}.sign1{margin-right:30px;}.sign2{margin-right:60px;}</style></head><body>');
  listSoThe.forEach((soThe,idx)=>{
    const row = allData.find(r=>r.soThe==soThe);
    if(!row){ w.document.write(`<h3 style="color:red">‚ö† Kh√¥ng t√¨m th·∫•y s·ªë th·∫ª: ${soThe}</h3><div class="page-break"></div>`); return; }
    const qrDiv = document.createElement('div'); new QRCode(qrDiv,{text:baseURL+'#'+encodeURIComponent(soThe),width:100,height:100});
    const qrImg = qrDiv.querySelector('img')?.src || qrDiv.querySelector('canvas')?.toDataURL();
    w.document.write(`<div class="header-logo"><div style="margin-left:0px;">C√îNG TY TNHH MAY XK</div><div style="margin-left:55px;">VI·ªÜT H·ªíNG</div></div>`);
    w.document.write(`<div style="position:relative;margin-bottom:40px;"><div style="position:absolute;left:60px;top:0;"><img src="${qrImg}" style="width:100px;height:100px;"></div><div style="text-align:center;font-size:20px;font-weight:bold;padding-top:60px;">L√ù L·ªäCH M√ÅY VH-${soThe}</div></div>`);
    const fields = [['S·ªë th·∫ª',row.soThe],['S·ªë m√°y',row.soMay],['Lo·∫°i m√°y',row.loaiMay],['V·ªã tr√≠',row.viTri],['Ghi ch√∫',row.ghiChu],['ƒê√£ ki·ªÉm k√™',row.daKiemKe?'‚úÖ':'‚ùå'],['In QR',row.chonIn?'‚úÖ':'‚ùå'],['Ng√†y mua',row.ngayMua],['N∆°i mua',row.noiMua],['B·∫£o d∆∞·ª°ng Q1',row.bdQ1?'‚úÖ '+row.bdNgayQ1:''],['B·∫£o d∆∞·ª°ng Q2',row.bdQ2?'‚úÖ '+row.bdNgayQ2:''],['B·∫£o d∆∞·ª°ng Q3',row.bdQ3?'‚úÖ '+row.bdNgayQ3:''],['B·∫£o d∆∞·ª°ng Q4',row.bdQ4?'‚úÖ '+row.bdNgayQ4:''],['S·ª≠a ch·ªØa',row.suaChua]];
    w.document.write('<table>'); fields.forEach(f=>{w.document.write(`<tr><th>${f[0]}</th><td>${f[1]}</td></tr>`);}); w.document.write('</table>');
    w.document.write('<div class="sign-box"><div class="sign1" style="margin-right:1px;">Vƒ©nh Long, ng√†y ..... th√°ng ..... nƒÉm .....</div><div class="sign2" style="margin-right:105px;">Ng∆∞·ªùi l·∫≠p</div></div>');
    if(idx<listSoThe.length-1) w.document.write('<div class="page-break"></div>');
  });
  w.document.write('</body></html>'); w.document.close(); w.focus(); w.print();
};

// --- Init ---
loadData();
</script>
</body>
</html>
