<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body { font-family: Arial,sans-serif; margin:0; background:#f4f6f8; }
header { padding:10px 20px; background:#fff; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
header h1 { margin:0; font-size:20px; }
button { padding:5px 10px; margin:0 2px; cursor:pointer; }
table { border-collapse: collapse; width:100%; margin-top:10px; background:#fff; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; font-size:13px; }
th { background:#eee; }
.highlight-row { background:#fffae6 !important; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:15px; width:350px; border-radius:5px; max-height:90%; overflow-y:auto; position:relative; }
.modal-content h2 { margin-top:0; }
.modal-content label { display:block; margin:5px 0 2px; font-weight:bold; }
.modal-content input, .modal-content textarea { width:100%; padding:4px; margin-bottom:5px; }
.modal-close { position:absolute; top:5px; right:10px; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>üìã Ki·ªÉm k√™ m√°y Vi·ªát H·ªìng</h1>
  <div>
    <button id="btnAdd">Th√™m m·ªõi</button>
    <button id="btnRefresh">Load l·∫°i</button>
    <button id="btnPrint">In QR</button>
    <button id="btnPrintLyLich">In L√Ω L·ªãch</button>
    <input type="text" id="soThePrint" placeholder="S·ªë th·∫ª / all" style="width:80px">
  </div>
</header>

<div style="padding:10px;">
  <table id="dataTable">
    <thead>
      <tr>
        <th>#</th>
        <th>S·ªë th·∫ª</th>
        <th>S·ªë m√°y</th>
        <th>Lo·∫°i m√°y</th>
        <th>V·ªã tr√≠</th>
        <th>Ghi ch√∫</th>
        <th>ƒê√£ KK <input type="checkbox" id="checkAllKK"></th>
        <th>In QR <input type="checkbox" id="checkAllQR"></th>
        <th>Q1 <input type="checkbox" id="checkAllQ1"></th>
        <th>Q2 <input type="checkbox" id="checkAllQ2"></th>
        <th>Q3 <input type="checkbox" id="checkAllQ3"></th>
        <th>Q4 <input type="checkbox" id="checkAllQ4"></th>
        <th>S·ª≠a</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="modal-close" id="modalClose">&times;</span>
    <h2>Ch·ªânh s·ª≠a / Th√™m m√°y</h2>
    <label>S·ªë th·∫ª</label><input id="m_soThe">
    <label>S·ªë m√°y</label><input id="m_soMay">
    <label>Lo·∫°i m√°y</label><input id="m_loaiMay">
    <label>V·ªã tr√≠</label><input id="m_viTri">
    <label>Ghi ch√∫</label><textarea id="m_ghiChu"></textarea>
    <label>ƒê√£ ki·ªÉm k√™</label><input type="checkbox" id="m_daKiemKe">
    <label>In QR</label><input type="checkbox" id="m_chonIn">
    <label>B·∫£o d∆∞·ª°ng Q1</label><input type="checkbox" id="m_bdQ1"><input type="date" id="m_bdNgayQ1">
    <label>B·∫£o d∆∞·ª°ng Q2</label><input type="checkbox" id="m_bdQ2"><input type="date" id="m_bdNgayQ2">
    <label>B·∫£o d∆∞·ª°ng Q3</label><input type="checkbox" id="m_bdQ3"><input type="date" id="m_bdNgayQ3">
    <label>B·∫£o d∆∞·ª°ng Q4</label><input type="checkbox" id="m_bdQ4"><input type="date" id="m_bdNgayQ4">
    <label>S·ª≠a ch·ªØa</label><input id="m_suaChua">
    <div style="margin-top:10px; text-align:right;">
      <button id="modalSave">L∆∞u</button>
      <button id="modalCancel">H·ªßy</button>
    </div>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev/";
let allData = [], editingIndex = null;

// Fetch d·ªØ li·ªáu t·ª´ Worker
async function loadData() {
  try {
    const res = await fetch(WORKER_URL);
    allData = await res.json();
    renderTable();
    highlightFromHash();
  } catch(err) {
    alert("L·ªói load d·ªØ li·ªáu: "+err);
  }
}

// Render table
function renderTable() {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";
  allData.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.index = idx;
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td class="col-so-the">${r.soThe||''}</td>
      <td>${r.soMay||''}</td>
      <td>${r.loaiMay||''}</td>
      <td>${r.viTri||''}</td>
      <td>${r.ghiChu||''}</td>
      <td><input type="checkbox" class="daKiemKe" ${r.daKiemKe?'checked':''}></td>
      <td><input type="checkbox" class="chonIn" ${r.chonIn?'checked':''}></td>
      <td><input type="checkbox" class="bdQ1" ${r.bdQ1?'checked':''}></td>
      <td><input type="checkbox" class="bdQ2" ${r.bdQ2?'checked':''}></td>
      <td><input type="checkbox" class="bdQ3" ${r.bdQ3?'checked':''}></td>
      <td><input type="checkbox" class="bdQ4" ${r.bdQ4?'checked':''}></td>
      <td><button class="editBtn">S·ª≠a</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Checkbox change
  document.querySelectorAll(".daKiemKe").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].daKiemKe = cb.checked;
    };
  });
  document.querySelectorAll(".chonIn").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].chonIn = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ1").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ1 = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ2").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ2 = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ3").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ3 = cb.checked;
    };
  });
  document.querySelectorAll(".bdQ4").forEach(cb=>{
    cb.onchange = e=>{
      const idx = Number(cb.closest("tr").dataset.index);
      allData[idx].bdQ4 = cb.checked;
    };
  });

  // Edit button
  document.querySelectorAll(".editBtn").forEach(btn=>{
    btn.onclick = ()=>{
      editingIndex = Number(btn.closest("tr").dataset.index);
      openEditModal(editingIndex);
    };
  });
}

// Modal
const modal = document.getElementById("editModal");
const modalClose = document.getElementById("modalClose");
const modalCancel = document.getElementById("modalCancel");
const modalSave = document.getElementById("modalSave");
const m_soThe = document.getElementById("m_soThe");
const m_soMay = document.getElementById("m_soMay");
const m_loaiMay = document.getElementById("m_loaiMay");
const m_viTri = document.getElementById("m_viTri");
const m_ghiChu = document.getElementById("m_ghiChu");
const m_daKiemKe = document.getElementById("m_daKiemKe");
const m_chonIn = document.getElementById("m_chonIn");
const m_bdQ1 = document.getElementById("m_bdQ1");
const m_bdQ2 = document.getElementById("m_bdQ2");
const m_bdQ3 = document.getElementById("m_bdQ3");
const m_bdQ4 = document.getElementById("m_bdQ4");
const m_bdNgayQ1 = document.getElementById("m_bdNgayQ1");
const m_bdNgayQ2 = document.getElementById("m_bdNgayQ2");
const m_bdNgayQ3 = document.getElementById("m_bdNgayQ3");
const m_bdNgayQ4 = document.getElementById("m_bdNgayQ4");
const m_suaChua = document.getElementById("m_suaChua");

function openEditModal(idx){
  modal.style.display="flex";
  if(idx!==null){
    const r = allData[idx];
    m_soThe.value=r.soThe||'';
    m_soMay.value=r.soMay||'';
    m_loaiMay.value=r.loaiMay||'';
    m_viTri.value=r.viTri||'';
    m_ghiChu.value=r.ghiChu||'';
    m_daKiemKe.checked=r.daKiemKe||false;
    m_chonIn.checked=r.chonIn||false;
    m_bdQ1.checked=r.bdQ1||false;
    m_bdQ2.checked=r.bdQ2||false;
    m_bdQ3.checked=r.bdQ3||false;
    m_bdQ4.checked=r.bdQ4||false;
    m_bdNgayQ1.value=r.bdNgayQ1||'';
    m_bdNgayQ2.value=r.bdNgayQ2||'';
    m_bdNgayQ3.value=r.bdNgayQ3||'';
    m_bdNgayQ4.value=r.bdNgayQ4||'';
    m_suaChua.value=r.suaChua||'';
  } else {
    m_soThe.value=""; m_soMay.value=""; m_loaiMay.value=""; m_viTri.value=""; m_ghiChu.value="";
    m_daKiemKe.checked=false; m_chonIn.checked=false;
    m_bdQ1.checked=false; m_bdQ2.checked=false; m_bdQ3.checked=false; m_bdQ4.checked=false;
    m_bdNgayQ1.value=""; m_bdNgayQ2.value=""; m_bdNgayQ3.value=""; m_bdNgayQ4.value="";
    m_suaChua.value="";
  }
}

modalClose.onclick = modalCancel.onclick = ()=>{ modal.style.display="none"; }

modalSave.onclick = ()=>{
  const obj = {
    soThe: m_soThe.value.trim(),
    soMay: m_soMay.value.trim(),
    loaiMay: m_loaiMay.value.trim(),
    viTri: m_viTri.value.trim(),
    ghiChu: m_ghiChu.value.trim(),
    daKiemKe: m_daKiemKe.checked,
    chonIn: m_chonIn.checked,
    bdQ1: m_bdQ1.checked,
    bdQ2: m_bdQ2.checked,
    bdQ3: m_bdQ3.checked,
    bdQ4: m_bdQ4.checked,
    bdNgayQ1: m_bdNgayQ1.value,
    bdNgayQ2: m_bdNgayQ2.value,
    bdNgayQ3: m_bdNgayQ3.value,
    bdNgayQ4: m_bdNgayQ4.value,
    suaChua: m_suaChua.value
  };
  if(editingIndex!==null) allData[editingIndex] = obj;
  else allData.push(obj);
  renderTable();
  modal.style.display="none";
};

// Check/uncheck t·∫•t c·∫£
document.getElementById("checkAllKK").onchange = function(){
  document.querySelectorAll(".daKiemKe").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQR").onchange = function(){
  document.querySelectorAll(".chonIn").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ1").onchange = function(){
  document.querySelectorAll(".bdQ1").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ2").onchange = function(){
  document.querySelectorAll(".bdQ2").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ3").onchange = function(){
  document.querySelectorAll(".bdQ3").forEach(cb=>cb.checked=this.checked);
};
document.getElementById("checkAllQ4").onchange = function(){
  document.querySelectorAll(".bdQ4").forEach(cb=>cb.checked=this.checked);
};

// Scroll & highlight t·ª´ hash
let hashScrollDone=false;
function highlightFromHash(retry=40){
  const code=location.hash.slice(1);
  if(!code) return;
  const rows=document.querySelectorAll("#dataTable tbody tr");
  let found=false;
  rows.forEach(row=>{
    const soTheCell=row.querySelector(".col-so-the");
    if(!soTheCell) return;
    if(soTheCell.textContent.trim()===code){
      row.classList.add("highlight-row");
      if(!hashScrollDone){ row.scrollIntoView({behavior:"smooth", block:"center"}); hashScrollDone=true; }
      found=true;
    }
  });
  if(!found && retry>0) setTimeout(()=>highlightFromHash(retry-1),150);
}
window.addEventListener("hashchange",()=>{ hashScrollDone=false; setTimeout(()=>highlightFromHash(),100); });

// N√∫t in QR & l√Ω l·ªãch (gi·ªØ nguy√™n nh∆∞ code n√¢ng c·∫•p)
document.getElementById('btnPrint').onclick = function(){ /* ...code in QR nh∆∞ tr√™n... */ };
document.getElementById('btnPrintLyLich').onclick = function(){ /* ...code in l√Ω l·ªãch nh∆∞ tr√™n... */ };

// Add m·ªõi
document.getElementById('btnAdd').onclick=()=>openEditModal(null);
document.getElementById('btnRefresh').onclick=loadData;

// Load l·∫ßn ƒë·∫ßu
loadData();
</script>
</body>
</html>
