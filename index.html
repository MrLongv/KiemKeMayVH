<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“‹ Kiá»ƒm kÃª mÃ¡y may</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 0;
}
header {
  background: #0078d7;
  color: white;
  padding: 10px;
  text-align: center;
  font-size: 20px;
}
#controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  padding: 10px;
  background: #fff;
  border-bottom: 1px solid #ddd;
}
#controls button {
  background: #0078d7;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
}
#controls button:hover {
  background: #005fa3;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}
th {
  background: #0078d7;
  color: white;
}
tr.highlight {
  background: yellow !important;
}
input[type="text"] {
  padding: 6px;
  width: 160px;
}
@media (max-width: 768px) {
  table { font-size: 13px; }
  #controls { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>
<header>ğŸ“‹ Kiá»ƒm kÃª MÃ¡y May</header>

<div id="controls">
  <input type="text" id="searchBox" placeholder="ğŸ” TÃ¬m theo sá»‘ tháº» hoáº·c sá»‘ mÃ¡y" />
  <button onclick="exportExcel()">â¬‡ï¸ Xuáº¥t Excel</button>
  <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none" />
  <button onclick="document.getElementById('fileInput').click()">â¬†ï¸ Nháº­p Excel</button>
  <button onclick="addRow()">â• ThÃªm dÃ²ng</button>
  <button onclick="syncToSheet()">ğŸ”„ Äá»“ng bá»™ Google Sheet</button>
</div>

<div style="overflow-x:auto;">
  <table id="dataTable">
    <thead>
      <tr>
        <th>Sá»‘ Tháº»</th>
        <th>Sá»‘ MÃ¡y</th>
        <th>Loáº¡i MÃ¡y</th>
        <th>Vá»‹ TrÃ­</th>
        <th>Ghi ChÃº</th>
        <th>HÃ nh Äá»™ng</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const gasUrl = 'https://script.google.com/macros/s/AKfycbyV36oZEfMdC7Hc2EOqVL5r2A6qMPWvo5sU3qUdDhxbQ1hMPzwSYgdGnXPioOeZeWVs/exec';
const localUrl = 'data.json';
let allData = [];

async function loadData() {
  try {
    const res = await fetch(gasUrl + '?action=getData');
    const json = await res.json();
    if (!json.success) throw new Error('GAS tráº£ lá»—i');
    allData = json.data;
    renderTable(allData);
    console.log('âœ… Load tá»« Google Sheet');
  } catch (err) {
    console.warn('âš ï¸ GAS lá»—i, thá»­ data.json', err);
    const res = await fetch(localUrl);
    allData = await res.json();
    renderTable(allData);
  }
}

function renderTable(data) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  data.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.soThe || ''}</td>
      <td>${r.soMay || ''}</td>
      <td>${r.loaiMay || ''}</td>
      <td>${r.viTri || ''}</td>
      <td>${r.ghiChu || ''}</td>
      <td>
        <button onclick="editRow(${i})">âœï¸</button>
        <button onclick="deleteRow(${i})">ğŸ—‘ï¸</button>
      </td>`;
    tbody.appendChild(tr);
  });
  highlightFromQR();
}

function editRow(index) {
  const r = allData[index];
  const newData = {
    soThe: prompt('Sá»‘ tháº»:', r.soThe),
    soMay: prompt('Sá»‘ mÃ¡y:', r.soMay),
    loaiMay: prompt('Loáº¡i mÃ¡y:', r.loaiMay),
    viTri: prompt('Vá»‹ trÃ­:', r.viTri),
    ghiChu: prompt('Ghi chÃº:', r.ghiChu)
  };
  allData[index] = newData;
  renderTable(allData);
}

function deleteRow(i) {
  if (confirm('XÃ³a dÃ²ng nÃ y?')) {
    allData.splice(i, 1);
    renderTable(allData);
  }
}

function addRow() {
  const newData = {
    soThe: prompt('Sá»‘ tháº»:'),
    soMay: prompt('Sá»‘ mÃ¡y:'),
    loaiMay: prompt('Loáº¡i mÃ¡y:'),
    viTri: prompt('Vá»‹ trÃ­:'),
    ghiChu: prompt('Ghi chÃº:')
  };
  if (newData.soThe) {
    allData.push(newData);
    renderTable(allData);
  }
}

async function syncToSheet() {
  try {
    const res = await fetch(gasUrl + '?action=updateData', {
      method: 'POST',
      body: JSON.stringify(allData),
      headers: { 'Content-Type': 'application/json' }
    });
    const txt = await res.text();
    alert('âœ… ÄÃ£ Ä‘á»“ng bá»™ lÃªn Google Sheet!\n' + txt);
  } catch (e) {
    alert('âŒ Lá»—i khi Ä‘á»“ng bá»™: ' + e.message);
  }
}

function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(allData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'DanhSachMay');
  XLSX.writeFile(wb, 'DanhSachMay.xlsx');
}

document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const data = new Uint8Array(ev.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    allData = XLSX.utils.sheet_to_json(sheet);
    renderTable(allData);
  };
  reader.readAsArrayBuffer(file);
}

// --- Highlight + scroll theo QR ---
function highlightFromQR() {
  const url = new URL(window.location.href);
  const code = url.searchParams.get('q');
  if (!code) return;
  const index = allData.findIndex(r => r.soThe === code || r.soMay === code);
  if (index >= 0) {
    const rows = document.querySelectorAll('#dataTable tbody tr');
    rows.forEach(r => r.classList.remove('highlight'));
    const target = rows[index];
    target.classList.add('highlight');
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
  } else {
    alert('KhÃ´ng tÃ¬m tháº¥y: ' + code);
  }
}

window.onload = loadData;
</script>
</body>
</html>
