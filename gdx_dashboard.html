<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Gƒê X∆∞·ªüng</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: "Segoe UI", sans-serif; margin: 20px; background:#f4f4f4; }
  h1 { text-align:center; }
  .filters { display:flex; gap:10px; margin-bottom:20px; justify-content:center; }
  select, input[type=date] { padding:5px 10px; font-size:14px; }
  canvas { background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); margin-bottom:30px; }
  table { width:100%; border-collapse: collapse; margin-bottom:30px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#eee; }
  .ok { color:green; }
  .bad { color:red; }
</style>
</head>
<body>

<h1>üìä Dashboard Gƒê X∆∞·ªüng</h1>

<div class="filters">
  <label>Ch·ªçn ng√†y: <input type="date" id="filterDate"></label>
  <label>Ch·ªçn t·ªï: 
    <select id="filterTo">
      <option value="">T·∫•t c·∫£</option>
    </select>
  </label>
  <button onclick="loadDashboard()">L·ªçc</button>
</div>

<canvas id="chartHS" height="80"></canvas>

<h2>üî• Top l·ªói ·∫£nh h∆∞·ªüng nƒÉng su·∫•t</h2>
<ul id="topErrors"></ul>

<h2>üìã B·∫£ng chi ti·∫øt</h2>
<table id="tableDetail">
  <thead>
    <tr>
      <th>Ng√†y</th>
      <th>X∆∞·ªüng</th>
      <th>T·ªï</th>
      <th>Khung gi·ªù</th>
      <th>HS%</th>
      <th>L·ªói</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
let allData = [];

async function loadDashboard() {
  const filterDate = document.getElementById('filterDate').value;
  const filterTo = document.getElementById('filterTo').value;

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "getData",
      role: "gdx_xuong",
      xuong: 1,       // thay x∆∞·ªüng t∆∞∆°ng ·ª©ng user
      to: filterTo || null
    })
  });
  const data = await res.json();
  if(!data.success) return alert('L·ªói t·∫£i d·ªØ li·ªáu');

  allData = data.data.filter(d => !filterDate || d.ngay===filterDate);

  renderTable();
  renderChart();
  renderTopErrors();
  populateToFilter();
}

function renderTable() {
  const tbody = document.querySelector('#tableDetail tbody');
  tbody.innerHTML = '';
  allData.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.ngay}</td>
      <td>${d.xuong}</td>
      <td>${d.to_nhom}</td>
      <td>${d.khung_gio}</td>
      <td>${d.hieu_suat}</td>
      <td>${d.nguyen_nhan || ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderChart() {
  const ctx = document.getElementById('chartHS').getContext('2d');
  const labels = [...new Set(allData.map(d=>d.khung_gio))].sort();
  const hsData = labels.map(g=>{
    const arr = allData.filter(d=>d.khung_gio===g).map(d=>d.hieu_suat);
    return arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
  });

  if(window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'HS% trung b√¨nh',
        data: hsData,
        backgroundColor: 'rgba(54,162,235,0.7)',
        borderColor: 'rgba(54,162,235,1)',
        borderWidth:1
      }]
    },
    options: {
      indexAxis: 'y',
      scales: {
        x: { beginAtZero:true, max:100 }
      }
    }
  });
}

function renderTopErrors() {
  const count = {};
  allData.forEach(d=>{
    if(d.nguyen_nhan) count[d.nguyen_nhan] = (count[d.nguyen_nhan]||0)+1;
  });
  const ul = document.getElementById('topErrors');
  ul.innerHTML = '';
  Object.entries(count).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{
    const li = document.createElement('li');
    li.textContent = `${k}: ${v} l·∫ßn`;
    ul.appendChild(li);
  });
}

function populateToFilter() {
  const select = document.getElementById('filterTo');
  select.innerHTML = '<option value="">T·∫•t c·∫£</option>';
  [...new Set(allData.map(d=>d.to_nhom))].sort((a,b)=>a-b).forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    select.appendChild(opt);
  });
}

// init default: h√¥m nay
document.getElementById('filterDate').value = new Date().toISOString().slice(0,10);
loadDashboard();
</script>

</body>
</html>
