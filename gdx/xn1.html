<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ðŸ“Š GDX â€“ XÆ°á»Ÿng 1</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f3f4f6}
header{background:#1e40af;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:600}
.box{background:#fff;margin:12px;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#e0e7ff;position:sticky;top:0}
.bad{background:#fee2e2;color:#b91c1c;font-weight:600}
.mid{background:#fef9c3;color:#92400e;font-weight:600}
.good{background:#dcfce7;color:#166534;font-weight:600}
.empty{color:#999}
.controls{display:flex;gap:8px;margin-bottom:10px}
select,input,button{padding:6px}
</style>
</head>

<body>

<header>ðŸ“Š DASHBOARD GDX â€“ XÆ¯á»žNG 1</header>

<div class="box">
  <div class="controls">
    <select id="mode">
      <option value="day">Theo ngÃ y</option>
      <option value="week">Theo tuáº§n</option>
      <option value="month">Theo thÃ¡ng</option>
    </select>
    <input type="date" id="date">
    <button onclick="loadData()">ðŸ”„ Xem</button>
  </div>

  <div style="overflow:auto">
    <table id="table"></table>
  </div>
</div>

<script>
const API_URL="https://nang-suat-may.hoalangiongxoai.workers.dev";
const TO_LIST=[1,3,5,7,9];
const HOURS=["07-08","08-09","09-10","10-11","11-12","12-13","13-14","14-15","15-16","16-17"];

// auth
const u=JSON.parse(localStorage.getItem("USER"));
if(!u||u.role!=="gdx_xuong"||Number(u.xuong)!==1){
  location.href="../login.html";
}

date.value=new Date().toISOString().slice(0,10);

function loadData(){
  const mode=modeSel.value;
  const base=new Date(date.value);

  let from,to;
  if(mode==="day"){
    from=to=date.value;
  }else if(mode==="week"){
    const d=base.getDay()||7;
    base.setDate(base.getDate()-d+1);
    from=base.toISOString().slice(0,10);
    base.setDate(base.getDate()+6);
    to=base.toISOString().slice(0,10);
  }else{
    from=date.value.slice(0,7)+"-01";
    to=new Date(base.getFullYear(),base.getMonth()+1,0).toISOString().slice(0,10);
  }

  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"getHourRange",
      xuong:1,
      from,to
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success)return;
    render(res.data);
  });
}

const modeSel=document.getElementById("mode");

function render(data){
  const map={};
  data.forEach(d=>{
    const k=`${d.to_nhom}_${d.khung_gio}`;
    if(!map[k]) map[k]=[];
    map[k].push(d.hieu_suat);
  });

  let html="<tr><th>Tá»•</th>";
  HOURS.forEach(h=>html+=`<th>${h}</th>`);
  html+="</tr>";

  TO_LIST.forEach(to=>{
    html+=`<tr><th>Tá»• ${to}</th>`;
    HOURS.forEach(h=>{
      const k=`${to}_${h}`;
      if(!map[k]){
        html+=`<td class="empty">â€“</td>`;
      }else{
        const avg=Math.round(map[k].reduce((a,b)=>a+b,0)/map[k].length);
        let cls="good";
        if(avg<80)cls="bad";
        else if(avg<95)cls="mid";
        html+=`<td class="${cls}">${avg}%</td>`;
      }
    });
    html+="</tr>";
  });

  table.innerHTML=html;
}

loadData();
</script>

</body>
</html>
