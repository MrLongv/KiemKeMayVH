<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>üìä GDX ‚Äì B·∫£ng nƒÉng su·∫•t theo gi·ªù</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f3f4f6}
header{background:#1e40af;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:600}
.box{background:#fff;margin:12px;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#e0e7ff}
.low{background:#fee2e2;color:#991b1b;font-weight:600}
.mid{background:#fef9c3;color:#92400e;font-weight:600}
.high{background:#dcfce7;color:#166534;font-weight:600}
tfoot td{font-weight:bold;background:#f1f5f9}
</style>
</head>

<body>

<header>üìä DASHBOARD GDX ‚Äì X∆Ø·ªûNG 1 (THEO GI·ªú)</header>

<div class="box">
  <b>Ng√†y:</b>
  <input type="date" id="ngay">
  <button onclick="loadData()">üîÑ Xem</button>
</div>

<div class="box" style="overflow:auto">
  <table id="tbl"></table>
</div>

<script>
const API_URL="https://nang-suat-may.hoalangiongxoai.workers.dev";
const HOURS=["07-08","08-09","09-10","10-11","11-12","12-13","13-14","14-15","15-16","16-17"];

/* ===== AUTH ===== */
const u=JSON.parse(localStorage.getItem("USER"));
if(!u||u.role!=="gdx_xuong"||Number(u.xuong)!==1){
  location.href="../login.html";
}

/* ===== DATE ===== */
const today=new Date().toISOString().slice(0,10);
ngay.value=today;

/* ===== LOAD ===== */
function loadData(){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"getHourRange",
      xuong:1,
      from:ngay.value,
      to:ngay.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.success) return;
    render(res.data);
  });
}

/* ===== RENDER ===== */
function render(data){
  const tbl=document.getElementById("tbl");
  tbl.innerHTML="";

  if(data.length===0){
    tbl.innerHTML="<tr><td>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>";
    return;
  }

  // pivot
  const map={};
  data.forEach(d=>{
    const t=d.to_nhom;
    if(!map[t]) map[t]={};
    map[t][d.khung_gio]=d;
  });

  // header
  let html="<tr><th>T·ªï</th>";
  HOURS.forEach(h=>html+=`<th>${h}</th>`);
  html+="<th>T·ªïng</th><th>HS%</th></tr>";

  // rows
  Object.keys(map).sort((a,b)=>a-b).forEach(to=>{
    let sumTT=0,sumKH=0;
    html+=`<tr><td><b>T·ªï ${to}</b></td>`;

    HOURS.forEach(h=>{
      const d=map[to][h];
      if(!d){
        html+="<td></td>";
        return;
      }
      sumTT+=d.thuc_te;
      sumKH+=d.ke_hoach_gio;
      let cls=d.hieu_suat<80?"low":d.hieu_suat<95?"mid":"high";
      html+=`<td class="${cls}">${d.thuc_te}</td>`;
    });

    const hs=sumKH?Math.round(sumTT/sumKH*100):0;
    let cls=hs<80?"low":hs<95?"mid":"high";
    html+=`<td>${sumTT}</td><td class="${cls}">${hs}%</td></tr>`;
  });

  tbl.innerHTML=html;
}

loadData();
</script>
</body>
</html>
