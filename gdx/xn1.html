<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üè≠ GƒêX ‚Äì Dashboard x∆∞·ªüng</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f3f4f6;
}
header{
  background:#7c2d12;
  color:#fff;
  padding:12px 20px;
  font-size:18px;
}
.container{
  padding:20px;
}
.top{
  margin-bottom:12px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  margin-bottom:20px;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
  font-size:14px;
}
th{
  background:#e5e7eb;
}
.bad{ background:#fee2e2 }
.warn{ background:#fef9c3 }
.good{ background:#dcfce7 }
button{
  padding:4px 8px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  background:#2563eb;
  color:#fff;
}
.detail{
  display:none;
}
</style>
</head>

<body>

<header>üè≠ DASHBOARD GI√ÅM ƒê·ªêC X∆Ø·ªûNG</header>

<div class="container">

  <div class="top">
    üìÖ Ng√†y:
    <input type="date" id="ngay">
    <button onclick="loadData()">üîÑ T·∫£i d·ªØ li·ªáu</button>
  </div>

  <!-- T·ªîNG H·ª¢P NG√ÄY -->
  <table>
    <thead>
      <tr>
        <th>T·ªï</th>
        <th>Th·ª±c t·∫ø</th>
        <th>ƒêM ng√†y</th>
        <th>Gi·ªù l√†m</th>
        <th>Hi·ªáu su·∫•t</th>
        <th>Chi ti·∫øt</th>
      </tr>
    </thead>
    <tbody id="dayBody"></tbody>
  </table>

  <!-- CHI TI·∫æT GI·ªú -->
  <div id="detailBox"></div>

</div>

<script>
const API_URL = "https://nang-suat-may.hoalangiongxoai.workers.dev";
const user = JSON.parse(localStorage.getItem("USER")||"{}");

if(user.role !== "gdx"){
  alert("Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p");
  location.href="../login.html";
}

const xuong = user.xuong;
document.getElementById("ngay").value =
  new Date().toISOString().slice(0,10);

/* ===== LOAD DASHBOARD ===== */
function loadData(){
  const ngay=document.getElementById("ngay").value;

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"getDayByXuong",
      ngay,
      xuong
    })
  })
  .then(r=>r.json())
  .then(res=>{
    const tbody=document.getElementById("dayBody");
    tbody.innerHTML="";

    if(!res.success || res.data.length===0){
      tbody.innerHTML="<tr><td colspan=6>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>";
      return;
    }

    res.data.forEach(r=>{
      const hs=r.hieu_suat_ngay||0;
      let cls="good";
      if(hs<80) cls="bad";
      else if(hs<95) cls="warn";

      const tr=document.createElement("tr");
      tr.className=cls;
      tr.innerHTML=`
        <td>${r.to_nhom}</td>
        <td>${r.tong_sp}</td>
        <td>${r.dinh_muc_ngay}</td>
        <td>${r.so_gio_lam}</td>
        <td><b>${hs}%</b></td>
        <td>
          <button onclick="loadDetail('${r.to_nhom}')">Xem</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

/* ===== LOAD CHI TI·∫æT GI·ªú ===== */
function loadDetail(to_nhom){
  const ngay=document.getElementById("ngay").value;

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"getHour",
      ngay,
      xuong,
      to_nhom
    })
  })
  .then(r=>r.json())
  .then(res=>{
    const box=document.getElementById("detailBox");
    if(!res.success){
      box.innerHTML="";
      return;
    }

    let html=`
      <h3>‚è± Chi ti·∫øt t·ªï ${to_nhom}</h3>
      <table>
        <tr>
          <th>Gi·ªù</th>
          <th>ƒêM</th>
          <th>Th·ª±c t·∫ø</th>
          <th>HS%</th>
          <th>Nguy√™n nh√¢n</th>
        </tr>
    `;

    res.data.forEach(h=>{
      html+=`
        <tr>
          <td>${h.khung_gio}</td>
          <td>${h.ke_hoach_gio}</td>
          <td>${h.thuc_te}</td>
          <td>${h.hieu_suat}%</td>
          <td>${h.nguyen_nhan||""}</td>
        </tr>
      `;
    });

    html+="</table>";
    box.innerHTML=html;
  });
}

loadData();
</script>

</body>
</html>
