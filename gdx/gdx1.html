<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GDX1 ‚Äì Dashboard Gi√°m ƒë·ªëc x∆∞·ªüng (XN1)</title>

<style>
:root{
  --bg:#f3f4f6;--card:#fff;--line:#d1d5db;--text:#111827;--muted:#6b7280;
  --head:#eef2f7;--head2:#e5e7eb;
  --primary:#2563eb;--good:#16a34a;--warn:#f59e0b;--bad:#dc2626;
  --shadow:0 10px 24px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

.topbar{
  position:sticky;top:0;z-index:20;
  background:linear-gradient(180deg,#0b1b3a,#0e2552);
  color:#fff;padding:12px 14px;box-shadow:0 10px 24px rgba(0,0,0,.18)
}
.toprow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
.brand b{display:block}
.brand span{font-size:12px;opacity:.85}

.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.ctl{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.12);padding:6px 8px;border-radius:12px}
.ctl label{font-size:12px;opacity:.9}
.ctl input,.ctl select{
  background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
  color:#fff;padding:6px 8px;border-radius:10px;font-size:12px
}
.btn{border:none;background:var(--primary);color:#fff;padding:8px 10px;border-radius:12px;font-weight:800;font-size:12px;cursor:pointer}
.btn.ghost{background:rgba(255,255,255,.18)}

.status{
  font-size:12px;opacity:.95;padding:6px 10px;
  background:rgba(255,255,255,.12);border-radius:12px
}

.wrap{padding:14px}

.kpi{
  display:grid;
  grid-template-columns:repeat(4,minmax(180px,1fr));
  gap:12px;margin-bottom:14px
}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:14px
}
.card .label{font-size:12px;color:var(--muted)}
.card .value{font-size:22px;font-weight:900;margin-top:4px}
.card .sub{font-size:12px;color:var(--muted);margin-top:2px}

.tableWrap{
  background:#fff;border:1px solid var(--line);
  border-radius:16px;overflow:auto;box-shadow:var(--shadow)
}

table{
  width:max(1600px,100%);
  border-collapse:collapse;
  font-size:12.5px
}
th,td{border:1px solid var(--line);padding:6px;text-align:center;white-space:nowrap}
thead tr:nth-child(1) th{background:var(--head);font-weight:900}
thead tr:nth-child(2) th{background:var(--head2);font-weight:800}
tbody tr:nth-child(even) td{background:#fafafa}

.calc{font-weight:900}
.pct.good{color:var(--good)}
.pct.warn{color:var(--warn)}
.pct.bad{color:var(--bad)}

tfoot td{background:#f1f5f9;font-weight:900}

.small{font-size:12px;color:var(--muted);margin-top:10px}
</style>
</head>

<body>

<!-- ================= TOPBAR ================= -->
<div class="topbar">
  <div class="toprow">
    <div class="brand">
      <b>üìä GDX1 ‚Äì DASHBOARD GI√ÅM ƒê·ªêC X∆Ø·ªûNG</b>
      <span id="roleHint">‚Äî</span>
    </div>

    <div class="controls">
      <div class="ctl">
        <label>Ng√†y</label>
        <input type="date" id="date" />
      </div>
      <button class="btn" onclick="reload()">T·∫£i d·ªØ li·ªáu</button>
      <button class="btn ghost" onclick="logout()">ƒêƒÉng xu·∫•t</button>
      <div class="status" id="status">Ch∆∞a t·∫£i</div>
    </div>
  </div>
</div>

<div class="wrap">

<!-- ================= KPI ================= -->
<div class="kpi">
  <div class="card">
    <div class="label">T·ªîNG S·∫¢N L∆Ø·ª¢NG</div>
    <div class="value" id="kpiSp">0</div>
    <div class="sub">To√†n x∆∞·ªüng (ng√†y)</div>
  </div>

  <div class="card">
    <div class="label">HI·ªÜU SU·∫§T TB</div>
    <div class="value" id="kpiHs">0%</div>
    <div class="sub">So v·ªõi ƒë·ªãnh m·ª©c ng√†y</div>
  </div>

  <div class="card">
    <div class="label">T·ªîNG USD CU·ªêI NG√ÄY</div>
    <div class="value" id="usdNgayTop">0.00</div>
    <div class="sub">USD to√†n x∆∞·ªüng</div>
  </div>

  <div class="card">
    <div class="label">USD / GI·ªú CAO NH·∫§T</div>
    <div class="value" id="kpiMax">0.00</div>
    <div class="sub">Trong 9 khung gi·ªù</div>
  </div>
</div>

<!-- ================= TABLE ================= -->
<div class="tableWrap">
<table id="tbl">
<thead>
  <tr>
    <th rowspan="2">T·ªî</th>
    <th rowspan="2">M√É H√ÄNG</th>
    <th rowspan="2">ƒêM NG√ÄY</th>
    <th colspan="9">S·∫¢N L∆Ø·ª¢NG THEO GI·ªú</th>
    <th rowspan="2">T·ªîNG SP</th>
    <th rowspan="2">USD/TH</th>
    <th rowspan="2">HI·ªÜU SU·∫§T</th>
  </tr>
  <tr id="hourHead"></tr>
</thead>

<tbody id="tbody"></tbody>

<tfoot>
<tr>
  <td colspan="3">T·ªîNG USD / GI·ªú</td>
  <td class="usdGio"></td><td class="usdGio"></td><td class="usdGio"></td>
  <td class="usdGio"></td><td class="usdGio"></td><td class="usdGio"></td>
  <td class="usdGio"></td><td class="usdGio"></td><td class="usdGio"></td>
  <td colspan="3"></td>
</tr>
</tfoot>
</table>
</div>

<div class="small" id="rangeInfo"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL="https://nang-suat-may.hoalangiongxoai.workers.dev";
const XUONG=1;
const HOURS=["7-8","8-9","9-10","10-11","12-13","13-14","14-15","15-16","16-17"];

/* ================= SESSION ================= */
const KEY="NS_SESSION";
function sess(){try{return JSON.parse(localStorage.getItem(KEY)||"null")}catch{return null}}
function mustLogin(){const s=sess();if(!s||!s.token){location.href="../login.html";return null}return s}
function logout(){localStorage.removeItem(KEY);location.href="../login.html"}

/* ================= UTIL ================= */
function todayISO(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}
function n(v){return Number(v)||0}
function fmt2(v){return n(v).toFixed(2)}
function fmt1(v){return n(v).toFixed(1)}
function pctClass(h){return h>=95?"good":h>=80?"warn":"bad"}
async function apiPost(p){
  const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});
  return await r.json();
}

/* ================= INIT ================= */
document.getElementById("date").value=todayISO();
document.getElementById("hourHead").innerHTML=HOURS.map(h=>`<th>${h}</th>`).join("");

let S=mustLogin();
if(S){
  const ok=(S.role==="gdx" && Number(S.xuong)===XUONG)||(S.role==="gdc");
  if(!ok){
    document.getElementById("roleHint").innerText=`‚õî Kh√¥ng ƒë√∫ng quy·ªÅn: role=${S.role} xuong=${S.xuong}`;
  }else{
    document.getElementById("roleHint").innerText=
      S.role==="gdc"?"üëÄ GƒêC ‚Äì xem XN1":"üëÄ GƒêX1 ‚Äì ch·ªâ xem";
    reload();
  }
}

/* ================= MAIN ================= */
async function reload(){
  const ngay=document.getElementById("date").value;
  document.getElementById("status").innerText="ƒêang t·∫£i...";

  const res=await apiPost({
    action:"getTkXuongDay",
    token:S.token,
    ngay,
    xuong:XUONG
  });

  if(!res.success){
    document.getElementById("status").innerText="L·ªói t·∫£i";
    return;
  }

  render(res.rows||[]);
  document.getElementById("status").innerText=`ƒê√£ t·∫£i ‚Ä¢ ${ngay}`;
}

function render(rows){
  let sumSp=0,sumKe=0,sumUsd=0;
  const usdGio=Array(HOURS.length).fill(0);

  document.getElementById("tbody").innerHTML=rows.map(r=>{
    const hours=r.hours||Array(HOURS.length).fill(0);
    const tongSp=hours.reduce((a,b)=>a+n(b),0);
    const usd=tongSp*n(r.don_gia);
    const hs=r.dinh_muc_ngay>0?(tongSp/r.dinh_muc_ngay*100):0;

    sumSp+=tongSp;
    sumKe+=n(r.dinh_muc_ngay);
    sumUsd+=usd;
    hours.forEach((v,i)=>usdGio[i]+=n(v)*n(r.don_gia));

    return `<tr>
      <td><b>${r.to_nhom}</b></td>
      <td>${r.ma_hang||""}</td>
      <td>${r.dinh_muc_ngay||0}</td>
      ${hours.map(v=>`<td>${v||0}</td>`).join("")}
      <td class="calc">${tongSp}</td>
      <td class="calc">${fmt2(usd)}</td>
      <td class="pct ${pctClass(hs)}">${fmt1(hs)}%</td>
    </tr>`;
  }).join("");

  document.querySelectorAll(".usdGio").forEach((td,i)=>td.innerText=fmt2(usdGio[i]||0));

  document.getElementById("kpiSp").innerText=sumSp;
  document.getElementById("kpiHs").innerText=fmt1(sumKe?sumSp/sumKe*100:0)+"%";
  document.getElementById("usdNgayTop").innerText=fmt2(sumUsd);
  document.getElementById("kpiMax").innerText=fmt2(Math.max(...usdGio));
}
</script>

</body>
</html>
