<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý kiểm kê + In QR</title>

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
    }
    h2 {
        margin-bottom: 10px;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
    }
    th, td {
        border: 1px solid #777;
        padding: 8px;
        text-align: center;
    }
    th {
        background: #eee;
    }
    .btn {
        padding: 10px 16px;
        background: #0077ff;
        color: #fff;
        border: none;
        cursor: pointer;
        margin-right: 10px;
        border-radius: 6px;
    }
    .btn:hover { opacity: 0.8; }

    .input-text {
        padding: 6px;
        width: 180px;
        margin-right: 5px;
    }
</style>
</head>

<body>

<h2>QUẢN LÝ KIỂM KÊ + IN QR</h2>

<button class="btn" id="btnAddRow">Thêm dòng</button>
<button class="btn" id="btnSave">Lưu dữ liệu</button>
<button class="btn" id="btnPrintQR">In QR</button>
<button class="btn" id="btnPrintResume">In lý lịch</button>

<table id="dataTable">
    <thead>
        <tr>
            <th>Chọn</th>
            <th>Số thẻ</th>
            <th>Số máy</th>
            <th>Loại máy</th>
            <th>Vị trí</th>
            <th>Ghi chú</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
/* ========================================================
                    MAIN DATA
======================================================== */
let allData = [];

/* ========================================================
                    LOAD DATA
======================================================== */
function loadData() {
    const saved = localStorage.getItem("inventoryData");
    if (saved) {
        allData = JSON.parse(saved);
    } else {
        // dữ liệu mẫu
        allData = [
            { id: 1, soThe: "ST001", soMay: "SM01", loaiMay: "Laptop", viTri: "Kho 1", ghiChu: "" },
            { id: 2, soThe: "ST002", soMay: "SM02", loaiMay: "PC", viTri: "Kho 2", ghiChu: "" }
        ];
    }
    renderTable();
}

/* ========================================================
                    RENDER TABLE
======================================================== */
function renderTable() {
    const tb = document.querySelector("#dataTable tbody");
    tb.innerHTML = "";

    allData.forEach(row => {
        tb.innerHTML += `
            <tr>
                <td><input type="checkbox" class="rowSelect" data-id="${row.id}"></td>
                <td><input class="input-text" value="${row.soThe}" onchange="updateField(${row.id}, 'soThe', this.value)" /></td>
                <td><input class="input-text" value="${row.soMay}" onchange="updateField(${row.id}, 'soMay', this.value)" /></td>
                <td><input class="input-text" value="${row.loaiMay}" onchange="updateField(${row.id}, 'loaiMay', this.value)" /></td>
                <td><input class="input-text" value="${row.viTri}" onchange="updateField(${row.id}, 'viTri', this.value)" /></td>
                <td><input class="input-text" value="${row.ghiChu}" onchange="updateField(${row.id}, 'ghiChu', this.value)" /></td>
            </tr>
        `;
    });
}

/* ========================================================
                    UPDATE FIELD
======================================================== */
function updateField(id, key, value) {
    const row = allData.find(r => r.id == id);
    if (row) {
        row[key] = value;
    }
}

/* ========================================================
                    ADD NEW ROW
======================================================== */
document.getElementById("btnAddRow").onclick = () => {
    const newId = Date.now();
    allData.push({
        id: newId,
        soThe: "",
        soMay: "",
        loaiMay: "",
        viTri: "",
        ghiChu: ""
    });
    renderTable();
};

/* ========================================================
                    SAVE DATA
======================================================== */
document.getElementById("btnSave").onclick = () => {
    localStorage.setItem("inventoryData", JSON.stringify(allData));
    alert("Đã lưu dữ liệu!");
};

/* ========================================================
                    PRINT QR (HD, không lỗi)
======================================================== */
document.getElementById('btnPrintQR').onclick = () => {
  const ids = Array.from(document.querySelectorAll('.rowSelect:checked'))
                   .map(cb => cb.dataset.id);

  if (ids.length === 0) {
    alert("Chọn ít nhất một dòng để in QR");
    return;
  }

  const w = window.open("", "_blank");

  w.document.write(`
    <html>
    <head>
      <title>In QR</title>
      <style>
        body { font-family: Arial; padding: 20px; }
        .qrItem { 
          page-break-after: always; 
          text-align: center; 
          margin-bottom: 40px;
        }
        .qrLabel {
          font-size: 22px; 
          margin-top: 10px;
        }
      </style>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    </head>
    <body>
  `);

  ids.forEach(id => {
    const row = allData.find(r => r.id == id);
    if (!row) return;

    const cid = "qr_" + row.id;

    w.document.write(`
      <div class="qrItem">
        <div id="${cid}"></div>
        <div class="qrLabel">${row.soThe}</div>
      </div>
    `);
  });

  w.document.write("</body></html>");
  w.document.close();

  w.onload = () => {
    ids.forEach(id => {
      const row = allData.find(r => r.id == id);
      if (!row) return;

      const cid = "qr_" + row.id;
      const qrData = location.origin + location.pathname + "?soThe=" + encodeURIComponent(row.soThe);

      new w.QRCode(w.document.getElementById(cid), {
        text: qrData,
        width: 350,
        height: 350,
        correctLevel: w.QRCode.CorrectLevel.H
      });
    });
  };
};

/* ========================================================
                    PRINT RESUME
======================================================== */
document.getElementById('btnPrintResume').onclick = () => { 
  const ids = Array.from(document.querySelectorAll('.rowSelect:checked'))
                   .map(cb => cb.dataset.id);

  if (ids.length === 0) {
    alert("Chọn dòng để in!");
    return;
  }

  ids.forEach(id => { 
    const row = allData.find(r => r.id == id); 
    if (!row) return;

    const w = window.open(); 
    w.document.write(`
        <h2>Lý lịch: ${row.soThe}</h2>
        <p><b>Số máy:</b> ${row.soMay}</p>
        <p><b>Loại:</b> ${row.loaiMay}</p>
        <p><b>Vị trí:</b> ${row.viTri}</p>
        <p><b>Ghi chú:</b> ${row.ghiChu}</p>
    `); 
    w.document.close();
  });
};

/* ========================================================
                    START
======================================================== */
loadData();
</script>

</body>
</html>
