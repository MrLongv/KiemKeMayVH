<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý Kiểm kê VH</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #eee; }
  .toolbar { display: flex; gap: 10px; margin-bottom: 20px; }
  .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,.4); display:none; justify-content:center; align-items:center; }
  .modal .card { background:#fff; padding:20px; width:500px; max-height:80vh; overflow:auto; border-radius:6px; }
  .dropdown { padding:6px; }
  .btn { padding:6px 12px; cursor:pointer; }
  .btn-primary { background:#007bff; color:#fff; border:none; }
  .btn-green { background:#28a745; color:#fff; border:none; }
  .btn-red { background:#dc3545; color:#fff; border:none; }
</style>
</head>
<body>

<h2>Quản lý Kiểm kê Vật Hữu</h2>

<div class="toolbar">
  <input id="searchBox" placeholder="Tìm theo số thẻ / số máy..." style="padding:6px;">
  
  <select id="filterBox" class="dropdown">
    <option value="all">Hiển thị tất cả</option>
    <option value="kk_done">Đã kiểm kê</option>
    <option value="kk_none">Chưa kiểm kê</option>
    <option value="qr_done">Đã in QR</option>
    <option value="qr_none">Chưa in QR</option>
  </select>

  <button class="btn btn-primary" onclick="printSelectedQR()">In QR đã chọn</button>
  <button class="btn btn-green" onclick="printSelectedLyLich()">In lý lịch đã chọn</button>
</div>

<table id="mainTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Số thẻ</th>
      <th>Số máy</th>
      <th>Loại máy</th>
      <th>Vị trí</th>
      <th>Ghi chú</th>
      <th>Đã KK</th>
      <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th>
      <th>In QR</th>
      <th>Sửa</th>
      <th>Chọn in</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal chỉnh sửa -->
<div id="editModal" class="modal">
  <div class="card">
    <h3>Chỉnh sửa</h3>

    <label>Số thẻ</label><br>
    <input id="m_soThe" style="width:100%"><br>

    <label>Số máy</label><br>
    <input id="m_soMay" style="width:100%"><br>

    <label>Loại máy</label><br>
    <input id="m_loaiMay" style="width:100%"><br>

    <label>Vị trí</label><br>
    <input id="m_viTri" style="width:100%"><br>

    <label>Ghi chú</label><br>
    <input id="m_ghiChu" style="width:100%"><br>

    <label><input type="checkbox" id="m_daKiemKe"> Đã kiểm kê</label><br>

    <label><input type="checkbox" id="m_bdQ1"> Bảo dưỡng Q1</label><br>
    <label><input type="checkbox" id="m_bdQ2"> Bảo dưỡng Q2</label><br>
    <label><input type="checkbox" id="m_bdQ3"> Bảo dưỡng Q3</label><br>
    <label><input type="checkbox" id="m_bdQ4"> Bảo dưỡng Q4</label><br>

    <label>Ngày mua</label><br>
    <input id="m_ngayMua" style="width:100%"><br>

    <label>Nơi mua</label><br>
    <input id="m_noiMua" style="width:100%"><br>

    <label>Sửa chữa</label><br>
    <input id="m_suaChua" style="width:100%"><br><br>

    <button class="btn btn-primary" onclick="saveEdit()">Lưu</button>
    <button class="btn btn-red" onclick="closeModal()">Đóng</button>
  </div>
</div>

<script>
/* ================================
        CONFIG
================================ */
const API_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev"; // <- sửa thành Worker của bạn

let ROWS = [];
let editingId = null;

/* ================================
        LOAD DATA
================================ */
async function loadData(){
  let res = await fetch(API_URL + "/");
  let j = await res.json();
  ROWS = j.data || [];
  renderTable();
}

/* ================================
        RENDER TABLE
================================ */
function renderTable(){
  const tb = document.querySelector("#mainTable tbody");
  tb.innerHTML = "";

  const kw = searchBox.value.toLowerCase();
  const filter = filterBox.value;

  ROWS.forEach(r=>{
    if(kw){
      let ok = r.soThe.toLowerCase().includes(kw) ||
               r.soMay.toLowerCase().includes(kw);
      if(!ok) return;
    }

    if(filter==="kk_done" && !r.daKiemKe) return;
    if(filter==="kk_none" && r.daKiemKe) return;
    if(filter==="qr_done" && !r.chonIn) return;
    if(filter==="qr_none" && r.chonIn) return;

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.soThe}</td>
      <td>${r.soMay}</td>
      <td>${r.loaiMay}</td>
      <td>${r.viTri}</td>
      <td>${r.ghiChu}</td>

      <td><input type="checkbox" ${r.daKiemKe?"checked":""}
           onchange="toggleField(${r.id},'daKiemKe',this.checked)"></td>

      <td><input type="checkbox" ${r.bdQ1?"checked":""}
           onchange="toggleField(${r.id},'bdQ1',this.checked)"></td>
      <td><input type="checkbox" ${r.bdQ2?"checked":""}
           onchange="toggleField(${r.id},'bdQ2',this.checked)"></td>
      <td><input type="checkbox" ${r.bdQ3?"checked":""}
           onchange="toggleField(${r.id},'bdQ3',this.checked)"></td>
      <td><input type="checkbox" ${r.bdQ4?"checked":""}
           onchange="toggleField(${r.id},'bdQ4',this.checked)"></td>

      <td><input type="checkbox" ${r.chonIn?"checked":""}
           class="qr-check" data-id="${r.soThe}"
           onchange="toggleField(${r.id},'chonIn',this.checked)"></td>

      <td><button class="btn btn-primary" onclick="openEdit(${r.id})">Sửa</button></td>

      <td><input type="checkbox" class="multi-check" data-id="${r.soThe}"></td>
    `;

    tb.appendChild(tr);
  });
}

/* ================================
        UPDATE FIELD
================================ */
async function toggleField(id, field, value){
  let row = ROWS.find(x=>x.id===id);
  if(!row) return;

  row[field] = value ? 1 : 0;

  await fetch(API_URL + "/update", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(row)
  });
}

/* ================================
        EDIT MODAL
================================ */
function openEdit(id){
  editingId = id;
  const r = ROWS.find(x=>x.id===id);
  if(!r) return;

  m_soThe.value = r.soThe;
  m_soMay.value = r.soMay;
  m_loaiMay.value = r.loaiMay;
  m_viTri.value = r.viTri;
  m_ghiChu.value = r.ghiChu;
  m_daKiemKe.checked = r.daKiemKe;
  m_bdQ1.checked = r.bdQ1;
  m_bdQ2.checked = r.bdQ2;
  m_bdQ3.checked = r.bdQ3;
  m_bdQ4.checked = r.bdQ4;
  m_ngayMua.value = r.ngayMua;
  m_noiMua.value = r.noiMua;
  m_suaChua.value = r.suaChua;

  editModal.style.display = "flex";
}

function closeModal(){ editModal.style.display="none"; }

async function saveEdit(){
  let r = ROWS.find(x=>x.id===editingId);
  if(!r) return;

  r.soThe = m_soThe.value;
  r.soMay = m_soMay.value;
  r.loaiMay = m_loaiMay.value;
  r.viTri = m_viTri.value;
  r.ghiChu = m_ghiChu.value;
  r.daKiemKe = m_daKiemKe.checked ? 1:0;
  r.bdQ1 = m_bdQ1.checked?1:0;
  r.bdQ2 = m_bdQ2.checked?1:0;
  r.bdQ3 = m_bdQ3.checked?1:0;
  r.bdQ4 = m_bdQ4.checked?1:0;
  r.ngayMua = m_ngayMua.value;
  r.noiMua = m_noiMua.value;
  r.suaChua = m_suaChua.value;

  await fetch(API_URL + "/update", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(r)
  });

  closeModal();
  renderTable();
}

/* ================================
        QR GENERATOR (Standalone)
================================ */
class QR8bitByte{constructor(t){this.mode=4,this.data=t}getLength(){return this.data.length}write(t){for(let e=0;e<this.data.length;e++)t.put(this.data.charCodeAt(e),8)}}
class QRCodeModel{
  constructor(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}
  addData(t){this.dataList.push(new QR8bitByte(t))}
  isDark(t,e){return this.modules[t][e]}
  getModuleCount(){return this.moduleCount}
  make(){
    this.moduleCount=21,this.modules=Array(this.moduleCount).fill().map(()=>Array(this.moduleCount).fill(!1));
    const t=(t,e)=>{for(let r=0;r<7;r++)for(let a=0;a<7;a++)this.modules[t+r][e+a]=0===r||6===r||0===a||6===a||r>=2&&r<=4&&a>=2&&a<=4};
    t(0,0),t(0,14),t(14,0);
    const e=[];
    this.dataList.forEach(t=>{for(let r=0;r<t.data.length;r++){let a=t.data.charCodeAt(r);for(let t=7;t>=0;t--)e.push(a>>t&1)}})
    let r=this.moduleCount-1,a=this.moduleCount-1,s=-1;
    for(let t=0;t<e.length;t++){
      this.modules[r][a]=1===e[t],a--;
      a<0&&(a=this.moduleCount-1,
      (r+=s)<0&&(r=0,s=1),
      r>=this.moduleCount&&(r=this.moduleCount-1,s=-1))
    }
  }
}
function makeQR(t,e,r=256){
  const a=new QRCodeModel(1,1);
  a.addData(e),a.make();
  const s=a.getModuleCount(),o=r/s,i=document.createElement("canvas");
  i.width=r,i.height=r;
  const n=i.getContext("2d");
  n.fillStyle="#fff",n.fillRect(0,0,r,r),n.fillStyle="#000";
  for(let t=0;t<s;t++)for(let e=0;e<s;e++)a.isDark(t,e)&&n.fillRect(e*o,t*o,o,o);
  t.innerHTML="";
  const l=document.createElement("img");
  l.src=i.toDataURL("image/png"),l.style.width="100%",t.appendChild(l)
}

/* ================================
        PRINT QR SELECTED
================================ */
function printSelectedQR(){
  let selected = [...document.querySelectorAll(".qr-check:checked")].map(e=>e.dataset.id);
  if(selected.length===0){ alert("Chưa chọn dòng nào!"); return; }

  let w = window.open("", "_blank");
  w.document.write(`<html><body><h2>QR Codes</h2>`);

  selected.forEach(id=>{
    w.document.write(`
      <div style="page-break-inside:avoid; margin:20px">
        <div id="qr_${id}" style="width:180px;height:180px;"></div>
        <div><b>${id}</b></div>
      </div>
    `);
  });

  w.document.write("</body></html>");
  w.document.close();

  selected.forEach(id=>{
    let el = w.document.getElementById("qr_"+id);
    makeQR(el, "#"+id, 180);
  });
}

/* ================================
        PRINT LÝ LỊCH
================================ */
function printSelectedLyLich(){
  let selected = [...document.querySelectorAll(".multi-check:checked")].map(e=>e.dataset.id);
  if(selected.length===0){ alert("Chưa chọn dòng nào!"); return; }

  let w = window.open("", "_blank");
  w.document.write("<html><body>");
  w.document.write("<h2>Lý lịch máy móc</h2>");

  selected.forEach(st=>{
    let r = ROWS.find(x=>x.soThe===st);
    if(!r) return;
    w.document.write(`
      <div style="margin:20px; page-break-after:always;">
        <h3>${r.soThe}</h3>
        <p><b>Số máy:</b> ${r.soMay}</p>
        <p><b>Loại máy:</b> ${r.loaiMay}</p>
        <p><b>Vị trí:</b> ${r.viTri}</p>
        <p><b>Ghi chú:</b> ${r.ghiChu}</p>
        <p><b>Ngày mua:</b> ${r.ngayMua}</p>
        <p><b>Nơi mua:</b> ${r.noiMua}</p>
        <p><b>Sửa chữa:</b> ${r.suaChua}</p>
      </div>
    `);
  });

  w.document.write("</body></html>");
  w.document.close();
}

/* ================================
        EVENTS
================================ */
searchBox.oninput = renderTable;
filterBox.onchange = renderTable;

/* ================================
        INIT
================================ */
loadData();
</script>
</body>
</html>
