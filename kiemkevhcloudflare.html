<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kiểm kê VH</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:10px;background:#f4f4f4;}
table{border-collapse:collapse;width:100%;margin-top:10px;}
th, td{border:1px solid #ccc;padding:6px;text-align:center;}
th{background:#eee;}
button{padding:4px 8px;margin:2px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:#fff;padding:10px;width:400px;max-height:90%;overflow:auto;position:relative;}
.modal-content label{display:block;margin-top:5px;}
input[type=text],input[type=date]{width:100%;padding:3px;margin-top:2px;}
</style>
</head>
<body>

<h2>Kiểm kê VH <button id="btnAdd">Thêm</button></h2>
<label>Năm: <select id="yearSelect"></select></label>
<table id="dataTable">
<thead>
<tr>
<th>ID</th><th>Số thẻ</th><th>Số máy</th><th>Loại máy</th><th>Vị trí</th><th>Ghi chú</th>
<th>Đã KK</th><th>In QR</th><th>Ngày mua</th><th>Nơi mua</th>
<th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Sửa chữa</th><th>Hành động</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="modal">
<div class="modal-content">
<h3 id="modalTitle">Sửa</h3>
<label>Số thẻ <input type="text" id="m_soThe"></label>
<label>Số máy <input type="text" id="m_soMay"></label>
<label>Loại máy <input type="text" id="m_loaiMay"></label>
<label>Vị trí <input type="text" id="m_viTri"></label>
<label>Ghi chú <input type="text" id="m_ghiChu"></label>
<label>Ngày mua <input type="date" id="m_ngayMua"></label>
<label>Nơi mua <input type="text" id="m_noiMua"></label>
<label>Sửa chữa <input type="text" id="m_suaChua"></label>
<label><input type="checkbox" id="m_daKiemKe"> Đã KK</label>
<label><input type="checkbox" id="m_chonIn"> In QR</label>
<label><input type="checkbox" id="m_bdQ1"> Q1 ngày <input type="date" id="m_bdNgayQ1"></label>
<label><input type="checkbox" id="m_bdQ2"> Q2 ngày <input type="date" id="m_bdNgayQ2"></label>
<label><input type="checkbox" id="m_bdQ3"> Q3 ngày <input type="date" id="m_bdNgayQ3"></label>
<label><input type="checkbox" id="m_bdQ4"> Q4 ngày <input type="date" id="m_bdNgayQ4"></label>
<button id="modalSave">Lưu</button>
<button id="modalClose">Đóng</button>
</div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev"; // Thay bằng URL Worker của bạn
let allData = [], editingId=null;
const m_soThe=document.getElementById('m_soThe');
const m_soMay=document.getElementById('m_soMay');
const m_loaiMay=document.getElementById('m_loaiMay');
const m_viTri=document.getElementById('m_viTri');
const m_ghiChu=document.getElementById('m_ghiChu');
const m_daKiemKe=document.getElementById('m_daKiemKe');
const m_chonIn=document.getElementById('m_chonIn');
const m_bdQ1=document.getElementById('m_bdQ1'), m_bdNgayQ1=document.getElementById('m_bdNgayQ1');
const m_bdQ2=document.getElementById('m_bdQ2'), m_bdNgayQ2=document.getElementById('m_bdNgayQ2');
const m_bdQ3=document.getElementById('m_bdQ3'), m_bdNgayQ3=document.getElementById('m_bdNgayQ3');
const m_bdQ4=document.getElementById('m_bdQ4'), m_bdNgayQ4=document.getElementById('m_bdNgayQ4');
const m_ngayMua=document.getElementById('m_ngayMua');
const m_noiMua=document.getElementById('m_noiMua');
const m_suaChua=document.getElementById('m_suaChua');
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const yearSelect=document.getElementById('yearSelect');

function openModal(id=null){
  editingId=id;
  modal.style.display='flex';
  modalTitle.textContent = id?"Sửa":"Thêm";
  if(id){
    const row = allData.find(r=>r.id===id);
    m_soThe.value=row.soThe||"";
    m_soMay.value=row.soMay||"";
    m_loaiMay.value=row.loaiMay||"";
    m_viTri.value=row.viTri||"";
    m_ghiChu.value=row.ghiChu||"";
    m_ngayMua.value=row.ngayMua||"";
    m_noiMua.value=row.noiMua||"";
    m_suaChua.value=row.suaChua||"";
    m_daKiemKe.checked=!!row.daKiemKe;
    m_chonIn.checked=!!row.chonIn;
    m_bdQ1.checked=!!row.bdQ1; m_bdNgayQ1.value=row.bdNgayQ1||"";
    m_bdQ2.checked=!!row.bdQ2; m_bdNgayQ2.value=row.bdNgayQ2||"";
    m_bdQ3.checked=!!row.bdQ3; m_bdNgayQ3.value=row.bdNgayQ3||"";
    m_bdQ4.checked=!!row.bdQ4; m_bdNgayQ4.value=row.bdNgayQ4||"";
  }else{
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value="";
    m_ngayMua.value=m_noiMua.value=m_suaChua.value="";
    m_daKiemKe.checked=m_chonIn.checked=false;
    m_bdQ1.checked=m_bdQ2.checked=m_bdQ3.checked=m_bdQ4.checked=false;
    m_bdNgayQ1.value=m_bdNgayQ2.value=m_bdNgayQ3.value=m_bdNgayQ4.value="";
  }
}

document.getElementById('modalClose').onclick=()=>{modal.style.display='none';}

async function loadData(){
  const year = yearSelect.value;
  try{
    const res = await fetch(`${WORKER_URL}/?year=${year}`);
    const data = await res.json();
    if(data.success){ allData=data.data; renderTable(); }
    else alert("Lỗi khi load dữ liệu: "+data.error);
  }catch(err){ alert("Lỗi khi load dữ liệu: "+err); }
}

function renderTable(){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  allData.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${row.id}</td>
      <td>${row.soThe||""}</td>
      <td>${row.soMay||""}</td>
      <td>${row.loaiMay||""}</td>
      <td>${row.viTri||""}</td>
      <td>${row.ghiChu||""}</td>
      <td><input type="checkbox" disabled ${row.daKiemKe?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.chonIn?"checked":""}></td>
      <td>${row.ngayMua||""}</td>
      <td>${row.noiMua||""}</td>
      <td><input type="checkbox" disabled ${row.bdQ1?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.bdQ2?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.bdQ3?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.bdQ4?"checked":""}></td>
      <td>${row.suaChua||""}</td>
      <td><button onclick="openModal(${row.id})">Sửa</button></td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById('modalSave').onclick=async ()=>{
  const payload={
    id:editingId,
    soThe:m_soThe.value,
    soMay:m_soMay.value,
    loaiMay:m_loaiMay.value,
    viTri:m_viTri.value,
    ghiChu:m_ghiChu.value,
    daKiemKe:m_daKiemKe.checked,
    chonIn:m_chonIn.checked,
    bdQ1:m_bdQ1.checked, bdNgayQ1:m_bdNgayQ1.value,
    bdQ2:m_bdQ2.checked, bdNgayQ2:m_bdNgayQ2.value,
    bdQ3:m_bdQ3.checked, bdNgayQ3:m_bdNgayQ3.value,
    bdQ4:m_bdQ4.checked, bdNgayQ4:m_bdNgayQ4.value,
    ngayMua:m_ngayMua.value,
    noiMua:m_noiMua.value,
    suaChua:m_suaChua.value,
    nam:yearSelect.value
  };
  try{
    const url=editingId?`${WORKER_URL}/update`:`${WORKER_URL}/add`;
    const res=await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    if(data.success){ modal.style.display='none'; loadData(); }
    else alert("Lỗi khi lưu: "+data.error);
  }catch(err){ alert("Lỗi khi lưu: "+err); }
};

document.getElementById('btnAdd').onclick=()=>openModal(null);

// Fill year select
const currentYear = new Date().getFullYear();
for(let y=currentYear-1;y<=currentYear+2;y++){
  const opt=document.createElement('option'); opt.value=y; opt.text=y;
  if(y===currentYear) opt.selected=true;
  yearSelect.appendChild(opt);
}
yearSelect.onchange=()=>loadData();

// Initial load
loadData();
</script>
</body>
</html>
