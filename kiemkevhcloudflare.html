<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kiểm kê VH</title>
<style>
body{ font-family:Arial,sans-serif; margin:0; padding:10px; background:#f4f4f4; }
h2 { display:flex; align-items:center; justify-content:space-between; }
table{ border-collapse:collapse; width:100%; margin-top:10px; }
th, td{ border:1px solid #ccc; padding:6px; text-align:center; }
th{ background:#eee; }
button{ padding:4px 8px; margin:2px; cursor:pointer; }
.modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content{ background:#fff; padding:10px; width:400px; max-height:90%; overflow:auto; position:relative; border-radius:5px; }
.highlight-row{ background:yellow !important; transition: background 1s; }
#qrModal .modal-content{ width:320px; text-align:center; }
#toolbar{ margin-top:10px; display:flex; gap:10px; flex-wrap:nowrap; overflow-x:auto; align-items:center; }
#toolbar input[type=text]{ padding:4px 6px; width:200px; flex-shrink:0; }
#filterSelect{ padding:4px 6px; flex-shrink:0; }
</style>
</head>
<body>

<h2>Kiểm kê VH <button id="btnAdd">Thêm</button></h2>

<div id="toolbar">
  <input type="text" id="searchBox" placeholder="Tìm kiếm Số thẻ/Số máy/Loại/Vị trí...">
  <select id="filterSelect">
    <option value="all">Tất cả</option>
    <option value="chuaKiemKe">Chưa kiểm kê</option>
    <option value="daKiemKe">Đã kiểm kê</option>
    <option value="chuaInQR">Chưa in QR</option>
    <option value="daInQR">Đã in QR</option>
  </select>
  <button id="btnPrintSelectedQR">In QR chọn</button>
  <button id="btnPrintSelectedRecord">In Lý lịch chọn</button>
  <label>Năm: <select id="yearSelect"></select></label>
</div>

<table id="dataTable">
<thead>
<tr>
  <th><input type="checkbox" id="selectAll"></th>
  <th>ID</th><th>Số thẻ</th><th>Số máy</th><th>Loại máy</th><th>Vị trí</th><th>Ghi chú</th>
  <th>Đã KK</th><th>In QR</th><th>Ngày mua</th><th>Nơi mua</th>
  <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Sửa chữa</th><th>Hành động</th><th>QR / Lý lịch</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- Modal Sửa -->
<div class="modal" id="modal">
<div class="modal-content">
<h3 id="modalTitle">Sửa</h3>
<label>Số thẻ <input type="text" id="m_soThe"></label><br>
<label>Số máy <input type="text" id="m_soMay"></label><br>
<label>Loại máy <input type="text" id="m_loaiMay"></label><br>
<label>Vị trí <input type="text" id="m_viTri"></label><br>
<label>Ghi chú <input type="text" id="m_ghiChu"></label><br>
<label>Ngày mua <input type="date" id="m_ngayMua"></label><br>
<label>Nơi mua <input type="text" id="m_noiMua"></label><br>
<label>Sửa chữa <input type="text" id="m_suaChua"></label><br>
<label><input type="checkbox" id="m_daKiemKe"> Đã KK</label><br>
<label><input type="checkbox" id="m_chonIn"> In QR</label><br>
<label><input type="checkbox" id="m_bdQ1"> Q1 ngày <input type="date" id="m_bdNgayQ1"></label><br>
<label><input type="checkbox" id="m_bdQ2"> Q2 ngày <input type="date" id="m_bdNgayQ2"></label><br>
<label><input type="checkbox" id="m_bdQ3"> Q3 ngày <input type="date" id="m_bdNgayQ3"></label><br>
<label><input type="checkbox" id="m_bdQ4"> Q4 ngày <input type="date" id="m_bdNgayQ4"></label><br>
<button id="modalSave">Lưu</button>
<button id="modalClose">Đóng</button>
</div>
</div>

<!-- Modal QR -->
<div class="modal" id="qrModal">
  <div class="modal-content">
    <h3>Mã QR</h3>
    <div id="qrBox"></div>
    <button onclick="document.getElementById('qrModal').style.display='none'">Đóng</button>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev";
let allData=[], editingId=null;

// Modal fields
const m_soThe=document.getElementById('m_soThe'), m_soMay=document.getElementById('m_soMay'),
      m_loaiMay=document.getElementById('m_loaiMay'), m_viTri=document.getElementById('m_viTri'),
      m_ghiChu=document.getElementById('m_ghiChu'), m_daKiemKe=document.getElementById('m_daKiemKe'),
      m_chonIn=document.getElementById('m_chonIn'), m_bdQ1=document.getElementById('m_bdQ1'),
      m_bdNgayQ1=document.getElementById('m_bdNgayQ1'), m_bdQ2=document.getElementById('m_bdQ2'),
      m_bdNgayQ2=document.getElementById('m_bdNgayQ2'), m_bdQ3=document.getElementById('m_bdQ3'),
      m_bdNgayQ3=document.getElementById('m_bdNgayQ3'), m_bdQ4=document.getElementById('m_bdQ4'),
      m_bdNgayQ4=document.getElementById('m_bdNgayQ4'), m_ngayMua=document.getElementById('m_ngayMua'),
      m_noiMua=document.getElementById('m_noiMua'), m_suaChua=document.getElementById('m_suaChua');

const modal=document.getElementById('modal'), modalTitle=document.getElementById('modalTitle'),
      yearSelect=document.getElementById('yearSelect'), searchBox=document.getElementById('searchBox'),
      filterSelect=document.getElementById('filterSelect'), selectAllBox=document.getElementById('selectAll');

// Open modal
function openModal(id=null){
  editingId=id; modal.style.display='flex'; modalTitle.textContent = id?"Sửa":"Thêm";
  if(id){
    const row=allData.find(r=>r.id===id); if(!row) return;
    m_soThe.value=row.soThe||""; m_soMay.value=row.soMay||""; m_loaiMay.value=row.loaiMay||"";
    m_viTri.value=row.viTri||""; m_ghiChu.value=row.ghiChu||""; m_ngayMua.value=row.ngayMua||"";
    m_noiMua.value=row.noiMua||""; m_suaChua.value=row.suaChua||""; m_daKiemKe.checked=!!row.daKiemKe;
    m_chonIn.checked=!!row.chonIn; m_bdQ1.checked=!!row.bdQ1; m_bdNgayQ1.value=row.bdNgayQ1||"";
    m_bdQ2.checked=!!row.bdQ2; m_bdNgayQ2.value=row.bdNgayQ2||"";
    m_bdQ3.checked=!!row.bdQ3; m_bdNgayQ3.value=row.bdNgayQ3||"";
    m_bdQ4.checked=!!row.bdQ4; m_bdNgayQ4.value=row.bdNgayQ4||"";
  } else {
    m_soThe.value=m_soMay.value=m_loaiMay.value=m_viTri.value=m_ghiChu.value="";
    m_ngayMua.value=m_noiMua.value=m_suaChua.value="";
    m_daKiemKe.checked=m_chonIn.checked=false;
    m_bdQ1.checked=m_bdQ2.checked=m_bdQ3.checked=m_bdQ4.checked=false;
    m_bdNgayQ1.value=m_bdNgayQ2.value=m_bdNgayQ3.value=m_bdNgayQ4.value="";
  }
}
document.getElementById('modalClose').onclick=()=>modal.style.display='none';

// Load data
async function loadData(){
  try{
    const year = yearSelect.value;
    const res = await fetch(`${WORKER_URL}/?year=${year}`);
    const data = await res.json();
    if(data.success){ allData=data.data; applyFilters(); } 
    else alert("Lỗi khi load dữ liệu: "+data.error);
  }catch(err){ alert("Lỗi khi load dữ liệu: "+err); }
}

// Render table
function renderTable(data){
  const tbody=document.querySelector("#dataTable tbody"); tbody.innerHTML="";
  data.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" class="rowSelect" data-id="${row.id}"></td>
      <td>${row.id}</td><td>${row.soThe||""}</td><td>${row.soMay||""}</td><td>${row.loaiMay||""}</td><td>${row.viTri||""}</td><td>${row.ghiChu||""}</td>
      <td><input type="checkbox" disabled ${row.daKiemKe?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.chonIn?"checked":""}></td>
      <td>${row.ngayMua||""}</td><td>${row.noiMua||""}</td>
      <td><input type="checkbox" disabled ${row.bdQ1?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.bdQ2?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.bdQ3?"checked":""}></td>
      <td><input type="checkbox" disabled ${row.bdQ4?"checked":""}></td>
      <td>${row.suaChua||""}</td>
      <td><button onclick="openModal(${row.id})">Sửa</button></td>
      <td><button onclick="makeQR('${row.soThe||""}')">QR</button> <button onclick="printRecord(${row.id})">Lý lịch</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Save modal
document.getElementById('modalSave').onclick=async ()=>{
  const payload={ id:editingId, soThe:m_soThe.value, soMay:m_soMay.value, loaiMay:m_loaiMay.value, viTri:m_viTri.value,
                  ghiChu:m_ghiChu.value, daKiemKe:m_daKiemKe.checked, chonIn:m_chonIn.checked,
                  bdQ1:m_bdQ1.checked, bdNgayQ1:m_bdNgayQ1.value, bdQ2:m_bdQ2.checked, bdNgayQ2:m_bdNgayQ2.value,
                  bdQ3:m_bdQ3.checked, bdNgayQ3:m_bdNgayQ3.value, bdQ4:m_bdQ4.checked, bdNgayQ4:m_bdNgayQ4.value,
                  ngayMua:m_ngayMua.value, noiMua:m_noiMua.value, suaChua:m_suaChua.value, nam:yearSelect.value };
  try{
    const url=editingId?`${WORKER_URL}/update`:`${WORKER_URL}/add`;
    const res=await fetch(url,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
    const data=await res.json();
    if(data.success){ modal.style.display='none'; loadData(); } else alert("Lỗi khi lưu: "+data.error);
  }catch(err){ alert("Lỗi khi lưu: "+err); }
};
document.getElementById('btnAdd').onclick=()=>openModal(null);

// Year select
const currentYear=new Date().getFullYear();
for(let y=currentYear-1;y<=currentYear+2;y++){ const opt=document.createElement('option'); opt.value=y; opt.text=y; if(y===currentYear) opt.selected=true; yearSelect.appendChild(opt); }
yearSelect.onchange=loadData;

// Search & Filter
searchBox.addEventListener('input', applyFilters);
filterSelect.addEventListener('change', applyFilters);

function applyFilters(){
  const q = searchBox.value.toLowerCase();
  let filtered = allData.filter(r => r.soThe?.toLowerCase().includes(q) || r.soMay?.toLowerCase().includes(q) || r.loaiMay?.toLowerCase().includes(q) || r.viTri?.toLowerCase().includes(q));
  switch(filterSelect.value){
    case 'daKiemKe': filtered = filtered.filter(r=>r.daKiemKe); break;
    case 'chuaKiemKe': filtered = filtered.filter(r=>!r.daKiemKe); break;
    case 'daInQR': filtered = filtered.filter(r=>r.chonIn); break;
    case 'chuaInQR': filtered = filtered.filter(r=>!r.chonIn); break;
  }
  renderTable(filtered);
}

// Select all
selectAllBox.addEventListener('change',()=>{ document.querySelectorAll('.rowSelect').forEach(cb=>cb.checked=selectAllBox.checked); });

// Make QR
function makeQR(soThe){
  if(!soThe){ alert("Dòng này không có Số thẻ!"); return; }
  const url = location.origin + location.pathname + "?soThe=" + encodeURIComponent(soThe);
  const qrModal=document.getElementById('qrModal'); qrModal.style.display='flex';
  document.getElementById('qrBox').innerHTML=`<img src="https://chart.googleapis.com/chart?cht=qr&chs=250x250&chl=${encodeURIComponent(url)}"><p><b>${soThe}</b></p>`;
}

// Print single record
function printRecord(id){
  const r=allData.find(x=>x.id===id); if(!r){ alert("Không tìm thấy dữ liệu"); return; }
  const w=window.open('','_blank'); w.document.write('<html><head><title>Lý lịch</title></head><body>');
  w.document.write('<h2>Lý lịch máy</h2><ul>'); for(const key in r) w.document.write(`<li><b>${key}:</b> ${r[key]}</li>`); w.document.write('</ul></body></html>'); w.document.close(); w.print();
}

// Print selected QR
document.getElementById('btnPrintSelectedQR').onclick=()=>{
  const ids=Array.from(document.querySelectorAll('.rowSelect:checked')).map(cb=>parseInt(cb.dataset.id));
  if(ids.length===0){ alert("Chưa chọn dòng nào"); return; }
  const w=window.open('','_blank'); w.document.write('<html><head><title>QR</title></head><body>');
  ids.forEach(id=>{ const r=allData.find(x=>x.id===id); if(r){ const url = location.origin + location.pathname + "?soThe=" + encodeURIComponent(r.soThe); w.document.write(`<div style="display:inline-block;margin:5px;text-align:center;"><img src="https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=${encodeURIComponent(url)}"><p>${r.soThe}</p></div>`); } });
  w.document.write('</body></html>'); w.document.close(); w.print();
}

// Print selected records
document.getElementById('btnPrintSelectedRecord').onclick=()=>{
  const ids=Array.from(document.querySelectorAll('.rowSelect:checked')).map(cb=>parseInt(cb.dataset.id));
  if(ids.length===0){ alert("Chưa chọn dòng nào"); return; }
  const w=window.open('','_blank'); w.document.write('<html><head><title>Lý lịch</title></head><body>');
  ids.forEach(id=>{ const r=allData.find(x=>x.id===id); if(r){ w.document.write('<div style="border:1px solid #ccc;margin:5px;padding:5px;"><h3>Lý lịch máy '+r.soThe+'</h3><ul>'); for(const key in r) w.document.write(`<li><b>${key}:</b> ${r[key]}</li>`); w.document.write('</ul></div>'); } });
  w.document.write('</body></html>'); w.document.close(); w.print();
}

// Initial load
loadData();
</script>
</body>
</html>
