<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kiểm kê VH</title>

<style>
body { font-family: Arial; margin:0; padding:10px; background:#f4f4f4; }
table { border-collapse:collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }
button { padding:4px 8px; margin:2px; cursor:pointer; }

.modal{
  display:none; position:fixed; top:0; left:0;
  width:100%; height:100%; background:rgba(0,0,0,0.5);
  justify-content:center; align-items:center; z-index:1000;
}
.modal-content{
  background:#fff; padding:15px; width:420px; max-height:90%; overflow:auto;
  border-radius:6px;
}

.highlight-row{
  background:yellow !important;
  transition:background 1.5s;
}

#qrModal .modal-content { width:360px; text-align:center; }

/* QR in nhiều */
#printArea img { margin:10px; }
</style>

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>
<body>

<h2>Kiểm kê VH  
  <button id="btnAdd">Thêm</button>
  <button id="btnPrintQRSelected">In QR chọn</button>
</h2>

<label>Năm:
  <select id="yearSelect"></select>
</label>

<label style="margin-left:20px;">Lọc:
<select id="filterBox">
  <option value="all">Tất cả</option>
  <option value="checked">Đã kiểm kê</option>
  <option value="unchecked">Chưa kiểm kê</option>
  <option value="qr">Đã in QR</option>
  <option value="noqr">Chưa in QR</option>
</select>
</label>

<input type="text" id="searchBox" placeholder="Tìm số thẻ / số máy..." style="margin-left:20px;">

<table id="dataTable">
<thead>
<tr>
  <th><input type="checkbox" id="checkAll"></th>
  <th>ID</th><th>Số thẻ</th><th>Số máy</th><th>Loại máy</th><th>Vị trí</th>
  <th>Đã KK</th><th>In QR</th>
  <th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th>
  <th>HĐ</th><th>QR</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- Modal Thêm/Sửa -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Sửa</h3>

    <label>Số thẻ <input id="m_soThe"></label>
    <label>Số máy <input id="m_soMay"></label>
    <label>Loại máy <input id="m_loaiMay"></label>
    <label>Vị trí <input id="m_viTri"></label>

    <label><input type="checkbox" id="m_daKiemKe"> Đã kiểm kê</label>
    <label><input type="checkbox" id="m_chonIn"> In QR</label>

    <label><input type="checkbox" id="m_bdQ1"> Q1</label>
    <label><input type="checkbox" id="m_bdQ2"> Q2</label>
    <label><input type="checkbox" id="m_bdQ3"> Q3</label>
    <label><input type="checkbox" id="m_bdQ4"> Q4</label>

    <button id="modalSave">Lưu</button>
    <button onclick="modal.style.display='none'">Đóng</button>
  </div>
</div>

<!-- Modal hiển thị QR -->
<div class="modal" id="qrModal">
  <div class="modal-content">
    <h3>Mã QR</h3>
    <div id="qrBox"></div>
    <button onclick="qrModal.style.display='none'">Đóng</button>
  </div>
</div>

<!-- Modal in nhiều QR -->
<div class="modal" id="printQRModal">
  <div class="modal-content" style="width:600px;">
    <h3>In QR nhiều</h3>
    <div id="printArea"></div>
    <button onclick="window.print()">In</button>
    <button onclick="printQRModal.style.display='none'">Đóng</button>
  </div>
</div>

<script>
const WORKER_URL = "https://snowy-surf-e985.hoalangiongxoai.workers.dev";

let allData = [];
let editingId = null;

const modal = document.getElementById("modal");
const qrModal = document.getElementById("qrModal");
const printQRModal = document.getElementById("printQRModal");

// Load năm
const yearSelect=document.getElementById("yearSelect");
const yNow=new Date().getFullYear();
for(let y=yNow-1;y<=yNow+2;y++){
  let op=document.createElement("option");
  op.value=y; op.text=y;
  if(y===yNow) op.selected=true;
  yearSelect.appendChild(op);
}

yearSelect.onchange = loadData;
document.getElementById("filterBox").onchange = renderTable;
document.getElementById("searchBox").oninput = renderTable;

// =========== LOAD DATA ============
async function loadData(){
  const res = await fetch(`${WORKER_URL}/?year=${yearSelect.value}`);
  const js = await res.json();
  allData = js.data || [];
  renderTable();
}

// =========== HIỂN THỊ ============
function renderTable(){
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  const filter = document.getElementById("filterBox").value;
  const search = document.getElementById("searchBox").value.toLowerCase();

  let rows = allData.filter(r=>{
    if(filter==="checked" && !r.daKiemKe) return false;
    if(filter==="unchecked" && r.daKiemKe) return false;
    if(filter==="qr" && !r.chonIn) return false;
    if(filter==="noqr" && r.chonIn) return false;

    if(search && !(
      (r.soThe||"").toLowerCase().includes(search) ||
      (r.soMay||"").toLowerCase().includes(search)
    )) return false;

    return true;
  });

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input type="checkbox" class="rowCheck" data-id="${r.id}"></td>
      <td>${r.id}</td>
      <td>${r.soThe||""}</td>
      <td>${r.soMay||""}</td>
      <td>${r.loaiMay||""}</td>
      <td>${r.viTri||""}</td>

      <td><input type="checkbox" onchange="toggleField(${r.id},'daKiemKe',this.checked)" ${r.daKiemKe?'checked':''}></td>
      <td><input type="checkbox" onchange="toggleField(${r.id},'chonIn',this.checked)" ${r.chonIn?'checked':''}></td>

      <td><input type="checkbox" onchange="toggleField(${r.id},'bdQ1',this.checked)" ${r.bdQ1?'checked':''}></td>
      <td><input type="checkbox" onchange="toggleField(${r.id},'bdQ2',this.checked)" ${r.bdQ2?'checked':''}></td>
      <td><input type="checkbox" onchange="toggleField(${r.id},'bdQ3',this.checked)" ${r.bdQ3?'checked':''}></td>
      <td><input type="checkbox" onchange="toggleField(${r.id},'bdQ4',this.checked)" ${r.bdQ4?'checked':''}></td>

      <td><button onclick="openModal(${r.id})">Sửa</button></td>
      <td><button onclick="showQR('${r.soThe||""}')">QR</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// ========== CẬP NHẬT TRỰC TIẾP ============
async function toggleField(id, field, val){
  const row = allData.find(x=>x.id===id);
  if(!row) return;

  row[field] = val ? 1 : 0;

  await fetch(`${WORKER_URL}/update`, {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(row)
  });
}

// ========== MỞ QR ============
function showQR(soThe){
  qrModal.style.display='flex';
  const box = document.getElementById("qrBox");
  box.innerHTML = "";

  const url = location.origin + location.pathname + "?soThe=" + encodeURIComponent(soThe);

  new QRCode(box, {
    text: url,
    width: 250,
    height: 250
  });

  box.innerHTML += `<p><b>${soThe}</b></p>`;
}

// ========== IN QR CHỌN ============
document.getElementById("btnPrintQRSelected").onclick = ()=>{
  const ids = [...document.querySelectorAll(".rowCheck:checked")].map(x=>x.dataset.id);
  if(ids.length===0){ alert("Chưa chọn dòng nào!"); return; }

  const area = document.getElementById("printArea");
  area.innerHTML = "";
  printQRModal.style.display='flex';

  ids.forEach(id=>{
    const row = allData.find(r=>r.id==id);
    if(!row) return;

    const div = document.createElement("div");
    div.style.display="inline-block";
    div.style.textAlign="center";

    const qrDiv = document.createElement("div");
    div.appendChild(qrDiv);

    const url = location.origin + location.pathname + "?soThe=" + encodeURIComponent(row.soThe);

    new QRCode(qrDiv,{
      text:url,
      width:200,
      height:200
    });
    div.innerHTML += `<p>${row.soThe}</p>`;
    area.appendChild(div);
  });
};

// ========== MODAL SỬA =============
document.getElementById("btnAdd").onclick=()=>openModal(null);

function openModal(id){
  modal.style.display='flex';
  editingId=id;

  const r = allData.find(x=>x.id===id) || {};

  modalTitle.textContent = id?"Sửa":"Thêm";

  m_soThe.value = r.soThe||"";
  m_soMay.value = r.soMay||"";
  m_loaiMay.value = r.loaiMay||"";
  m_viTri.value = r.viTri||"";
  m_daKiemKe.checked = !!r.daKiemKe;
  m_chonIn.checked = !!r.chonIn;
  m_bdQ1.checked = !!r.bdQ1;
  m_bdQ2.checked = !!r.bdQ2;
  m_bdQ3.checked = !!r.bdQ3;
  m_bdQ4.checked = !!r.bdQ4;
}

document.getElementById("modalSave").onclick=async ()=>{
  const payload = {
    id:editingId,
    nam:yearSelect.value,
    soThe:m_soThe.value,
    soMay:m_soMay.value,
    loaiMay:m_loaiMay.value,
    viTri:m_viTri.value,
    daKiemKe:m_daKiemKe.checked,
    chonIn:m_chonIn.checked,
    bdQ1:m_bdQ1.checked,
    bdQ2:m_bdQ2.checked,
    bdQ3:m_bdQ3.checked,
    bdQ4:m_bdQ4.checked
  };

  const url = editingId ? "/update" : "/add";

  await fetch(WORKER_URL + url,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  modal.style.display='none';
  loadData();
};

// ========== SCROLL TO QR ==========
function scrollToSoThe(soThe){
  const rows=document.querySelectorAll("#dataTable tbody tr");
  rows.forEach(tr=>{
    if(tr.children[2].textContent.trim() === soThe){
      tr.classList.add("highlight-row");
      tr.scrollIntoView({behavior:"smooth", block:"center"});
    }
  });
}

// Load first
loadData();
</script>

</body>
</html>
